{"ast":null,"code":"import { Loader, LoaderUtils, Interpolant, Quaternion, FileLoader, SkinnedMesh, Skeleton, Bone, Vector3, Float32BufferAttribute, BufferGeometry, Uint16BufferAttribute, TextureLoader, Color, CustomBlending, SrcAlphaFactor, OneMinusSrcAlphaFactor, DstAlphaFactor, DoubleSide, FrontSide, MultiplyOperation, AddOperation, MeshToonMaterial, NearestFilter, RepeatWrapping, AnimationClip, VectorKeyframeTrack, QuaternionKeyframeTrack, NumberKeyframeTrack, Euler } from 'three';\nimport { TGALoader } from './TGALoader.js';\nimport { Parser } from 'mmd-parser';\n/**\n * Dependencies\n *  - mmd-parser https://github.com/takahirox/mmd-parser\n *  - TGALoader\n *  - OutlineEffect\n *\n * MMDLoader creates Three.js Objects from MMD resources as\n * PMD, PMX, VMD, and VPD files.\n *\n * PMD/PMX is a model data format, VMD is a motion data format\n * VPD is a posing data format used in MMD(Miku Miku Dance).\n *\n * MMD official site\n *  - https://sites.google.com/view/evpvp/\n *\n * PMD, VMD format (in Japanese)\n *  - http://blog.goo.ne.jp/torisu_tetosuki/e/209ad341d3ece2b1b4df24abf619d6e4\n *\n * PMX format\n *  - https://gist.github.com/felixjones/f8a06bd48f9da9a4539f\n *\n * TODO\n *  - light motion in vmd support.\n *  - SDEF support.\n *  - uv/material/bone morphing support.\n *  - more precise grant skinning support.\n *  - shadow support.\n */\n\nvar MMDLoader = function () {\n  /**\n   * @param {THREE.LoadingManager} manager\n   */\n  function MMDLoader(manager) {\n    Loader.call(this, manager);\n    this.loader = new FileLoader(this.manager);\n    this.parser = null; // lazy generation\n\n    this.meshBuilder = new MeshBuilder(this.manager);\n    this.animationBuilder = new AnimationBuilder();\n  }\n\n  MMDLoader.prototype = Object.assign(Object.create(Loader.prototype), {\n    constructor: MMDLoader,\n\n    /**\n     * @param {string} animationPath\n     * @return {MMDLoader}\n     */\n    setAnimationPath: function setAnimationPath(animationPath) {\n      this.animationPath = animationPath;\n      return this;\n    },\n    // Load MMD assets as Three.js Object\n\n    /**\n     * Loads Model file (.pmd or .pmx) as a SkinnedMesh.\n     *\n     * @param {string} url - url to Model(.pmd or .pmx) file\n     * @param {function} onLoad\n     * @param {function} onProgress\n     * @param {function} onError\n     */\n    load: function load(url, onLoad, onProgress, onError) {\n      var builder = this.meshBuilder.setCrossOrigin(this.crossOrigin); // resource path\n\n      var resourcePath;\n\n      if (this.resourcePath !== '') {\n        resourcePath = this.resourcePath;\n      } else if (this.path !== '') {\n        resourcePath = this.path;\n      } else {\n        resourcePath = LoaderUtils.extractUrlBase(url);\n      }\n\n      var modelExtension = this._extractExtension(url).toLowerCase(); // Should I detect by seeing header?\n\n\n      if (modelExtension !== 'pmd' && modelExtension !== 'pmx') {\n        if (onError) onError(new Error('THREE.MMDLoader: Unknown model file extension .' + modelExtension + '.'));\n        return;\n      }\n\n      this[modelExtension === 'pmd' ? 'loadPMD' : 'loadPMX'](url, function (data) {\n        onLoad(builder.build(data, resourcePath, onProgress, onError));\n      }, onProgress, onError);\n    },\n\n    /**\n     * Loads Motion file(s) (.vmd) as a AnimationClip.\n     * If two or more files are specified, they'll be merged.\n     *\n     * @param {string|Array<string>} url - url(s) to animation(.vmd) file(s)\n     * @param {SkinnedMesh|THREE.Camera} object - tracks will be fitting to this object\n     * @param {function} onLoad\n     * @param {function} onProgress\n     * @param {function} onError\n     */\n    loadAnimation: function loadAnimation(url, object, onLoad, onProgress, onError) {\n      var builder = this.animationBuilder;\n      this.loadVMD(url, function (vmd) {\n        onLoad(object.isCamera ? builder.buildCameraAnimation(vmd) : builder.build(vmd, object));\n      }, onProgress, onError);\n    },\n\n    /**\n     * Loads mode file and motion file(s) as an object containing\n     * a SkinnedMesh and a AnimationClip.\n     * Tracks of AnimationClip are fitting to the model.\n     *\n     * @param {string} modelUrl - url to Model(.pmd or .pmx) file\n     * @param {string|Array{string}} vmdUrl - url(s) to animation(.vmd) file\n     * @param {function} onLoad\n     * @param {function} onProgress\n     * @param {function} onError\n     */\n    loadWithAnimation: function loadWithAnimation(modelUrl, vmdUrl, onLoad, onProgress, onError) {\n      var scope = this;\n      this.load(modelUrl, function (mesh) {\n        scope.loadAnimation(vmdUrl, mesh, function (animation) {\n          onLoad({\n            mesh: mesh,\n            animation: animation\n          });\n        }, onProgress, onError);\n      }, onProgress, onError);\n    },\n    // Load MMD assets as Object data parsed by MMDParser\n\n    /**\n     * Loads .pmd file as an Object.\n     *\n     * @param {string} url - url to .pmd file\n     * @param {function} onLoad\n     * @param {function} onProgress\n     * @param {function} onError\n     */\n    loadPMD: function loadPMD(url, onLoad, onProgress, onError) {\n      var parser = this._getParser();\n\n      this.loader.setMimeType(undefined).setPath(this.path).setResponseType('arraybuffer').setRequestHeader(this.requestHeader).setWithCredentials(this.withCredentials).load(url, function (buffer) {\n        onLoad(parser.parsePmd(buffer, true));\n      }, onProgress, onError);\n    },\n\n    /**\n     * Loads .pmx file as an Object.\n     *\n     * @param {string} url - url to .pmx file\n     * @param {function} onLoad\n     * @param {function} onProgress\n     * @param {function} onError\n     */\n    loadPMX: function loadPMX(url, onLoad, onProgress, onError) {\n      var parser = this._getParser();\n\n      this.loader.setMimeType(undefined).setPath(this.path).setResponseType('arraybuffer').setRequestHeader(this.requestHeader).setWithCredentials(this.withCredentials).load(url, function (buffer) {\n        onLoad(parser.parsePmx(buffer, true));\n      }, onProgress, onError);\n    },\n\n    /**\n     * Loads .vmd file as an Object. If two or more files are specified\n     * they'll be merged.\n     *\n     * @param {string|Array<string>} url - url(s) to .vmd file(s)\n     * @param {function} onLoad\n     * @param {function} onProgress\n     * @param {function} onError\n     */\n    loadVMD: function loadVMD(url, onLoad, onProgress, onError) {\n      var urls = Array.isArray(url) ? url : [url];\n      var vmds = [];\n      var vmdNum = urls.length;\n\n      var parser = this._getParser();\n\n      this.loader.setMimeType(undefined).setPath(this.animationPath).setResponseType('arraybuffer').setRequestHeader(this.requestHeader).setWithCredentials(this.withCredentials);\n\n      for (var i = 0, il = urls.length; i < il; i++) {\n        this.loader.load(urls[i], function (buffer) {\n          vmds.push(parser.parseVmd(buffer, true));\n          if (vmds.length === vmdNum) onLoad(parser.mergeVmds(vmds));\n        }, onProgress, onError);\n      }\n    },\n\n    /**\n     * Loads .vpd file as an Object.\n     *\n     * @param {string} url - url to .vpd file\n     * @param {boolean} isUnicode\n     * @param {function} onLoad\n     * @param {function} onProgress\n     * @param {function} onError\n     */\n    loadVPD: function loadVPD(url, isUnicode, onLoad, onProgress, onError) {\n      var parser = this._getParser();\n\n      this.loader.setMimeType(isUnicode ? undefined : 'text/plain; charset=shift_jis').setPath(this.animationPath).setResponseType('text').setRequestHeader(this.requestHeader).setWithCredentials(this.withCredentials).load(url, function (text) {\n        onLoad(parser.parseVpd(text, true));\n      }, onProgress, onError);\n    },\n    // private methods\n    _extractExtension: function _extractExtension(url) {\n      var index = url.lastIndexOf('.');\n      return index < 0 ? '' : url.slice(index + 1);\n    },\n    _getParser: function _getParser() {\n      if (this.parser === null) {\n        this.parser = new Parser(); // eslint-disable-line no-undef\n      }\n\n      return this.parser;\n    }\n  }); // Utilities\n\n  /*\n   * base64 encoded defalut toon textures toon00.bmp - toon10.bmp.\n   * We don't need to request external toon image files.\n   * This idea is from http://www20.atpages.jp/katwat/three.js_r58/examples/mytest37/mmd.three.js\n   */\n\n  var DEFAULT_TOON_TEXTURES = ['data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAL0lEQVRYR+3QQREAAAzCsOFfNJPBJ1XQS9r2hsUAAQIECBAgQIAAAQIECBAgsBZ4MUx/ofm2I/kAAAAASUVORK5CYII=', 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAN0lEQVRYR+3WQREAMBACsZ5/bWiiMvgEBTt5cW37hjsBBAgQIECAwFwgyfYPCCBAgAABAgTWAh8aBHZBl14e8wAAAABJRU5ErkJggg==', 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAOUlEQVRYR+3WMREAMAwDsYY/yoDI7MLwIiP40+RJklfcCCBAgAABAgTqArfb/QMCCBAgQIAAgbbAB3z/e0F3js2cAAAAAElFTkSuQmCC', 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAN0lEQVRYR+3WQREAMBACsZ5/B5ilMvgEBTt5cW37hjsBBAgQIECAwFwgyfYPCCBAgAABAgTWAh81dWyx0gFwKAAAAABJRU5ErkJggg==', 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAOklEQVRYR+3WoREAMAwDsWb/UQtCy9wxTOQJ/oQ8SXKKGwEECBAgQIBAXeDt7f4BAQQIECBAgEBb4AOz8Hzx7WLY4wAAAABJRU5ErkJggg==', 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABPUlEQVRYR+1XwW7CMAy1+f9fZOMysSEOEweEOPRNdm3HbdOyIhAcklPrOs/PLy9RygBALxzcCDQFmgJNgaZAU6Ap0BR4PwX8gsRMVLssMRH5HcpzJEaWL7EVg9F1IHRlyqQohgVr4FGUlUcMJSjcUlDw0zvjeun70cLWmneoyf7NgBTQSniBTQQSuJAZsOnnaczjIMb5hCiuHKxokCrJfVnrctyZL0PkJAJe1HMil4nxeyi3Ypfn1kX51jpPvo/JeCNC4PhVdHdJw2XjBR8brF8PEIhNVn12AgP7uHsTBguBn53MUZCqv7Lp07Pn5k1Ro+uWmUNn7D+M57rtk7aG0Vo73xyF/fbFf0bPJjDXngnGocDTdFhygZjwUQrMNrDcmZlQT50VJ/g/UwNyHpu778+yW+/ksOz/BFo54P4AsUXMfRq7XWsAAAAASUVORK5CYII=', 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAACMElEQVRYR+2Xv4pTQRTGf2dubhLdICiii2KnYKHVolhauKWPoGAnNr6BD6CvIVaihYuI2i1ia0BY0MZGRHQXjZj/mSPnnskfNWiWZUlzJ5k7M2cm833nO5Mziej2DWWJRUoCpQKlAntSQCqgw39/iUWAGmh37jrRnVsKlgpiqmkoGVABA7E57fvY+pJDdgKqF6HzFCSADkDq+F6AHABtQ+UMVE5D7zXod7fFNhTEckTbj5XQgHzNN+5tQvc5NG7C6BNkp6D3EmpXHDR+dQAjFLchW3VS9rlw3JBh+B7ys5Cf9z0GW1C/7P32AyBAOAz1q4jGliIH3YPuBnSfQX4OGreTIgEYQb/pBDtPnEQ4CivXYPAWBk13oHrB54yA9QuSn2H4AcKRpEILDt0BUzj+RLR1V5EqjD66NPRBVpLcQwjHoHYJOhsQv6U4mnzmrIXJCFr4LDwm/xBUoboG9XX4cc9VKdYoSA2yk5NQLJaKDUjTBoveG3Z2TElTxwjNK4M3LEZgUdDdruvcXzKBpStgp2NPiWi3ks9ZXxIoFVi+AvHLdc9TqtjL3/aYjpPlrzOcEnK62Szhimdd7xX232zFDTgtxezOu3WNMRLjiKgjtOhHVMd1loynVHvOgjuIIJMaELEqhJAV/RCSLbWTcfPFakFgFlALTRRvx+ok6Hlp/Q+v3fmx90bMyUzaEAhmM3KvHlXTL5DxnbGf/1M8RNNACLL5MNtPxP/mypJAqcDSFfgFhpYqWUzhTEAAAAAASUVORK5CYII=', 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAL0lEQVRYR+3QQREAAAzCsOFfNJPBJ1XQS9r2hsUAAQIECBAgQIAAAQIECBAgsBZ4MUx/ofm2I/kAAAAASUVORK5CYII=', 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAL0lEQVRYR+3QQREAAAzCsOFfNJPBJ1XQS9r2hsUAAQIECBAgQIAAAQIECBAgsBZ4MUx/ofm2I/kAAAAASUVORK5CYII=', 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAL0lEQVRYR+3QQREAAAzCsOFfNJPBJ1XQS9r2hsUAAQIECBAgQIAAAQIECBAgsBZ4MUx/ofm2I/kAAAAASUVORK5CYII=', 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAL0lEQVRYR+3QQREAAAzCsOFfNJPBJ1XQS9r2hsUAAQIECBAgQIAAAQIECBAgsBZ4MUx/ofm2I/kAAAAASUVORK5CYII=']; // Builders. They build Three.js object from Object data parsed by MMDParser.\n\n  /**\n   * @param {THREE.LoadingManager} manager\n   */\n\n  function MeshBuilder(manager) {\n    this.geometryBuilder = new GeometryBuilder();\n    this.materialBuilder = new MaterialBuilder(manager);\n  }\n\n  MeshBuilder.prototype = {\n    constructor: MeshBuilder,\n    crossOrigin: 'anonymous',\n\n    /**\n     * @param {string} crossOrigin\n     * @return {MeshBuilder}\n     */\n    setCrossOrigin: function setCrossOrigin(crossOrigin) {\n      this.crossOrigin = crossOrigin;\n      return this;\n    },\n\n    /**\n     * @param {Object} data - parsed PMD/PMX data\n     * @param {string} resourcePath\n     * @param {function} onProgress\n     * @param {function} onError\n     * @return {SkinnedMesh}\n     */\n    build: function build(data, resourcePath, onProgress, onError) {\n      var geometry = this.geometryBuilder.build(data);\n      var material = this.materialBuilder.setCrossOrigin(this.crossOrigin).setResourcePath(resourcePath).build(data, geometry, onProgress, onError);\n      var mesh = new SkinnedMesh(geometry, material);\n      var skeleton = new Skeleton(initBones(mesh));\n      mesh.bind(skeleton); // console.log( mesh ); // for console debug\n\n      return mesh;\n    }\n  }; // TODO: Try to remove this function\n\n  function initBones(mesh) {\n    var geometry = mesh.geometry;\n    var bones = [],\n        bone,\n        gbone;\n    var i, il;\n\n    if (geometry && geometry.bones !== undefined) {\n      // first, create array of 'Bone' objects from geometry data\n      for (i = 0, il = geometry.bones.length; i < il; i++) {\n        gbone = geometry.bones[i]; // create new 'Bone' object\n\n        bone = new Bone();\n        bones.push(bone); // apply values\n\n        bone.name = gbone.name;\n        bone.position.fromArray(gbone.pos);\n        bone.quaternion.fromArray(gbone.rotq);\n        if (gbone.scl !== undefined) bone.scale.fromArray(gbone.scl);\n      } // second, create bone hierarchy\n\n\n      for (i = 0, il = geometry.bones.length; i < il; i++) {\n        gbone = geometry.bones[i];\n\n        if (gbone.parent !== -1 && gbone.parent !== null && bones[gbone.parent] !== undefined) {\n          // subsequent bones in the hierarchy\n          bones[gbone.parent].add(bones[i]);\n        } else {\n          // topmost bone, immediate child of the skinned mesh\n          mesh.add(bones[i]);\n        }\n      }\n    } // now the bones are part of the scene graph and children of the skinned mesh.\n    // let's update the corresponding matrices\n\n\n    mesh.updateMatrixWorld(true);\n    return bones;\n  } //\n\n\n  function GeometryBuilder() {}\n\n  GeometryBuilder.prototype = {\n    constructor: GeometryBuilder,\n\n    /**\n     * @param {Object} data - parsed PMD/PMX data\n     * @return {BufferGeometry}\n     */\n    build: function build(data) {\n      // for geometry\n      var positions = [];\n      var uvs = [];\n      var normals = [];\n      var indices = [];\n      var groups = [];\n      var bones = [];\n      var skinIndices = [];\n      var skinWeights = [];\n      var morphTargets = [];\n      var morphPositions = [];\n      var iks = [];\n      var grants = [];\n      var rigidBodies = [];\n      var constraints = []; // for work\n\n      var offset = 0;\n      var boneTypeTable = {}; // positions, normals, uvs, skinIndices, skinWeights\n\n      for (var i = 0; i < data.metadata.vertexCount; i++) {\n        var v = data.vertices[i];\n\n        for (var j = 0, jl = v.position.length; j < jl; j++) {\n          positions.push(v.position[j]);\n        }\n\n        for (var _j = 0, _jl = v.normal.length; _j < _jl; _j++) {\n          normals.push(v.normal[_j]);\n        }\n\n        for (var _j2 = 0, _jl2 = v.uv.length; _j2 < _jl2; _j2++) {\n          uvs.push(v.uv[_j2]);\n        }\n\n        for (var _j3 = 0; _j3 < 4; _j3++) {\n          skinIndices.push(v.skinIndices.length - 1 >= _j3 ? v.skinIndices[_j3] : 0.0);\n        }\n\n        for (var _j4 = 0; _j4 < 4; _j4++) {\n          skinWeights.push(v.skinWeights.length - 1 >= _j4 ? v.skinWeights[_j4] : 0.0);\n        }\n      } // indices\n\n\n      for (var _i = 0; _i < data.metadata.faceCount; _i++) {\n        var face = data.faces[_i];\n\n        for (var _j5 = 0, _jl3 = face.indices.length; _j5 < _jl3; _j5++) {\n          indices.push(face.indices[_j5]);\n        }\n      } // groups\n\n\n      for (var _i2 = 0; _i2 < data.metadata.materialCount; _i2++) {\n        var material = data.materials[_i2];\n        groups.push({\n          offset: offset * 3,\n          count: material.faceCount * 3\n        });\n        offset += material.faceCount;\n      } // bones\n\n\n      for (var _i3 = 0; _i3 < data.metadata.rigidBodyCount; _i3++) {\n        var body = data.rigidBodies[_i3];\n        var value = boneTypeTable[body.boneIndex]; // keeps greater number if already value is set without any special reasons\n\n        value = value === undefined ? body.type : Math.max(body.type, value);\n        boneTypeTable[body.boneIndex] = value;\n      }\n\n      for (var _i4 = 0; _i4 < data.metadata.boneCount; _i4++) {\n        var boneData = data.bones[_i4];\n        var bone = {\n          parent: boneData.parentIndex,\n          name: boneData.name,\n          pos: boneData.position.slice(0, 3),\n          rotq: [0, 0, 0, 1],\n          scl: [1, 1, 1],\n          rigidBodyType: boneTypeTable[_i4] !== undefined ? boneTypeTable[_i4] : -1\n        };\n\n        if (bone.parent !== -1) {\n          bone.pos[0] -= data.bones[bone.parent].position[0];\n          bone.pos[1] -= data.bones[bone.parent].position[1];\n          bone.pos[2] -= data.bones[bone.parent].position[2];\n        }\n\n        bones.push(bone);\n      } // iks\n      // TODO: remove duplicated codes between PMD and PMX\n\n\n      if (data.metadata.format === 'pmd') {\n        for (var _i5 = 0; _i5 < data.metadata.ikCount; _i5++) {\n          var ik = data.iks[_i5];\n          var param = {\n            target: ik.target,\n            effector: ik.effector,\n            iteration: ik.iteration,\n            maxAngle: ik.maxAngle * 4,\n            links: []\n          };\n\n          for (var _j6 = 0, _jl4 = ik.links.length; _j6 < _jl4; _j6++) {\n            var link = {};\n            link.index = ik.links[_j6].index;\n            link.enabled = true;\n\n            if (data.bones[link.index].name.indexOf('ひざ') >= 0) {\n              link.limitation = new Vector3(1.0, 0.0, 0.0);\n            }\n\n            param.links.push(link);\n          }\n\n          iks.push(param);\n        }\n      } else {\n        for (var _i6 = 0; _i6 < data.metadata.boneCount; _i6++) {\n          var ik = data.bones[_i6].ik;\n          if (ik === undefined) continue;\n          var param = {\n            target: _i6,\n            effector: ik.effector,\n            iteration: ik.iteration,\n            maxAngle: ik.maxAngle,\n            links: []\n          };\n\n          for (var _j7 = 0, _jl5 = ik.links.length; _j7 < _jl5; _j7++) {\n            var link = {};\n            link.index = ik.links[_j7].index;\n            link.enabled = true;\n\n            if (ik.links[_j7].angleLimitation === 1) {\n              // Revert if rotationMin/Max doesn't work well\n              // link.limitation = new Vector3( 1.0, 0.0, 0.0 );\n              var rotationMin = ik.links[_j7].lowerLimitationAngle;\n              var rotationMax = ik.links[_j7].upperLimitationAngle; // Convert Left to Right coordinate by myself because\n              // MMDParser doesn't convert. It's a MMDParser's bug\n\n              var tmp1 = -rotationMax[0];\n              var tmp2 = -rotationMax[1];\n              rotationMax[0] = -rotationMin[0];\n              rotationMax[1] = -rotationMin[1];\n              rotationMin[0] = tmp1;\n              rotationMin[1] = tmp2;\n              link.rotationMin = new Vector3().fromArray(rotationMin);\n              link.rotationMax = new Vector3().fromArray(rotationMax);\n            }\n\n            param.links.push(link);\n          }\n\n          iks.push(param);\n        }\n      } // grants\n\n\n      if (data.metadata.format === 'pmx') {\n        for (var _i7 = 0; _i7 < data.metadata.boneCount; _i7++) {\n          var boneData = data.bones[_i7];\n          var grant = boneData.grant;\n          if (grant === undefined) continue;\n          var param = {\n            index: _i7,\n            parentIndex: grant.parentIndex,\n            ratio: grant.ratio,\n            isLocal: grant.isLocal,\n            affectRotation: grant.affectRotation,\n            affectPosition: grant.affectPosition,\n            transformationClass: boneData.transformationClass\n          };\n          grants.push(param);\n        }\n\n        grants.sort(function (a, b) {\n          return a.transformationClass - b.transformationClass;\n        });\n      } // morph\n\n\n      function updateAttributes(attribute, morph, ratio) {\n        for (var _i8 = 0; _i8 < morph.elementCount; _i8++) {\n          var element = morph.elements[_i8];\n          var index;\n\n          if (data.metadata.format === 'pmd') {\n            index = data.morphs[0].elements[element.index].index;\n          } else {\n            index = element.index;\n          }\n\n          attribute.array[index * 3 + 0] += element.position[0] * ratio;\n          attribute.array[index * 3 + 1] += element.position[1] * ratio;\n          attribute.array[index * 3 + 2] += element.position[2] * ratio;\n        }\n      }\n\n      for (var _i9 = 0; _i9 < data.metadata.morphCount; _i9++) {\n        var morph = data.morphs[_i9];\n        var params = {\n          name: morph.name\n        };\n        var attribute = new Float32BufferAttribute(data.metadata.vertexCount * 3, 3);\n        attribute.name = morph.name;\n\n        for (var _j8 = 0; _j8 < data.metadata.vertexCount * 3; _j8++) {\n          attribute.array[_j8] = positions[_j8];\n        }\n\n        if (data.metadata.format === 'pmd') {\n          if (_i9 !== 0) {\n            updateAttributes(attribute, morph, 1.0);\n          }\n        } else {\n          if (morph.type === 0) {\n            // group\n            for (var _j9 = 0; _j9 < morph.elementCount; _j9++) {\n              var morph2 = data.morphs[morph.elements[_j9].index];\n              var ratio = morph.elements[_j9].ratio;\n\n              if (morph2.type === 1) {\n                updateAttributes(attribute, morph2, ratio);\n              }\n            }\n          } else if (morph.type === 1) {\n            // vertex\n            updateAttributes(attribute, morph, 1.0);\n          } else if (morph.type === 2) ;else if (morph.type === 3) ;else if (morph.type === 4) ;else if (morph.type === 5) ;else if (morph.type === 6) ;else if (morph.type === 7) ;else if (morph.type === 8) ;\n        }\n\n        morphTargets.push(params);\n        morphPositions.push(attribute);\n      } // rigid bodies from rigidBodies field.\n\n\n      for (var _i10 = 0; _i10 < data.metadata.rigidBodyCount; _i10++) {\n        var rigidBody = data.rigidBodies[_i10];\n        var params = {};\n\n        for (var key in rigidBody) {\n          params[key] = rigidBody[key];\n        }\n        /*\n         * RigidBody position parameter in PMX seems global position\n         * while the one in PMD seems offset from corresponding bone.\n         * So unify being offset.\n         */\n\n\n        if (data.metadata.format === 'pmx') {\n          if (params.boneIndex !== -1) {\n            var bone = data.bones[params.boneIndex];\n            params.position[0] -= bone.position[0];\n            params.position[1] -= bone.position[1];\n            params.position[2] -= bone.position[2];\n          }\n        }\n\n        rigidBodies.push(params);\n      } // constraints from constraints field.\n\n\n      for (var _i11 = 0; _i11 < data.metadata.constraintCount; _i11++) {\n        var constraint = data.constraints[_i11];\n        var params = {};\n\n        for (var _key in constraint) {\n          params[_key] = constraint[_key];\n        }\n\n        var bodyA = rigidBodies[params.rigidBodyIndex1];\n        var bodyB = rigidBodies[params.rigidBodyIndex2]; // Refer to http://www20.atpages.jp/katwat/wp/?p=4135\n\n        if (bodyA.type !== 0 && bodyB.type === 2) {\n          if (bodyA.boneIndex !== -1 && bodyB.boneIndex !== -1 && data.bones[bodyB.boneIndex].parentIndex === bodyA.boneIndex) {\n            bodyB.type = 1;\n          }\n        }\n\n        constraints.push(params);\n      } // build BufferGeometry.\n\n\n      var geometry = new BufferGeometry();\n      geometry.setAttribute('position', new Float32BufferAttribute(positions, 3));\n      geometry.setAttribute('normal', new Float32BufferAttribute(normals, 3));\n      geometry.setAttribute('uv', new Float32BufferAttribute(uvs, 2));\n      geometry.setAttribute('skinIndex', new Uint16BufferAttribute(skinIndices, 4));\n      geometry.setAttribute('skinWeight', new Float32BufferAttribute(skinWeights, 4));\n      geometry.setIndex(indices);\n\n      for (var _i12 = 0, il = groups.length; _i12 < il; _i12++) {\n        geometry.addGroup(groups[_i12].offset, groups[_i12].count, _i12);\n      }\n\n      geometry.bones = bones;\n      geometry.morphTargets = morphTargets;\n      geometry.morphAttributes.position = morphPositions;\n      geometry.morphTargetsRelative = false;\n      geometry.userData.MMD = {\n        bones: bones,\n        iks: iks,\n        grants: grants,\n        rigidBodies: rigidBodies,\n        constraints: constraints,\n        format: data.metadata.format\n      };\n      geometry.computeBoundingSphere();\n      return geometry;\n    }\n  }; //\n\n  /**\n   * @param {THREE.LoadingManager} manager\n   */\n\n  function MaterialBuilder(manager) {\n    this.manager = manager;\n    this.textureLoader = new TextureLoader(this.manager);\n    this.tgaLoader = null; // lazy generation\n  }\n\n  MaterialBuilder.prototype = {\n    constructor: MaterialBuilder,\n    crossOrigin: 'anonymous',\n    resourcePath: undefined,\n\n    /**\n     * @param {string} crossOrigin\n     * @return {MaterialBuilder}\n     */\n    setCrossOrigin: function setCrossOrigin(crossOrigin) {\n      this.crossOrigin = crossOrigin;\n      return this;\n    },\n\n    /**\n     * @param {string} resourcePath\n     * @return {MaterialBuilder}\n     */\n    setResourcePath: function setResourcePath(resourcePath) {\n      this.resourcePath = resourcePath;\n      return this;\n    },\n\n    /**\n     * @param {Object} data - parsed PMD/PMX data\n     * @param {BufferGeometry} geometry - some properties are dependend on geometry\n     * @param {function} onProgress\n     * @param {function} onError\n     * @return {Array<MeshToonMaterial>}\n     */\n    build: function build(data, geometry\n    /*, onProgress, onError */\n    ) {\n      var materials = [];\n      var textures = {};\n      this.textureLoader.setCrossOrigin(this.crossOrigin); // materials\n\n      for (var i = 0; i < data.metadata.materialCount; i++) {\n        var material = data.materials[i];\n        var params = {\n          userData: {}\n        };\n        if (material.name !== undefined) params.name = material.name;\n        /*\n         * Color\n         *\n         * MMD         MeshToonMaterial\n         * diffuse  -  color\n         * ambient  -  emissive * a\n         *               (a = 1.0 without map texture or 0.2 with map texture)\n         *\n         * MeshToonMaterial doesn't have ambient. Set it to emissive instead.\n         * It'll be too bright if material has map texture so using coef 0.2.\n         */\n\n        params.color = new Color().fromArray(material.diffuse);\n        params.opacity = material.diffuse[3];\n        params.emissive = new Color().fromArray(material.ambient);\n        params.transparent = params.opacity !== 1.0; //\n\n        params.skinning = geometry.bones.length > 0 ? true : false;\n        params.morphTargets = geometry.morphTargets.length > 0 ? true : false;\n        params.fog = true; // blend\n\n        params.blending = CustomBlending;\n        params.blendSrc = SrcAlphaFactor;\n        params.blendDst = OneMinusSrcAlphaFactor;\n        params.blendSrcAlpha = SrcAlphaFactor;\n        params.blendDstAlpha = DstAlphaFactor; // side\n\n        if (data.metadata.format === 'pmx' && (material.flag & 0x1) === 1) {\n          params.side = DoubleSide;\n        } else {\n          params.side = params.opacity === 1.0 ? FrontSide : DoubleSide;\n        }\n\n        if (data.metadata.format === 'pmd') {\n          // map, envMap\n          if (material.fileName) {\n            var fileName = material.fileName;\n            var fileNames = fileName.split('*'); // fileNames[ 0 ]: mapFileName\n            // fileNames[ 1 ]: envMapFileName( optional )\n\n            params.map = this._loadTexture(fileNames[0], textures);\n\n            if (fileNames.length > 1) {\n              var extension = fileNames[1].slice(-4).toLowerCase();\n              params.envMap = this._loadTexture(fileNames[1], textures);\n              params.combine = extension === '.sph' ? MultiplyOperation : AddOperation;\n            }\n          } // gradientMap\n\n\n          var toonFileName = material.toonIndex === -1 ? 'toon00.bmp' : data.toonTextures[material.toonIndex].fileName;\n          params.gradientMap = this._loadTexture(toonFileName, textures, {\n            isToonTexture: true,\n            isDefaultToonTexture: this._isDefaultToonTexture(toonFileName)\n          }); // parameters for OutlineEffect\n\n          params.userData.outlineParameters = {\n            thickness: material.edgeFlag === 1 ? 0.003 : 0.0,\n            color: [0, 0, 0],\n            alpha: 1.0,\n            visible: material.edgeFlag === 1\n          };\n        } else {\n          // map\n          if (material.textureIndex !== -1) {\n            params.map = this._loadTexture(data.textures[material.textureIndex], textures);\n          } // envMap TODO: support m.envFlag === 3\n\n\n          if (material.envTextureIndex !== -1 && (material.envFlag === 1 || material.envFlag == 2)) {\n            params.envMap = this._loadTexture(data.textures[material.envTextureIndex], textures);\n            params.combine = material.envFlag === 1 ? MultiplyOperation : AddOperation;\n          } // gradientMap\n\n\n          var toonFileName, isDefaultToon;\n\n          if (material.toonIndex === -1 || material.toonFlag !== 0) {\n            toonFileName = 'toon' + ('0' + (material.toonIndex + 1)).slice(-2) + '.bmp';\n            isDefaultToon = true;\n          } else {\n            toonFileName = data.textures[material.toonIndex];\n            isDefaultToon = false;\n          }\n\n          params.gradientMap = this._loadTexture(toonFileName, textures, {\n            isToonTexture: true,\n            isDefaultToonTexture: isDefaultToon\n          }); // parameters for OutlineEffect\n\n          params.userData.outlineParameters = {\n            thickness: material.edgeSize / 300,\n            // TODO: better calculation?\n            color: material.edgeColor.slice(0, 3),\n            alpha: material.edgeColor[3],\n            visible: (material.flag & 0x10) !== 0 && material.edgeSize > 0.0\n          };\n        }\n\n        if (params.map !== undefined) {\n          if (!params.transparent) {\n            this._checkImageTransparency(params.map, geometry, i);\n          }\n\n          params.emissive.multiplyScalar(0.2);\n        }\n\n        materials.push(new MeshToonMaterial(params));\n      }\n\n      if (data.metadata.format === 'pmx') {\n        // set transparent true if alpha morph is defined.\n        var checkAlphaMorph = function checkAlphaMorph(elements, materials) {\n          for (var _i13 = 0, il = elements.length; _i13 < il; _i13++) {\n            var element = elements[_i13];\n            if (element.index === -1) continue;\n            var material = materials[element.index];\n\n            if (material.opacity !== element.diffuse[3]) {\n              material.transparent = true;\n            }\n          }\n        };\n\n        for (var _i14 = 0, il = data.morphs.length; _i14 < il; _i14++) {\n          var morph = data.morphs[_i14];\n          var elements = morph.elements;\n\n          if (morph.type === 0) {\n            for (var j = 0, jl = elements.length; j < jl; j++) {\n              var morph2 = data.morphs[elements[j].index];\n              if (morph2.type !== 8) continue;\n              checkAlphaMorph(morph2.elements, materials);\n            }\n          } else if (morph.type === 8) {\n            checkAlphaMorph(elements, materials);\n          }\n        }\n      }\n\n      return materials;\n    },\n    // private methods\n    _getTGALoader: function _getTGALoader() {\n      if (this.tgaLoader === null) {\n        if (TGALoader === undefined) {\n          throw new Error('THREE.MMDLoader: Import TGALoader');\n        }\n\n        this.tgaLoader = new TGALoader(this.manager);\n      }\n\n      return this.tgaLoader;\n    },\n    _isDefaultToonTexture: function _isDefaultToonTexture(name) {\n      if (name.length !== 10) return false;\n      return /toon(10|0[0-9])\\.bmp/.test(name);\n    },\n    _loadTexture: function _loadTexture(filePath, textures, params, onProgress, onError) {\n      params = params || {};\n      var scope = this;\n      var fullPath;\n\n      if (params.isDefaultToonTexture === true) {\n        var index;\n\n        try {\n          index = parseInt(filePath.match(/toon([0-9]{2})\\.bmp$/)[1]);\n        } catch (e) {\n          console.warn('THREE.MMDLoader: ' + filePath + ' seems like a ' + 'not right default texture path. Using toon00.bmp instead.');\n          index = 0;\n        }\n\n        fullPath = DEFAULT_TOON_TEXTURES[index];\n      } else {\n        fullPath = this.resourcePath + filePath;\n      }\n\n      if (textures[fullPath] !== undefined) return textures[fullPath];\n      var loader = this.manager.getHandler(fullPath);\n\n      if (loader === null) {\n        loader = filePath.slice(-4).toLowerCase() === '.tga' ? this._getTGALoader() : this.textureLoader;\n      }\n\n      var texture = loader.load(fullPath, function (t) {\n        // MMD toon texture is Axis-Y oriented\n        // but Three.js gradient map is Axis-X oriented.\n        // So here replaces the toon texture image with the rotated one.\n        if (params.isToonTexture === true) {\n          t.image = scope._getRotatedImage(t.image);\n          t.magFilter = NearestFilter;\n          t.minFilter = NearestFilter;\n        }\n\n        t.flipY = false;\n        t.wrapS = RepeatWrapping;\n        t.wrapT = RepeatWrapping;\n\n        for (var i = 0; i < texture.readyCallbacks.length; i++) {\n          texture.readyCallbacks[i](texture);\n        }\n\n        delete texture.readyCallbacks;\n      }, onProgress, onError);\n      texture.readyCallbacks = [];\n      textures[fullPath] = texture;\n      return texture;\n    },\n    _getRotatedImage: function _getRotatedImage(image) {\n      var canvas = document.createElement('canvas');\n      var context = canvas.getContext('2d');\n      var width = image.width;\n      var height = image.height;\n      canvas.width = width;\n      canvas.height = height;\n      context.clearRect(0, 0, width, height);\n      context.translate(width / 2.0, height / 2.0);\n      context.rotate(0.5 * Math.PI); // 90.0 * Math.PI / 180.0\n\n      context.translate(-width / 2.0, -height / 2.0);\n      context.drawImage(image, 0, 0);\n      return context.getImageData(0, 0, width, height);\n    },\n    // Check if the partial image area used by the texture is transparent.\n    _checkImageTransparency: function _checkImageTransparency(map, geometry, groupIndex) {\n      map.readyCallbacks.push(function (texture) {\n        // Is there any efficient ways?\n        function createImageData(image) {\n          var canvas = document.createElement('canvas');\n          canvas.width = image.width;\n          canvas.height = image.height;\n          var context = canvas.getContext('2d');\n          context.drawImage(image, 0, 0);\n          return context.getImageData(0, 0, canvas.width, canvas.height);\n        }\n\n        function detectImageTransparency(image, uvs, indices) {\n          var width = image.width;\n          var height = image.height;\n          var data = image.data;\n          var threshold = 253;\n          if (data.length / (width * height) !== 4) return false;\n\n          for (var i = 0; i < indices.length; i += 3) {\n            var centerUV = {\n              x: 0.0,\n              y: 0.0\n            };\n\n            for (var j = 0; j < 3; j++) {\n              var index = indices[i * 3 + j];\n              var uv = {\n                x: uvs[index * 2 + 0],\n                y: uvs[index * 2 + 1]\n              };\n              if (getAlphaByUv(image, uv) < threshold) return true;\n              centerUV.x += uv.x;\n              centerUV.y += uv.y;\n            }\n\n            centerUV.x /= 3;\n            centerUV.y /= 3;\n            if (getAlphaByUv(image, centerUV) < threshold) return true;\n          }\n\n          return false;\n        }\n        /*\n         * This method expects\n         *   texture.flipY = false\n         *   texture.wrapS = RepeatWrapping\n         *   texture.wrapT = RepeatWrapping\n         * TODO: more precise\n         */\n\n\n        function getAlphaByUv(image, uv) {\n          var width = image.width;\n          var height = image.height;\n          var x = Math.round(uv.x * width) % width;\n          var y = Math.round(uv.y * height) % height;\n          if (x < 0) x += width;\n          if (y < 0) y += height;\n          var index = y * width + x;\n          return image.data[index * 4 + 3];\n        }\n\n        var imageData = texture.image.data !== undefined ? texture.image : createImageData(texture.image);\n        var group = geometry.groups[groupIndex];\n\n        if (detectImageTransparency(imageData, geometry.attributes.uv.array, geometry.index.array.slice(group.start, group.start + group.count))) {\n          map.transparent = true;\n        }\n      });\n    }\n  }; //\n\n  function AnimationBuilder() {}\n\n  AnimationBuilder.prototype = {\n    constructor: AnimationBuilder,\n\n    /**\n     * @param {Object} vmd - parsed VMD data\n     * @param {SkinnedMesh} mesh - tracks will be fitting to mesh\n     * @return {AnimationClip}\n     */\n    build: function build(vmd, mesh) {\n      // combine skeletal and morph animations\n      var tracks = this.buildSkeletalAnimation(vmd, mesh).tracks;\n      var tracks2 = this.buildMorphAnimation(vmd, mesh).tracks;\n\n      for (var i = 0, il = tracks2.length; i < il; i++) {\n        tracks.push(tracks2[i]);\n      }\n\n      return new AnimationClip('', -1, tracks);\n    },\n\n    /**\n     * @param {Object} vmd - parsed VMD data\n     * @param {SkinnedMesh} mesh - tracks will be fitting to mesh\n     * @return {AnimationClip}\n     */\n    buildSkeletalAnimation: function buildSkeletalAnimation(vmd, mesh) {\n      function pushInterpolation(array, interpolation, index) {\n        array.push(interpolation[index + 0] / 127); // x1\n\n        array.push(interpolation[index + 8] / 127); // x2\n\n        array.push(interpolation[index + 4] / 127); // y1\n\n        array.push(interpolation[index + 12] / 127); // y2\n      }\n\n      var tracks = [];\n      var motions = {};\n      var bones = mesh.skeleton.bones;\n      var boneNameDictionary = {};\n\n      for (var i = 0, il = bones.length; i < il; i++) {\n        boneNameDictionary[bones[i].name] = true;\n      }\n\n      for (var _i15 = 0; _i15 < vmd.metadata.motionCount; _i15++) {\n        var motion = vmd.motions[_i15];\n        var boneName = motion.boneName;\n        if (boneNameDictionary[boneName] === undefined) continue;\n        motions[boneName] = motions[boneName] || [];\n        motions[boneName].push(motion);\n      }\n\n      for (var key in motions) {\n        var array = motions[key];\n        array.sort(function (a, b) {\n          return a.frameNum - b.frameNum;\n        });\n        var times = [];\n        var positions = [];\n        var rotations = [];\n        var pInterpolations = [];\n        var rInterpolations = [];\n        var basePosition = mesh.skeleton.getBoneByName(key).position.toArray();\n\n        for (var _i16 = 0, _il = array.length; _i16 < _il; _i16++) {\n          var time = array[_i16].frameNum / 30;\n          var position = array[_i16].position;\n          var rotation = array[_i16].rotation;\n          var interpolation = array[_i16].interpolation;\n          times.push(time);\n\n          for (var j = 0; j < 3; j++) {\n            positions.push(basePosition[j] + position[j]);\n          }\n\n          for (var _j10 = 0; _j10 < 4; _j10++) {\n            rotations.push(rotation[_j10]);\n          }\n\n          for (var _j11 = 0; _j11 < 3; _j11++) {\n            pushInterpolation(pInterpolations, interpolation, _j11);\n          }\n\n          pushInterpolation(rInterpolations, interpolation, 3);\n        }\n\n        var targetName = '.bones[' + key + ']';\n        tracks.push(this._createTrack(targetName + '.position', VectorKeyframeTrack, times, positions, pInterpolations));\n        tracks.push(this._createTrack(targetName + '.quaternion', QuaternionKeyframeTrack, times, rotations, rInterpolations));\n      }\n\n      return new AnimationClip('', -1, tracks);\n    },\n\n    /**\n     * @param {Object} vmd - parsed VMD data\n     * @param {SkinnedMesh} mesh - tracks will be fitting to mesh\n     * @return {AnimationClip}\n     */\n    buildMorphAnimation: function buildMorphAnimation(vmd, mesh) {\n      var tracks = [];\n      var morphs = {};\n      var morphTargetDictionary = mesh.morphTargetDictionary;\n\n      for (var i = 0; i < vmd.metadata.morphCount; i++) {\n        var morph = vmd.morphs[i];\n        var morphName = morph.morphName;\n        if (morphTargetDictionary[morphName] === undefined) continue;\n        morphs[morphName] = morphs[morphName] || [];\n        morphs[morphName].push(morph);\n      }\n\n      for (var key in morphs) {\n        var array = morphs[key];\n        array.sort(function (a, b) {\n          return a.frameNum - b.frameNum;\n        });\n        var times = [];\n        var values = [];\n\n        for (var _i17 = 0, il = array.length; _i17 < il; _i17++) {\n          times.push(array[_i17].frameNum / 30);\n          values.push(array[_i17].weight);\n        }\n\n        tracks.push(new NumberKeyframeTrack('.morphTargetInfluences[' + morphTargetDictionary[key] + ']', times, values));\n      }\n\n      return new AnimationClip('', -1, tracks);\n    },\n\n    /**\n     * @param {Object} vmd - parsed VMD data\n     * @return {AnimationClip}\n     */\n    buildCameraAnimation: function buildCameraAnimation(vmd) {\n      function pushVector3(array, vec) {\n        array.push(vec.x);\n        array.push(vec.y);\n        array.push(vec.z);\n      }\n\n      function pushQuaternion(array, q) {\n        array.push(q.x);\n        array.push(q.y);\n        array.push(q.z);\n        array.push(q.w);\n      }\n\n      function pushInterpolation(array, interpolation, index) {\n        array.push(interpolation[index * 4 + 0] / 127); // x1\n\n        array.push(interpolation[index * 4 + 1] / 127); // x2\n\n        array.push(interpolation[index * 4 + 2] / 127); // y1\n\n        array.push(interpolation[index * 4 + 3] / 127); // y2\n      }\n\n      var tracks = [];\n      var cameras = vmd.cameras === undefined ? [] : vmd.cameras.slice();\n      cameras.sort(function (a, b) {\n        return a.frameNum - b.frameNum;\n      });\n      var times = [];\n      var centers = [];\n      var quaternions = [];\n      var positions = [];\n      var fovs = [];\n      var cInterpolations = [];\n      var qInterpolations = [];\n      var pInterpolations = [];\n      var fInterpolations = [];\n      var quaternion = new Quaternion();\n      var euler = new Euler();\n      var position = new Vector3();\n      var center = new Vector3();\n\n      for (var i = 0, il = cameras.length; i < il; i++) {\n        var motion = cameras[i];\n        var time = motion.frameNum / 30;\n        var pos = motion.position;\n        var rot = motion.rotation;\n        var distance = motion.distance;\n        var fov = motion.fov;\n        var interpolation = motion.interpolation;\n        times.push(time);\n        position.set(0, 0, -distance);\n        center.set(pos[0], pos[1], pos[2]);\n        euler.set(-rot[0], -rot[1], -rot[2]);\n        quaternion.setFromEuler(euler);\n        position.add(center);\n        position.applyQuaternion(quaternion);\n        pushVector3(centers, center);\n        pushQuaternion(quaternions, quaternion);\n        pushVector3(positions, position);\n        fovs.push(fov);\n\n        for (var j = 0; j < 3; j++) {\n          pushInterpolation(cInterpolations, interpolation, j);\n        }\n\n        pushInterpolation(qInterpolations, interpolation, 3); // use the same parameter for x, y, z axis.\n\n        for (var _j12 = 0; _j12 < 3; _j12++) {\n          pushInterpolation(pInterpolations, interpolation, 4);\n        }\n\n        pushInterpolation(fInterpolations, interpolation, 5);\n      }\n\n      var tracks = []; // I expect an object whose name 'target' exists under THREE.Camera\n\n      tracks.push(this._createTrack('target.position', VectorKeyframeTrack, times, centers, cInterpolations));\n      tracks.push(this._createTrack('.quaternion', QuaternionKeyframeTrack, times, quaternions, qInterpolations));\n      tracks.push(this._createTrack('.position', VectorKeyframeTrack, times, positions, pInterpolations));\n      tracks.push(this._createTrack('.fov', NumberKeyframeTrack, times, fovs, fInterpolations));\n      return new AnimationClip('', -1, tracks);\n    },\n    // private method\n    _createTrack: function _createTrack(node, typedKeyframeTrack, times, values, interpolations) {\n      /*\n       * optimizes here not to let KeyframeTrackPrototype optimize\n       * because KeyframeTrackPrototype optimizes times and values but\n       * doesn't optimize interpolations.\n       */\n      if (times.length > 2) {\n        times = times.slice();\n        values = values.slice();\n        interpolations = interpolations.slice();\n        var stride = values.length / times.length;\n        var interpolateStride = interpolations.length / times.length;\n        var index = 1;\n\n        for (var aheadIndex = 2, endIndex = times.length; aheadIndex < endIndex; aheadIndex++) {\n          for (var i = 0; i < stride; i++) {\n            if (values[index * stride + i] !== values[(index - 1) * stride + i] || values[index * stride + i] !== values[aheadIndex * stride + i]) {\n              index++;\n              break;\n            }\n          }\n\n          if (aheadIndex > index) {\n            times[index] = times[aheadIndex];\n\n            for (var _i18 = 0; _i18 < stride; _i18++) {\n              values[index * stride + _i18] = values[aheadIndex * stride + _i18];\n            }\n\n            for (var _i19 = 0; _i19 < interpolateStride; _i19++) {\n              interpolations[index * interpolateStride + _i19] = interpolations[aheadIndex * interpolateStride + _i19];\n            }\n          }\n        }\n\n        times.length = index + 1;\n        values.length = (index + 1) * stride;\n        interpolations.length = (index + 1) * interpolateStride;\n      }\n\n      var track = new typedKeyframeTrack(node, times, values);\n\n      track.createInterpolant = function InterpolantFactoryMethodCubicBezier(result) {\n        return new CubicBezierInterpolation(this.times, this.values, this.getValueSize(), result, new Float32Array(interpolations));\n      };\n\n      return track;\n    }\n  }; // interpolation\n\n  function CubicBezierInterpolation(parameterPositions, sampleValues, sampleSize, resultBuffer, params) {\n    Interpolant.call(this, parameterPositions, sampleValues, sampleSize, resultBuffer);\n    this.interpolationParams = params;\n  }\n\n  CubicBezierInterpolation.prototype = Object.assign(Object.create(Interpolant.prototype), {\n    constructor: CubicBezierInterpolation,\n    interpolate_: function interpolate_(i1, t0, t, t1) {\n      var result = this.resultBuffer;\n      var values = this.sampleValues;\n      var stride = this.valueSize;\n      var params = this.interpolationParams;\n      var offset1 = i1 * stride;\n      var offset0 = offset1 - stride; // No interpolation if next key frame is in one frame in 30fps.\n      // This is from MMD animation spec.\n      // '1.5' is for precision loss. times are Float32 in Three.js Animation system.\n\n      var weight1 = t1 - t0 < 1 / 30 * 1.5 ? 0.0 : (t - t0) / (t1 - t0);\n\n      if (stride === 4) {\n        // Quaternion\n        var x1 = params[i1 * 4 + 0];\n        var x2 = params[i1 * 4 + 1];\n        var y1 = params[i1 * 4 + 2];\n        var y2 = params[i1 * 4 + 3];\n\n        var ratio = this._calculate(x1, x2, y1, y2, weight1);\n\n        Quaternion.slerpFlat(result, 0, values, offset0, values, offset1, ratio);\n      } else if (stride === 3) {\n        // Vector3\n        for (var i = 0; i !== stride; ++i) {\n          var x1 = params[i1 * 12 + i * 4 + 0];\n          var x2 = params[i1 * 12 + i * 4 + 1];\n          var y1 = params[i1 * 12 + i * 4 + 2];\n          var y2 = params[i1 * 12 + i * 4 + 3];\n\n          var ratio = this._calculate(x1, x2, y1, y2, weight1);\n\n          result[i] = values[offset0 + i] * (1 - ratio) + values[offset1 + i] * ratio;\n        }\n      } else {\n        // Number\n        var x1 = params[i1 * 4 + 0];\n        var x2 = params[i1 * 4 + 1];\n        var y1 = params[i1 * 4 + 2];\n        var y2 = params[i1 * 4 + 3];\n\n        var ratio = this._calculate(x1, x2, y1, y2, weight1);\n\n        result[0] = values[offset0] * (1 - ratio) + values[offset1] * ratio;\n      }\n\n      return result;\n    },\n    _calculate: function _calculate(x1, x2, y1, y2, x) {\n      /*\n       * Cubic Bezier curves\n       *   https://en.wikipedia.org/wiki/B%C3%A9zier_curve#Cubic_B.C3.A9zier_curves\n       *\n       * B(t) = ( 1 - t ) ^ 3 * P0\n       *      + 3 * ( 1 - t ) ^ 2 * t * P1\n       *      + 3 * ( 1 - t ) * t^2 * P2\n       *      + t ^ 3 * P3\n       *      ( 0 <= t <= 1 )\n       *\n       * MMD uses Cubic Bezier curves for bone and camera animation interpolation.\n       *   http://d.hatena.ne.jp/edvakf/20111016/1318716097\n       *\n       *    x = ( 1 - t ) ^ 3 * x0\n       *      + 3 * ( 1 - t ) ^ 2 * t * x1\n       *      + 3 * ( 1 - t ) * t^2 * x2\n       *      + t ^ 3 * x3\n       *    y = ( 1 - t ) ^ 3 * y0\n       *      + 3 * ( 1 - t ) ^ 2 * t * y1\n       *      + 3 * ( 1 - t ) * t^2 * y2\n       *      + t ^ 3 * y3\n       *      ( x0 = 0, y0 = 0 )\n       *      ( x3 = 1, y3 = 1 )\n       *      ( 0 <= t, x1, x2, y1, y2 <= 1 )\n       *\n       * Here solves this equation with Bisection method,\n       *   https://en.wikipedia.org/wiki/Bisection_method\n       * gets t, and then calculate y.\n       *\n       * f(t) = 3 * ( 1 - t ) ^ 2 * t * x1\n       *      + 3 * ( 1 - t ) * t^2 * x2\n       *      + t ^ 3 - x = 0\n       *\n       * (Another option: Newton's method\n       *    https://en.wikipedia.org/wiki/Newton%27s_method)\n       */\n      var c = 0.5;\n      var t = c;\n      var s = 1.0 - t;\n      var loop = 15;\n      var eps = 1e-5;\n      var math = Math;\n      var sst3, stt3, ttt;\n\n      for (var i = 0; i < loop; i++) {\n        sst3 = 3.0 * s * s * t;\n        stt3 = 3.0 * s * t * t;\n        ttt = t * t * t;\n        var ft = sst3 * x1 + stt3 * x2 + ttt - x;\n        if (math.abs(ft) < eps) break;\n        c /= 2.0;\n        t += ft < 0 ? c : -c;\n        s = 1.0 - t;\n      }\n\n      return sst3 * y1 + stt3 * y2 + ttt;\n    }\n  });\n  return MMDLoader;\n}();\n\nexport { MMDLoader };","map":{"version":3,"sources":["/Projects/arrayftw/node_modules/three-stdlib/loaders/MMDLoader.js"],"names":["Loader","LoaderUtils","Interpolant","Quaternion","FileLoader","SkinnedMesh","Skeleton","Bone","Vector3","Float32BufferAttribute","BufferGeometry","Uint16BufferAttribute","TextureLoader","Color","CustomBlending","SrcAlphaFactor","OneMinusSrcAlphaFactor","DstAlphaFactor","DoubleSide","FrontSide","MultiplyOperation","AddOperation","MeshToonMaterial","NearestFilter","RepeatWrapping","AnimationClip","VectorKeyframeTrack","QuaternionKeyframeTrack","NumberKeyframeTrack","Euler","TGALoader","Parser","MMDLoader","manager","call","loader","parser","meshBuilder","MeshBuilder","animationBuilder","AnimationBuilder","prototype","Object","assign","create","constructor","setAnimationPath","animationPath","load","url","onLoad","onProgress","onError","builder","setCrossOrigin","crossOrigin","resourcePath","path","extractUrlBase","modelExtension","_extractExtension","toLowerCase","Error","data","build","loadAnimation","object","loadVMD","vmd","isCamera","buildCameraAnimation","loadWithAnimation","modelUrl","vmdUrl","scope","mesh","animation","loadPMD","_getParser","setMimeType","undefined","setPath","setResponseType","setRequestHeader","requestHeader","setWithCredentials","withCredentials","buffer","parsePmd","loadPMX","parsePmx","urls","Array","isArray","vmds","vmdNum","length","i","il","push","parseVmd","mergeVmds","loadVPD","isUnicode","text","parseVpd","index","lastIndexOf","slice","DEFAULT_TOON_TEXTURES","geometryBuilder","GeometryBuilder","materialBuilder","MaterialBuilder","geometry","material","setResourcePath","skeleton","initBones","bind","bones","bone","gbone","name","position","fromArray","pos","quaternion","rotq","scl","scale","parent","add","updateMatrixWorld","positions","uvs","normals","indices","groups","skinIndices","skinWeights","morphTargets","morphPositions","iks","grants","rigidBodies","constraints","offset","boneTypeTable","metadata","vertexCount","v","vertices","j","jl","normal","uv","faceCount","face","faces","materialCount","materials","count","rigidBodyCount","body","value","boneIndex","type","Math","max","boneCount","boneData","parentIndex","rigidBodyType","format","ikCount","ik","param","target","effector","iteration","maxAngle","links","link","enabled","indexOf","limitation","angleLimitation","rotationMin","lowerLimitationAngle","rotationMax","upperLimitationAngle","tmp1","tmp2","grant","ratio","isLocal","affectRotation","affectPosition","transformationClass","sort","a","b","updateAttributes","attribute","morph","elementCount","element","elements","morphs","array","morphCount","params","morph2","rigidBody","key","constraintCount","constraint","bodyA","rigidBodyIndex1","bodyB","rigidBodyIndex2","setAttribute","setIndex","addGroup","morphAttributes","morphTargetsRelative","userData","MMD","computeBoundingSphere","textureLoader","tgaLoader","textures","color","diffuse","opacity","emissive","ambient","transparent","skinning","fog","blending","blendSrc","blendDst","blendSrcAlpha","blendDstAlpha","flag","side","fileName","fileNames","split","map","_loadTexture","extension","envMap","combine","toonFileName","toonIndex","toonTextures","gradientMap","isToonTexture","isDefaultToonTexture","_isDefaultToonTexture","outlineParameters","thickness","edgeFlag","alpha","visible","textureIndex","envTextureIndex","envFlag","isDefaultToon","toonFlag","edgeSize","edgeColor","_checkImageTransparency","multiplyScalar","checkAlphaMorph","_getTGALoader","test","filePath","fullPath","parseInt","match","e","console","warn","getHandler","texture","t","image","_getRotatedImage","magFilter","minFilter","flipY","wrapS","wrapT","readyCallbacks","canvas","document","createElement","context","getContext","width","height","clearRect","translate","rotate","PI","drawImage","getImageData","groupIndex","createImageData","detectImageTransparency","threshold","centerUV","x","y","getAlphaByUv","round","imageData","group","attributes","start","tracks","buildSkeletalAnimation","tracks2","buildMorphAnimation","pushInterpolation","interpolation","motions","boneNameDictionary","motionCount","motion","boneName","frameNum","times","rotations","pInterpolations","rInterpolations","basePosition","getBoneByName","toArray","time","rotation","targetName","_createTrack","morphTargetDictionary","morphName","values","weight","pushVector3","vec","z","pushQuaternion","q","w","cameras","centers","quaternions","fovs","cInterpolations","qInterpolations","fInterpolations","euler","center","rot","distance","fov","set","setFromEuler","applyQuaternion","node","typedKeyframeTrack","interpolations","stride","interpolateStride","aheadIndex","endIndex","track","createInterpolant","InterpolantFactoryMethodCubicBezier","result","CubicBezierInterpolation","getValueSize","Float32Array","parameterPositions","sampleValues","sampleSize","resultBuffer","interpolationParams","interpolate_","i1","t0","t1","valueSize","offset1","offset0","weight1","x1","x2","y1","y2","_calculate","slerpFlat","c","s","loop","eps","math","sst3","stt3","ttt","ft","abs"],"mappings":"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","sourcesContent":["import { Loader, LoaderUtils, Interpolant, Quaternion, FileLoader, SkinnedMesh, Skeleton, Bone, Vector3, Float32BufferAttribute, BufferGeometry, Uint16BufferAttribute, TextureLoader, Color, CustomBlending, SrcAlphaFactor, OneMinusSrcAlphaFactor, DstAlphaFactor, DoubleSide, FrontSide, MultiplyOperation, AddOperation, MeshToonMaterial, NearestFilter, RepeatWrapping, AnimationClip, VectorKeyframeTrack, QuaternionKeyframeTrack, NumberKeyframeTrack, Euler } from 'three';\nimport { TGALoader } from './TGALoader.js';\nimport { Parser } from 'mmd-parser';\n\n/**\n * Dependencies\n *  - mmd-parser https://github.com/takahirox/mmd-parser\n *  - TGALoader\n *  - OutlineEffect\n *\n * MMDLoader creates Three.js Objects from MMD resources as\n * PMD, PMX, VMD, and VPD files.\n *\n * PMD/PMX is a model data format, VMD is a motion data format\n * VPD is a posing data format used in MMD(Miku Miku Dance).\n *\n * MMD official site\n *  - https://sites.google.com/view/evpvp/\n *\n * PMD, VMD format (in Japanese)\n *  - http://blog.goo.ne.jp/torisu_tetosuki/e/209ad341d3ece2b1b4df24abf619d6e4\n *\n * PMX format\n *  - https://gist.github.com/felixjones/f8a06bd48f9da9a4539f\n *\n * TODO\n *  - light motion in vmd support.\n *  - SDEF support.\n *  - uv/material/bone morphing support.\n *  - more precise grant skinning support.\n *  - shadow support.\n */\n\nvar MMDLoader = function () {\n  /**\n   * @param {THREE.LoadingManager} manager\n   */\n  function MMDLoader(manager) {\n    Loader.call(this, manager);\n    this.loader = new FileLoader(this.manager);\n    this.parser = null; // lazy generation\n\n    this.meshBuilder = new MeshBuilder(this.manager);\n    this.animationBuilder = new AnimationBuilder();\n  }\n\n  MMDLoader.prototype = Object.assign(Object.create(Loader.prototype), {\n    constructor: MMDLoader,\n\n    /**\n     * @param {string} animationPath\n     * @return {MMDLoader}\n     */\n    setAnimationPath: function (animationPath) {\n      this.animationPath = animationPath;\n      return this;\n    },\n    // Load MMD assets as Three.js Object\n\n    /**\n     * Loads Model file (.pmd or .pmx) as a SkinnedMesh.\n     *\n     * @param {string} url - url to Model(.pmd or .pmx) file\n     * @param {function} onLoad\n     * @param {function} onProgress\n     * @param {function} onError\n     */\n    load: function (url, onLoad, onProgress, onError) {\n      var builder = this.meshBuilder.setCrossOrigin(this.crossOrigin); // resource path\n\n      var resourcePath;\n\n      if (this.resourcePath !== '') {\n        resourcePath = this.resourcePath;\n      } else if (this.path !== '') {\n        resourcePath = this.path;\n      } else {\n        resourcePath = LoaderUtils.extractUrlBase(url);\n      }\n\n      var modelExtension = this._extractExtension(url).toLowerCase(); // Should I detect by seeing header?\n\n\n      if (modelExtension !== 'pmd' && modelExtension !== 'pmx') {\n        if (onError) onError(new Error('THREE.MMDLoader: Unknown model file extension .' + modelExtension + '.'));\n        return;\n      }\n\n      this[modelExtension === 'pmd' ? 'loadPMD' : 'loadPMX'](url, function (data) {\n        onLoad(builder.build(data, resourcePath, onProgress, onError));\n      }, onProgress, onError);\n    },\n\n    /**\n     * Loads Motion file(s) (.vmd) as a AnimationClip.\n     * If two or more files are specified, they'll be merged.\n     *\n     * @param {string|Array<string>} url - url(s) to animation(.vmd) file(s)\n     * @param {SkinnedMesh|THREE.Camera} object - tracks will be fitting to this object\n     * @param {function} onLoad\n     * @param {function} onProgress\n     * @param {function} onError\n     */\n    loadAnimation: function (url, object, onLoad, onProgress, onError) {\n      var builder = this.animationBuilder;\n      this.loadVMD(url, function (vmd) {\n        onLoad(object.isCamera ? builder.buildCameraAnimation(vmd) : builder.build(vmd, object));\n      }, onProgress, onError);\n    },\n\n    /**\n     * Loads mode file and motion file(s) as an object containing\n     * a SkinnedMesh and a AnimationClip.\n     * Tracks of AnimationClip are fitting to the model.\n     *\n     * @param {string} modelUrl - url to Model(.pmd or .pmx) file\n     * @param {string|Array{string}} vmdUrl - url(s) to animation(.vmd) file\n     * @param {function} onLoad\n     * @param {function} onProgress\n     * @param {function} onError\n     */\n    loadWithAnimation: function (modelUrl, vmdUrl, onLoad, onProgress, onError) {\n      var scope = this;\n      this.load(modelUrl, function (mesh) {\n        scope.loadAnimation(vmdUrl, mesh, function (animation) {\n          onLoad({\n            mesh: mesh,\n            animation: animation\n          });\n        }, onProgress, onError);\n      }, onProgress, onError);\n    },\n    // Load MMD assets as Object data parsed by MMDParser\n\n    /**\n     * Loads .pmd file as an Object.\n     *\n     * @param {string} url - url to .pmd file\n     * @param {function} onLoad\n     * @param {function} onProgress\n     * @param {function} onError\n     */\n    loadPMD: function (url, onLoad, onProgress, onError) {\n      var parser = this._getParser();\n\n      this.loader.setMimeType(undefined).setPath(this.path).setResponseType('arraybuffer').setRequestHeader(this.requestHeader).setWithCredentials(this.withCredentials).load(url, function (buffer) {\n        onLoad(parser.parsePmd(buffer, true));\n      }, onProgress, onError);\n    },\n\n    /**\n     * Loads .pmx file as an Object.\n     *\n     * @param {string} url - url to .pmx file\n     * @param {function} onLoad\n     * @param {function} onProgress\n     * @param {function} onError\n     */\n    loadPMX: function (url, onLoad, onProgress, onError) {\n      var parser = this._getParser();\n\n      this.loader.setMimeType(undefined).setPath(this.path).setResponseType('arraybuffer').setRequestHeader(this.requestHeader).setWithCredentials(this.withCredentials).load(url, function (buffer) {\n        onLoad(parser.parsePmx(buffer, true));\n      }, onProgress, onError);\n    },\n\n    /**\n     * Loads .vmd file as an Object. If two or more files are specified\n     * they'll be merged.\n     *\n     * @param {string|Array<string>} url - url(s) to .vmd file(s)\n     * @param {function} onLoad\n     * @param {function} onProgress\n     * @param {function} onError\n     */\n    loadVMD: function (url, onLoad, onProgress, onError) {\n      var urls = Array.isArray(url) ? url : [url];\n      var vmds = [];\n      var vmdNum = urls.length;\n\n      var parser = this._getParser();\n\n      this.loader.setMimeType(undefined).setPath(this.animationPath).setResponseType('arraybuffer').setRequestHeader(this.requestHeader).setWithCredentials(this.withCredentials);\n\n      for (let i = 0, il = urls.length; i < il; i++) {\n        this.loader.load(urls[i], function (buffer) {\n          vmds.push(parser.parseVmd(buffer, true));\n          if (vmds.length === vmdNum) onLoad(parser.mergeVmds(vmds));\n        }, onProgress, onError);\n      }\n    },\n\n    /**\n     * Loads .vpd file as an Object.\n     *\n     * @param {string} url - url to .vpd file\n     * @param {boolean} isUnicode\n     * @param {function} onLoad\n     * @param {function} onProgress\n     * @param {function} onError\n     */\n    loadVPD: function (url, isUnicode, onLoad, onProgress, onError) {\n      var parser = this._getParser();\n\n      this.loader.setMimeType(isUnicode ? undefined : 'text/plain; charset=shift_jis').setPath(this.animationPath).setResponseType('text').setRequestHeader(this.requestHeader).setWithCredentials(this.withCredentials).load(url, function (text) {\n        onLoad(parser.parseVpd(text, true));\n      }, onProgress, onError);\n    },\n    // private methods\n    _extractExtension: function (url) {\n      var index = url.lastIndexOf('.');\n      return index < 0 ? '' : url.slice(index + 1);\n    },\n    _getParser: function () {\n      if (this.parser === null) {\n        this.parser = new Parser(); // eslint-disable-line no-undef\n      }\n\n      return this.parser;\n    }\n  }); // Utilities\n\n  /*\n   * base64 encoded defalut toon textures toon00.bmp - toon10.bmp.\n   * We don't need to request external toon image files.\n   * This idea is from http://www20.atpages.jp/katwat/three.js_r58/examples/mytest37/mmd.three.js\n   */\n\n  var DEFAULT_TOON_TEXTURES = ['data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAL0lEQVRYR+3QQREAAAzCsOFfNJPBJ1XQS9r2hsUAAQIECBAgQIAAAQIECBAgsBZ4MUx/ofm2I/kAAAAASUVORK5CYII=', 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAN0lEQVRYR+3WQREAMBACsZ5/bWiiMvgEBTt5cW37hjsBBAgQIECAwFwgyfYPCCBAgAABAgTWAh8aBHZBl14e8wAAAABJRU5ErkJggg==', 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAOUlEQVRYR+3WMREAMAwDsYY/yoDI7MLwIiP40+RJklfcCCBAgAABAgTqArfb/QMCCBAgQIAAgbbAB3z/e0F3js2cAAAAAElFTkSuQmCC', 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAN0lEQVRYR+3WQREAMBACsZ5/B5ilMvgEBTt5cW37hjsBBAgQIECAwFwgyfYPCCBAgAABAgTWAh81dWyx0gFwKAAAAABJRU5ErkJggg==', 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAOklEQVRYR+3WoREAMAwDsWb/UQtCy9wxTOQJ/oQ8SXKKGwEECBAgQIBAXeDt7f4BAQQIECBAgEBb4AOz8Hzx7WLY4wAAAABJRU5ErkJggg==', 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABPUlEQVRYR+1XwW7CMAy1+f9fZOMysSEOEweEOPRNdm3HbdOyIhAcklPrOs/PLy9RygBALxzcCDQFmgJNgaZAU6Ap0BR4PwX8gsRMVLssMRH5HcpzJEaWL7EVg9F1IHRlyqQohgVr4FGUlUcMJSjcUlDw0zvjeun70cLWmneoyf7NgBTQSniBTQQSuJAZsOnnaczjIMb5hCiuHKxokCrJfVnrctyZL0PkJAJe1HMil4nxeyi3Ypfn1kX51jpPvo/JeCNC4PhVdHdJw2XjBR8brF8PEIhNVn12AgP7uHsTBguBn53MUZCqv7Lp07Pn5k1Ro+uWmUNn7D+M57rtk7aG0Vo73xyF/fbFf0bPJjDXngnGocDTdFhygZjwUQrMNrDcmZlQT50VJ/g/UwNyHpu778+yW+/ksOz/BFo54P4AsUXMfRq7XWsAAAAASUVORK5CYII=', 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAACMElEQVRYR+2Xv4pTQRTGf2dubhLdICiii2KnYKHVolhauKWPoGAnNr6BD6CvIVaihYuI2i1ia0BY0MZGRHQXjZj/mSPnnskfNWiWZUlzJ5k7M2cm833nO5Mziej2DWWJRUoCpQKlAntSQCqgw39/iUWAGmh37jrRnVsKlgpiqmkoGVABA7E57fvY+pJDdgKqF6HzFCSADkDq+F6AHABtQ+UMVE5D7zXod7fFNhTEckTbj5XQgHzNN+5tQvc5NG7C6BNkp6D3EmpXHDR+dQAjFLchW3VS9rlw3JBh+B7ys5Cf9z0GW1C/7P32AyBAOAz1q4jGliIH3YPuBnSfQX4OGreTIgEYQb/pBDtPnEQ4CivXYPAWBk13oHrB54yA9QuSn2H4AcKRpEILDt0BUzj+RLR1V5EqjD66NPRBVpLcQwjHoHYJOhsQv6U4mnzmrIXJCFr4LDwm/xBUoboG9XX4cc9VKdYoSA2yk5NQLJaKDUjTBoveG3Z2TElTxwjNK4M3LEZgUdDdruvcXzKBpStgp2NPiWi3ks9ZXxIoFVi+AvHLdc9TqtjL3/aYjpPlrzOcEnK62Szhimdd7xX232zFDTgtxezOu3WNMRLjiKgjtOhHVMd1loynVHvOgjuIIJMaELEqhJAV/RCSLbWTcfPFakFgFlALTRRvx+ok6Hlp/Q+v3fmx90bMyUzaEAhmM3KvHlXTL5DxnbGf/1M8RNNACLL5MNtPxP/mypJAqcDSFfgFhpYqWUzhTEAAAAAASUVORK5CYII=', 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAL0lEQVRYR+3QQREAAAzCsOFfNJPBJ1XQS9r2hsUAAQIECBAgQIAAAQIECBAgsBZ4MUx/ofm2I/kAAAAASUVORK5CYII=', 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAL0lEQVRYR+3QQREAAAzCsOFfNJPBJ1XQS9r2hsUAAQIECBAgQIAAAQIECBAgsBZ4MUx/ofm2I/kAAAAASUVORK5CYII=', 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAL0lEQVRYR+3QQREAAAzCsOFfNJPBJ1XQS9r2hsUAAQIECBAgQIAAAQIECBAgsBZ4MUx/ofm2I/kAAAAASUVORK5CYII=', 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAL0lEQVRYR+3QQREAAAzCsOFfNJPBJ1XQS9r2hsUAAQIECBAgQIAAAQIECBAgsBZ4MUx/ofm2I/kAAAAASUVORK5CYII=']; // Builders. They build Three.js object from Object data parsed by MMDParser.\n\n  /**\n   * @param {THREE.LoadingManager} manager\n   */\n\n  function MeshBuilder(manager) {\n    this.geometryBuilder = new GeometryBuilder();\n    this.materialBuilder = new MaterialBuilder(manager);\n  }\n\n  MeshBuilder.prototype = {\n    constructor: MeshBuilder,\n    crossOrigin: 'anonymous',\n\n    /**\n     * @param {string} crossOrigin\n     * @return {MeshBuilder}\n     */\n    setCrossOrigin: function (crossOrigin) {\n      this.crossOrigin = crossOrigin;\n      return this;\n    },\n\n    /**\n     * @param {Object} data - parsed PMD/PMX data\n     * @param {string} resourcePath\n     * @param {function} onProgress\n     * @param {function} onError\n     * @return {SkinnedMesh}\n     */\n    build: function (data, resourcePath, onProgress, onError) {\n      var geometry = this.geometryBuilder.build(data);\n      var material = this.materialBuilder.setCrossOrigin(this.crossOrigin).setResourcePath(resourcePath).build(data, geometry, onProgress, onError);\n      var mesh = new SkinnedMesh(geometry, material);\n      var skeleton = new Skeleton(initBones(mesh));\n      mesh.bind(skeleton); // console.log( mesh ); // for console debug\n\n      return mesh;\n    }\n  }; // TODO: Try to remove this function\n\n  function initBones(mesh) {\n    var geometry = mesh.geometry;\n    var bones = [],\n        bone,\n        gbone;\n    var i, il;\n\n    if (geometry && geometry.bones !== undefined) {\n      // first, create array of 'Bone' objects from geometry data\n      for (i = 0, il = geometry.bones.length; i < il; i++) {\n        gbone = geometry.bones[i]; // create new 'Bone' object\n\n        bone = new Bone();\n        bones.push(bone); // apply values\n\n        bone.name = gbone.name;\n        bone.position.fromArray(gbone.pos);\n        bone.quaternion.fromArray(gbone.rotq);\n        if (gbone.scl !== undefined) bone.scale.fromArray(gbone.scl);\n      } // second, create bone hierarchy\n\n\n      for (i = 0, il = geometry.bones.length; i < il; i++) {\n        gbone = geometry.bones[i];\n\n        if (gbone.parent !== -1 && gbone.parent !== null && bones[gbone.parent] !== undefined) {\n          // subsequent bones in the hierarchy\n          bones[gbone.parent].add(bones[i]);\n        } else {\n          // topmost bone, immediate child of the skinned mesh\n          mesh.add(bones[i]);\n        }\n      }\n    } // now the bones are part of the scene graph and children of the skinned mesh.\n    // let's update the corresponding matrices\n\n\n    mesh.updateMatrixWorld(true);\n    return bones;\n  } //\n\n\n  function GeometryBuilder() {}\n\n  GeometryBuilder.prototype = {\n    constructor: GeometryBuilder,\n\n    /**\n     * @param {Object} data - parsed PMD/PMX data\n     * @return {BufferGeometry}\n     */\n    build: function (data) {\n      // for geometry\n      var positions = [];\n      var uvs = [];\n      var normals = [];\n      var indices = [];\n      var groups = [];\n      var bones = [];\n      var skinIndices = [];\n      var skinWeights = [];\n      var morphTargets = [];\n      var morphPositions = [];\n      var iks = [];\n      var grants = [];\n      var rigidBodies = [];\n      var constraints = []; // for work\n\n      var offset = 0;\n      var boneTypeTable = {}; // positions, normals, uvs, skinIndices, skinWeights\n\n      for (let i = 0; i < data.metadata.vertexCount; i++) {\n        var v = data.vertices[i];\n\n        for (let j = 0, jl = v.position.length; j < jl; j++) {\n          positions.push(v.position[j]);\n        }\n\n        for (let j = 0, jl = v.normal.length; j < jl; j++) {\n          normals.push(v.normal[j]);\n        }\n\n        for (let j = 0, jl = v.uv.length; j < jl; j++) {\n          uvs.push(v.uv[j]);\n        }\n\n        for (let j = 0; j < 4; j++) {\n          skinIndices.push(v.skinIndices.length - 1 >= j ? v.skinIndices[j] : 0.0);\n        }\n\n        for (let j = 0; j < 4; j++) {\n          skinWeights.push(v.skinWeights.length - 1 >= j ? v.skinWeights[j] : 0.0);\n        }\n      } // indices\n\n\n      for (let i = 0; i < data.metadata.faceCount; i++) {\n        var face = data.faces[i];\n\n        for (let j = 0, jl = face.indices.length; j < jl; j++) {\n          indices.push(face.indices[j]);\n        }\n      } // groups\n\n\n      for (let i = 0; i < data.metadata.materialCount; i++) {\n        var material = data.materials[i];\n        groups.push({\n          offset: offset * 3,\n          count: material.faceCount * 3\n        });\n        offset += material.faceCount;\n      } // bones\n\n\n      for (let i = 0; i < data.metadata.rigidBodyCount; i++) {\n        var body = data.rigidBodies[i];\n        var value = boneTypeTable[body.boneIndex]; // keeps greater number if already value is set without any special reasons\n\n        value = value === undefined ? body.type : Math.max(body.type, value);\n        boneTypeTable[body.boneIndex] = value;\n      }\n\n      for (let i = 0; i < data.metadata.boneCount; i++) {\n        var boneData = data.bones[i];\n        var bone = {\n          parent: boneData.parentIndex,\n          name: boneData.name,\n          pos: boneData.position.slice(0, 3),\n          rotq: [0, 0, 0, 1],\n          scl: [1, 1, 1],\n          rigidBodyType: boneTypeTable[i] !== undefined ? boneTypeTable[i] : -1\n        };\n\n        if (bone.parent !== -1) {\n          bone.pos[0] -= data.bones[bone.parent].position[0];\n          bone.pos[1] -= data.bones[bone.parent].position[1];\n          bone.pos[2] -= data.bones[bone.parent].position[2];\n        }\n\n        bones.push(bone);\n      } // iks\n      // TODO: remove duplicated codes between PMD and PMX\n\n\n      if (data.metadata.format === 'pmd') {\n        for (let i = 0; i < data.metadata.ikCount; i++) {\n          var ik = data.iks[i];\n          var param = {\n            target: ik.target,\n            effector: ik.effector,\n            iteration: ik.iteration,\n            maxAngle: ik.maxAngle * 4,\n            links: []\n          };\n\n          for (let j = 0, jl = ik.links.length; j < jl; j++) {\n            var link = {};\n            link.index = ik.links[j].index;\n            link.enabled = true;\n\n            if (data.bones[link.index].name.indexOf('ひざ') >= 0) {\n              link.limitation = new Vector3(1.0, 0.0, 0.0);\n            }\n\n            param.links.push(link);\n          }\n\n          iks.push(param);\n        }\n      } else {\n        for (let i = 0; i < data.metadata.boneCount; i++) {\n          var ik = data.bones[i].ik;\n          if (ik === undefined) continue;\n          var param = {\n            target: i,\n            effector: ik.effector,\n            iteration: ik.iteration,\n            maxAngle: ik.maxAngle,\n            links: []\n          };\n\n          for (let j = 0, jl = ik.links.length; j < jl; j++) {\n            var link = {};\n            link.index = ik.links[j].index;\n            link.enabled = true;\n\n            if (ik.links[j].angleLimitation === 1) {\n              // Revert if rotationMin/Max doesn't work well\n              // link.limitation = new Vector3( 1.0, 0.0, 0.0 );\n              var rotationMin = ik.links[j].lowerLimitationAngle;\n              var rotationMax = ik.links[j].upperLimitationAngle; // Convert Left to Right coordinate by myself because\n              // MMDParser doesn't convert. It's a MMDParser's bug\n\n              var tmp1 = -rotationMax[0];\n              var tmp2 = -rotationMax[1];\n              rotationMax[0] = -rotationMin[0];\n              rotationMax[1] = -rotationMin[1];\n              rotationMin[0] = tmp1;\n              rotationMin[1] = tmp2;\n              link.rotationMin = new Vector3().fromArray(rotationMin);\n              link.rotationMax = new Vector3().fromArray(rotationMax);\n            }\n\n            param.links.push(link);\n          }\n\n          iks.push(param);\n        }\n      } // grants\n\n\n      if (data.metadata.format === 'pmx') {\n        for (let i = 0; i < data.metadata.boneCount; i++) {\n          var boneData = data.bones[i];\n          var grant = boneData.grant;\n          if (grant === undefined) continue;\n          var param = {\n            index: i,\n            parentIndex: grant.parentIndex,\n            ratio: grant.ratio,\n            isLocal: grant.isLocal,\n            affectRotation: grant.affectRotation,\n            affectPosition: grant.affectPosition,\n            transformationClass: boneData.transformationClass\n          };\n          grants.push(param);\n        }\n\n        grants.sort(function (a, b) {\n          return a.transformationClass - b.transformationClass;\n        });\n      } // morph\n\n\n      function updateAttributes(attribute, morph, ratio) {\n        for (let i = 0; i < morph.elementCount; i++) {\n          var element = morph.elements[i];\n          var index;\n\n          if (data.metadata.format === 'pmd') {\n            index = data.morphs[0].elements[element.index].index;\n          } else {\n            index = element.index;\n          }\n\n          attribute.array[index * 3 + 0] += element.position[0] * ratio;\n          attribute.array[index * 3 + 1] += element.position[1] * ratio;\n          attribute.array[index * 3 + 2] += element.position[2] * ratio;\n        }\n      }\n\n      for (let i = 0; i < data.metadata.morphCount; i++) {\n        var morph = data.morphs[i];\n        var params = {\n          name: morph.name\n        };\n        var attribute = new Float32BufferAttribute(data.metadata.vertexCount * 3, 3);\n        attribute.name = morph.name;\n\n        for (let j = 0; j < data.metadata.vertexCount * 3; j++) {\n          attribute.array[j] = positions[j];\n        }\n\n        if (data.metadata.format === 'pmd') {\n          if (i !== 0) {\n            updateAttributes(attribute, morph, 1.0);\n          }\n        } else {\n          if (morph.type === 0) {\n            // group\n            for (let j = 0; j < morph.elementCount; j++) {\n              var morph2 = data.morphs[morph.elements[j].index];\n              var ratio = morph.elements[j].ratio;\n\n              if (morph2.type === 1) {\n                updateAttributes(attribute, morph2, ratio);\n              }\n            }\n          } else if (morph.type === 1) {\n            // vertex\n            updateAttributes(attribute, morph, 1.0);\n          } else if (morph.type === 2) ; else if (morph.type === 3) ; else if (morph.type === 4) ; else if (morph.type === 5) ; else if (morph.type === 6) ; else if (morph.type === 7) ; else if (morph.type === 8) ;\n        }\n\n        morphTargets.push(params);\n        morphPositions.push(attribute);\n      } // rigid bodies from rigidBodies field.\n\n\n      for (let i = 0; i < data.metadata.rigidBodyCount; i++) {\n        var rigidBody = data.rigidBodies[i];\n        var params = {};\n\n        for (let key in rigidBody) {\n          params[key] = rigidBody[key];\n        }\n        /*\n         * RigidBody position parameter in PMX seems global position\n         * while the one in PMD seems offset from corresponding bone.\n         * So unify being offset.\n         */\n\n\n        if (data.metadata.format === 'pmx') {\n          if (params.boneIndex !== -1) {\n            var bone = data.bones[params.boneIndex];\n            params.position[0] -= bone.position[0];\n            params.position[1] -= bone.position[1];\n            params.position[2] -= bone.position[2];\n          }\n        }\n\n        rigidBodies.push(params);\n      } // constraints from constraints field.\n\n\n      for (let i = 0; i < data.metadata.constraintCount; i++) {\n        var constraint = data.constraints[i];\n        var params = {};\n\n        for (let key in constraint) {\n          params[key] = constraint[key];\n        }\n\n        var bodyA = rigidBodies[params.rigidBodyIndex1];\n        var bodyB = rigidBodies[params.rigidBodyIndex2]; // Refer to http://www20.atpages.jp/katwat/wp/?p=4135\n\n        if (bodyA.type !== 0 && bodyB.type === 2) {\n          if (bodyA.boneIndex !== -1 && bodyB.boneIndex !== -1 && data.bones[bodyB.boneIndex].parentIndex === bodyA.boneIndex) {\n            bodyB.type = 1;\n          }\n        }\n\n        constraints.push(params);\n      } // build BufferGeometry.\n\n\n      var geometry = new BufferGeometry();\n      geometry.setAttribute('position', new Float32BufferAttribute(positions, 3));\n      geometry.setAttribute('normal', new Float32BufferAttribute(normals, 3));\n      geometry.setAttribute('uv', new Float32BufferAttribute(uvs, 2));\n      geometry.setAttribute('skinIndex', new Uint16BufferAttribute(skinIndices, 4));\n      geometry.setAttribute('skinWeight', new Float32BufferAttribute(skinWeights, 4));\n      geometry.setIndex(indices);\n\n      for (let i = 0, il = groups.length; i < il; i++) {\n        geometry.addGroup(groups[i].offset, groups[i].count, i);\n      }\n\n      geometry.bones = bones;\n      geometry.morphTargets = morphTargets;\n      geometry.morphAttributes.position = morphPositions;\n      geometry.morphTargetsRelative = false;\n      geometry.userData.MMD = {\n        bones: bones,\n        iks: iks,\n        grants: grants,\n        rigidBodies: rigidBodies,\n        constraints: constraints,\n        format: data.metadata.format\n      };\n      geometry.computeBoundingSphere();\n      return geometry;\n    }\n  }; //\n\n  /**\n   * @param {THREE.LoadingManager} manager\n   */\n\n  function MaterialBuilder(manager) {\n    this.manager = manager;\n    this.textureLoader = new TextureLoader(this.manager);\n    this.tgaLoader = null; // lazy generation\n  }\n\n  MaterialBuilder.prototype = {\n    constructor: MaterialBuilder,\n    crossOrigin: 'anonymous',\n    resourcePath: undefined,\n\n    /**\n     * @param {string} crossOrigin\n     * @return {MaterialBuilder}\n     */\n    setCrossOrigin: function (crossOrigin) {\n      this.crossOrigin = crossOrigin;\n      return this;\n    },\n\n    /**\n     * @param {string} resourcePath\n     * @return {MaterialBuilder}\n     */\n    setResourcePath: function (resourcePath) {\n      this.resourcePath = resourcePath;\n      return this;\n    },\n\n    /**\n     * @param {Object} data - parsed PMD/PMX data\n     * @param {BufferGeometry} geometry - some properties are dependend on geometry\n     * @param {function} onProgress\n     * @param {function} onError\n     * @return {Array<MeshToonMaterial>}\n     */\n    build: function (data, geometry\n    /*, onProgress, onError */\n    ) {\n      var materials = [];\n      var textures = {};\n      this.textureLoader.setCrossOrigin(this.crossOrigin); // materials\n\n      for (let i = 0; i < data.metadata.materialCount; i++) {\n        var material = data.materials[i];\n        var params = {\n          userData: {}\n        };\n        if (material.name !== undefined) params.name = material.name;\n        /*\n         * Color\n         *\n         * MMD         MeshToonMaterial\n         * diffuse  -  color\n         * ambient  -  emissive * a\n         *               (a = 1.0 without map texture or 0.2 with map texture)\n         *\n         * MeshToonMaterial doesn't have ambient. Set it to emissive instead.\n         * It'll be too bright if material has map texture so using coef 0.2.\n         */\n\n        params.color = new Color().fromArray(material.diffuse);\n        params.opacity = material.diffuse[3];\n        params.emissive = new Color().fromArray(material.ambient);\n        params.transparent = params.opacity !== 1.0; //\n\n        params.skinning = geometry.bones.length > 0 ? true : false;\n        params.morphTargets = geometry.morphTargets.length > 0 ? true : false;\n        params.fog = true; // blend\n\n        params.blending = CustomBlending;\n        params.blendSrc = SrcAlphaFactor;\n        params.blendDst = OneMinusSrcAlphaFactor;\n        params.blendSrcAlpha = SrcAlphaFactor;\n        params.blendDstAlpha = DstAlphaFactor; // side\n\n        if (data.metadata.format === 'pmx' && (material.flag & 0x1) === 1) {\n          params.side = DoubleSide;\n        } else {\n          params.side = params.opacity === 1.0 ? FrontSide : DoubleSide;\n        }\n\n        if (data.metadata.format === 'pmd') {\n          // map, envMap\n          if (material.fileName) {\n            var fileName = material.fileName;\n            var fileNames = fileName.split('*'); // fileNames[ 0 ]: mapFileName\n            // fileNames[ 1 ]: envMapFileName( optional )\n\n            params.map = this._loadTexture(fileNames[0], textures);\n\n            if (fileNames.length > 1) {\n              var extension = fileNames[1].slice(-4).toLowerCase();\n              params.envMap = this._loadTexture(fileNames[1], textures);\n              params.combine = extension === '.sph' ? MultiplyOperation : AddOperation;\n            }\n          } // gradientMap\n\n\n          var toonFileName = material.toonIndex === -1 ? 'toon00.bmp' : data.toonTextures[material.toonIndex].fileName;\n          params.gradientMap = this._loadTexture(toonFileName, textures, {\n            isToonTexture: true,\n            isDefaultToonTexture: this._isDefaultToonTexture(toonFileName)\n          }); // parameters for OutlineEffect\n\n          params.userData.outlineParameters = {\n            thickness: material.edgeFlag === 1 ? 0.003 : 0.0,\n            color: [0, 0, 0],\n            alpha: 1.0,\n            visible: material.edgeFlag === 1\n          };\n        } else {\n          // map\n          if (material.textureIndex !== -1) {\n            params.map = this._loadTexture(data.textures[material.textureIndex], textures);\n          } // envMap TODO: support m.envFlag === 3\n\n\n          if (material.envTextureIndex !== -1 && (material.envFlag === 1 || material.envFlag == 2)) {\n            params.envMap = this._loadTexture(data.textures[material.envTextureIndex], textures);\n            params.combine = material.envFlag === 1 ? MultiplyOperation : AddOperation;\n          } // gradientMap\n\n\n          var toonFileName, isDefaultToon;\n\n          if (material.toonIndex === -1 || material.toonFlag !== 0) {\n            toonFileName = 'toon' + ('0' + (material.toonIndex + 1)).slice(-2) + '.bmp';\n            isDefaultToon = true;\n          } else {\n            toonFileName = data.textures[material.toonIndex];\n            isDefaultToon = false;\n          }\n\n          params.gradientMap = this._loadTexture(toonFileName, textures, {\n            isToonTexture: true,\n            isDefaultToonTexture: isDefaultToon\n          }); // parameters for OutlineEffect\n\n          params.userData.outlineParameters = {\n            thickness: material.edgeSize / 300,\n            // TODO: better calculation?\n            color: material.edgeColor.slice(0, 3),\n            alpha: material.edgeColor[3],\n            visible: (material.flag & 0x10) !== 0 && material.edgeSize > 0.0\n          };\n        }\n\n        if (params.map !== undefined) {\n          if (!params.transparent) {\n            this._checkImageTransparency(params.map, geometry, i);\n          }\n\n          params.emissive.multiplyScalar(0.2);\n        }\n\n        materials.push(new MeshToonMaterial(params));\n      }\n\n      if (data.metadata.format === 'pmx') {\n        // set transparent true if alpha morph is defined.\n        function checkAlphaMorph(elements, materials) {\n          for (let i = 0, il = elements.length; i < il; i++) {\n            var element = elements[i];\n            if (element.index === -1) continue;\n            var material = materials[element.index];\n\n            if (material.opacity !== element.diffuse[3]) {\n              material.transparent = true;\n            }\n          }\n        }\n\n        for (let i = 0, il = data.morphs.length; i < il; i++) {\n          var morph = data.morphs[i];\n          var elements = morph.elements;\n\n          if (morph.type === 0) {\n            for (let j = 0, jl = elements.length; j < jl; j++) {\n              var morph2 = data.morphs[elements[j].index];\n              if (morph2.type !== 8) continue;\n              checkAlphaMorph(morph2.elements, materials);\n            }\n          } else if (morph.type === 8) {\n            checkAlphaMorph(elements, materials);\n          }\n        }\n      }\n\n      return materials;\n    },\n    // private methods\n    _getTGALoader: function () {\n      if (this.tgaLoader === null) {\n        if (TGALoader === undefined) {\n          throw new Error('THREE.MMDLoader: Import TGALoader');\n        }\n\n        this.tgaLoader = new TGALoader(this.manager);\n      }\n\n      return this.tgaLoader;\n    },\n    _isDefaultToonTexture: function (name) {\n      if (name.length !== 10) return false;\n      return /toon(10|0[0-9])\\.bmp/.test(name);\n    },\n    _loadTexture: function (filePath, textures, params, onProgress, onError) {\n      params = params || {};\n      var scope = this;\n      var fullPath;\n\n      if (params.isDefaultToonTexture === true) {\n        var index;\n\n        try {\n          index = parseInt(filePath.match(/toon([0-9]{2})\\.bmp$/)[1]);\n        } catch (e) {\n          console.warn('THREE.MMDLoader: ' + filePath + ' seems like a ' + 'not right default texture path. Using toon00.bmp instead.');\n          index = 0;\n        }\n\n        fullPath = DEFAULT_TOON_TEXTURES[index];\n      } else {\n        fullPath = this.resourcePath + filePath;\n      }\n\n      if (textures[fullPath] !== undefined) return textures[fullPath];\n      var loader = this.manager.getHandler(fullPath);\n\n      if (loader === null) {\n        loader = filePath.slice(-4).toLowerCase() === '.tga' ? this._getTGALoader() : this.textureLoader;\n      }\n\n      var texture = loader.load(fullPath, function (t) {\n        // MMD toon texture is Axis-Y oriented\n        // but Three.js gradient map is Axis-X oriented.\n        // So here replaces the toon texture image with the rotated one.\n        if (params.isToonTexture === true) {\n          t.image = scope._getRotatedImage(t.image);\n          t.magFilter = NearestFilter;\n          t.minFilter = NearestFilter;\n        }\n\n        t.flipY = false;\n        t.wrapS = RepeatWrapping;\n        t.wrapT = RepeatWrapping;\n\n        for (let i = 0; i < texture.readyCallbacks.length; i++) {\n          texture.readyCallbacks[i](texture);\n        }\n\n        delete texture.readyCallbacks;\n      }, onProgress, onError);\n      texture.readyCallbacks = [];\n      textures[fullPath] = texture;\n      return texture;\n    },\n    _getRotatedImage: function (image) {\n      var canvas = document.createElement('canvas');\n      var context = canvas.getContext('2d');\n      var width = image.width;\n      var height = image.height;\n      canvas.width = width;\n      canvas.height = height;\n      context.clearRect(0, 0, width, height);\n      context.translate(width / 2.0, height / 2.0);\n      context.rotate(0.5 * Math.PI); // 90.0 * Math.PI / 180.0\n\n      context.translate(-width / 2.0, -height / 2.0);\n      context.drawImage(image, 0, 0);\n      return context.getImageData(0, 0, width, height);\n    },\n    // Check if the partial image area used by the texture is transparent.\n    _checkImageTransparency: function (map, geometry, groupIndex) {\n      map.readyCallbacks.push(function (texture) {\n        // Is there any efficient ways?\n        function createImageData(image) {\n          var canvas = document.createElement('canvas');\n          canvas.width = image.width;\n          canvas.height = image.height;\n          var context = canvas.getContext('2d');\n          context.drawImage(image, 0, 0);\n          return context.getImageData(0, 0, canvas.width, canvas.height);\n        }\n\n        function detectImageTransparency(image, uvs, indices) {\n          var width = image.width;\n          var height = image.height;\n          var data = image.data;\n          var threshold = 253;\n          if (data.length / (width * height) !== 4) return false;\n\n          for (let i = 0; i < indices.length; i += 3) {\n            var centerUV = {\n              x: 0.0,\n              y: 0.0\n            };\n\n            for (let j = 0; j < 3; j++) {\n              var index = indices[i * 3 + j];\n              var uv = {\n                x: uvs[index * 2 + 0],\n                y: uvs[index * 2 + 1]\n              };\n              if (getAlphaByUv(image, uv) < threshold) return true;\n              centerUV.x += uv.x;\n              centerUV.y += uv.y;\n            }\n\n            centerUV.x /= 3;\n            centerUV.y /= 3;\n            if (getAlphaByUv(image, centerUV) < threshold) return true;\n          }\n\n          return false;\n        }\n        /*\n         * This method expects\n         *   texture.flipY = false\n         *   texture.wrapS = RepeatWrapping\n         *   texture.wrapT = RepeatWrapping\n         * TODO: more precise\n         */\n\n\n        function getAlphaByUv(image, uv) {\n          var width = image.width;\n          var height = image.height;\n          var x = Math.round(uv.x * width) % width;\n          var y = Math.round(uv.y * height) % height;\n          if (x < 0) x += width;\n          if (y < 0) y += height;\n          var index = y * width + x;\n          return image.data[index * 4 + 3];\n        }\n\n        var imageData = texture.image.data !== undefined ? texture.image : createImageData(texture.image);\n        var group = geometry.groups[groupIndex];\n\n        if (detectImageTransparency(imageData, geometry.attributes.uv.array, geometry.index.array.slice(group.start, group.start + group.count))) {\n          map.transparent = true;\n        }\n      });\n    }\n  }; //\n\n  function AnimationBuilder() {}\n\n  AnimationBuilder.prototype = {\n    constructor: AnimationBuilder,\n\n    /**\n     * @param {Object} vmd - parsed VMD data\n     * @param {SkinnedMesh} mesh - tracks will be fitting to mesh\n     * @return {AnimationClip}\n     */\n    build: function (vmd, mesh) {\n      // combine skeletal and morph animations\n      var tracks = this.buildSkeletalAnimation(vmd, mesh).tracks;\n      var tracks2 = this.buildMorphAnimation(vmd, mesh).tracks;\n\n      for (let i = 0, il = tracks2.length; i < il; i++) {\n        tracks.push(tracks2[i]);\n      }\n\n      return new AnimationClip('', -1, tracks);\n    },\n\n    /**\n     * @param {Object} vmd - parsed VMD data\n     * @param {SkinnedMesh} mesh - tracks will be fitting to mesh\n     * @return {AnimationClip}\n     */\n    buildSkeletalAnimation: function (vmd, mesh) {\n      function pushInterpolation(array, interpolation, index) {\n        array.push(interpolation[index + 0] / 127); // x1\n\n        array.push(interpolation[index + 8] / 127); // x2\n\n        array.push(interpolation[index + 4] / 127); // y1\n\n        array.push(interpolation[index + 12] / 127); // y2\n      }\n\n      var tracks = [];\n      var motions = {};\n      var bones = mesh.skeleton.bones;\n      var boneNameDictionary = {};\n\n      for (let i = 0, il = bones.length; i < il; i++) {\n        boneNameDictionary[bones[i].name] = true;\n      }\n\n      for (let i = 0; i < vmd.metadata.motionCount; i++) {\n        var motion = vmd.motions[i];\n        var boneName = motion.boneName;\n        if (boneNameDictionary[boneName] === undefined) continue;\n        motions[boneName] = motions[boneName] || [];\n        motions[boneName].push(motion);\n      }\n\n      for (let key in motions) {\n        var array = motions[key];\n        array.sort(function (a, b) {\n          return a.frameNum - b.frameNum;\n        });\n        var times = [];\n        var positions = [];\n        var rotations = [];\n        var pInterpolations = [];\n        var rInterpolations = [];\n        var basePosition = mesh.skeleton.getBoneByName(key).position.toArray();\n\n        for (let i = 0, il = array.length; i < il; i++) {\n          var time = array[i].frameNum / 30;\n          var position = array[i].position;\n          var rotation = array[i].rotation;\n          var interpolation = array[i].interpolation;\n          times.push(time);\n\n          for (let j = 0; j < 3; j++) positions.push(basePosition[j] + position[j]);\n\n          for (let j = 0; j < 4; j++) rotations.push(rotation[j]);\n\n          for (let j = 0; j < 3; j++) pushInterpolation(pInterpolations, interpolation, j);\n\n          pushInterpolation(rInterpolations, interpolation, 3);\n        }\n\n        var targetName = '.bones[' + key + ']';\n        tracks.push(this._createTrack(targetName + '.position', VectorKeyframeTrack, times, positions, pInterpolations));\n        tracks.push(this._createTrack(targetName + '.quaternion', QuaternionKeyframeTrack, times, rotations, rInterpolations));\n      }\n\n      return new AnimationClip('', -1, tracks);\n    },\n\n    /**\n     * @param {Object} vmd - parsed VMD data\n     * @param {SkinnedMesh} mesh - tracks will be fitting to mesh\n     * @return {AnimationClip}\n     */\n    buildMorphAnimation: function (vmd, mesh) {\n      var tracks = [];\n      var morphs = {};\n      var morphTargetDictionary = mesh.morphTargetDictionary;\n\n      for (let i = 0; i < vmd.metadata.morphCount; i++) {\n        var morph = vmd.morphs[i];\n        var morphName = morph.morphName;\n        if (morphTargetDictionary[morphName] === undefined) continue;\n        morphs[morphName] = morphs[morphName] || [];\n        morphs[morphName].push(morph);\n      }\n\n      for (let key in morphs) {\n        var array = morphs[key];\n        array.sort(function (a, b) {\n          return a.frameNum - b.frameNum;\n        });\n        var times = [];\n        var values = [];\n\n        for (let i = 0, il = array.length; i < il; i++) {\n          times.push(array[i].frameNum / 30);\n          values.push(array[i].weight);\n        }\n\n        tracks.push(new NumberKeyframeTrack('.morphTargetInfluences[' + morphTargetDictionary[key] + ']', times, values));\n      }\n\n      return new AnimationClip('', -1, tracks);\n    },\n\n    /**\n     * @param {Object} vmd - parsed VMD data\n     * @return {AnimationClip}\n     */\n    buildCameraAnimation: function (vmd) {\n      function pushVector3(array, vec) {\n        array.push(vec.x);\n        array.push(vec.y);\n        array.push(vec.z);\n      }\n\n      function pushQuaternion(array, q) {\n        array.push(q.x);\n        array.push(q.y);\n        array.push(q.z);\n        array.push(q.w);\n      }\n\n      function pushInterpolation(array, interpolation, index) {\n        array.push(interpolation[index * 4 + 0] / 127); // x1\n\n        array.push(interpolation[index * 4 + 1] / 127); // x2\n\n        array.push(interpolation[index * 4 + 2] / 127); // y1\n\n        array.push(interpolation[index * 4 + 3] / 127); // y2\n      }\n\n      var tracks = [];\n      var cameras = vmd.cameras === undefined ? [] : vmd.cameras.slice();\n      cameras.sort(function (a, b) {\n        return a.frameNum - b.frameNum;\n      });\n      var times = [];\n      var centers = [];\n      var quaternions = [];\n      var positions = [];\n      var fovs = [];\n      var cInterpolations = [];\n      var qInterpolations = [];\n      var pInterpolations = [];\n      var fInterpolations = [];\n      var quaternion = new Quaternion();\n      var euler = new Euler();\n      var position = new Vector3();\n      var center = new Vector3();\n\n      for (let i = 0, il = cameras.length; i < il; i++) {\n        var motion = cameras[i];\n        var time = motion.frameNum / 30;\n        var pos = motion.position;\n        var rot = motion.rotation;\n        var distance = motion.distance;\n        var fov = motion.fov;\n        var interpolation = motion.interpolation;\n        times.push(time);\n        position.set(0, 0, -distance);\n        center.set(pos[0], pos[1], pos[2]);\n        euler.set(-rot[0], -rot[1], -rot[2]);\n        quaternion.setFromEuler(euler);\n        position.add(center);\n        position.applyQuaternion(quaternion);\n        pushVector3(centers, center);\n        pushQuaternion(quaternions, quaternion);\n        pushVector3(positions, position);\n        fovs.push(fov);\n\n        for (let j = 0; j < 3; j++) {\n          pushInterpolation(cInterpolations, interpolation, j);\n        }\n\n        pushInterpolation(qInterpolations, interpolation, 3); // use the same parameter for x, y, z axis.\n\n        for (let j = 0; j < 3; j++) {\n          pushInterpolation(pInterpolations, interpolation, 4);\n        }\n\n        pushInterpolation(fInterpolations, interpolation, 5);\n      }\n\n      var tracks = []; // I expect an object whose name 'target' exists under THREE.Camera\n\n      tracks.push(this._createTrack('target.position', VectorKeyframeTrack, times, centers, cInterpolations));\n      tracks.push(this._createTrack('.quaternion', QuaternionKeyframeTrack, times, quaternions, qInterpolations));\n      tracks.push(this._createTrack('.position', VectorKeyframeTrack, times, positions, pInterpolations));\n      tracks.push(this._createTrack('.fov', NumberKeyframeTrack, times, fovs, fInterpolations));\n      return new AnimationClip('', -1, tracks);\n    },\n    // private method\n    _createTrack: function (node, typedKeyframeTrack, times, values, interpolations) {\n      /*\n       * optimizes here not to let KeyframeTrackPrototype optimize\n       * because KeyframeTrackPrototype optimizes times and values but\n       * doesn't optimize interpolations.\n       */\n      if (times.length > 2) {\n        times = times.slice();\n        values = values.slice();\n        interpolations = interpolations.slice();\n        var stride = values.length / times.length;\n        var interpolateStride = interpolations.length / times.length;\n        var index = 1;\n\n        for (let aheadIndex = 2, endIndex = times.length; aheadIndex < endIndex; aheadIndex++) {\n          for (let i = 0; i < stride; i++) {\n            if (values[index * stride + i] !== values[(index - 1) * stride + i] || values[index * stride + i] !== values[aheadIndex * stride + i]) {\n              index++;\n              break;\n            }\n          }\n\n          if (aheadIndex > index) {\n            times[index] = times[aheadIndex];\n\n            for (let i = 0; i < stride; i++) {\n              values[index * stride + i] = values[aheadIndex * stride + i];\n            }\n\n            for (let i = 0; i < interpolateStride; i++) {\n              interpolations[index * interpolateStride + i] = interpolations[aheadIndex * interpolateStride + i];\n            }\n          }\n        }\n\n        times.length = index + 1;\n        values.length = (index + 1) * stride;\n        interpolations.length = (index + 1) * interpolateStride;\n      }\n\n      var track = new typedKeyframeTrack(node, times, values);\n\n      track.createInterpolant = function InterpolantFactoryMethodCubicBezier(result) {\n        return new CubicBezierInterpolation(this.times, this.values, this.getValueSize(), result, new Float32Array(interpolations));\n      };\n\n      return track;\n    }\n  }; // interpolation\n\n  function CubicBezierInterpolation(parameterPositions, sampleValues, sampleSize, resultBuffer, params) {\n    Interpolant.call(this, parameterPositions, sampleValues, sampleSize, resultBuffer);\n    this.interpolationParams = params;\n  }\n\n  CubicBezierInterpolation.prototype = Object.assign(Object.create(Interpolant.prototype), {\n    constructor: CubicBezierInterpolation,\n    interpolate_: function (i1, t0, t, t1) {\n      var result = this.resultBuffer;\n      var values = this.sampleValues;\n      var stride = this.valueSize;\n      var params = this.interpolationParams;\n      var offset1 = i1 * stride;\n      var offset0 = offset1 - stride; // No interpolation if next key frame is in one frame in 30fps.\n      // This is from MMD animation spec.\n      // '1.5' is for precision loss. times are Float32 in Three.js Animation system.\n\n      var weight1 = t1 - t0 < 1 / 30 * 1.5 ? 0.0 : (t - t0) / (t1 - t0);\n\n      if (stride === 4) {\n        // Quaternion\n        var x1 = params[i1 * 4 + 0];\n        var x2 = params[i1 * 4 + 1];\n        var y1 = params[i1 * 4 + 2];\n        var y2 = params[i1 * 4 + 3];\n\n        var ratio = this._calculate(x1, x2, y1, y2, weight1);\n\n        Quaternion.slerpFlat(result, 0, values, offset0, values, offset1, ratio);\n      } else if (stride === 3) {\n        // Vector3\n        for (let i = 0; i !== stride; ++i) {\n          var x1 = params[i1 * 12 + i * 4 + 0];\n          var x2 = params[i1 * 12 + i * 4 + 1];\n          var y1 = params[i1 * 12 + i * 4 + 2];\n          var y2 = params[i1 * 12 + i * 4 + 3];\n\n          var ratio = this._calculate(x1, x2, y1, y2, weight1);\n\n          result[i] = values[offset0 + i] * (1 - ratio) + values[offset1 + i] * ratio;\n        }\n      } else {\n        // Number\n        var x1 = params[i1 * 4 + 0];\n        var x2 = params[i1 * 4 + 1];\n        var y1 = params[i1 * 4 + 2];\n        var y2 = params[i1 * 4 + 3];\n\n        var ratio = this._calculate(x1, x2, y1, y2, weight1);\n\n        result[0] = values[offset0] * (1 - ratio) + values[offset1] * ratio;\n      }\n\n      return result;\n    },\n    _calculate: function (x1, x2, y1, y2, x) {\n      /*\n       * Cubic Bezier curves\n       *   https://en.wikipedia.org/wiki/B%C3%A9zier_curve#Cubic_B.C3.A9zier_curves\n       *\n       * B(t) = ( 1 - t ) ^ 3 * P0\n       *      + 3 * ( 1 - t ) ^ 2 * t * P1\n       *      + 3 * ( 1 - t ) * t^2 * P2\n       *      + t ^ 3 * P3\n       *      ( 0 <= t <= 1 )\n       *\n       * MMD uses Cubic Bezier curves for bone and camera animation interpolation.\n       *   http://d.hatena.ne.jp/edvakf/20111016/1318716097\n       *\n       *    x = ( 1 - t ) ^ 3 * x0\n       *      + 3 * ( 1 - t ) ^ 2 * t * x1\n       *      + 3 * ( 1 - t ) * t^2 * x2\n       *      + t ^ 3 * x3\n       *    y = ( 1 - t ) ^ 3 * y0\n       *      + 3 * ( 1 - t ) ^ 2 * t * y1\n       *      + 3 * ( 1 - t ) * t^2 * y2\n       *      + t ^ 3 * y3\n       *      ( x0 = 0, y0 = 0 )\n       *      ( x3 = 1, y3 = 1 )\n       *      ( 0 <= t, x1, x2, y1, y2 <= 1 )\n       *\n       * Here solves this equation with Bisection method,\n       *   https://en.wikipedia.org/wiki/Bisection_method\n       * gets t, and then calculate y.\n       *\n       * f(t) = 3 * ( 1 - t ) ^ 2 * t * x1\n       *      + 3 * ( 1 - t ) * t^2 * x2\n       *      + t ^ 3 - x = 0\n       *\n       * (Another option: Newton's method\n       *    https://en.wikipedia.org/wiki/Newton%27s_method)\n       */\n      var c = 0.5;\n      var t = c;\n      var s = 1.0 - t;\n      var loop = 15;\n      var eps = 1e-5;\n      var math = Math;\n      var sst3, stt3, ttt;\n\n      for (let i = 0; i < loop; i++) {\n        sst3 = 3.0 * s * s * t;\n        stt3 = 3.0 * s * t * t;\n        ttt = t * t * t;\n        var ft = sst3 * x1 + stt3 * x2 + ttt - x;\n        if (math.abs(ft) < eps) break;\n        c /= 2.0;\n        t += ft < 0 ? c : -c;\n        s = 1.0 - t;\n      }\n\n      return sst3 * y1 + stt3 * y2 + ttt;\n    }\n  });\n  return MMDLoader;\n}();\n\nexport { MMDLoader };\n"]},"metadata":{},"sourceType":"module"}