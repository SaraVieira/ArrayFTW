{"ast":null,"code":"import { Loader, FileLoader, TextureLoader, LoaderUtils, Group, Color, Matrix4, BufferGeometry, Float32BufferAttribute, Mesh, MeshPhongMaterial, BufferAttribute, MeshStandardMaterial, sRGBEncoding, RepeatWrapping, ClampToEdgeWrapping, MirroredRepeatWrapping, LinearFilter, LinearMipmapLinearFilter, NearestFilter } from 'three';\nimport { unzipSync } from 'fflate';\n/**\n *\n * 3D Manufacturing Format (3MF) specification: https://3mf.io/specification/\n *\n * The following features from the core specification are supported:\n *\n * - 3D Models\n * - Object Resources (Meshes and Components)\n * - Material Resources (Base Materials)\n *\n * 3MF Materials and Properties Extension are only partially supported.\n *\n * - Texture 2D\n * - Texture 2D Groups\n * - Color Groups (Vertex Colors)\n * - Metallic Display Properties (PBR)\n */\n\nvar ThreeMFLoader = function ThreeMFLoader(manager) {\n  Loader.call(this, manager);\n  this.availableExtensions = [];\n};\n\nThreeMFLoader.prototype = Object.assign(Object.create(Loader.prototype), {\n  constructor: ThreeMFLoader,\n  load: function load(url, onLoad, onProgress, onError) {\n    var scope = this;\n    var loader = new FileLoader(scope.manager);\n    loader.setPath(scope.path);\n    loader.setResponseType('arraybuffer');\n    loader.setRequestHeader(scope.requestHeader);\n    loader.setWithCredentials(scope.withCredentials);\n    loader.load(url, function (buffer) {\n      try {\n        onLoad(scope.parse(buffer));\n      } catch (e) {\n        if (onError) {\n          onError(e);\n        } else {\n          console.error(e);\n        }\n\n        scope.manager.itemError(url);\n      }\n    }, onProgress, onError);\n  },\n  parse: function parse(data) {\n    var scope = this;\n    var textureLoader = new TextureLoader(this.manager);\n\n    function loadDocument(data) {\n      var zip = null;\n      var file = null;\n      var relsName;\n      var modelRelsName;\n      var modelPartNames = [];\n      var texturesPartNames = [];\n      var rels;\n      var modelRels;\n      var modelParts = {};\n      var printTicketParts = {};\n      var texturesParts = {};\n      var otherParts = {};\n\n      try {\n        zip = unzipSync(new Uint8Array(data)); // eslint-disable-line no-undef\n      } catch (e) {\n        if (e instanceof ReferenceError) {\n          console.error('THREE.3MFLoader: fflate missing and file is compressed.');\n          return null;\n        }\n      }\n\n      for (file in zip) {\n        if (file.match(/\\_rels\\/.rels$/)) {\n          relsName = file;\n        } else if (file.match(/3D\\/_rels\\/.*\\.model\\.rels$/)) {\n          modelRelsName = file;\n        } else if (file.match(/^3D\\/.*\\.model$/)) {\n          modelPartNames.push(file);\n        } else if (file.match(/^3D\\/Metadata\\/.*\\.xml$/)) ;else if (file.match(/^3D\\/Textures?\\/.*/)) {\n          texturesPartNames.push(file);\n        } else if (file.match(/^3D\\/Other\\/.*/)) ;\n      } //\n\n\n      var relsView = zip[relsName];\n      var relsFileText = LoaderUtils.decodeText(relsView);\n      rels = parseRelsXml(relsFileText); //\n\n      if (modelRelsName) {\n        var relsView = zip[modelRelsName];\n        var relsFileText = LoaderUtils.decodeText(relsView);\n        modelRels = parseRelsXml(relsFileText);\n      } //\n\n\n      for (var i = 0; i < modelPartNames.length; i++) {\n        var modelPart = modelPartNames[i];\n        var view = zip[modelPart];\n        var fileText = LoaderUtils.decodeText(view);\n        var xmlData = new DOMParser().parseFromString(fileText, 'application/xml');\n\n        if (xmlData.documentElement.nodeName.toLowerCase() !== 'model') {\n          console.error('THREE.3MFLoader: Error loading 3MF - no 3MF document found: ', modelPart);\n        }\n\n        var modelNode = xmlData.querySelector('model');\n        var extensions = {};\n\n        for (var _i = 0; _i < modelNode.attributes.length; _i++) {\n          var attr = modelNode.attributes[_i];\n\n          if (attr.name.match(/^xmlns:(.+)$/)) {\n            extensions[attr.value] = RegExp.$1;\n          }\n        }\n\n        var modelData = parseModelNode(modelNode);\n        modelData['xml'] = modelNode;\n\n        if (0 < Object.keys(extensions).length) {\n          modelData['extensions'] = extensions;\n        }\n\n        modelParts[modelPart] = modelData;\n      } //\n\n\n      for (var _i2 = 0; _i2 < texturesPartNames.length; _i2++) {\n        var texturesPartName = texturesPartNames[_i2];\n        texturesParts[texturesPartName] = zip[texturesPartName].buffer;\n      }\n\n      return {\n        rels: rels,\n        modelRels: modelRels,\n        model: modelParts,\n        printTicket: printTicketParts,\n        texture: texturesParts,\n        other: otherParts\n      };\n    }\n\n    function parseRelsXml(relsFileText) {\n      var relationships = [];\n      var relsXmlData = new DOMParser().parseFromString(relsFileText, 'application/xml');\n      var relsNodes = relsXmlData.querySelectorAll('Relationship');\n\n      for (var i = 0; i < relsNodes.length; i++) {\n        var relsNode = relsNodes[i];\n        var relationship = {\n          target: relsNode.getAttribute('Target'),\n          //required\n          id: relsNode.getAttribute('Id'),\n          //required\n          type: relsNode.getAttribute('Type') //required\n\n        };\n        relationships.push(relationship);\n      }\n\n      return relationships;\n    }\n\n    function parseMetadataNodes(metadataNodes) {\n      var metadataData = {};\n\n      for (var i = 0; i < metadataNodes.length; i++) {\n        var metadataNode = metadataNodes[i];\n        var name = metadataNode.getAttribute('name');\n        var validNames = ['Title', 'Designer', 'Description', 'Copyright', 'LicenseTerms', 'Rating', 'CreationDate', 'ModificationDate'];\n\n        if (0 <= validNames.indexOf(name)) {\n          metadataData[name] = metadataNode.textContent;\n        }\n      }\n\n      return metadataData;\n    }\n\n    function parseBasematerialsNode(basematerialsNode) {\n      var basematerialsData = {\n        id: basematerialsNode.getAttribute('id'),\n        // required\n        basematerials: []\n      };\n      var basematerialNodes = basematerialsNode.querySelectorAll('base');\n\n      for (var i = 0; i < basematerialNodes.length; i++) {\n        var basematerialNode = basematerialNodes[i];\n        var basematerialData = parseBasematerialNode(basematerialNode);\n        basematerialData.index = i; // the order and count of the material nodes form an implicit 0-based index\n\n        basematerialsData.basematerials.push(basematerialData);\n      }\n\n      return basematerialsData;\n    }\n\n    function parseTexture2DNode(texture2DNode) {\n      var texture2dData = {\n        id: texture2DNode.getAttribute('id'),\n        // required\n        path: texture2DNode.getAttribute('path'),\n        // required\n        contenttype: texture2DNode.getAttribute('contenttype'),\n        // required\n        tilestyleu: texture2DNode.getAttribute('tilestyleu'),\n        tilestylev: texture2DNode.getAttribute('tilestylev'),\n        filter: texture2DNode.getAttribute('filter')\n      };\n      return texture2dData;\n    }\n\n    function parseTextures2DGroupNode(texture2DGroupNode) {\n      var texture2DGroupData = {\n        id: texture2DGroupNode.getAttribute('id'),\n        // required\n        texid: texture2DGroupNode.getAttribute('texid'),\n        // required\n        displaypropertiesid: texture2DGroupNode.getAttribute('displaypropertiesid')\n      };\n      var tex2coordNodes = texture2DGroupNode.querySelectorAll('tex2coord');\n      var uvs = [];\n\n      for (var i = 0; i < tex2coordNodes.length; i++) {\n        var tex2coordNode = tex2coordNodes[i];\n        var u = tex2coordNode.getAttribute('u');\n        var v = tex2coordNode.getAttribute('v');\n        uvs.push(parseFloat(u), parseFloat(v));\n      }\n\n      texture2DGroupData['uvs'] = new Float32Array(uvs);\n      return texture2DGroupData;\n    }\n\n    function parseColorGroupNode(colorGroupNode) {\n      var colorGroupData = {\n        id: colorGroupNode.getAttribute('id'),\n        // required\n        displaypropertiesid: colorGroupNode.getAttribute('displaypropertiesid')\n      };\n      var colorNodes = colorGroupNode.querySelectorAll('color');\n      var colors = [];\n      var colorObject = new Color();\n\n      for (var i = 0; i < colorNodes.length; i++) {\n        var colorNode = colorNodes[i];\n        var color = colorNode.getAttribute('color');\n        colorObject.setStyle(color.substring(0, 7));\n        colorObject.convertSRGBToLinear(); // color is in sRGB\n\n        colors.push(colorObject.r, colorObject.g, colorObject.b);\n      }\n\n      colorGroupData['colors'] = new Float32Array(colors);\n      return colorGroupData;\n    }\n\n    function parseMetallicDisplaypropertiesNode(metallicDisplaypropetiesNode) {\n      var metallicDisplaypropertiesData = {\n        id: metallicDisplaypropetiesNode.getAttribute('id') // required\n\n      };\n      var metallicNodes = metallicDisplaypropetiesNode.querySelectorAll('pbmetallic');\n      var metallicData = [];\n\n      for (var i = 0; i < metallicNodes.length; i++) {\n        var metallicNode = metallicNodes[i];\n        metallicData.push({\n          name: metallicNode.getAttribute('name'),\n          // required\n          metallicness: parseFloat(metallicNode.getAttribute('metallicness')),\n          // required\n          roughness: parseFloat(metallicNode.getAttribute('roughness')) // required\n\n        });\n      }\n\n      metallicDisplaypropertiesData.data = metallicData;\n      return metallicDisplaypropertiesData;\n    }\n\n    function parseBasematerialNode(basematerialNode) {\n      var basematerialData = {};\n      basematerialData['name'] = basematerialNode.getAttribute('name'); // required\n\n      basematerialData['displaycolor'] = basematerialNode.getAttribute('displaycolor'); // required\n\n      basematerialData['displaypropertiesid'] = basematerialNode.getAttribute('displaypropertiesid');\n      return basematerialData;\n    }\n\n    function parseMeshNode(meshNode) {\n      var meshData = {};\n      var vertices = [];\n      var vertexNodes = meshNode.querySelectorAll('vertices vertex');\n\n      for (var i = 0; i < vertexNodes.length; i++) {\n        var vertexNode = vertexNodes[i];\n        var x = vertexNode.getAttribute('x');\n        var y = vertexNode.getAttribute('y');\n        var z = vertexNode.getAttribute('z');\n        vertices.push(parseFloat(x), parseFloat(y), parseFloat(z));\n      }\n\n      meshData['vertices'] = new Float32Array(vertices);\n      var triangleProperties = [];\n      var triangles = [];\n      var triangleNodes = meshNode.querySelectorAll('triangles triangle');\n\n      for (var _i3 = 0; _i3 < triangleNodes.length; _i3++) {\n        var triangleNode = triangleNodes[_i3];\n        var v1 = triangleNode.getAttribute('v1');\n        var v2 = triangleNode.getAttribute('v2');\n        var v3 = triangleNode.getAttribute('v3');\n        var p1 = triangleNode.getAttribute('p1');\n        var p2 = triangleNode.getAttribute('p2');\n        var p3 = triangleNode.getAttribute('p3');\n        var pid = triangleNode.getAttribute('pid');\n        var triangleProperty = {};\n        triangleProperty['v1'] = parseInt(v1, 10);\n        triangleProperty['v2'] = parseInt(v2, 10);\n        triangleProperty['v3'] = parseInt(v3, 10);\n        triangles.push(triangleProperty['v1'], triangleProperty['v2'], triangleProperty['v3']); // optional\n\n        if (p1) {\n          triangleProperty['p1'] = parseInt(p1, 10);\n        }\n\n        if (p2) {\n          triangleProperty['p2'] = parseInt(p2, 10);\n        }\n\n        if (p3) {\n          triangleProperty['p3'] = parseInt(p3, 10);\n        }\n\n        if (pid) {\n          triangleProperty['pid'] = pid;\n        }\n\n        if (0 < Object.keys(triangleProperty).length) {\n          triangleProperties.push(triangleProperty);\n        }\n      }\n\n      meshData['triangleProperties'] = triangleProperties;\n      meshData['triangles'] = new Uint32Array(triangles);\n      return meshData;\n    }\n\n    function parseComponentsNode(componentsNode) {\n      var components = [];\n      var componentNodes = componentsNode.querySelectorAll('component');\n\n      for (var i = 0; i < componentNodes.length; i++) {\n        var componentNode = componentNodes[i];\n        var componentData = parseComponentNode(componentNode);\n        components.push(componentData);\n      }\n\n      return components;\n    }\n\n    function parseComponentNode(componentNode) {\n      var componentData = {};\n      componentData['objectId'] = componentNode.getAttribute('objectid'); // required\n\n      var transform = componentNode.getAttribute('transform');\n\n      if (transform) {\n        componentData['transform'] = parseTransform(transform);\n      }\n\n      return componentData;\n    }\n\n    function parseTransform(transform) {\n      var t = [];\n      transform.split(' ').forEach(function (s) {\n        t.push(parseFloat(s));\n      });\n      var matrix = new Matrix4();\n      matrix.set(t[0], t[3], t[6], t[9], t[1], t[4], t[7], t[10], t[2], t[5], t[8], t[11], 0.0, 0.0, 0.0, 1.0);\n      return matrix;\n    }\n\n    function parseObjectNode(objectNode) {\n      var objectData = {\n        type: objectNode.getAttribute('type')\n      };\n      var id = objectNode.getAttribute('id');\n\n      if (id) {\n        objectData['id'] = id;\n      }\n\n      var pid = objectNode.getAttribute('pid');\n\n      if (pid) {\n        objectData['pid'] = pid;\n      }\n\n      var pindex = objectNode.getAttribute('pindex');\n\n      if (pindex) {\n        objectData['pindex'] = pindex;\n      }\n\n      var thumbnail = objectNode.getAttribute('thumbnail');\n\n      if (thumbnail) {\n        objectData['thumbnail'] = thumbnail;\n      }\n\n      var partnumber = objectNode.getAttribute('partnumber');\n\n      if (partnumber) {\n        objectData['partnumber'] = partnumber;\n      }\n\n      var name = objectNode.getAttribute('name');\n\n      if (name) {\n        objectData['name'] = name;\n      }\n\n      var meshNode = objectNode.querySelector('mesh');\n\n      if (meshNode) {\n        objectData['mesh'] = parseMeshNode(meshNode);\n      }\n\n      var componentsNode = objectNode.querySelector('components');\n\n      if (componentsNode) {\n        objectData['components'] = parseComponentsNode(componentsNode);\n      }\n\n      return objectData;\n    }\n\n    function parseResourcesNode(resourcesNode) {\n      var resourcesData = {};\n      resourcesData['basematerials'] = {};\n      var basematerialsNodes = resourcesNode.querySelectorAll('basematerials');\n\n      for (var i = 0; i < basematerialsNodes.length; i++) {\n        var basematerialsNode = basematerialsNodes[i];\n        var basematerialsData = parseBasematerialsNode(basematerialsNode);\n        resourcesData['basematerials'][basematerialsData['id']] = basematerialsData;\n      } //\n\n\n      resourcesData['texture2d'] = {};\n      var textures2DNodes = resourcesNode.querySelectorAll('texture2d');\n\n      for (var _i4 = 0; _i4 < textures2DNodes.length; _i4++) {\n        var textures2DNode = textures2DNodes[_i4];\n        var texture2DData = parseTexture2DNode(textures2DNode);\n        resourcesData['texture2d'][texture2DData['id']] = texture2DData;\n      } //\n\n\n      resourcesData['colorgroup'] = {};\n      var colorGroupNodes = resourcesNode.querySelectorAll('colorgroup');\n\n      for (var _i5 = 0; _i5 < colorGroupNodes.length; _i5++) {\n        var colorGroupNode = colorGroupNodes[_i5];\n        var colorGroupData = parseColorGroupNode(colorGroupNode);\n        resourcesData['colorgroup'][colorGroupData['id']] = colorGroupData;\n      } //\n\n\n      resourcesData['pbmetallicdisplayproperties'] = {};\n      var pbmetallicdisplaypropertiesNodes = resourcesNode.querySelectorAll('pbmetallicdisplayproperties');\n\n      for (var _i6 = 0; _i6 < pbmetallicdisplaypropertiesNodes.length; _i6++) {\n        var pbmetallicdisplaypropertiesNode = pbmetallicdisplaypropertiesNodes[_i6];\n        var pbmetallicdisplaypropertiesData = parseMetallicDisplaypropertiesNode(pbmetallicdisplaypropertiesNode);\n        resourcesData['pbmetallicdisplayproperties'][pbmetallicdisplaypropertiesData['id']] = pbmetallicdisplaypropertiesData;\n      } //\n\n\n      resourcesData['texture2dgroup'] = {};\n      var textures2DGroupNodes = resourcesNode.querySelectorAll('texture2dgroup');\n\n      for (var _i7 = 0; _i7 < textures2DGroupNodes.length; _i7++) {\n        var textures2DGroupNode = textures2DGroupNodes[_i7];\n        var textures2DGroupData = parseTextures2DGroupNode(textures2DGroupNode);\n        resourcesData['texture2dgroup'][textures2DGroupData['id']] = textures2DGroupData;\n      } //\n\n\n      resourcesData['object'] = {};\n      var objectNodes = resourcesNode.querySelectorAll('object');\n\n      for (var _i8 = 0; _i8 < objectNodes.length; _i8++) {\n        var objectNode = objectNodes[_i8];\n        var objectData = parseObjectNode(objectNode);\n        resourcesData['object'][objectData['id']] = objectData;\n      }\n\n      return resourcesData;\n    }\n\n    function parseBuildNode(buildNode) {\n      var buildData = [];\n      var itemNodes = buildNode.querySelectorAll('item');\n\n      for (var i = 0; i < itemNodes.length; i++) {\n        var itemNode = itemNodes[i];\n        var buildItem = {\n          objectId: itemNode.getAttribute('objectid')\n        };\n        var transform = itemNode.getAttribute('transform');\n\n        if (transform) {\n          buildItem['transform'] = parseTransform(transform);\n        }\n\n        buildData.push(buildItem);\n      }\n\n      return buildData;\n    }\n\n    function parseModelNode(modelNode) {\n      var modelData = {\n        unit: modelNode.getAttribute('unit') || 'millimeter'\n      };\n      var metadataNodes = modelNode.querySelectorAll('metadata');\n\n      if (metadataNodes) {\n        modelData['metadata'] = parseMetadataNodes(metadataNodes);\n      }\n\n      var resourcesNode = modelNode.querySelector('resources');\n\n      if (resourcesNode) {\n        modelData['resources'] = parseResourcesNode(resourcesNode);\n      }\n\n      var buildNode = modelNode.querySelector('build');\n\n      if (buildNode) {\n        modelData['build'] = parseBuildNode(buildNode);\n      }\n\n      return modelData;\n    }\n\n    function buildTexture(texture2dgroup, objects, modelData, textureData) {\n      var texid = texture2dgroup.texid;\n      var texture2ds = modelData.resources.texture2d;\n      var texture2d = texture2ds[texid];\n\n      if (texture2d) {\n        var data = textureData[texture2d.path];\n        var type = texture2d.contenttype;\n        var blob = new Blob([data], {\n          type: type\n        });\n        var sourceURI = URL.createObjectURL(blob);\n        var texture = textureLoader.load(sourceURI, function () {\n          URL.revokeObjectURL(sourceURI);\n        });\n        texture.encoding = sRGBEncoding; // texture parameters\n\n        switch (texture2d.tilestyleu) {\n          case 'wrap':\n            texture.wrapS = RepeatWrapping;\n            break;\n\n          case 'mirror':\n            texture.wrapS = MirroredRepeatWrapping;\n            break;\n\n          case 'none':\n          case 'clamp':\n            texture.wrapS = ClampToEdgeWrapping;\n            break;\n\n          default:\n            texture.wrapS = RepeatWrapping;\n        }\n\n        switch (texture2d.tilestylev) {\n          case 'wrap':\n            texture.wrapT = RepeatWrapping;\n            break;\n\n          case 'mirror':\n            texture.wrapT = MirroredRepeatWrapping;\n            break;\n\n          case 'none':\n          case 'clamp':\n            texture.wrapT = ClampToEdgeWrapping;\n            break;\n\n          default:\n            texture.wrapT = RepeatWrapping;\n        }\n\n        switch (texture2d.filter) {\n          case 'auto':\n            texture.magFilter = LinearFilter;\n            texture.minFilter = LinearMipmapLinearFilter;\n            break;\n\n          case 'linear':\n            texture.magFilter = LinearFilter;\n            texture.minFilter = LinearFilter;\n            break;\n\n          case 'nearest':\n            texture.magFilter = NearestFilter;\n            texture.minFilter = NearestFilter;\n            break;\n\n          default:\n            texture.magFilter = LinearFilter;\n            texture.minFilter = LinearMipmapLinearFilter;\n        }\n\n        return texture;\n      } else {\n        return null;\n      }\n    }\n\n    function buildBasematerialsMeshes(basematerials, triangleProperties, modelData, meshData, textureData, objectData) {\n      var objectPindex = objectData.pindex;\n      var materialMap = {};\n\n      for (var i = 0, l = triangleProperties.length; i < l; i++) {\n        var triangleProperty = triangleProperties[i];\n        var pindex = triangleProperty.p1 !== undefined ? triangleProperty.p1 : objectPindex;\n        if (materialMap[pindex] === undefined) materialMap[pindex] = [];\n        materialMap[pindex].push(triangleProperty);\n      } //\n\n\n      var keys = Object.keys(materialMap);\n      var meshes = [];\n\n      for (var _i9 = 0, _l = keys.length; _i9 < _l; _i9++) {\n        var materialIndex = keys[_i9];\n        var trianglePropertiesProps = materialMap[materialIndex];\n        var basematerialData = basematerials.basematerials[materialIndex];\n        var material = getBuild(basematerialData, objects, modelData, textureData, objectData, buildBasematerial); //\n\n        var geometry = new BufferGeometry();\n        var positionData = [];\n        var vertices = meshData.vertices;\n\n        for (var j = 0, jl = trianglePropertiesProps.length; j < jl; j++) {\n          var triangleProperty = trianglePropertiesProps[j];\n          positionData.push(vertices[triangleProperty.v1 * 3 + 0]);\n          positionData.push(vertices[triangleProperty.v1 * 3 + 1]);\n          positionData.push(vertices[triangleProperty.v1 * 3 + 2]);\n          positionData.push(vertices[triangleProperty.v2 * 3 + 0]);\n          positionData.push(vertices[triangleProperty.v2 * 3 + 1]);\n          positionData.push(vertices[triangleProperty.v2 * 3 + 2]);\n          positionData.push(vertices[triangleProperty.v3 * 3 + 0]);\n          positionData.push(vertices[triangleProperty.v3 * 3 + 1]);\n          positionData.push(vertices[triangleProperty.v3 * 3 + 2]);\n        }\n\n        geometry.setAttribute('position', new Float32BufferAttribute(positionData, 3)); //\n\n        var mesh = new Mesh(geometry, material);\n        meshes.push(mesh);\n      }\n\n      return meshes;\n    }\n\n    function buildTexturedMesh(texture2dgroup, triangleProperties, modelData, meshData, textureData, objectData) {\n      // geometry\n      var geometry = new BufferGeometry();\n      var positionData = [];\n      var uvData = [];\n      var vertices = meshData.vertices;\n      var uvs = texture2dgroup.uvs;\n\n      for (var i = 0, l = triangleProperties.length; i < l; i++) {\n        var triangleProperty = triangleProperties[i];\n        positionData.push(vertices[triangleProperty.v1 * 3 + 0]);\n        positionData.push(vertices[triangleProperty.v1 * 3 + 1]);\n        positionData.push(vertices[triangleProperty.v1 * 3 + 2]);\n        positionData.push(vertices[triangleProperty.v2 * 3 + 0]);\n        positionData.push(vertices[triangleProperty.v2 * 3 + 1]);\n        positionData.push(vertices[triangleProperty.v2 * 3 + 2]);\n        positionData.push(vertices[triangleProperty.v3 * 3 + 0]);\n        positionData.push(vertices[triangleProperty.v3 * 3 + 1]);\n        positionData.push(vertices[triangleProperty.v3 * 3 + 2]); //\n\n        uvData.push(uvs[triangleProperty.p1 * 2 + 0]);\n        uvData.push(uvs[triangleProperty.p1 * 2 + 1]);\n        uvData.push(uvs[triangleProperty.p2 * 2 + 0]);\n        uvData.push(uvs[triangleProperty.p2 * 2 + 1]);\n        uvData.push(uvs[triangleProperty.p3 * 2 + 0]);\n        uvData.push(uvs[triangleProperty.p3 * 2 + 1]);\n      }\n\n      geometry.setAttribute('position', new Float32BufferAttribute(positionData, 3));\n      geometry.setAttribute('uv', new Float32BufferAttribute(uvData, 2)); // material\n\n      var texture = getBuild(texture2dgroup, objects, modelData, textureData, objectData, buildTexture);\n      var material = new MeshPhongMaterial({\n        map: texture,\n        flatShading: true\n      }); // mesh\n\n      var mesh = new Mesh(geometry, material);\n      return mesh;\n    }\n\n    function buildVertexColorMesh(colorgroup, triangleProperties, modelData, meshData, objectData) {\n      // geometry\n      var geometry = new BufferGeometry();\n      var positionData = [];\n      var colorData = [];\n      var vertices = meshData.vertices;\n      var colors = colorgroup.colors;\n\n      for (var i = 0, l = triangleProperties.length; i < l; i++) {\n        var triangleProperty = triangleProperties[i];\n        var v1 = triangleProperty.v1;\n        var v2 = triangleProperty.v2;\n        var v3 = triangleProperty.v3;\n        positionData.push(vertices[v1 * 3 + 0]);\n        positionData.push(vertices[v1 * 3 + 1]);\n        positionData.push(vertices[v1 * 3 + 2]);\n        positionData.push(vertices[v2 * 3 + 0]);\n        positionData.push(vertices[v2 * 3 + 1]);\n        positionData.push(vertices[v2 * 3 + 2]);\n        positionData.push(vertices[v3 * 3 + 0]);\n        positionData.push(vertices[v3 * 3 + 1]);\n        positionData.push(vertices[v3 * 3 + 2]); //\n\n        var p1 = triangleProperty.p1 !== undefined ? triangleProperty.p1 : objectData.pindex;\n        var p2 = triangleProperty.p2 !== undefined ? triangleProperty.p2 : p1;\n        var p3 = triangleProperty.p3 !== undefined ? triangleProperty.p3 : p1;\n        colorData.push(colors[p1 * 3 + 0]);\n        colorData.push(colors[p1 * 3 + 1]);\n        colorData.push(colors[p1 * 3 + 2]);\n        colorData.push(colors[p2 * 3 + 0]);\n        colorData.push(colors[p2 * 3 + 1]);\n        colorData.push(colors[p2 * 3 + 2]);\n        colorData.push(colors[p3 * 3 + 0]);\n        colorData.push(colors[p3 * 3 + 1]);\n        colorData.push(colors[p3 * 3 + 2]);\n      }\n\n      geometry.setAttribute('position', new Float32BufferAttribute(positionData, 3));\n      geometry.setAttribute('color', new Float32BufferAttribute(colorData, 3)); // material\n\n      var material = new MeshPhongMaterial({\n        vertexColors: true,\n        flatShading: true\n      }); // mesh\n\n      var mesh = new Mesh(geometry, material);\n      return mesh;\n    }\n\n    function buildDefaultMesh(meshData) {\n      var geometry = new BufferGeometry();\n      geometry.setIndex(new BufferAttribute(meshData['triangles'], 1));\n      geometry.setAttribute('position', new BufferAttribute(meshData['vertices'], 3));\n      var material = new MeshPhongMaterial({\n        color: 0xaaaaff,\n        flatShading: true\n      });\n      var mesh = new Mesh(geometry, material);\n      return mesh;\n    }\n\n    function buildMeshes(resourceMap, modelData, meshData, textureData, objectData) {\n      var keys = Object.keys(resourceMap);\n      var meshes = [];\n\n      for (var i = 0, il = keys.length; i < il; i++) {\n        var resourceId = keys[i];\n        var triangleProperties = resourceMap[resourceId];\n        var resourceType = getResourceType(resourceId, modelData);\n\n        switch (resourceType) {\n          case 'material':\n            var basematerials = modelData.resources.basematerials[resourceId];\n            var newMeshes = buildBasematerialsMeshes(basematerials, triangleProperties, modelData, meshData, textureData, objectData);\n\n            for (var j = 0, jl = newMeshes.length; j < jl; j++) {\n              meshes.push(newMeshes[j]);\n            }\n\n            break;\n\n          case 'texture':\n            var texture2dgroup = modelData.resources.texture2dgroup[resourceId];\n            meshes.push(buildTexturedMesh(texture2dgroup, triangleProperties, modelData, meshData, textureData, objectData));\n            break;\n\n          case 'vertexColors':\n            var colorgroup = modelData.resources.colorgroup[resourceId];\n            meshes.push(buildVertexColorMesh(colorgroup, triangleProperties, modelData, meshData, objectData));\n            break;\n\n          case 'default':\n            meshes.push(buildDefaultMesh(meshData));\n            break;\n\n          default:\n            console.error('THREE.3MFLoader: Unsupported resource type.');\n        }\n      }\n\n      return meshes;\n    }\n\n    function getResourceType(pid, modelData) {\n      if (modelData.resources.texture2dgroup[pid] !== undefined) {\n        return 'texture';\n      } else if (modelData.resources.basematerials[pid] !== undefined) {\n        return 'material';\n      } else if (modelData.resources.colorgroup[pid] !== undefined) {\n        return 'vertexColors';\n      } else if (pid === 'default') {\n        return 'default';\n      } else {\n        return undefined;\n      }\n    }\n\n    function analyzeObject(modelData, meshData, objectData) {\n      var resourceMap = {};\n      var triangleProperties = meshData['triangleProperties'];\n      var objectPid = objectData.pid;\n\n      for (var i = 0, l = triangleProperties.length; i < l; i++) {\n        var triangleProperty = triangleProperties[i];\n        var pid = triangleProperty.pid !== undefined ? triangleProperty.pid : objectPid;\n        if (pid === undefined) pid = 'default';\n        if (resourceMap[pid] === undefined) resourceMap[pid] = [];\n        resourceMap[pid].push(triangleProperty);\n      }\n\n      return resourceMap;\n    }\n\n    function buildGroup(meshData, objects, modelData, textureData, objectData) {\n      var group = new Group();\n      var resourceMap = analyzeObject(modelData, meshData, objectData);\n      var meshes = buildMeshes(resourceMap, modelData, meshData, textureData, objectData);\n\n      for (var i = 0, l = meshes.length; i < l; i++) {\n        group.add(meshes[i]);\n      }\n\n      return group;\n    }\n\n    function applyExtensions(extensions, meshData, modelXml) {\n      if (!extensions) {\n        return;\n      }\n\n      var availableExtensions = [];\n      var keys = Object.keys(extensions);\n\n      for (var i = 0; i < keys.length; i++) {\n        var ns = keys[i];\n\n        for (var j = 0; j < scope.availableExtensions.length; j++) {\n          var extension = scope.availableExtensions[j];\n\n          if (extension.ns === ns) {\n            availableExtensions.push(extension);\n          }\n        }\n      }\n\n      for (var _i10 = 0; _i10 < availableExtensions.length; _i10++) {\n        var extension = availableExtensions[_i10];\n        extension.apply(modelXml, extensions[extension['ns']], meshData);\n      }\n    }\n\n    function getBuild(data, objects, modelData, textureData, objectData, builder) {\n      if (data.build !== undefined) return data.build;\n      data.build = builder(data, objects, modelData, textureData, objectData);\n      return data.build;\n    }\n\n    function buildBasematerial(materialData, objects, modelData) {\n      var material;\n      var displaypropertiesid = materialData.displaypropertiesid;\n      var pbmetallicdisplayproperties = modelData.resources.pbmetallicdisplayproperties;\n\n      if (displaypropertiesid !== null && pbmetallicdisplayproperties[displaypropertiesid] !== undefined) {\n        // metallic display property, use StandardMaterial\n        var pbmetallicdisplayproperty = pbmetallicdisplayproperties[displaypropertiesid];\n        var metallicData = pbmetallicdisplayproperty.data[materialData.index];\n        material = new MeshStandardMaterial({\n          flatShading: true,\n          roughness: metallicData.roughness,\n          metalness: metallicData.metallicness\n        });\n      } else {\n        // otherwise use PhongMaterial\n        material = new MeshPhongMaterial({\n          flatShading: true\n        });\n      }\n\n      material.name = materialData.name; // displaycolor MUST be specified with a value of a 6 or 8 digit hexadecimal number, e.g. \"#RRGGBB\" or \"#RRGGBBAA\"\n\n      var displaycolor = materialData.displaycolor;\n      var color = displaycolor.substring(0, 7);\n      material.color.setStyle(color);\n      material.color.convertSRGBToLinear(); // displaycolor is in sRGB\n      // process alpha if set\n\n      if (displaycolor.length === 9) {\n        material.opacity = parseInt(displaycolor.charAt(7) + displaycolor.charAt(8), 16) / 255;\n      }\n\n      return material;\n    }\n\n    function buildComposite(compositeData, objects, modelData, textureData) {\n      var composite = new Group();\n\n      for (var j = 0; j < compositeData.length; j++) {\n        var component = compositeData[j];\n        var build = objects[component.objectId];\n\n        if (build === undefined) {\n          buildObject(component.objectId, objects, modelData, textureData);\n          build = objects[component.objectId];\n        }\n\n        var object3D = build.clone(); // apply component transform\n\n        var transform = component.transform;\n\n        if (transform) {\n          object3D.applyMatrix4(transform);\n        }\n\n        composite.add(object3D);\n      }\n\n      return composite;\n    }\n\n    function buildObject(objectId, objects, modelData, textureData) {\n      var objectData = modelData['resources']['object'][objectId];\n\n      if (objectData['mesh']) {\n        var meshData = objectData['mesh'];\n        var extensions = modelData['extensions'];\n        var modelXml = modelData['xml'];\n        applyExtensions(extensions, meshData, modelXml);\n        objects[objectData.id] = getBuild(meshData, objects, modelData, textureData, objectData, buildGroup);\n      } else {\n        var compositeData = objectData['components'];\n        objects[objectData.id] = getBuild(compositeData, objects, modelData, textureData, objectData, buildComposite);\n      }\n    }\n\n    function buildObjects(data3mf) {\n      var modelsData = data3mf.model;\n      var modelRels = data3mf.modelRels;\n      var objects = {};\n      var modelsKeys = Object.keys(modelsData);\n      var textureData = {}; // evaluate model relationships to textures\n\n      if (modelRels) {\n        for (var i = 0, l = modelRels.length; i < l; i++) {\n          var modelRel = modelRels[i];\n          var textureKey = modelRel.target.substring(1);\n\n          if (data3mf.texture[textureKey]) {\n            textureData[modelRel.target] = data3mf.texture[textureKey];\n          }\n        }\n      } // start build\n\n\n      for (var _i11 = 0; _i11 < modelsKeys.length; _i11++) {\n        var modelsKey = modelsKeys[_i11];\n        var modelData = modelsData[modelsKey];\n        var objectIds = Object.keys(modelData['resources']['object']);\n\n        for (var j = 0; j < objectIds.length; j++) {\n          var objectId = objectIds[j];\n          buildObject(objectId, objects, modelData, textureData);\n        }\n      }\n\n      return objects;\n    }\n\n    function fetch3DModelPart(rels) {\n      for (var i = 0; i < rels.length; i++) {\n        var rel = rels[i];\n        var extension = rel.target.split('.').pop();\n        if (extension.toLowerCase() === 'model') return rel;\n      }\n    }\n\n    function build(objects, data3mf) {\n      var group = new Group();\n      var relationship = fetch3DModelPart(data3mf['rels']);\n      var buildData = data3mf.model[relationship['target'].substring(1)]['build'];\n\n      for (var i = 0; i < buildData.length; i++) {\n        var buildItem = buildData[i];\n        var object3D = objects[buildItem['objectId']]; // apply transform\n\n        var transform = buildItem['transform'];\n\n        if (transform) {\n          object3D.applyMatrix4(transform);\n        }\n\n        group.add(object3D);\n      }\n\n      return group;\n    }\n\n    var data3mf = loadDocument(data);\n    var objects = buildObjects(data3mf);\n    return build(objects, data3mf);\n  },\n  addExtension: function addExtension(extension) {\n    this.availableExtensions.push(extension);\n  }\n});\nexport { ThreeMFLoader };","map":{"version":3,"sources":["/Projects/arrayftw/node_modules/three-stdlib/loaders/3MFLoader.js"],"names":["Loader","FileLoader","TextureLoader","LoaderUtils","Group","Color","Matrix4","BufferGeometry","Float32BufferAttribute","Mesh","MeshPhongMaterial","BufferAttribute","MeshStandardMaterial","sRGBEncoding","RepeatWrapping","ClampToEdgeWrapping","MirroredRepeatWrapping","LinearFilter","LinearMipmapLinearFilter","NearestFilter","unzipSync","ThreeMFLoader","manager","call","availableExtensions","prototype","Object","assign","create","constructor","load","url","onLoad","onProgress","onError","scope","loader","setPath","path","setResponseType","setRequestHeader","requestHeader","setWithCredentials","withCredentials","buffer","parse","e","console","error","itemError","data","textureLoader","loadDocument","zip","file","relsName","modelRelsName","modelPartNames","texturesPartNames","rels","modelRels","modelParts","printTicketParts","texturesParts","otherParts","Uint8Array","ReferenceError","match","push","relsView","relsFileText","decodeText","parseRelsXml","i","length","modelPart","view","fileText","xmlData","DOMParser","parseFromString","documentElement","nodeName","toLowerCase","modelNode","querySelector","extensions","attributes","attr","name","value","RegExp","$1","modelData","parseModelNode","keys","texturesPartName","model","printTicket","texture","other","relationships","relsXmlData","relsNodes","querySelectorAll","relsNode","relationship","target","getAttribute","id","type","parseMetadataNodes","metadataNodes","metadataData","metadataNode","validNames","indexOf","textContent","parseBasematerialsNode","basematerialsNode","basematerialsData","basematerials","basematerialNodes","basematerialNode","basematerialData","parseBasematerialNode","index","parseTexture2DNode","texture2DNode","texture2dData","contenttype","tilestyleu","tilestylev","filter","parseTextures2DGroupNode","texture2DGroupNode","texture2DGroupData","texid","displaypropertiesid","tex2coordNodes","uvs","tex2coordNode","u","v","parseFloat","Float32Array","parseColorGroupNode","colorGroupNode","colorGroupData","colorNodes","colors","colorObject","colorNode","color","setStyle","substring","convertSRGBToLinear","r","g","b","parseMetallicDisplaypropertiesNode","metallicDisplaypropetiesNode","metallicDisplaypropertiesData","metallicNodes","metallicData","metallicNode","metallicness","roughness","parseMeshNode","meshNode","meshData","vertices","vertexNodes","vertexNode","x","y","z","triangleProperties","triangles","triangleNodes","triangleNode","v1","v2","v3","p1","p2","p3","pid","triangleProperty","parseInt","Uint32Array","parseComponentsNode","componentsNode","components","componentNodes","componentNode","componentData","parseComponentNode","transform","parseTransform","t","split","forEach","s","matrix","set","parseObjectNode","objectNode","objectData","pindex","thumbnail","partnumber","parseResourcesNode","resourcesNode","resourcesData","basematerialsNodes","textures2DNodes","textures2DNode","texture2DData","colorGroupNodes","pbmetallicdisplaypropertiesNodes","pbmetallicdisplaypropertiesNode","pbmetallicdisplaypropertiesData","textures2DGroupNodes","textures2DGroupNode","textures2DGroupData","objectNodes","parseBuildNode","buildNode","buildData","itemNodes","itemNode","buildItem","objectId","unit","buildTexture","texture2dgroup","objects","textureData","texture2ds","resources","texture2d","blob","Blob","sourceURI","URL","createObjectURL","revokeObjectURL","encoding","wrapS","wrapT","magFilter","minFilter","buildBasematerialsMeshes","objectPindex","materialMap","l","undefined","meshes","materialIndex","trianglePropertiesProps","material","getBuild","buildBasematerial","geometry","positionData","j","jl","setAttribute","mesh","buildTexturedMesh","uvData","map","flatShading","buildVertexColorMesh","colorgroup","colorData","vertexColors","buildDefaultMesh","setIndex","buildMeshes","resourceMap","il","resourceId","resourceType","getResourceType","newMeshes","analyzeObject","objectPid","buildGroup","group","add","applyExtensions","modelXml","ns","extension","apply","builder","build","materialData","pbmetallicdisplayproperties","pbmetallicdisplayproperty","metalness","displaycolor","opacity","charAt","buildComposite","compositeData","composite","component","buildObject","object3D","clone","applyMatrix4","buildObjects","data3mf","modelsData","modelsKeys","modelRel","textureKey","modelsKey","objectIds","fetch3DModelPart","rel","pop","addExtension"],"mappings":"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","sourcesContent":["import { Loader, FileLoader, TextureLoader, LoaderUtils, Group, Color, Matrix4, BufferGeometry, Float32BufferAttribute, Mesh, MeshPhongMaterial, BufferAttribute, MeshStandardMaterial, sRGBEncoding, RepeatWrapping, ClampToEdgeWrapping, MirroredRepeatWrapping, LinearFilter, LinearMipmapLinearFilter, NearestFilter } from 'three';\nimport { unzipSync } from 'fflate';\n\n/**\n *\n * 3D Manufacturing Format (3MF) specification: https://3mf.io/specification/\n *\n * The following features from the core specification are supported:\n *\n * - 3D Models\n * - Object Resources (Meshes and Components)\n * - Material Resources (Base Materials)\n *\n * 3MF Materials and Properties Extension are only partially supported.\n *\n * - Texture 2D\n * - Texture 2D Groups\n * - Color Groups (Vertex Colors)\n * - Metallic Display Properties (PBR)\n */\n\nvar ThreeMFLoader = function (manager) {\n  Loader.call(this, manager);\n  this.availableExtensions = [];\n};\n\nThreeMFLoader.prototype = Object.assign(Object.create(Loader.prototype), {\n  constructor: ThreeMFLoader,\n  load: function (url, onLoad, onProgress, onError) {\n    var scope = this;\n    var loader = new FileLoader(scope.manager);\n    loader.setPath(scope.path);\n    loader.setResponseType('arraybuffer');\n    loader.setRequestHeader(scope.requestHeader);\n    loader.setWithCredentials(scope.withCredentials);\n    loader.load(url, function (buffer) {\n      try {\n        onLoad(scope.parse(buffer));\n      } catch (e) {\n        if (onError) {\n          onError(e);\n        } else {\n          console.error(e);\n        }\n\n        scope.manager.itemError(url);\n      }\n    }, onProgress, onError);\n  },\n  parse: function (data) {\n    var scope = this;\n    var textureLoader = new TextureLoader(this.manager);\n\n    function loadDocument(data) {\n      var zip = null;\n      var file = null;\n      var relsName;\n      var modelRelsName;\n      var modelPartNames = [];\n      var texturesPartNames = [];\n      var rels;\n      var modelRels;\n      var modelParts = {};\n      var printTicketParts = {};\n      var texturesParts = {};\n      var otherParts = {};\n\n      try {\n        zip = unzipSync(new Uint8Array(data)); // eslint-disable-line no-undef\n      } catch (e) {\n        if (e instanceof ReferenceError) {\n          console.error('THREE.3MFLoader: fflate missing and file is compressed.');\n          return null;\n        }\n      }\n\n      for (file in zip) {\n        if (file.match(/\\_rels\\/.rels$/)) {\n          relsName = file;\n        } else if (file.match(/3D\\/_rels\\/.*\\.model\\.rels$/)) {\n          modelRelsName = file;\n        } else if (file.match(/^3D\\/.*\\.model$/)) {\n          modelPartNames.push(file);\n        } else if (file.match(/^3D\\/Metadata\\/.*\\.xml$/)) ; else if (file.match(/^3D\\/Textures?\\/.*/)) {\n          texturesPartNames.push(file);\n        } else if (file.match(/^3D\\/Other\\/.*/)) ;\n      } //\n\n\n      var relsView = zip[relsName];\n      var relsFileText = LoaderUtils.decodeText(relsView);\n      rels = parseRelsXml(relsFileText); //\n\n      if (modelRelsName) {\n        var relsView = zip[modelRelsName];\n        var relsFileText = LoaderUtils.decodeText(relsView);\n        modelRels = parseRelsXml(relsFileText);\n      } //\n\n\n      for (let i = 0; i < modelPartNames.length; i++) {\n        var modelPart = modelPartNames[i];\n        var view = zip[modelPart];\n        var fileText = LoaderUtils.decodeText(view);\n        var xmlData = new DOMParser().parseFromString(fileText, 'application/xml');\n\n        if (xmlData.documentElement.nodeName.toLowerCase() !== 'model') {\n          console.error('THREE.3MFLoader: Error loading 3MF - no 3MF document found: ', modelPart);\n        }\n\n        var modelNode = xmlData.querySelector('model');\n        var extensions = {};\n\n        for (let i = 0; i < modelNode.attributes.length; i++) {\n          var attr = modelNode.attributes[i];\n\n          if (attr.name.match(/^xmlns:(.+)$/)) {\n            extensions[attr.value] = RegExp.$1;\n          }\n        }\n\n        var modelData = parseModelNode(modelNode);\n        modelData['xml'] = modelNode;\n\n        if (0 < Object.keys(extensions).length) {\n          modelData['extensions'] = extensions;\n        }\n\n        modelParts[modelPart] = modelData;\n      } //\n\n\n      for (let i = 0; i < texturesPartNames.length; i++) {\n        var texturesPartName = texturesPartNames[i];\n        texturesParts[texturesPartName] = zip[texturesPartName].buffer;\n      }\n\n      return {\n        rels: rels,\n        modelRels: modelRels,\n        model: modelParts,\n        printTicket: printTicketParts,\n        texture: texturesParts,\n        other: otherParts\n      };\n    }\n\n    function parseRelsXml(relsFileText) {\n      var relationships = [];\n      var relsXmlData = new DOMParser().parseFromString(relsFileText, 'application/xml');\n      var relsNodes = relsXmlData.querySelectorAll('Relationship');\n\n      for (let i = 0; i < relsNodes.length; i++) {\n        var relsNode = relsNodes[i];\n        var relationship = {\n          target: relsNode.getAttribute('Target'),\n          //required\n          id: relsNode.getAttribute('Id'),\n          //required\n          type: relsNode.getAttribute('Type') //required\n\n        };\n        relationships.push(relationship);\n      }\n\n      return relationships;\n    }\n\n    function parseMetadataNodes(metadataNodes) {\n      var metadataData = {};\n\n      for (let i = 0; i < metadataNodes.length; i++) {\n        var metadataNode = metadataNodes[i];\n        var name = metadataNode.getAttribute('name');\n        var validNames = ['Title', 'Designer', 'Description', 'Copyright', 'LicenseTerms', 'Rating', 'CreationDate', 'ModificationDate'];\n\n        if (0 <= validNames.indexOf(name)) {\n          metadataData[name] = metadataNode.textContent;\n        }\n      }\n\n      return metadataData;\n    }\n\n    function parseBasematerialsNode(basematerialsNode) {\n      var basematerialsData = {\n        id: basematerialsNode.getAttribute('id'),\n        // required\n        basematerials: []\n      };\n      var basematerialNodes = basematerialsNode.querySelectorAll('base');\n\n      for (let i = 0; i < basematerialNodes.length; i++) {\n        var basematerialNode = basematerialNodes[i];\n        var basematerialData = parseBasematerialNode(basematerialNode);\n        basematerialData.index = i; // the order and count of the material nodes form an implicit 0-based index\n\n        basematerialsData.basematerials.push(basematerialData);\n      }\n\n      return basematerialsData;\n    }\n\n    function parseTexture2DNode(texture2DNode) {\n      var texture2dData = {\n        id: texture2DNode.getAttribute('id'),\n        // required\n        path: texture2DNode.getAttribute('path'),\n        // required\n        contenttype: texture2DNode.getAttribute('contenttype'),\n        // required\n        tilestyleu: texture2DNode.getAttribute('tilestyleu'),\n        tilestylev: texture2DNode.getAttribute('tilestylev'),\n        filter: texture2DNode.getAttribute('filter')\n      };\n      return texture2dData;\n    }\n\n    function parseTextures2DGroupNode(texture2DGroupNode) {\n      var texture2DGroupData = {\n        id: texture2DGroupNode.getAttribute('id'),\n        // required\n        texid: texture2DGroupNode.getAttribute('texid'),\n        // required\n        displaypropertiesid: texture2DGroupNode.getAttribute('displaypropertiesid')\n      };\n      var tex2coordNodes = texture2DGroupNode.querySelectorAll('tex2coord');\n      var uvs = [];\n\n      for (let i = 0; i < tex2coordNodes.length; i++) {\n        var tex2coordNode = tex2coordNodes[i];\n        var u = tex2coordNode.getAttribute('u');\n        var v = tex2coordNode.getAttribute('v');\n        uvs.push(parseFloat(u), parseFloat(v));\n      }\n\n      texture2DGroupData['uvs'] = new Float32Array(uvs);\n      return texture2DGroupData;\n    }\n\n    function parseColorGroupNode(colorGroupNode) {\n      var colorGroupData = {\n        id: colorGroupNode.getAttribute('id'),\n        // required\n        displaypropertiesid: colorGroupNode.getAttribute('displaypropertiesid')\n      };\n      var colorNodes = colorGroupNode.querySelectorAll('color');\n      var colors = [];\n      var colorObject = new Color();\n\n      for (let i = 0; i < colorNodes.length; i++) {\n        var colorNode = colorNodes[i];\n        var color = colorNode.getAttribute('color');\n        colorObject.setStyle(color.substring(0, 7));\n        colorObject.convertSRGBToLinear(); // color is in sRGB\n\n        colors.push(colorObject.r, colorObject.g, colorObject.b);\n      }\n\n      colorGroupData['colors'] = new Float32Array(colors);\n      return colorGroupData;\n    }\n\n    function parseMetallicDisplaypropertiesNode(metallicDisplaypropetiesNode) {\n      var metallicDisplaypropertiesData = {\n        id: metallicDisplaypropetiesNode.getAttribute('id') // required\n\n      };\n      var metallicNodes = metallicDisplaypropetiesNode.querySelectorAll('pbmetallic');\n      var metallicData = [];\n\n      for (let i = 0; i < metallicNodes.length; i++) {\n        var metallicNode = metallicNodes[i];\n        metallicData.push({\n          name: metallicNode.getAttribute('name'),\n          // required\n          metallicness: parseFloat(metallicNode.getAttribute('metallicness')),\n          // required\n          roughness: parseFloat(metallicNode.getAttribute('roughness')) // required\n\n        });\n      }\n\n      metallicDisplaypropertiesData.data = metallicData;\n      return metallicDisplaypropertiesData;\n    }\n\n    function parseBasematerialNode(basematerialNode) {\n      var basematerialData = {};\n      basematerialData['name'] = basematerialNode.getAttribute('name'); // required\n\n      basematerialData['displaycolor'] = basematerialNode.getAttribute('displaycolor'); // required\n\n      basematerialData['displaypropertiesid'] = basematerialNode.getAttribute('displaypropertiesid');\n      return basematerialData;\n    }\n\n    function parseMeshNode(meshNode) {\n      var meshData = {};\n      var vertices = [];\n      var vertexNodes = meshNode.querySelectorAll('vertices vertex');\n\n      for (let i = 0; i < vertexNodes.length; i++) {\n        var vertexNode = vertexNodes[i];\n        var x = vertexNode.getAttribute('x');\n        var y = vertexNode.getAttribute('y');\n        var z = vertexNode.getAttribute('z');\n        vertices.push(parseFloat(x), parseFloat(y), parseFloat(z));\n      }\n\n      meshData['vertices'] = new Float32Array(vertices);\n      var triangleProperties = [];\n      var triangles = [];\n      var triangleNodes = meshNode.querySelectorAll('triangles triangle');\n\n      for (let i = 0; i < triangleNodes.length; i++) {\n        var triangleNode = triangleNodes[i];\n        var v1 = triangleNode.getAttribute('v1');\n        var v2 = triangleNode.getAttribute('v2');\n        var v3 = triangleNode.getAttribute('v3');\n        var p1 = triangleNode.getAttribute('p1');\n        var p2 = triangleNode.getAttribute('p2');\n        var p3 = triangleNode.getAttribute('p3');\n        var pid = triangleNode.getAttribute('pid');\n        var triangleProperty = {};\n        triangleProperty['v1'] = parseInt(v1, 10);\n        triangleProperty['v2'] = parseInt(v2, 10);\n        triangleProperty['v3'] = parseInt(v3, 10);\n        triangles.push(triangleProperty['v1'], triangleProperty['v2'], triangleProperty['v3']); // optional\n\n        if (p1) {\n          triangleProperty['p1'] = parseInt(p1, 10);\n        }\n\n        if (p2) {\n          triangleProperty['p2'] = parseInt(p2, 10);\n        }\n\n        if (p3) {\n          triangleProperty['p3'] = parseInt(p3, 10);\n        }\n\n        if (pid) {\n          triangleProperty['pid'] = pid;\n        }\n\n        if (0 < Object.keys(triangleProperty).length) {\n          triangleProperties.push(triangleProperty);\n        }\n      }\n\n      meshData['triangleProperties'] = triangleProperties;\n      meshData['triangles'] = new Uint32Array(triangles);\n      return meshData;\n    }\n\n    function parseComponentsNode(componentsNode) {\n      var components = [];\n      var componentNodes = componentsNode.querySelectorAll('component');\n\n      for (let i = 0; i < componentNodes.length; i++) {\n        var componentNode = componentNodes[i];\n        var componentData = parseComponentNode(componentNode);\n        components.push(componentData);\n      }\n\n      return components;\n    }\n\n    function parseComponentNode(componentNode) {\n      var componentData = {};\n      componentData['objectId'] = componentNode.getAttribute('objectid'); // required\n\n      var transform = componentNode.getAttribute('transform');\n\n      if (transform) {\n        componentData['transform'] = parseTransform(transform);\n      }\n\n      return componentData;\n    }\n\n    function parseTransform(transform) {\n      var t = [];\n      transform.split(' ').forEach(function (s) {\n        t.push(parseFloat(s));\n      });\n      var matrix = new Matrix4();\n      matrix.set(t[0], t[3], t[6], t[9], t[1], t[4], t[7], t[10], t[2], t[5], t[8], t[11], 0.0, 0.0, 0.0, 1.0);\n      return matrix;\n    }\n\n    function parseObjectNode(objectNode) {\n      var objectData = {\n        type: objectNode.getAttribute('type')\n      };\n      var id = objectNode.getAttribute('id');\n\n      if (id) {\n        objectData['id'] = id;\n      }\n\n      var pid = objectNode.getAttribute('pid');\n\n      if (pid) {\n        objectData['pid'] = pid;\n      }\n\n      var pindex = objectNode.getAttribute('pindex');\n\n      if (pindex) {\n        objectData['pindex'] = pindex;\n      }\n\n      var thumbnail = objectNode.getAttribute('thumbnail');\n\n      if (thumbnail) {\n        objectData['thumbnail'] = thumbnail;\n      }\n\n      var partnumber = objectNode.getAttribute('partnumber');\n\n      if (partnumber) {\n        objectData['partnumber'] = partnumber;\n      }\n\n      var name = objectNode.getAttribute('name');\n\n      if (name) {\n        objectData['name'] = name;\n      }\n\n      var meshNode = objectNode.querySelector('mesh');\n\n      if (meshNode) {\n        objectData['mesh'] = parseMeshNode(meshNode);\n      }\n\n      var componentsNode = objectNode.querySelector('components');\n\n      if (componentsNode) {\n        objectData['components'] = parseComponentsNode(componentsNode);\n      }\n\n      return objectData;\n    }\n\n    function parseResourcesNode(resourcesNode) {\n      var resourcesData = {};\n      resourcesData['basematerials'] = {};\n      var basematerialsNodes = resourcesNode.querySelectorAll('basematerials');\n\n      for (let i = 0; i < basematerialsNodes.length; i++) {\n        var basematerialsNode = basematerialsNodes[i];\n        var basematerialsData = parseBasematerialsNode(basematerialsNode);\n        resourcesData['basematerials'][basematerialsData['id']] = basematerialsData;\n      } //\n\n\n      resourcesData['texture2d'] = {};\n      var textures2DNodes = resourcesNode.querySelectorAll('texture2d');\n\n      for (let i = 0; i < textures2DNodes.length; i++) {\n        var textures2DNode = textures2DNodes[i];\n        var texture2DData = parseTexture2DNode(textures2DNode);\n        resourcesData['texture2d'][texture2DData['id']] = texture2DData;\n      } //\n\n\n      resourcesData['colorgroup'] = {};\n      var colorGroupNodes = resourcesNode.querySelectorAll('colorgroup');\n\n      for (let i = 0; i < colorGroupNodes.length; i++) {\n        var colorGroupNode = colorGroupNodes[i];\n        var colorGroupData = parseColorGroupNode(colorGroupNode);\n        resourcesData['colorgroup'][colorGroupData['id']] = colorGroupData;\n      } //\n\n\n      resourcesData['pbmetallicdisplayproperties'] = {};\n      var pbmetallicdisplaypropertiesNodes = resourcesNode.querySelectorAll('pbmetallicdisplayproperties');\n\n      for (let i = 0; i < pbmetallicdisplaypropertiesNodes.length; i++) {\n        var pbmetallicdisplaypropertiesNode = pbmetallicdisplaypropertiesNodes[i];\n        var pbmetallicdisplaypropertiesData = parseMetallicDisplaypropertiesNode(pbmetallicdisplaypropertiesNode);\n        resourcesData['pbmetallicdisplayproperties'][pbmetallicdisplaypropertiesData['id']] = pbmetallicdisplaypropertiesData;\n      } //\n\n\n      resourcesData['texture2dgroup'] = {};\n      var textures2DGroupNodes = resourcesNode.querySelectorAll('texture2dgroup');\n\n      for (let i = 0; i < textures2DGroupNodes.length; i++) {\n        var textures2DGroupNode = textures2DGroupNodes[i];\n        var textures2DGroupData = parseTextures2DGroupNode(textures2DGroupNode);\n        resourcesData['texture2dgroup'][textures2DGroupData['id']] = textures2DGroupData;\n      } //\n\n\n      resourcesData['object'] = {};\n      var objectNodes = resourcesNode.querySelectorAll('object');\n\n      for (let i = 0; i < objectNodes.length; i++) {\n        var objectNode = objectNodes[i];\n        var objectData = parseObjectNode(objectNode);\n        resourcesData['object'][objectData['id']] = objectData;\n      }\n\n      return resourcesData;\n    }\n\n    function parseBuildNode(buildNode) {\n      var buildData = [];\n      var itemNodes = buildNode.querySelectorAll('item');\n\n      for (let i = 0; i < itemNodes.length; i++) {\n        var itemNode = itemNodes[i];\n        var buildItem = {\n          objectId: itemNode.getAttribute('objectid')\n        };\n        var transform = itemNode.getAttribute('transform');\n\n        if (transform) {\n          buildItem['transform'] = parseTransform(transform);\n        }\n\n        buildData.push(buildItem);\n      }\n\n      return buildData;\n    }\n\n    function parseModelNode(modelNode) {\n      var modelData = {\n        unit: modelNode.getAttribute('unit') || 'millimeter'\n      };\n      var metadataNodes = modelNode.querySelectorAll('metadata');\n\n      if (metadataNodes) {\n        modelData['metadata'] = parseMetadataNodes(metadataNodes);\n      }\n\n      var resourcesNode = modelNode.querySelector('resources');\n\n      if (resourcesNode) {\n        modelData['resources'] = parseResourcesNode(resourcesNode);\n      }\n\n      var buildNode = modelNode.querySelector('build');\n\n      if (buildNode) {\n        modelData['build'] = parseBuildNode(buildNode);\n      }\n\n      return modelData;\n    }\n\n    function buildTexture(texture2dgroup, objects, modelData, textureData) {\n      var texid = texture2dgroup.texid;\n      var texture2ds = modelData.resources.texture2d;\n      var texture2d = texture2ds[texid];\n\n      if (texture2d) {\n        var data = textureData[texture2d.path];\n        var type = texture2d.contenttype;\n        var blob = new Blob([data], {\n          type: type\n        });\n        var sourceURI = URL.createObjectURL(blob);\n        var texture = textureLoader.load(sourceURI, function () {\n          URL.revokeObjectURL(sourceURI);\n        });\n        texture.encoding = sRGBEncoding; // texture parameters\n\n        switch (texture2d.tilestyleu) {\n          case 'wrap':\n            texture.wrapS = RepeatWrapping;\n            break;\n\n          case 'mirror':\n            texture.wrapS = MirroredRepeatWrapping;\n            break;\n\n          case 'none':\n          case 'clamp':\n            texture.wrapS = ClampToEdgeWrapping;\n            break;\n\n          default:\n            texture.wrapS = RepeatWrapping;\n        }\n\n        switch (texture2d.tilestylev) {\n          case 'wrap':\n            texture.wrapT = RepeatWrapping;\n            break;\n\n          case 'mirror':\n            texture.wrapT = MirroredRepeatWrapping;\n            break;\n\n          case 'none':\n          case 'clamp':\n            texture.wrapT = ClampToEdgeWrapping;\n            break;\n\n          default:\n            texture.wrapT = RepeatWrapping;\n        }\n\n        switch (texture2d.filter) {\n          case 'auto':\n            texture.magFilter = LinearFilter;\n            texture.minFilter = LinearMipmapLinearFilter;\n            break;\n\n          case 'linear':\n            texture.magFilter = LinearFilter;\n            texture.minFilter = LinearFilter;\n            break;\n\n          case 'nearest':\n            texture.magFilter = NearestFilter;\n            texture.minFilter = NearestFilter;\n            break;\n\n          default:\n            texture.magFilter = LinearFilter;\n            texture.minFilter = LinearMipmapLinearFilter;\n        }\n\n        return texture;\n      } else {\n        return null;\n      }\n    }\n\n    function buildBasematerialsMeshes(basematerials, triangleProperties, modelData, meshData, textureData, objectData) {\n      var objectPindex = objectData.pindex;\n      var materialMap = {};\n\n      for (let i = 0, l = triangleProperties.length; i < l; i++) {\n        var triangleProperty = triangleProperties[i];\n        var pindex = triangleProperty.p1 !== undefined ? triangleProperty.p1 : objectPindex;\n        if (materialMap[pindex] === undefined) materialMap[pindex] = [];\n        materialMap[pindex].push(triangleProperty);\n      } //\n\n\n      var keys = Object.keys(materialMap);\n      var meshes = [];\n\n      for (let i = 0, l = keys.length; i < l; i++) {\n        var materialIndex = keys[i];\n        var trianglePropertiesProps = materialMap[materialIndex];\n        var basematerialData = basematerials.basematerials[materialIndex];\n        var material = getBuild(basematerialData, objects, modelData, textureData, objectData, buildBasematerial); //\n\n        var geometry = new BufferGeometry();\n        var positionData = [];\n        var vertices = meshData.vertices;\n\n        for (let j = 0, jl = trianglePropertiesProps.length; j < jl; j++) {\n          var triangleProperty = trianglePropertiesProps[j];\n          positionData.push(vertices[triangleProperty.v1 * 3 + 0]);\n          positionData.push(vertices[triangleProperty.v1 * 3 + 1]);\n          positionData.push(vertices[triangleProperty.v1 * 3 + 2]);\n          positionData.push(vertices[triangleProperty.v2 * 3 + 0]);\n          positionData.push(vertices[triangleProperty.v2 * 3 + 1]);\n          positionData.push(vertices[triangleProperty.v2 * 3 + 2]);\n          positionData.push(vertices[triangleProperty.v3 * 3 + 0]);\n          positionData.push(vertices[triangleProperty.v3 * 3 + 1]);\n          positionData.push(vertices[triangleProperty.v3 * 3 + 2]);\n        }\n\n        geometry.setAttribute('position', new Float32BufferAttribute(positionData, 3)); //\n\n        var mesh = new Mesh(geometry, material);\n        meshes.push(mesh);\n      }\n\n      return meshes;\n    }\n\n    function buildTexturedMesh(texture2dgroup, triangleProperties, modelData, meshData, textureData, objectData) {\n      // geometry\n      var geometry = new BufferGeometry();\n      var positionData = [];\n      var uvData = [];\n      var vertices = meshData.vertices;\n      var uvs = texture2dgroup.uvs;\n\n      for (let i = 0, l = triangleProperties.length; i < l; i++) {\n        var triangleProperty = triangleProperties[i];\n        positionData.push(vertices[triangleProperty.v1 * 3 + 0]);\n        positionData.push(vertices[triangleProperty.v1 * 3 + 1]);\n        positionData.push(vertices[triangleProperty.v1 * 3 + 2]);\n        positionData.push(vertices[triangleProperty.v2 * 3 + 0]);\n        positionData.push(vertices[triangleProperty.v2 * 3 + 1]);\n        positionData.push(vertices[triangleProperty.v2 * 3 + 2]);\n        positionData.push(vertices[triangleProperty.v3 * 3 + 0]);\n        positionData.push(vertices[triangleProperty.v3 * 3 + 1]);\n        positionData.push(vertices[triangleProperty.v3 * 3 + 2]); //\n\n        uvData.push(uvs[triangleProperty.p1 * 2 + 0]);\n        uvData.push(uvs[triangleProperty.p1 * 2 + 1]);\n        uvData.push(uvs[triangleProperty.p2 * 2 + 0]);\n        uvData.push(uvs[triangleProperty.p2 * 2 + 1]);\n        uvData.push(uvs[triangleProperty.p3 * 2 + 0]);\n        uvData.push(uvs[triangleProperty.p3 * 2 + 1]);\n      }\n\n      geometry.setAttribute('position', new Float32BufferAttribute(positionData, 3));\n      geometry.setAttribute('uv', new Float32BufferAttribute(uvData, 2)); // material\n\n      var texture = getBuild(texture2dgroup, objects, modelData, textureData, objectData, buildTexture);\n      var material = new MeshPhongMaterial({\n        map: texture,\n        flatShading: true\n      }); // mesh\n\n      var mesh = new Mesh(geometry, material);\n      return mesh;\n    }\n\n    function buildVertexColorMesh(colorgroup, triangleProperties, modelData, meshData, objectData) {\n      // geometry\n      var geometry = new BufferGeometry();\n      var positionData = [];\n      var colorData = [];\n      var vertices = meshData.vertices;\n      var colors = colorgroup.colors;\n\n      for (let i = 0, l = triangleProperties.length; i < l; i++) {\n        var triangleProperty = triangleProperties[i];\n        var v1 = triangleProperty.v1;\n        var v2 = triangleProperty.v2;\n        var v3 = triangleProperty.v3;\n        positionData.push(vertices[v1 * 3 + 0]);\n        positionData.push(vertices[v1 * 3 + 1]);\n        positionData.push(vertices[v1 * 3 + 2]);\n        positionData.push(vertices[v2 * 3 + 0]);\n        positionData.push(vertices[v2 * 3 + 1]);\n        positionData.push(vertices[v2 * 3 + 2]);\n        positionData.push(vertices[v3 * 3 + 0]);\n        positionData.push(vertices[v3 * 3 + 1]);\n        positionData.push(vertices[v3 * 3 + 2]); //\n\n        var p1 = triangleProperty.p1 !== undefined ? triangleProperty.p1 : objectData.pindex;\n        var p2 = triangleProperty.p2 !== undefined ? triangleProperty.p2 : p1;\n        var p3 = triangleProperty.p3 !== undefined ? triangleProperty.p3 : p1;\n        colorData.push(colors[p1 * 3 + 0]);\n        colorData.push(colors[p1 * 3 + 1]);\n        colorData.push(colors[p1 * 3 + 2]);\n        colorData.push(colors[p2 * 3 + 0]);\n        colorData.push(colors[p2 * 3 + 1]);\n        colorData.push(colors[p2 * 3 + 2]);\n        colorData.push(colors[p3 * 3 + 0]);\n        colorData.push(colors[p3 * 3 + 1]);\n        colorData.push(colors[p3 * 3 + 2]);\n      }\n\n      geometry.setAttribute('position', new Float32BufferAttribute(positionData, 3));\n      geometry.setAttribute('color', new Float32BufferAttribute(colorData, 3)); // material\n\n      var material = new MeshPhongMaterial({\n        vertexColors: true,\n        flatShading: true\n      }); // mesh\n\n      var mesh = new Mesh(geometry, material);\n      return mesh;\n    }\n\n    function buildDefaultMesh(meshData) {\n      var geometry = new BufferGeometry();\n      geometry.setIndex(new BufferAttribute(meshData['triangles'], 1));\n      geometry.setAttribute('position', new BufferAttribute(meshData['vertices'], 3));\n      var material = new MeshPhongMaterial({\n        color: 0xaaaaff,\n        flatShading: true\n      });\n      var mesh = new Mesh(geometry, material);\n      return mesh;\n    }\n\n    function buildMeshes(resourceMap, modelData, meshData, textureData, objectData) {\n      var keys = Object.keys(resourceMap);\n      var meshes = [];\n\n      for (let i = 0, il = keys.length; i < il; i++) {\n        var resourceId = keys[i];\n        var triangleProperties = resourceMap[resourceId];\n        var resourceType = getResourceType(resourceId, modelData);\n\n        switch (resourceType) {\n          case 'material':\n            var basematerials = modelData.resources.basematerials[resourceId];\n            var newMeshes = buildBasematerialsMeshes(basematerials, triangleProperties, modelData, meshData, textureData, objectData);\n\n            for (let j = 0, jl = newMeshes.length; j < jl; j++) {\n              meshes.push(newMeshes[j]);\n            }\n\n            break;\n\n          case 'texture':\n            var texture2dgroup = modelData.resources.texture2dgroup[resourceId];\n            meshes.push(buildTexturedMesh(texture2dgroup, triangleProperties, modelData, meshData, textureData, objectData));\n            break;\n\n          case 'vertexColors':\n            var colorgroup = modelData.resources.colorgroup[resourceId];\n            meshes.push(buildVertexColorMesh(colorgroup, triangleProperties, modelData, meshData, objectData));\n            break;\n\n          case 'default':\n            meshes.push(buildDefaultMesh(meshData));\n            break;\n\n          default:\n            console.error('THREE.3MFLoader: Unsupported resource type.');\n        }\n      }\n\n      return meshes;\n    }\n\n    function getResourceType(pid, modelData) {\n      if (modelData.resources.texture2dgroup[pid] !== undefined) {\n        return 'texture';\n      } else if (modelData.resources.basematerials[pid] !== undefined) {\n        return 'material';\n      } else if (modelData.resources.colorgroup[pid] !== undefined) {\n        return 'vertexColors';\n      } else if (pid === 'default') {\n        return 'default';\n      } else {\n        return undefined;\n      }\n    }\n\n    function analyzeObject(modelData, meshData, objectData) {\n      var resourceMap = {};\n      var triangleProperties = meshData['triangleProperties'];\n      var objectPid = objectData.pid;\n\n      for (let i = 0, l = triangleProperties.length; i < l; i++) {\n        var triangleProperty = triangleProperties[i];\n        var pid = triangleProperty.pid !== undefined ? triangleProperty.pid : objectPid;\n        if (pid === undefined) pid = 'default';\n        if (resourceMap[pid] === undefined) resourceMap[pid] = [];\n        resourceMap[pid].push(triangleProperty);\n      }\n\n      return resourceMap;\n    }\n\n    function buildGroup(meshData, objects, modelData, textureData, objectData) {\n      var group = new Group();\n      var resourceMap = analyzeObject(modelData, meshData, objectData);\n      var meshes = buildMeshes(resourceMap, modelData, meshData, textureData, objectData);\n\n      for (let i = 0, l = meshes.length; i < l; i++) {\n        group.add(meshes[i]);\n      }\n\n      return group;\n    }\n\n    function applyExtensions(extensions, meshData, modelXml) {\n      if (!extensions) {\n        return;\n      }\n\n      var availableExtensions = [];\n      var keys = Object.keys(extensions);\n\n      for (let i = 0; i < keys.length; i++) {\n        var ns = keys[i];\n\n        for (let j = 0; j < scope.availableExtensions.length; j++) {\n          var extension = scope.availableExtensions[j];\n\n          if (extension.ns === ns) {\n            availableExtensions.push(extension);\n          }\n        }\n      }\n\n      for (let i = 0; i < availableExtensions.length; i++) {\n        var extension = availableExtensions[i];\n        extension.apply(modelXml, extensions[extension['ns']], meshData);\n      }\n    }\n\n    function getBuild(data, objects, modelData, textureData, objectData, builder) {\n      if (data.build !== undefined) return data.build;\n      data.build = builder(data, objects, modelData, textureData, objectData);\n      return data.build;\n    }\n\n    function buildBasematerial(materialData, objects, modelData) {\n      var material;\n      var displaypropertiesid = materialData.displaypropertiesid;\n      var pbmetallicdisplayproperties = modelData.resources.pbmetallicdisplayproperties;\n\n      if (displaypropertiesid !== null && pbmetallicdisplayproperties[displaypropertiesid] !== undefined) {\n        // metallic display property, use StandardMaterial\n        var pbmetallicdisplayproperty = pbmetallicdisplayproperties[displaypropertiesid];\n        var metallicData = pbmetallicdisplayproperty.data[materialData.index];\n        material = new MeshStandardMaterial({\n          flatShading: true,\n          roughness: metallicData.roughness,\n          metalness: metallicData.metallicness\n        });\n      } else {\n        // otherwise use PhongMaterial\n        material = new MeshPhongMaterial({\n          flatShading: true\n        });\n      }\n\n      material.name = materialData.name; // displaycolor MUST be specified with a value of a 6 or 8 digit hexadecimal number, e.g. \"#RRGGBB\" or \"#RRGGBBAA\"\n\n      var displaycolor = materialData.displaycolor;\n      var color = displaycolor.substring(0, 7);\n      material.color.setStyle(color);\n      material.color.convertSRGBToLinear(); // displaycolor is in sRGB\n      // process alpha if set\n\n      if (displaycolor.length === 9) {\n        material.opacity = parseInt(displaycolor.charAt(7) + displaycolor.charAt(8), 16) / 255;\n      }\n\n      return material;\n    }\n\n    function buildComposite(compositeData, objects, modelData, textureData) {\n      var composite = new Group();\n\n      for (let j = 0; j < compositeData.length; j++) {\n        var component = compositeData[j];\n        var build = objects[component.objectId];\n\n        if (build === undefined) {\n          buildObject(component.objectId, objects, modelData, textureData);\n          build = objects[component.objectId];\n        }\n\n        var object3D = build.clone(); // apply component transform\n\n        var transform = component.transform;\n\n        if (transform) {\n          object3D.applyMatrix4(transform);\n        }\n\n        composite.add(object3D);\n      }\n\n      return composite;\n    }\n\n    function buildObject(objectId, objects, modelData, textureData) {\n      var objectData = modelData['resources']['object'][objectId];\n\n      if (objectData['mesh']) {\n        var meshData = objectData['mesh'];\n        var extensions = modelData['extensions'];\n        var modelXml = modelData['xml'];\n        applyExtensions(extensions, meshData, modelXml);\n        objects[objectData.id] = getBuild(meshData, objects, modelData, textureData, objectData, buildGroup);\n      } else {\n        var compositeData = objectData['components'];\n        objects[objectData.id] = getBuild(compositeData, objects, modelData, textureData, objectData, buildComposite);\n      }\n    }\n\n    function buildObjects(data3mf) {\n      var modelsData = data3mf.model;\n      var modelRels = data3mf.modelRels;\n      var objects = {};\n      var modelsKeys = Object.keys(modelsData);\n      var textureData = {}; // evaluate model relationships to textures\n\n      if (modelRels) {\n        for (let i = 0, l = modelRels.length; i < l; i++) {\n          var modelRel = modelRels[i];\n          var textureKey = modelRel.target.substring(1);\n\n          if (data3mf.texture[textureKey]) {\n            textureData[modelRel.target] = data3mf.texture[textureKey];\n          }\n        }\n      } // start build\n\n\n      for (let i = 0; i < modelsKeys.length; i++) {\n        var modelsKey = modelsKeys[i];\n        var modelData = modelsData[modelsKey];\n        var objectIds = Object.keys(modelData['resources']['object']);\n\n        for (let j = 0; j < objectIds.length; j++) {\n          var objectId = objectIds[j];\n          buildObject(objectId, objects, modelData, textureData);\n        }\n      }\n\n      return objects;\n    }\n\n    function fetch3DModelPart(rels) {\n      for (let i = 0; i < rels.length; i++) {\n        var rel = rels[i];\n        var extension = rel.target.split('.').pop();\n        if (extension.toLowerCase() === 'model') return rel;\n      }\n    }\n\n    function build(objects, data3mf) {\n      var group = new Group();\n      var relationship = fetch3DModelPart(data3mf['rels']);\n      var buildData = data3mf.model[relationship['target'].substring(1)]['build'];\n\n      for (let i = 0; i < buildData.length; i++) {\n        var buildItem = buildData[i];\n        var object3D = objects[buildItem['objectId']]; // apply transform\n\n        var transform = buildItem['transform'];\n\n        if (transform) {\n          object3D.applyMatrix4(transform);\n        }\n\n        group.add(object3D);\n      }\n\n      return group;\n    }\n\n    var data3mf = loadDocument(data);\n    var objects = buildObjects(data3mf);\n    return build(objects, data3mf);\n  },\n  addExtension: function (extension) {\n    this.availableExtensions.push(extension);\n  }\n});\n\nexport { ThreeMFLoader };\n"]},"metadata":{},"sourceType":"module"}