{"ast":null,"code":"import _classCallCheck from \"/Projects/arrayftw/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/classCallCheck\";\nimport _createClass from \"/Projects/arrayftw/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/createClass\";\nimport _inherits from \"/Projects/arrayftw/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/inherits\";\nimport _createSuper from \"/Projects/arrayftw/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/createSuper\";\nimport { Group, BufferGeometry, BufferAttribute, LineSegments, LineBasicMaterial, Box3Helper, Box3, MeshBasicMaterial, DoubleSide, Mesh, PlaneGeometry } from 'three';\n\nvar CSMHelper = /*#__PURE__*/function (_Group) {\n  _inherits(CSMHelper, _Group);\n\n  var _super = _createSuper(CSMHelper);\n\n  function CSMHelper(csm) {\n    var _this;\n\n    _classCallCheck(this, CSMHelper);\n\n    _this = _super.call(this);\n    _this.csm = csm;\n    _this.displayFrustum = true;\n    _this.displayPlanes = true;\n    _this.displayShadowBounds = true;\n    var indices = new Uint16Array([0, 1, 1, 2, 2, 3, 3, 0, 4, 5, 5, 6, 6, 7, 7, 4, 0, 4, 1, 5, 2, 6, 3, 7]);\n    var positions = new Float32Array(24);\n    var frustumGeometry = new BufferGeometry();\n    frustumGeometry.setIndex(new BufferAttribute(indices, 1));\n    frustumGeometry.setAttribute('position', new BufferAttribute(positions, 3, false));\n    var frustumLines = new LineSegments(frustumGeometry, new LineBasicMaterial());\n\n    _this.add(frustumLines);\n\n    _this.frustumLines = frustumLines;\n    _this.cascadeLines = [];\n    _this.cascadePlanes = [];\n    _this.shadowLines = [];\n    return _this;\n  }\n\n  _createClass(CSMHelper, [{\n    key: \"updateVisibility\",\n    value: function updateVisibility() {\n      var displayFrustum = this.displayFrustum;\n      var displayPlanes = this.displayPlanes;\n      var displayShadowBounds = this.displayShadowBounds;\n      var frustumLines = this.frustumLines;\n      var cascadeLines = this.cascadeLines;\n      var cascadePlanes = this.cascadePlanes;\n      var shadowLines = this.shadowLines;\n\n      for (var i = 0, l = cascadeLines.length; i < l; i++) {\n        var cascadeLine = cascadeLines[i];\n        var cascadePlane = cascadePlanes[i];\n        var shadowLineGroup = shadowLines[i];\n        cascadeLine.visible = displayFrustum;\n        cascadePlane.visible = displayFrustum && displayPlanes;\n        shadowLineGroup.visible = displayShadowBounds;\n      }\n\n      frustumLines.visible = displayFrustum;\n    }\n  }, {\n    key: \"update\",\n    value: function update() {\n      var csm = this.csm;\n      var camera = csm.camera;\n      var cascades = csm.cascades;\n      var mainFrustum = csm.mainFrustum;\n      var frustums = csm.frustums;\n      var lights = csm.lights;\n      var frustumLines = this.frustumLines;\n      var frustumLinePositions = frustumLines.geometry.getAttribute('position');\n      var cascadeLines = this.cascadeLines;\n      var cascadePlanes = this.cascadePlanes;\n      var shadowLines = this.shadowLines;\n      this.position.copy(camera.position);\n      this.quaternion.copy(camera.quaternion);\n      this.scale.copy(camera.scale);\n      this.updateMatrixWorld(true);\n\n      while (cascadeLines.length > cascades) {\n        this.remove(cascadeLines.pop());\n        this.remove(cascadePlanes.pop());\n        this.remove(shadowLines.pop());\n      }\n\n      while (cascadeLines.length < cascades) {\n        var cascadeLine = new Box3Helper(new Box3(), 0xffffff);\n        var planeMat = new MeshBasicMaterial({\n          transparent: true,\n          opacity: 0.1,\n          depthWrite: false,\n          side: DoubleSide\n        });\n        var cascadePlane = new Mesh(new PlaneGeometry(), planeMat);\n        var shadowLineGroup = new Group();\n        var shadowLine = new Box3Helper(new Box3(), 0xffff00);\n        shadowLineGroup.add(shadowLine);\n        this.add(cascadeLine);\n        this.add(cascadePlane);\n        this.add(shadowLineGroup);\n        cascadeLines.push(cascadeLine);\n        cascadePlanes.push(cascadePlane);\n        shadowLines.push(shadowLineGroup);\n      }\n\n      for (var i = 0; i < cascades; i++) {\n        var frustum = frustums[i];\n        var light = lights[i];\n        var shadowCam = light.shadow.camera;\n        var _farVerts = frustum.vertices.far;\n        var _cascadeLine = cascadeLines[i];\n        var _cascadePlane = cascadePlanes[i];\n        var _shadowLineGroup = shadowLines[i];\n        var _shadowLine = _shadowLineGroup.children[0];\n\n        _cascadeLine.box.min.copy(_farVerts[2]);\n\n        _cascadeLine.box.max.copy(_farVerts[0]);\n\n        _cascadeLine.box.max.z += 1e-4;\n\n        _cascadePlane.position.addVectors(_farVerts[0], _farVerts[2]);\n\n        _cascadePlane.position.multiplyScalar(0.5);\n\n        _cascadePlane.scale.subVectors(_farVerts[0], _farVerts[2]);\n\n        _cascadePlane.scale.z = 1e-4;\n        this.remove(_shadowLineGroup);\n\n        _shadowLineGroup.position.copy(shadowCam.position);\n\n        _shadowLineGroup.quaternion.copy(shadowCam.quaternion);\n\n        _shadowLineGroup.scale.copy(shadowCam.scale);\n\n        _shadowLineGroup.updateMatrixWorld(true);\n\n        this.attach(_shadowLineGroup);\n\n        _shadowLine.box.min.set(shadowCam.bottom, shadowCam.left, -shadowCam.far);\n\n        _shadowLine.box.max.set(shadowCam.top, shadowCam.right, -shadowCam.near);\n      }\n\n      var nearVerts = mainFrustum.vertices.near;\n      var farVerts = mainFrustum.vertices.far;\n      frustumLinePositions.setXYZ(0, farVerts[0].x, farVerts[0].y, farVerts[0].z);\n      frustumLinePositions.setXYZ(1, farVerts[3].x, farVerts[3].y, farVerts[3].z);\n      frustumLinePositions.setXYZ(2, farVerts[2].x, farVerts[2].y, farVerts[2].z);\n      frustumLinePositions.setXYZ(3, farVerts[1].x, farVerts[1].y, farVerts[1].z);\n      frustumLinePositions.setXYZ(4, nearVerts[0].x, nearVerts[0].y, nearVerts[0].z);\n      frustumLinePositions.setXYZ(5, nearVerts[3].x, nearVerts[3].y, nearVerts[3].z);\n      frustumLinePositions.setXYZ(6, nearVerts[2].x, nearVerts[2].y, nearVerts[2].z);\n      frustumLinePositions.setXYZ(7, nearVerts[1].x, nearVerts[1].y, nearVerts[1].z);\n      frustumLinePositions.needsUpdate = true;\n    }\n  }]);\n\n  return CSMHelper;\n}(Group);\n\nexport { CSMHelper };","map":{"version":3,"sources":["/Projects/arrayftw/node_modules/three-stdlib/csm/CSMHelper.js"],"names":["Group","BufferGeometry","BufferAttribute","LineSegments","LineBasicMaterial","Box3Helper","Box3","MeshBasicMaterial","DoubleSide","Mesh","PlaneGeometry","CSMHelper","csm","displayFrustum","displayPlanes","displayShadowBounds","indices","Uint16Array","positions","Float32Array","frustumGeometry","setIndex","setAttribute","frustumLines","add","cascadeLines","cascadePlanes","shadowLines","i","l","length","cascadeLine","cascadePlane","shadowLineGroup","visible","camera","cascades","mainFrustum","frustums","lights","frustumLinePositions","geometry","getAttribute","position","copy","quaternion","scale","updateMatrixWorld","remove","pop","planeMat","transparent","opacity","depthWrite","side","shadowLine","push","frustum","light","shadowCam","shadow","farVerts","vertices","far","children","box","min","max","z","addVectors","multiplyScalar","subVectors","attach","set","bottom","left","top","right","near","nearVerts","setXYZ","x","y","needsUpdate"],"mappings":"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","sourcesContent":["import { Group, BufferGeometry, BufferAttribute, LineSegments, LineBasicMaterial, Box3Helper, Box3, MeshBasicMaterial, DoubleSide, Mesh, PlaneGeometry } from 'three';\n\nclass CSMHelper extends Group {\n  constructor(csm) {\n    super();\n    this.csm = csm;\n    this.displayFrustum = true;\n    this.displayPlanes = true;\n    this.displayShadowBounds = true;\n    const indices = new Uint16Array([0, 1, 1, 2, 2, 3, 3, 0, 4, 5, 5, 6, 6, 7, 7, 4, 0, 4, 1, 5, 2, 6, 3, 7]);\n    const positions = new Float32Array(24);\n    const frustumGeometry = new BufferGeometry();\n    frustumGeometry.setIndex(new BufferAttribute(indices, 1));\n    frustumGeometry.setAttribute('position', new BufferAttribute(positions, 3, false));\n    const frustumLines = new LineSegments(frustumGeometry, new LineBasicMaterial());\n    this.add(frustumLines);\n    this.frustumLines = frustumLines;\n    this.cascadeLines = [];\n    this.cascadePlanes = [];\n    this.shadowLines = [];\n  }\n\n  updateVisibility() {\n    const displayFrustum = this.displayFrustum;\n    const displayPlanes = this.displayPlanes;\n    const displayShadowBounds = this.displayShadowBounds;\n    const frustumLines = this.frustumLines;\n    const cascadeLines = this.cascadeLines;\n    const cascadePlanes = this.cascadePlanes;\n    const shadowLines = this.shadowLines;\n\n    for (let i = 0, l = cascadeLines.length; i < l; i++) {\n      const cascadeLine = cascadeLines[i];\n      const cascadePlane = cascadePlanes[i];\n      const shadowLineGroup = shadowLines[i];\n      cascadeLine.visible = displayFrustum;\n      cascadePlane.visible = displayFrustum && displayPlanes;\n      shadowLineGroup.visible = displayShadowBounds;\n    }\n\n    frustumLines.visible = displayFrustum;\n  }\n\n  update() {\n    const csm = this.csm;\n    const camera = csm.camera;\n    const cascades = csm.cascades;\n    const mainFrustum = csm.mainFrustum;\n    const frustums = csm.frustums;\n    const lights = csm.lights;\n    const frustumLines = this.frustumLines;\n    const frustumLinePositions = frustumLines.geometry.getAttribute('position');\n    const cascadeLines = this.cascadeLines;\n    const cascadePlanes = this.cascadePlanes;\n    const shadowLines = this.shadowLines;\n    this.position.copy(camera.position);\n    this.quaternion.copy(camera.quaternion);\n    this.scale.copy(camera.scale);\n    this.updateMatrixWorld(true);\n\n    while (cascadeLines.length > cascades) {\n      this.remove(cascadeLines.pop());\n      this.remove(cascadePlanes.pop());\n      this.remove(shadowLines.pop());\n    }\n\n    while (cascadeLines.length < cascades) {\n      const cascadeLine = new Box3Helper(new Box3(), 0xffffff);\n      const planeMat = new MeshBasicMaterial({\n        transparent: true,\n        opacity: 0.1,\n        depthWrite: false,\n        side: DoubleSide\n      });\n      const cascadePlane = new Mesh(new PlaneGeometry(), planeMat);\n      const shadowLineGroup = new Group();\n      const shadowLine = new Box3Helper(new Box3(), 0xffff00);\n      shadowLineGroup.add(shadowLine);\n      this.add(cascadeLine);\n      this.add(cascadePlane);\n      this.add(shadowLineGroup);\n      cascadeLines.push(cascadeLine);\n      cascadePlanes.push(cascadePlane);\n      shadowLines.push(shadowLineGroup);\n    }\n\n    for (let i = 0; i < cascades; i++) {\n      const frustum = frustums[i];\n      const light = lights[i];\n      const shadowCam = light.shadow.camera;\n      const farVerts = frustum.vertices.far;\n      const cascadeLine = cascadeLines[i];\n      const cascadePlane = cascadePlanes[i];\n      const shadowLineGroup = shadowLines[i];\n      const shadowLine = shadowLineGroup.children[0];\n      cascadeLine.box.min.copy(farVerts[2]);\n      cascadeLine.box.max.copy(farVerts[0]);\n      cascadeLine.box.max.z += 1e-4;\n      cascadePlane.position.addVectors(farVerts[0], farVerts[2]);\n      cascadePlane.position.multiplyScalar(0.5);\n      cascadePlane.scale.subVectors(farVerts[0], farVerts[2]);\n      cascadePlane.scale.z = 1e-4;\n      this.remove(shadowLineGroup);\n      shadowLineGroup.position.copy(shadowCam.position);\n      shadowLineGroup.quaternion.copy(shadowCam.quaternion);\n      shadowLineGroup.scale.copy(shadowCam.scale);\n      shadowLineGroup.updateMatrixWorld(true);\n      this.attach(shadowLineGroup);\n      shadowLine.box.min.set(shadowCam.bottom, shadowCam.left, -shadowCam.far);\n      shadowLine.box.max.set(shadowCam.top, shadowCam.right, -shadowCam.near);\n    }\n\n    const nearVerts = mainFrustum.vertices.near;\n    const farVerts = mainFrustum.vertices.far;\n    frustumLinePositions.setXYZ(0, farVerts[0].x, farVerts[0].y, farVerts[0].z);\n    frustumLinePositions.setXYZ(1, farVerts[3].x, farVerts[3].y, farVerts[3].z);\n    frustumLinePositions.setXYZ(2, farVerts[2].x, farVerts[2].y, farVerts[2].z);\n    frustumLinePositions.setXYZ(3, farVerts[1].x, farVerts[1].y, farVerts[1].z);\n    frustumLinePositions.setXYZ(4, nearVerts[0].x, nearVerts[0].y, nearVerts[0].z);\n    frustumLinePositions.setXYZ(5, nearVerts[3].x, nearVerts[3].y, nearVerts[3].z);\n    frustumLinePositions.setXYZ(6, nearVerts[2].x, nearVerts[2].y, nearVerts[2].z);\n    frustumLinePositions.setXYZ(7, nearVerts[1].x, nearVerts[1].y, nearVerts[1].z);\n    frustumLinePositions.needsUpdate = true;\n  }\n\n}\n\nexport { CSMHelper };\n"]},"metadata":{},"sourceType":"module"}