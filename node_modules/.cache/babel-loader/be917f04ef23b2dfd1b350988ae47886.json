{"ast":null,"code":"import { Quaternion, Object3D, Vector3, AnimationMixer } from 'three';\nimport { CCDIKSolver } from './CCDIKSolver.js';\nimport { MMDPhysics } from './MMDPhysics.js';\n/**\n * MMDAnimationHelper handles animation of MMD assets loaded by MMDLoader\n * with MMD special features as IK, Grant, and Physics.\n *\n * Dependencies\n *  - ammo.js https://github.com/kripken/ammo.js\n *  - MMDPhysics\n *  - CCDIKSolver\n *\n * TODO\n *  - more precise grant skinning support.\n */\n\nvar MMDAnimationHelper = function () {\n  /**\n   * @param {Object} params - (optional)\n   * @param {boolean} params.sync - Whether animation durations of added objects are synched. Default is true.\n   * @param {Number} params.afterglow - Default is 0.0.\n   * @param {boolean} params.resetPhysicsOnLoop - Default is true.\n   */\n  function MMDAnimationHelper(params) {\n    params = params || {};\n    this.meshes = [];\n    this.camera = null;\n    this.cameraTarget = new Object3D();\n    this.cameraTarget.name = 'target';\n    this.audio = null;\n    this.audioManager = null;\n    this.objects = new WeakMap();\n    this.configuration = {\n      sync: params.sync !== undefined ? params.sync : true,\n      afterglow: params.afterglow !== undefined ? params.afterglow : 0.0,\n      resetPhysicsOnLoop: params.resetPhysicsOnLoop !== undefined ? params.resetPhysicsOnLoop : true\n    };\n    this.enabled = {\n      animation: true,\n      ik: true,\n      grant: true,\n      physics: true,\n      cameraAnimation: true\n    };\n\n    this.onBeforePhysics = function ()\n    /* mesh */\n    {}; // experimental\n\n\n    this.sharedPhysics = false;\n    this.masterPhysics = null;\n  }\n\n  MMDAnimationHelper.prototype = {\n    constructor: MMDAnimationHelper,\n\n    /**\n     * Adds an Three.js Object to helper and setups animation.\n     * The anmation durations of added objects are synched\n     * if this.configuration.sync is true.\n     *\n     * @param {THREE.SkinnedMesh|THREE.Camera|THREE.Audio} object\n     * @param {Object} params - (optional)\n     * @param {THREE.AnimationClip|Array<THREE.AnimationClip>} params.animation - Only for THREE.SkinnedMesh and THREE.Camera. Default is undefined.\n     * @param {boolean} params.physics - Only for THREE.SkinnedMesh. Default is true.\n     * @param {Integer} params.warmup - Only for THREE.SkinnedMesh and physics is true. Default is 60.\n     * @param {Number} params.unitStep - Only for THREE.SkinnedMesh and physics is true. Default is 1 / 65.\n     * @param {Integer} params.maxStepNum - Only for THREE.SkinnedMesh and physics is true. Default is 3.\n     * @param {Vector3} params.gravity - Only for THREE.SkinnedMesh and physics is true. Default ( 0, - 9.8 * 10, 0 ).\n     * @param {Number} params.delayTime - Only for THREE.Audio. Default is 0.0.\n     * @return {MMDAnimationHelper}\n     */\n    add: function add(object, params) {\n      params = params || {};\n\n      if (object.isSkinnedMesh) {\n        this._addMesh(object, params);\n      } else if (object.isCamera) {\n        this._setupCamera(object, params);\n      } else if (object.type === 'Audio') {\n        this._setupAudio(object, params);\n      } else {\n        throw new Error('THREE.MMDAnimationHelper.add: ' + 'accepts only ' + 'THREE.SkinnedMesh or ' + 'THREE.Camera or ' + 'THREE.Audio instance.');\n      }\n\n      if (this.configuration.sync) this._syncDuration();\n      return this;\n    },\n\n    /**\n     * Removes an Three.js Object from helper.\n     *\n     * @param {THREE.SkinnedMesh|THREE.Camera|THREE.Audio} object\n     * @return {MMDAnimationHelper}\n     */\n    remove: function remove(object) {\n      if (object.isSkinnedMesh) {\n        this._removeMesh(object);\n      } else if (object.isCamera) {\n        this._clearCamera(object);\n      } else if (object.type === 'Audio') {\n        this._clearAudio(object);\n      } else {\n        throw new Error('THREE.MMDAnimationHelper.remove: ' + 'accepts only ' + 'THREE.SkinnedMesh or ' + 'THREE.Camera or ' + 'THREE.Audio instance.');\n      }\n\n      if (this.configuration.sync) this._syncDuration();\n      return this;\n    },\n\n    /**\n     * Updates the animation.\n     *\n     * @param {Number} delta\n     * @return {MMDAnimationHelper}\n     */\n    update: function update(delta) {\n      if (this.audioManager !== null) this.audioManager.control(delta);\n\n      for (var i = 0; i < this.meshes.length; i++) {\n        this._animateMesh(this.meshes[i], delta);\n      }\n\n      if (this.sharedPhysics) this._updateSharedPhysics(delta);\n      if (this.camera !== null) this._animateCamera(this.camera, delta);\n      return this;\n    },\n\n    /**\n     * Changes the pose of SkinnedMesh as VPD specifies.\n     *\n     * @param {THREE.SkinnedMesh} mesh\n     * @param {Object} vpd - VPD content parsed MMDParser\n     * @param {Object} params - (optional)\n     * @param {boolean} params.resetPose - Default is true.\n     * @param {boolean} params.ik - Default is true.\n     * @param {boolean} params.grant - Default is true.\n     * @return {MMDAnimationHelper}\n     */\n    pose: function pose(mesh, vpd, params) {\n      params = params || {};\n      if (params.resetPose !== false) mesh.pose();\n      var bones = mesh.skeleton.bones;\n      var boneParams = vpd.bones;\n      var boneNameDictionary = {};\n\n      for (var i = 0, il = bones.length; i < il; i++) {\n        boneNameDictionary[bones[i].name] = i;\n      }\n\n      var vector = new Vector3();\n      var quaternion = new Quaternion();\n\n      for (var _i = 0, _il = boneParams.length; _i < _il; _i++) {\n        var boneParam = boneParams[_i];\n        var boneIndex = boneNameDictionary[boneParam.name];\n        if (boneIndex === undefined) continue;\n        var bone = bones[boneIndex];\n        bone.position.add(vector.fromArray(boneParam.translation));\n        bone.quaternion.multiply(quaternion.fromArray(boneParam.quaternion));\n      }\n\n      mesh.updateMatrixWorld(true);\n\n      if (params.ik !== false) {\n        this._createCCDIKSolver(mesh).update(params.saveOriginalBonesBeforeIK); // this param is experimental\n\n      }\n\n      if (params.grant !== false) {\n        this.createGrantSolver(mesh).update();\n      }\n\n      return this;\n    },\n\n    /**\n     * Enabes/Disables an animation feature.\n     *\n     * @param {string} key\n     * @param {boolean} enabled\n     * @return {MMDAnimationHelper}\n     */\n    enable: function enable(key, enabled) {\n      if (this.enabled[key] === undefined) {\n        throw new Error(\"THREE.MMDAnimationHelper.enable: unknown key \".concat(key));\n      }\n\n      this.enabled[key] = enabled;\n\n      if (key === 'physics') {\n        for (var i = 0, il = this.meshes.length; i < il; i++) {\n          this._optimizeIK(this.meshes[i], enabled);\n        }\n      }\n\n      return this;\n    },\n\n    /**\n     * Creates an GrantSolver instance.\n     *\n     * @param {THREE.SkinnedMesh} mesh\n     * @return {GrantSolver}\n     */\n    createGrantSolver: function createGrantSolver(mesh) {\n      return new GrantSolver(mesh, mesh.geometry.userData.MMD.grants);\n    },\n    // private methods\n    _addMesh: function _addMesh(mesh, params) {\n      if (this.meshes.indexOf(mesh) >= 0) {\n        throw new Error(\"THREE.MMDAnimationHelper._addMesh: SkinnedMesh '\".concat(mesh.name, \"' has already been added.\"));\n      }\n\n      this.meshes.push(mesh);\n      this.objects.set(mesh, {\n        looped: false\n      });\n\n      this._setupMeshAnimation(mesh, params.animation);\n\n      if (params.physics !== false) {\n        this._setupMeshPhysics(mesh, params);\n      }\n\n      return this;\n    },\n    _setupCamera: function _setupCamera(camera, params) {\n      if (this.camera === camera) {\n        throw new Error(\"THREE.MMDAnimationHelper._setupCamera: Camera '\".concat(camera.name, \"' has already been set.\"));\n      }\n\n      if (this.camera) this.clearCamera(this.camera);\n      this.camera = camera;\n      camera.add(this.cameraTarget);\n      this.objects.set(camera, {});\n\n      if (params.animation !== undefined) {\n        this._setupCameraAnimation(camera, params.animation);\n      }\n\n      return this;\n    },\n    _setupAudio: function _setupAudio(audio, params) {\n      if (this.audio === audio) {\n        throw new Error(\"THREE.MMDAnimationHelper._setupAudio: Audio '\".concat(audio.name, \"' has already been set.\"));\n      }\n\n      if (this.audio) this.clearAudio(this.audio);\n      this.audio = audio;\n      this.audioManager = new AudioManager(audio, params);\n      this.objects.set(this.audioManager, {\n        duration: this.audioManager.duration\n      });\n      return this;\n    },\n    _removeMesh: function _removeMesh(mesh) {\n      var found = false;\n      var writeIndex = 0;\n\n      for (var i = 0, il = this.meshes.length; i < il; i++) {\n        if (this.meshes[i] === mesh) {\n          this.objects.delete(mesh);\n          found = true;\n          continue;\n        }\n\n        this.meshes[writeIndex++] = this.meshes[i];\n      }\n\n      if (!found) {\n        throw new Error(\"THREE.MMDAnimationHelper._removeMesh: SkinnedMesh '\".concat(mesh.name, \"' has not been added yet.\"));\n      }\n\n      this.meshes.length = writeIndex;\n      return this;\n    },\n    _clearCamera: function _clearCamera(camera) {\n      if (camera !== this.camera) {\n        throw new Error(\"THREE.MMDAnimationHelper._clearCamera: Camera '\".concat(camera.name, \"' has not been set yet.\"));\n      }\n\n      this.camera.remove(this.cameraTarget);\n      this.objects.delete(this.camera);\n      this.camera = null;\n      return this;\n    },\n    _clearAudio: function _clearAudio(audio) {\n      if (audio !== this.audio) {\n        throw new Error(\"THREE.MMDAnimationHelper._clearAudio: Audio '\".concat(audio.name, \"' has not been set yet.\"));\n      }\n\n      this.objects.delete(this.audioManager);\n      this.audio = null;\n      this.audioManager = null;\n      return this;\n    },\n    _setupMeshAnimation: function _setupMeshAnimation(mesh, animation) {\n      var objects = this.objects.get(mesh);\n\n      if (animation !== undefined) {\n        var animations = Array.isArray(animation) ? animation : [animation];\n        objects.mixer = new AnimationMixer(mesh);\n\n        for (var i = 0, il = animations.length; i < il; i++) {\n          objects.mixer.clipAction(animations[i]).play();\n        } // TODO: find a workaround not to access ._clip looking like a private property\n\n\n        objects.mixer.addEventListener('loop', function (event) {\n          var tracks = event.action._clip.tracks;\n          if (tracks.length > 0 && tracks[0].name.slice(0, 6) !== '.bones') return;\n          objects.looped = true;\n        });\n      }\n\n      objects.ikSolver = this._createCCDIKSolver(mesh);\n      objects.grantSolver = this.createGrantSolver(mesh);\n      return this;\n    },\n    _setupCameraAnimation: function _setupCameraAnimation(camera, animation) {\n      var animations = Array.isArray(animation) ? animation : [animation];\n      var objects = this.objects.get(camera);\n      objects.mixer = new AnimationMixer(camera);\n\n      for (var i = 0, il = animations.length; i < il; i++) {\n        objects.mixer.clipAction(animations[i]).play();\n      }\n    },\n    _setupMeshPhysics: function _setupMeshPhysics(mesh, params) {\n      var objects = this.objects.get(mesh); // shared physics is experimental\n\n      if (params.world === undefined && this.sharedPhysics) {\n        var masterPhysics = this._getMasterPhysics();\n\n        if (masterPhysics !== null) world = masterPhysics.world; // eslint-disable-line no-undef\n      }\n\n      objects.physics = this._createMMDPhysics(mesh, params);\n\n      if (objects.mixer && params.animationWarmup !== false) {\n        this._animateMesh(mesh, 0);\n\n        objects.physics.reset();\n      }\n\n      objects.physics.warmup(params.warmup !== undefined ? params.warmup : 60);\n\n      this._optimizeIK(mesh, true);\n    },\n    _animateMesh: function _animateMesh(mesh, delta) {\n      var objects = this.objects.get(mesh);\n      var mixer = objects.mixer;\n      var ikSolver = objects.ikSolver;\n      var grantSolver = objects.grantSolver;\n      var physics = objects.physics;\n      var looped = objects.looped; // alternate solution to save/restore bones but less performant?\n      //mesh.pose();\n      //this._updatePropertyMixersBuffer( mesh );\n\n      if (mixer && this.enabled.animation) {\n        this._restoreBones(mesh);\n\n        mixer.update(delta);\n\n        this._saveBones(mesh);\n\n        if (ikSolver && this.enabled.ik) {\n          mesh.updateMatrixWorld(true);\n          ikSolver.update();\n        }\n\n        if (grantSolver && this.enabled.grant) {\n          grantSolver.update();\n        }\n      }\n\n      if (looped === true && this.enabled.physics) {\n        if (physics && this.configuration.resetPhysicsOnLoop) physics.reset();\n        objects.looped = false;\n      }\n\n      if (physics && this.enabled.physics && !this.sharedPhysics) {\n        this.onBeforePhysics(mesh);\n        physics.update(delta);\n      }\n    },\n    _animateCamera: function _animateCamera(camera, delta) {\n      var mixer = this.objects.get(camera).mixer;\n\n      if (mixer && this.enabled.cameraAnimation) {\n        mixer.update(delta);\n        camera.updateProjectionMatrix();\n        camera.up.set(0, 1, 0);\n        camera.up.applyQuaternion(camera.quaternion);\n        camera.lookAt(this.cameraTarget.position);\n      }\n    },\n    _optimizeIK: function _optimizeIK(mesh, physicsEnabled) {\n      var iks = mesh.geometry.userData.MMD.iks;\n      var bones = mesh.geometry.userData.MMD.bones;\n\n      for (var i = 0, il = iks.length; i < il; i++) {\n        var ik = iks[i];\n        var links = ik.links;\n\n        for (var j = 0, jl = links.length; j < jl; j++) {\n          var link = links[j];\n\n          if (physicsEnabled === true) {\n            // disable IK of the bone the corresponding rigidBody type of which is 1 or 2\n            // because its rotation will be overriden by physics\n            link.enabled = bones[link.index].rigidBodyType > 0 ? false : true;\n          } else {\n            link.enabled = true;\n          }\n        }\n      }\n    },\n    _createCCDIKSolver: function _createCCDIKSolver(mesh) {\n      if (CCDIKSolver === undefined) {\n        throw new Error('THREE.MMDAnimationHelper: Import CCDIKSolver.');\n      }\n\n      return new CCDIKSolver(mesh, mesh.geometry.userData.MMD.iks);\n    },\n    _createMMDPhysics: function _createMMDPhysics(mesh, params) {\n      if (MMDPhysics === undefined) {\n        throw new Error('THREE.MMDPhysics: Import MMDPhysics.');\n      }\n\n      return new MMDPhysics(mesh, mesh.geometry.userData.MMD.rigidBodies, mesh.geometry.userData.MMD.constraints, params);\n    },\n\n    /*\n     * Detects the longest duration and then sets it to them to sync.\n     * TODO: Not to access private properties ( ._actions and ._clip )\n     */\n    _syncDuration: function _syncDuration() {\n      var max = 0.0;\n      var objects = this.objects;\n      var meshes = this.meshes;\n      var camera = this.camera;\n      var audioManager = this.audioManager; // get the longest duration\n\n      for (var i = 0, il = meshes.length; i < il; i++) {\n        var mixer = this.objects.get(meshes[i]).mixer;\n        if (mixer === undefined) continue;\n\n        for (var j = 0; j < mixer._actions.length; j++) {\n          var clip = mixer._actions[j]._clip;\n\n          if (!objects.has(clip)) {\n            objects.set(clip, {\n              duration: clip.duration\n            });\n          }\n\n          max = Math.max(max, objects.get(clip).duration);\n        }\n      }\n\n      if (camera !== null) {\n        var mixer = this.objects.get(camera).mixer;\n\n        if (mixer !== undefined) {\n          for (var _i2 = 0, _il2 = mixer._actions.length; _i2 < _il2; _i2++) {\n            var clip = mixer._actions[_i2]._clip;\n\n            if (!objects.has(clip)) {\n              objects.set(clip, {\n                duration: clip.duration\n              });\n            }\n\n            max = Math.max(max, objects.get(clip).duration);\n          }\n        }\n      }\n\n      if (audioManager !== null) {\n        max = Math.max(max, objects.get(audioManager).duration);\n      }\n\n      max += this.configuration.afterglow; // update the duration\n\n      for (var _i3 = 0, _il3 = this.meshes.length; _i3 < _il3; _i3++) {\n        var mixer = this.objects.get(this.meshes[_i3]).mixer;\n        if (mixer === undefined) continue;\n\n        for (var _j = 0, jl = mixer._actions.length; _j < jl; _j++) {\n          mixer._actions[_j]._clip.duration = max;\n        }\n      }\n\n      if (camera !== null) {\n        var mixer = this.objects.get(camera).mixer;\n\n        if (mixer !== undefined) {\n          for (var _i4 = 0, _il4 = mixer._actions.length; _i4 < _il4; _i4++) {\n            mixer._actions[_i4]._clip.duration = max;\n          }\n        }\n      }\n\n      if (audioManager !== null) {\n        audioManager.duration = max;\n      }\n    },\n    // workaround\n    _updatePropertyMixersBuffer: function _updatePropertyMixersBuffer(mesh) {\n      var mixer = this.objects.get(mesh).mixer;\n      var propertyMixers = mixer._bindings;\n      var accuIndex = mixer._accuIndex;\n\n      for (var i = 0, il = propertyMixers.length; i < il; i++) {\n        var propertyMixer = propertyMixers[i];\n        var buffer = propertyMixer.buffer;\n        var stride = propertyMixer.valueSize;\n        var offset = (accuIndex + 1) * stride;\n        propertyMixer.binding.getValue(buffer, offset);\n      }\n    },\n\n    /*\n     * Avoiding these two issues by restore/save bones before/after mixer animation.\n     *\n     * 1. PropertyMixer used by AnimationMixer holds cache value in .buffer.\n     *    Calculating IK, Grant, and Physics after mixer animation can break\n     *    the cache coherency.\n     *\n     * 2. Applying Grant two or more times without reset the posing breaks model.\n     */\n    _saveBones: function _saveBones(mesh) {\n      var objects = this.objects.get(mesh);\n      var bones = mesh.skeleton.bones;\n      var backupBones = objects.backupBones;\n\n      if (backupBones === undefined) {\n        backupBones = new Float32Array(bones.length * 7);\n        objects.backupBones = backupBones;\n      }\n\n      for (var i = 0, il = bones.length; i < il; i++) {\n        var bone = bones[i];\n        bone.position.toArray(backupBones, i * 7);\n        bone.quaternion.toArray(backupBones, i * 7 + 3);\n      }\n    },\n    _restoreBones: function _restoreBones(mesh) {\n      var objects = this.objects.get(mesh);\n      var backupBones = objects.backupBones;\n      if (backupBones === undefined) return;\n      var bones = mesh.skeleton.bones;\n\n      for (var i = 0, il = bones.length; i < il; i++) {\n        var bone = bones[i];\n        bone.position.fromArray(backupBones, i * 7);\n        bone.quaternion.fromArray(backupBones, i * 7 + 3);\n      }\n    },\n    // experimental\n    _getMasterPhysics: function _getMasterPhysics() {\n      if (this.masterPhysics !== null) return this.masterPhysics;\n\n      for (var i = 0, il = this.meshes.length; i < il; i++) {\n        var physics = this.meshes[i].physics;\n\n        if (physics !== undefined && physics !== null) {\n          this.masterPhysics = physics;\n          return this.masterPhysics;\n        }\n      }\n\n      return null;\n    },\n    _updateSharedPhysics: function _updateSharedPhysics(delta) {\n      if (this.meshes.length === 0 || !this.enabled.physics || !this.sharedPhysics) return;\n\n      var physics = this._getMasterPhysics();\n\n      if (physics === null) return;\n\n      for (var i = 0, il = this.meshes.length; i < il; i++) {\n        var p = this.meshes[i].physics;\n\n        if (p !== null && p !== undefined) {\n          p.updateRigidBodies();\n        }\n      }\n\n      physics.stepSimulation(delta);\n\n      for (var _i5 = 0, _il5 = this.meshes.length; _i5 < _il5; _i5++) {\n        var p = this.meshes[_i5].physics;\n\n        if (p !== null && p !== undefined) {\n          p.updateBones();\n        }\n      }\n    }\n  }; //\n\n  /**\n   * @param {THREE.Audio} audio\n   * @param {Object} params - (optional)\n   * @param {Nuumber} params.delayTime\n   */\n\n  function AudioManager(audio, params) {\n    params = params || {};\n    this.audio = audio;\n    this.elapsedTime = 0.0;\n    this.currentTime = 0.0;\n    this.delayTime = params.delayTime !== undefined ? params.delayTime : 0.0;\n    this.audioDuration = this.audio.buffer.duration;\n    this.duration = this.audioDuration + this.delayTime;\n  }\n\n  AudioManager.prototype = {\n    constructor: AudioManager,\n\n    /**\n     * @param {Number} delta\n     * @return {AudioManager}\n     */\n    control: function control(delta) {\n      this.elapsed += delta;\n      this.currentTime += delta;\n      if (this._shouldStopAudio()) this.audio.stop();\n      if (this._shouldStartAudio()) this.audio.play();\n      return this;\n    },\n    // private methods\n    _shouldStartAudio: function _shouldStartAudio() {\n      if (this.audio.isPlaying) return false;\n\n      while (this.currentTime >= this.duration) {\n        this.currentTime -= this.duration;\n      }\n\n      if (this.currentTime < this.delayTime) return false; // 'duration' can be bigger than 'audioDuration + delayTime' because of sync configuration\n\n      if (this.currentTime - this.delayTime > this.audioDuration) return false;\n      return true;\n    },\n    _shouldStopAudio: function _shouldStopAudio() {\n      return this.audio.isPlaying && this.currentTime >= this.duration;\n    }\n  };\n  /**\n   * @param {THREE.SkinnedMesh} mesh\n   * @param {Array<Object>} grants\n   */\n\n  function GrantSolver(mesh, grants) {\n    this.mesh = mesh;\n    this.grants = grants || [];\n  }\n\n  GrantSolver.prototype = {\n    constructor: GrantSolver,\n\n    /**\n     * @return {GrantSolver}\n     */\n    update: function () {\n      var quaternion = new Quaternion();\n      return function () {\n        var bones = this.mesh.skeleton.bones;\n        var grants = this.grants;\n\n        for (var i = 0, il = grants.length; i < il; i++) {\n          var grant = grants[i];\n          var bone = bones[grant.index];\n          var parentBone = bones[grant.parentIndex];\n\n          if (grant.isLocal) {\n            // TODO: implement\n            if (grant.affectPosition) ; // TODO: implement\n\n            if (grant.affectRotation) ;\n          } else {\n            // TODO: implement\n            if (grant.affectPosition) ;\n\n            if (grant.affectRotation) {\n              quaternion.set(0, 0, 0, 1);\n              quaternion.slerp(parentBone.quaternion, grant.ratio);\n              bone.quaternion.multiply(quaternion);\n            }\n          }\n        }\n\n        return this;\n      };\n    }()\n  };\n  return MMDAnimationHelper;\n}();\n\nexport { MMDAnimationHelper };","map":{"version":3,"sources":["/Projects/arrayftw/node_modules/three-stdlib/animation/MMDAnimationHelper.js"],"names":["Quaternion","Object3D","Vector3","AnimationMixer","CCDIKSolver","MMDPhysics","MMDAnimationHelper","params","meshes","camera","cameraTarget","name","audio","audioManager","objects","WeakMap","configuration","sync","undefined","afterglow","resetPhysicsOnLoop","enabled","animation","ik","grant","physics","cameraAnimation","onBeforePhysics","sharedPhysics","masterPhysics","prototype","constructor","add","object","isSkinnedMesh","_addMesh","isCamera","_setupCamera","type","_setupAudio","Error","_syncDuration","remove","_removeMesh","_clearCamera","_clearAudio","update","delta","control","i","length","_animateMesh","_updateSharedPhysics","_animateCamera","pose","mesh","vpd","resetPose","bones","skeleton","boneParams","boneNameDictionary","il","vector","quaternion","boneParam","boneIndex","bone","position","fromArray","translation","multiply","updateMatrixWorld","_createCCDIKSolver","saveOriginalBonesBeforeIK","createGrantSolver","enable","key","_optimizeIK","GrantSolver","geometry","userData","MMD","grants","indexOf","push","set","looped","_setupMeshAnimation","_setupMeshPhysics","clearCamera","_setupCameraAnimation","clearAudio","AudioManager","duration","found","writeIndex","delete","get","animations","Array","isArray","mixer","clipAction","play","addEventListener","event","tracks","action","_clip","slice","ikSolver","grantSolver","world","_getMasterPhysics","_createMMDPhysics","animationWarmup","reset","warmup","_restoreBones","_saveBones","updateProjectionMatrix","up","applyQuaternion","lookAt","physicsEnabled","iks","links","j","jl","link","index","rigidBodyType","rigidBodies","constraints","max","_actions","clip","has","Math","_updatePropertyMixersBuffer","propertyMixers","_bindings","accuIndex","_accuIndex","propertyMixer","buffer","stride","valueSize","offset","binding","getValue","backupBones","Float32Array","toArray","p","updateRigidBodies","stepSimulation","updateBones","elapsedTime","currentTime","delayTime","audioDuration","elapsed","_shouldStopAudio","stop","_shouldStartAudio","isPlaying","parentBone","parentIndex","isLocal","affectPosition","affectRotation","slerp","ratio"],"mappings":"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","sourcesContent":["import { Quaternion, Object3D, Vector3, AnimationMixer } from 'three';\nimport { CCDIKSolver } from './CCDIKSolver.js';\nimport { MMDPhysics } from './MMDPhysics.js';\n\n/**\n * MMDAnimationHelper handles animation of MMD assets loaded by MMDLoader\n * with MMD special features as IK, Grant, and Physics.\n *\n * Dependencies\n *  - ammo.js https://github.com/kripken/ammo.js\n *  - MMDPhysics\n *  - CCDIKSolver\n *\n * TODO\n *  - more precise grant skinning support.\n */\n\nconst MMDAnimationHelper = (() => {\n  /**\n   * @param {Object} params - (optional)\n   * @param {boolean} params.sync - Whether animation durations of added objects are synched. Default is true.\n   * @param {Number} params.afterglow - Default is 0.0.\n   * @param {boolean} params.resetPhysicsOnLoop - Default is true.\n   */\n  function MMDAnimationHelper(params) {\n    params = params || {};\n    this.meshes = [];\n    this.camera = null;\n    this.cameraTarget = new Object3D();\n    this.cameraTarget.name = 'target';\n    this.audio = null;\n    this.audioManager = null;\n    this.objects = new WeakMap();\n    this.configuration = {\n      sync: params.sync !== undefined ? params.sync : true,\n      afterglow: params.afterglow !== undefined ? params.afterglow : 0.0,\n      resetPhysicsOnLoop: params.resetPhysicsOnLoop !== undefined ? params.resetPhysicsOnLoop : true\n    };\n    this.enabled = {\n      animation: true,\n      ik: true,\n      grant: true,\n      physics: true,\n      cameraAnimation: true\n    };\n\n    this.onBeforePhysics = () =>\n    /* mesh */\n    {}; // experimental\n\n\n    this.sharedPhysics = false;\n    this.masterPhysics = null;\n  }\n\n  MMDAnimationHelper.prototype = {\n    constructor: MMDAnimationHelper,\n\n    /**\n     * Adds an Three.js Object to helper and setups animation.\n     * The anmation durations of added objects are synched\n     * if this.configuration.sync is true.\n     *\n     * @param {THREE.SkinnedMesh|THREE.Camera|THREE.Audio} object\n     * @param {Object} params - (optional)\n     * @param {THREE.AnimationClip|Array<THREE.AnimationClip>} params.animation - Only for THREE.SkinnedMesh and THREE.Camera. Default is undefined.\n     * @param {boolean} params.physics - Only for THREE.SkinnedMesh. Default is true.\n     * @param {Integer} params.warmup - Only for THREE.SkinnedMesh and physics is true. Default is 60.\n     * @param {Number} params.unitStep - Only for THREE.SkinnedMesh and physics is true. Default is 1 / 65.\n     * @param {Integer} params.maxStepNum - Only for THREE.SkinnedMesh and physics is true. Default is 3.\n     * @param {Vector3} params.gravity - Only for THREE.SkinnedMesh and physics is true. Default ( 0, - 9.8 * 10, 0 ).\n     * @param {Number} params.delayTime - Only for THREE.Audio. Default is 0.0.\n     * @return {MMDAnimationHelper}\n     */\n    add: function (object, params) {\n      params = params || {};\n\n      if (object.isSkinnedMesh) {\n        this._addMesh(object, params);\n      } else if (object.isCamera) {\n        this._setupCamera(object, params);\n      } else if (object.type === 'Audio') {\n        this._setupAudio(object, params);\n      } else {\n        throw new Error('THREE.MMDAnimationHelper.add: ' + 'accepts only ' + 'THREE.SkinnedMesh or ' + 'THREE.Camera or ' + 'THREE.Audio instance.');\n      }\n\n      if (this.configuration.sync) this._syncDuration();\n      return this;\n    },\n\n    /**\n     * Removes an Three.js Object from helper.\n     *\n     * @param {THREE.SkinnedMesh|THREE.Camera|THREE.Audio} object\n     * @return {MMDAnimationHelper}\n     */\n    remove: function (object) {\n      if (object.isSkinnedMesh) {\n        this._removeMesh(object);\n      } else if (object.isCamera) {\n        this._clearCamera(object);\n      } else if (object.type === 'Audio') {\n        this._clearAudio(object);\n      } else {\n        throw new Error('THREE.MMDAnimationHelper.remove: ' + 'accepts only ' + 'THREE.SkinnedMesh or ' + 'THREE.Camera or ' + 'THREE.Audio instance.');\n      }\n\n      if (this.configuration.sync) this._syncDuration();\n      return this;\n    },\n\n    /**\n     * Updates the animation.\n     *\n     * @param {Number} delta\n     * @return {MMDAnimationHelper}\n     */\n    update: function (delta) {\n      if (this.audioManager !== null) this.audioManager.control(delta);\n\n      for (let i = 0; i < this.meshes.length; i++) {\n        this._animateMesh(this.meshes[i], delta);\n      }\n\n      if (this.sharedPhysics) this._updateSharedPhysics(delta);\n      if (this.camera !== null) this._animateCamera(this.camera, delta);\n      return this;\n    },\n\n    /**\n     * Changes the pose of SkinnedMesh as VPD specifies.\n     *\n     * @param {THREE.SkinnedMesh} mesh\n     * @param {Object} vpd - VPD content parsed MMDParser\n     * @param {Object} params - (optional)\n     * @param {boolean} params.resetPose - Default is true.\n     * @param {boolean} params.ik - Default is true.\n     * @param {boolean} params.grant - Default is true.\n     * @return {MMDAnimationHelper}\n     */\n    pose: function (mesh, vpd, params) {\n      params = params || {};\n      if (params.resetPose !== false) mesh.pose();\n      const bones = mesh.skeleton.bones;\n      const boneParams = vpd.bones;\n      const boneNameDictionary = {};\n\n      for (let i = 0, il = bones.length; i < il; i++) {\n        boneNameDictionary[bones[i].name] = i;\n      }\n\n      const vector = new Vector3();\n      const quaternion = new Quaternion();\n\n      for (let i = 0, il = boneParams.length; i < il; i++) {\n        const boneParam = boneParams[i];\n        const boneIndex = boneNameDictionary[boneParam.name];\n        if (boneIndex === undefined) continue;\n        const bone = bones[boneIndex];\n        bone.position.add(vector.fromArray(boneParam.translation));\n        bone.quaternion.multiply(quaternion.fromArray(boneParam.quaternion));\n      }\n\n      mesh.updateMatrixWorld(true);\n\n      if (params.ik !== false) {\n        this._createCCDIKSolver(mesh).update(params.saveOriginalBonesBeforeIK); // this param is experimental\n\n      }\n\n      if (params.grant !== false) {\n        this.createGrantSolver(mesh).update();\n      }\n\n      return this;\n    },\n\n    /**\n     * Enabes/Disables an animation feature.\n     *\n     * @param {string} key\n     * @param {boolean} enabled\n     * @return {MMDAnimationHelper}\n     */\n    enable: function (key, enabled) {\n      if (this.enabled[key] === undefined) {\n        throw new Error(`THREE.MMDAnimationHelper.enable: unknown key ${key}`);\n      }\n\n      this.enabled[key] = enabled;\n\n      if (key === 'physics') {\n        for (let i = 0, il = this.meshes.length; i < il; i++) {\n          this._optimizeIK(this.meshes[i], enabled);\n        }\n      }\n\n      return this;\n    },\n\n    /**\n     * Creates an GrantSolver instance.\n     *\n     * @param {THREE.SkinnedMesh} mesh\n     * @return {GrantSolver}\n     */\n    createGrantSolver: function (mesh) {\n      return new GrantSolver(mesh, mesh.geometry.userData.MMD.grants);\n    },\n    // private methods\n    _addMesh: function (mesh, params) {\n      if (this.meshes.indexOf(mesh) >= 0) {\n        throw new Error(`THREE.MMDAnimationHelper._addMesh: SkinnedMesh '${mesh.name}' has already been added.`);\n      }\n\n      this.meshes.push(mesh);\n      this.objects.set(mesh, {\n        looped: false\n      });\n\n      this._setupMeshAnimation(mesh, params.animation);\n\n      if (params.physics !== false) {\n        this._setupMeshPhysics(mesh, params);\n      }\n\n      return this;\n    },\n    _setupCamera: function (camera, params) {\n      if (this.camera === camera) {\n        throw new Error(`THREE.MMDAnimationHelper._setupCamera: Camera '${camera.name}' has already been set.`);\n      }\n\n      if (this.camera) this.clearCamera(this.camera);\n      this.camera = camera;\n      camera.add(this.cameraTarget);\n      this.objects.set(camera, {});\n\n      if (params.animation !== undefined) {\n        this._setupCameraAnimation(camera, params.animation);\n      }\n\n      return this;\n    },\n    _setupAudio: function (audio, params) {\n      if (this.audio === audio) {\n        throw new Error(`THREE.MMDAnimationHelper._setupAudio: Audio '${audio.name}' has already been set.`);\n      }\n\n      if (this.audio) this.clearAudio(this.audio);\n      this.audio = audio;\n      this.audioManager = new AudioManager(audio, params);\n      this.objects.set(this.audioManager, {\n        duration: this.audioManager.duration\n      });\n      return this;\n    },\n    _removeMesh: function (mesh) {\n      let found = false;\n      let writeIndex = 0;\n\n      for (let i = 0, il = this.meshes.length; i < il; i++) {\n        if (this.meshes[i] === mesh) {\n          this.objects.delete(mesh);\n          found = true;\n          continue;\n        }\n\n        this.meshes[writeIndex++] = this.meshes[i];\n      }\n\n      if (!found) {\n        throw new Error(`THREE.MMDAnimationHelper._removeMesh: SkinnedMesh '${mesh.name}' has not been added yet.`);\n      }\n\n      this.meshes.length = writeIndex;\n      return this;\n    },\n    _clearCamera: function (camera) {\n      if (camera !== this.camera) {\n        throw new Error(`THREE.MMDAnimationHelper._clearCamera: Camera '${camera.name}' has not been set yet.`);\n      }\n\n      this.camera.remove(this.cameraTarget);\n      this.objects.delete(this.camera);\n      this.camera = null;\n      return this;\n    },\n    _clearAudio: function (audio) {\n      if (audio !== this.audio) {\n        throw new Error(`THREE.MMDAnimationHelper._clearAudio: Audio '${audio.name}' has not been set yet.`);\n      }\n\n      this.objects.delete(this.audioManager);\n      this.audio = null;\n      this.audioManager = null;\n      return this;\n    },\n    _setupMeshAnimation: function (mesh, animation) {\n      const objects = this.objects.get(mesh);\n\n      if (animation !== undefined) {\n        const animations = Array.isArray(animation) ? animation : [animation];\n        objects.mixer = new AnimationMixer(mesh);\n\n        for (let i = 0, il = animations.length; i < il; i++) {\n          objects.mixer.clipAction(animations[i]).play();\n        } // TODO: find a workaround not to access ._clip looking like a private property\n\n\n        objects.mixer.addEventListener('loop', event => {\n          const tracks = event.action._clip.tracks;\n          if (tracks.length > 0 && tracks[0].name.slice(0, 6) !== '.bones') return;\n          objects.looped = true;\n        });\n      }\n\n      objects.ikSolver = this._createCCDIKSolver(mesh);\n      objects.grantSolver = this.createGrantSolver(mesh);\n      return this;\n    },\n    _setupCameraAnimation: function (camera, animation) {\n      const animations = Array.isArray(animation) ? animation : [animation];\n      const objects = this.objects.get(camera);\n      objects.mixer = new AnimationMixer(camera);\n\n      for (let i = 0, il = animations.length; i < il; i++) {\n        objects.mixer.clipAction(animations[i]).play();\n      }\n    },\n    _setupMeshPhysics: function (mesh, params) {\n      const objects = this.objects.get(mesh); // shared physics is experimental\n\n      if (params.world === undefined && this.sharedPhysics) {\n        const masterPhysics = this._getMasterPhysics();\n\n        if (masterPhysics !== null) world = masterPhysics.world; // eslint-disable-line no-undef\n      }\n\n      objects.physics = this._createMMDPhysics(mesh, params);\n\n      if (objects.mixer && params.animationWarmup !== false) {\n        this._animateMesh(mesh, 0);\n\n        objects.physics.reset();\n      }\n\n      objects.physics.warmup(params.warmup !== undefined ? params.warmup : 60);\n\n      this._optimizeIK(mesh, true);\n    },\n    _animateMesh: function (mesh, delta) {\n      const objects = this.objects.get(mesh);\n      const mixer = objects.mixer;\n      const ikSolver = objects.ikSolver;\n      const grantSolver = objects.grantSolver;\n      const physics = objects.physics;\n      const looped = objects.looped; // alternate solution to save/restore bones but less performant?\n      //mesh.pose();\n      //this._updatePropertyMixersBuffer( mesh );\n\n      if (mixer && this.enabled.animation) {\n        this._restoreBones(mesh);\n\n        mixer.update(delta);\n\n        this._saveBones(mesh);\n\n        if (ikSolver && this.enabled.ik) {\n          mesh.updateMatrixWorld(true);\n          ikSolver.update();\n        }\n\n        if (grantSolver && this.enabled.grant) {\n          grantSolver.update();\n        }\n      }\n\n      if (looped === true && this.enabled.physics) {\n        if (physics && this.configuration.resetPhysicsOnLoop) physics.reset();\n        objects.looped = false;\n      }\n\n      if (physics && this.enabled.physics && !this.sharedPhysics) {\n        this.onBeforePhysics(mesh);\n        physics.update(delta);\n      }\n    },\n    _animateCamera: function (camera, delta) {\n      const mixer = this.objects.get(camera).mixer;\n\n      if (mixer && this.enabled.cameraAnimation) {\n        mixer.update(delta);\n        camera.updateProjectionMatrix();\n        camera.up.set(0, 1, 0);\n        camera.up.applyQuaternion(camera.quaternion);\n        camera.lookAt(this.cameraTarget.position);\n      }\n    },\n    _optimizeIK: function (mesh, physicsEnabled) {\n      const iks = mesh.geometry.userData.MMD.iks;\n      const bones = mesh.geometry.userData.MMD.bones;\n\n      for (let i = 0, il = iks.length; i < il; i++) {\n        const ik = iks[i];\n        const links = ik.links;\n\n        for (let j = 0, jl = links.length; j < jl; j++) {\n          const link = links[j];\n\n          if (physicsEnabled === true) {\n            // disable IK of the bone the corresponding rigidBody type of which is 1 or 2\n            // because its rotation will be overriden by physics\n            link.enabled = bones[link.index].rigidBodyType > 0 ? false : true;\n          } else {\n            link.enabled = true;\n          }\n        }\n      }\n    },\n    _createCCDIKSolver: function (mesh) {\n      if (CCDIKSolver === undefined) {\n        throw new Error('THREE.MMDAnimationHelper: Import CCDIKSolver.');\n      }\n\n      return new CCDIKSolver(mesh, mesh.geometry.userData.MMD.iks);\n    },\n    _createMMDPhysics: function (mesh, params) {\n      if (MMDPhysics === undefined) {\n        throw new Error('THREE.MMDPhysics: Import MMDPhysics.');\n      }\n\n      return new MMDPhysics(mesh, mesh.geometry.userData.MMD.rigidBodies, mesh.geometry.userData.MMD.constraints, params);\n    },\n\n    /*\n     * Detects the longest duration and then sets it to them to sync.\n     * TODO: Not to access private properties ( ._actions and ._clip )\n     */\n    _syncDuration: function () {\n      let max = 0.0;\n      const objects = this.objects;\n      const meshes = this.meshes;\n      const camera = this.camera;\n      const audioManager = this.audioManager; // get the longest duration\n\n      for (let i = 0, il = meshes.length; i < il; i++) {\n        var mixer = this.objects.get(meshes[i]).mixer;\n        if (mixer === undefined) continue;\n\n        for (let j = 0; j < mixer._actions.length; j++) {\n          var clip = mixer._actions[j]._clip;\n\n          if (!objects.has(clip)) {\n            objects.set(clip, {\n              duration: clip.duration\n            });\n          }\n\n          max = Math.max(max, objects.get(clip).duration);\n        }\n      }\n\n      if (camera !== null) {\n        var mixer = this.objects.get(camera).mixer;\n\n        if (mixer !== undefined) {\n          for (let i = 0, il = mixer._actions.length; i < il; i++) {\n            var clip = mixer._actions[i]._clip;\n\n            if (!objects.has(clip)) {\n              objects.set(clip, {\n                duration: clip.duration\n              });\n            }\n\n            max = Math.max(max, objects.get(clip).duration);\n          }\n        }\n      }\n\n      if (audioManager !== null) {\n        max = Math.max(max, objects.get(audioManager).duration);\n      }\n\n      max += this.configuration.afterglow; // update the duration\n\n      for (let i = 0, il = this.meshes.length; i < il; i++) {\n        var mixer = this.objects.get(this.meshes[i]).mixer;\n        if (mixer === undefined) continue;\n\n        for (let j = 0, jl = mixer._actions.length; j < jl; j++) {\n          mixer._actions[j]._clip.duration = max;\n        }\n      }\n\n      if (camera !== null) {\n        var mixer = this.objects.get(camera).mixer;\n\n        if (mixer !== undefined) {\n          for (let i = 0, il = mixer._actions.length; i < il; i++) {\n            mixer._actions[i]._clip.duration = max;\n          }\n        }\n      }\n\n      if (audioManager !== null) {\n        audioManager.duration = max;\n      }\n    },\n    // workaround\n    _updatePropertyMixersBuffer: function (mesh) {\n      const mixer = this.objects.get(mesh).mixer;\n      const propertyMixers = mixer._bindings;\n      const accuIndex = mixer._accuIndex;\n\n      for (let i = 0, il = propertyMixers.length; i < il; i++) {\n        const propertyMixer = propertyMixers[i];\n        const buffer = propertyMixer.buffer;\n        const stride = propertyMixer.valueSize;\n        const offset = (accuIndex + 1) * stride;\n        propertyMixer.binding.getValue(buffer, offset);\n      }\n    },\n\n    /*\n     * Avoiding these two issues by restore/save bones before/after mixer animation.\n     *\n     * 1. PropertyMixer used by AnimationMixer holds cache value in .buffer.\n     *    Calculating IK, Grant, and Physics after mixer animation can break\n     *    the cache coherency.\n     *\n     * 2. Applying Grant two or more times without reset the posing breaks model.\n     */\n    _saveBones: function (mesh) {\n      const objects = this.objects.get(mesh);\n      const bones = mesh.skeleton.bones;\n      let backupBones = objects.backupBones;\n\n      if (backupBones === undefined) {\n        backupBones = new Float32Array(bones.length * 7);\n        objects.backupBones = backupBones;\n      }\n\n      for (let i = 0, il = bones.length; i < il; i++) {\n        const bone = bones[i];\n        bone.position.toArray(backupBones, i * 7);\n        bone.quaternion.toArray(backupBones, i * 7 + 3);\n      }\n    },\n    _restoreBones: function (mesh) {\n      const objects = this.objects.get(mesh);\n      const backupBones = objects.backupBones;\n      if (backupBones === undefined) return;\n      const bones = mesh.skeleton.bones;\n\n      for (let i = 0, il = bones.length; i < il; i++) {\n        const bone = bones[i];\n        bone.position.fromArray(backupBones, i * 7);\n        bone.quaternion.fromArray(backupBones, i * 7 + 3);\n      }\n    },\n    // experimental\n    _getMasterPhysics: function () {\n      if (this.masterPhysics !== null) return this.masterPhysics;\n\n      for (let i = 0, il = this.meshes.length; i < il; i++) {\n        const physics = this.meshes[i].physics;\n\n        if (physics !== undefined && physics !== null) {\n          this.masterPhysics = physics;\n          return this.masterPhysics;\n        }\n      }\n\n      return null;\n    },\n    _updateSharedPhysics: function (delta) {\n      if (this.meshes.length === 0 || !this.enabled.physics || !this.sharedPhysics) return;\n\n      const physics = this._getMasterPhysics();\n\n      if (physics === null) return;\n\n      for (let i = 0, il = this.meshes.length; i < il; i++) {\n        var p = this.meshes[i].physics;\n\n        if (p !== null && p !== undefined) {\n          p.updateRigidBodies();\n        }\n      }\n\n      physics.stepSimulation(delta);\n\n      for (let i = 0, il = this.meshes.length; i < il; i++) {\n        var p = this.meshes[i].physics;\n\n        if (p !== null && p !== undefined) {\n          p.updateBones();\n        }\n      }\n    }\n  }; //\n\n  /**\n   * @param {THREE.Audio} audio\n   * @param {Object} params - (optional)\n   * @param {Nuumber} params.delayTime\n   */\n\n  function AudioManager(audio, params) {\n    params = params || {};\n    this.audio = audio;\n    this.elapsedTime = 0.0;\n    this.currentTime = 0.0;\n    this.delayTime = params.delayTime !== undefined ? params.delayTime : 0.0;\n    this.audioDuration = this.audio.buffer.duration;\n    this.duration = this.audioDuration + this.delayTime;\n  }\n\n  AudioManager.prototype = {\n    constructor: AudioManager,\n\n    /**\n     * @param {Number} delta\n     * @return {AudioManager}\n     */\n    control: function (delta) {\n      this.elapsed += delta;\n      this.currentTime += delta;\n      if (this._shouldStopAudio()) this.audio.stop();\n      if (this._shouldStartAudio()) this.audio.play();\n      return this;\n    },\n    // private methods\n    _shouldStartAudio: function () {\n      if (this.audio.isPlaying) return false;\n\n      while (this.currentTime >= this.duration) {\n        this.currentTime -= this.duration;\n      }\n\n      if (this.currentTime < this.delayTime) return false; // 'duration' can be bigger than 'audioDuration + delayTime' because of sync configuration\n\n      if (this.currentTime - this.delayTime > this.audioDuration) return false;\n      return true;\n    },\n    _shouldStopAudio: function () {\n      return this.audio.isPlaying && this.currentTime >= this.duration;\n    }\n  };\n  /**\n   * @param {THREE.SkinnedMesh} mesh\n   * @param {Array<Object>} grants\n   */\n\n  function GrantSolver(mesh, grants) {\n    this.mesh = mesh;\n    this.grants = grants || [];\n  }\n\n  GrantSolver.prototype = {\n    constructor: GrantSolver,\n\n    /**\n     * @return {GrantSolver}\n     */\n    update: (() => {\n      const quaternion = new Quaternion();\n      return function () {\n        const bones = this.mesh.skeleton.bones;\n        const grants = this.grants;\n\n        for (let i = 0, il = grants.length; i < il; i++) {\n          const grant = grants[i];\n          const bone = bones[grant.index];\n          const parentBone = bones[grant.parentIndex];\n\n          if (grant.isLocal) {\n            // TODO: implement\n            if (grant.affectPosition) ; // TODO: implement\n\n\n            if (grant.affectRotation) ;\n          } else {\n            // TODO: implement\n            if (grant.affectPosition) ;\n\n            if (grant.affectRotation) {\n              quaternion.set(0, 0, 0, 1);\n              quaternion.slerp(parentBone.quaternion, grant.ratio);\n              bone.quaternion.multiply(quaternion);\n            }\n          }\n        }\n\n        return this;\n      };\n    })()\n  };\n  return MMDAnimationHelper;\n})();\n\nexport { MMDAnimationHelper };\n"]},"metadata":{},"sourceType":"module"}