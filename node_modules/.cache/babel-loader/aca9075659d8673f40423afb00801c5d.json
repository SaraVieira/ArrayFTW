{"ast":null,"code":"import { Object3D, Box3, MathUtils, TextureLoader, UVMapping, sRGBEncoding, MeshLambertMaterial } from 'three';\nimport { MD2Loader } from '../loaders/MD2Loader.js';\nimport { MorphBlendMesh } from './MorphBlendMesh.js';\n\nvar MD2CharacterComplex = function MD2CharacterComplex() {\n  var scope = this;\n  this.scale = 1; // animation parameters\n\n  this.animationFPS = 6;\n  this.transitionFrames = 15; // movement model parameters\n\n  this.maxSpeed = 275;\n  this.maxReverseSpeed = -275;\n  this.frontAcceleration = 600;\n  this.backAcceleration = 600;\n  this.frontDecceleration = 600;\n  this.angularSpeed = 2.5; // rig\n\n  this.root = new Object3D();\n  this.meshBody = null;\n  this.meshWeapon = null;\n  this.controls = null; // skins\n\n  this.skinsBody = [];\n  this.skinsWeapon = [];\n  this.weapons = [];\n  this.currentSkin = undefined; //\n\n  this.onLoadComplete = function () {}; // internals\n\n\n  this.meshes = [];\n  this.animations = {};\n  this.loadCounter = 0; // internal movement control variables\n\n  this.speed = 0;\n  this.bodyOrientation = 0;\n  this.walkSpeed = this.maxSpeed;\n  this.crouchSpeed = this.maxSpeed * 0.5; // internal animation parameters\n\n  this.activeAnimation = null;\n  this.oldAnimation = null; // API\n\n  this.enableShadows = function (enable) {\n    for (var i = 0; i < this.meshes.length; i++) {\n      this.meshes[i].castShadow = enable;\n      this.meshes[i].receiveShadow = enable;\n    }\n  };\n\n  this.setVisible = function (enable) {\n    for (var i = 0; i < this.meshes.length; i++) {\n      this.meshes[i].visible = enable;\n      this.meshes[i].visible = enable;\n    }\n  };\n\n  this.shareParts = function (original) {\n    this.animations = original.animations;\n    this.walkSpeed = original.walkSpeed;\n    this.crouchSpeed = original.crouchSpeed;\n    this.skinsBody = original.skinsBody;\n    this.skinsWeapon = original.skinsWeapon; // BODY\n\n    var mesh = createPart(original.meshBody.geometry, this.skinsBody[0]);\n    mesh.scale.set(this.scale, this.scale, this.scale);\n    this.root.position.y = original.root.position.y;\n    this.root.add(mesh);\n    this.meshBody = mesh;\n    this.meshes.push(mesh); // WEAPONS\n\n    for (var i = 0; i < original.weapons.length; i++) {\n      var meshWeapon = createPart(original.weapons[i].geometry, this.skinsWeapon[i]);\n      meshWeapon.scale.set(this.scale, this.scale, this.scale);\n      meshWeapon.visible = false;\n      meshWeapon.name = original.weapons[i].name;\n      this.root.add(meshWeapon);\n      this.weapons[i] = meshWeapon;\n      this.meshWeapon = meshWeapon;\n      this.meshes.push(meshWeapon);\n    }\n  };\n\n  this.loadParts = function (config) {\n    this.animations = config.animations;\n    this.walkSpeed = config.walkSpeed;\n    this.crouchSpeed = config.crouchSpeed;\n    this.loadCounter = config.weapons.length * 2 + config.skins.length + 1;\n    var weaponsTextures = [];\n\n    for (var i = 0; i < config.weapons.length; i++) {\n      weaponsTextures[i] = config.weapons[i][1];\n    } // SKINS\n\n\n    this.skinsBody = loadTextures(config.baseUrl + 'skins/', config.skins);\n    this.skinsWeapon = loadTextures(config.baseUrl + 'skins/', weaponsTextures); // BODY\n\n    var loader = new MD2Loader();\n    loader.load(config.baseUrl + config.body, function (geo) {\n      var boundingBox = new Box3();\n      boundingBox.setFromBufferAttribute(geo.attributes.position);\n      scope.root.position.y = -scope.scale * boundingBox.min.y;\n      var mesh = createPart(geo, scope.skinsBody[0]);\n      mesh.scale.set(scope.scale, scope.scale, scope.scale);\n      scope.root.add(mesh);\n      scope.meshBody = mesh;\n      scope.meshes.push(mesh);\n      checkLoadingComplete();\n    }); // WEAPONS\n\n    var generateCallback = function generateCallback(index, name) {\n      return function (geo) {\n        var mesh = createPart(geo, scope.skinsWeapon[index]);\n        mesh.scale.set(scope.scale, scope.scale, scope.scale);\n        mesh.visible = false;\n        mesh.name = name;\n        scope.root.add(mesh);\n        scope.weapons[index] = mesh;\n        scope.meshWeapon = mesh;\n        scope.meshes.push(mesh);\n        checkLoadingComplete();\n      };\n    };\n\n    for (var _i = 0; _i < config.weapons.length; _i++) {\n      loader.load(config.baseUrl + config.weapons[_i][0], generateCallback(_i, config.weapons[_i][0]));\n    }\n  };\n\n  this.setPlaybackRate = function (rate) {\n    if (this.meshBody) this.meshBody.duration = this.meshBody.baseDuration / rate;\n    if (this.meshWeapon) this.meshWeapon.duration = this.meshWeapon.baseDuration / rate;\n  };\n\n  this.setWireframe = function (wireframeEnabled) {\n    if (wireframeEnabled) {\n      if (this.meshBody) this.meshBody.material = this.meshBody.materialWireframe;\n      if (this.meshWeapon) this.meshWeapon.material = this.meshWeapon.materialWireframe;\n    } else {\n      if (this.meshBody) this.meshBody.material = this.meshBody.materialTexture;\n      if (this.meshWeapon) this.meshWeapon.material = this.meshWeapon.materialTexture;\n    }\n  };\n\n  this.setSkin = function (index) {\n    if (this.meshBody && this.meshBody.material.wireframe === false) {\n      this.meshBody.material.map = this.skinsBody[index];\n      this.currentSkin = index;\n    }\n  };\n\n  this.setWeapon = function (index) {\n    for (var i = 0; i < this.weapons.length; i++) {\n      this.weapons[i].visible = false;\n    }\n\n    var activeWeapon = this.weapons[index];\n\n    if (activeWeapon) {\n      activeWeapon.visible = true;\n      this.meshWeapon = activeWeapon;\n\n      if (this.activeAnimation) {\n        activeWeapon.playAnimation(this.activeAnimation);\n        this.meshWeapon.setAnimationTime(this.activeAnimation, this.meshBody.getAnimationTime(this.activeAnimation));\n      }\n    }\n  };\n\n  this.setAnimation = function (animationName) {\n    if (animationName === this.activeAnimation || !animationName) return;\n\n    if (this.meshBody) {\n      this.meshBody.setAnimationWeight(animationName, 0);\n      this.meshBody.playAnimation(animationName);\n      this.oldAnimation = this.activeAnimation;\n      this.activeAnimation = animationName;\n      this.blendCounter = this.transitionFrames;\n    }\n\n    if (this.meshWeapon) {\n      this.meshWeapon.setAnimationWeight(animationName, 0);\n      this.meshWeapon.playAnimation(animationName);\n    }\n  };\n\n  this.update = function (delta) {\n    if (this.controls) this.updateMovementModel(delta);\n\n    if (this.animations) {\n      this.updateBehaviors();\n      this.updateAnimations(delta);\n    }\n  };\n\n  this.updateAnimations = function (delta) {\n    var mix = 1;\n\n    if (this.blendCounter > 0) {\n      mix = (this.transitionFrames - this.blendCounter) / this.transitionFrames;\n      this.blendCounter -= 1;\n    }\n\n    if (this.meshBody) {\n      this.meshBody.update(delta);\n      this.meshBody.setAnimationWeight(this.activeAnimation, mix);\n      this.meshBody.setAnimationWeight(this.oldAnimation, 1 - mix);\n    }\n\n    if (this.meshWeapon) {\n      this.meshWeapon.update(delta);\n      this.meshWeapon.setAnimationWeight(this.activeAnimation, mix);\n      this.meshWeapon.setAnimationWeight(this.oldAnimation, 1 - mix);\n    }\n  };\n\n  this.updateBehaviors = function () {\n    var controls = this.controls;\n    var animations = this.animations;\n    var moveAnimation, idleAnimation; // crouch vs stand\n\n    if (controls.crouch) {\n      moveAnimation = animations['crouchMove'];\n      idleAnimation = animations['crouchIdle'];\n    } else {\n      moveAnimation = animations['move'];\n      idleAnimation = animations['idle'];\n    } // actions\n\n\n    if (controls.jump) {\n      moveAnimation = animations['jump'];\n      idleAnimation = animations['jump'];\n    }\n\n    if (controls.attack) {\n      if (controls.crouch) {\n        moveAnimation = animations['crouchAttack'];\n        idleAnimation = animations['crouchAttack'];\n      } else {\n        moveAnimation = animations['attack'];\n        idleAnimation = animations['attack'];\n      }\n    } // set animations\n\n\n    if (controls.moveForward || controls.moveBackward || controls.moveLeft || controls.moveRight) {\n      if (this.activeAnimation !== moveAnimation) {\n        this.setAnimation(moveAnimation);\n      }\n    }\n\n    if (Math.abs(this.speed) < 0.2 * this.maxSpeed && !(controls.moveLeft || controls.moveRight || controls.moveForward || controls.moveBackward)) {\n      if (this.activeAnimation !== idleAnimation) {\n        this.setAnimation(idleAnimation);\n      }\n    } // set animation direction\n\n\n    if (controls.moveForward) {\n      if (this.meshBody) {\n        this.meshBody.setAnimationDirectionForward(this.activeAnimation);\n        this.meshBody.setAnimationDirectionForward(this.oldAnimation);\n      }\n\n      if (this.meshWeapon) {\n        this.meshWeapon.setAnimationDirectionForward(this.activeAnimation);\n        this.meshWeapon.setAnimationDirectionForward(this.oldAnimation);\n      }\n    }\n\n    if (controls.moveBackward) {\n      if (this.meshBody) {\n        this.meshBody.setAnimationDirectionBackward(this.activeAnimation);\n        this.meshBody.setAnimationDirectionBackward(this.oldAnimation);\n      }\n\n      if (this.meshWeapon) {\n        this.meshWeapon.setAnimationDirectionBackward(this.activeAnimation);\n        this.meshWeapon.setAnimationDirectionBackward(this.oldAnimation);\n      }\n    }\n  };\n\n  this.updateMovementModel = function (delta) {\n    var controls = this.controls; // speed based on controls\n\n    if (controls.crouch) this.maxSpeed = this.crouchSpeed;else this.maxSpeed = this.walkSpeed;\n    this.maxReverseSpeed = -this.maxSpeed;\n    if (controls.moveForward) this.speed = MathUtils.clamp(this.speed + delta * this.frontAcceleration, this.maxReverseSpeed, this.maxSpeed);\n    if (controls.moveBackward) this.speed = MathUtils.clamp(this.speed - delta * this.backAcceleration, this.maxReverseSpeed, this.maxSpeed); // orientation based on controls\n    // (don't just stand while turning)\n\n    var dir = 1;\n\n    if (controls.moveLeft) {\n      this.bodyOrientation += delta * this.angularSpeed;\n      this.speed = MathUtils.clamp(this.speed + dir * delta * this.frontAcceleration, this.maxReverseSpeed, this.maxSpeed);\n    }\n\n    if (controls.moveRight) {\n      this.bodyOrientation -= delta * this.angularSpeed;\n      this.speed = MathUtils.clamp(this.speed + dir * delta * this.frontAcceleration, this.maxReverseSpeed, this.maxSpeed);\n    } // speed decay\n\n\n    if (!(controls.moveForward || controls.moveBackward)) {\n      if (this.speed > 0) {\n        var k = exponentialEaseOut(this.speed / this.maxSpeed);\n        this.speed = MathUtils.clamp(this.speed - k * delta * this.frontDecceleration, 0, this.maxSpeed);\n      } else {\n        var k = exponentialEaseOut(this.speed / this.maxReverseSpeed);\n        this.speed = MathUtils.clamp(this.speed + k * delta * this.backAcceleration, this.maxReverseSpeed, 0);\n      }\n    } // displacement\n\n\n    var forwardDelta = this.speed * delta;\n    this.root.position.x += Math.sin(this.bodyOrientation) * forwardDelta;\n    this.root.position.z += Math.cos(this.bodyOrientation) * forwardDelta; // steering\n\n    this.root.rotation.y = this.bodyOrientation;\n  }; // internal helpers\n\n\n  function loadTextures(baseUrl, textureUrls) {\n    var textureLoader = new TextureLoader();\n    var textures = [];\n\n    for (var i = 0; i < textureUrls.length; i++) {\n      textures[i] = textureLoader.load(baseUrl + textureUrls[i], checkLoadingComplete);\n      textures[i].mapping = UVMapping;\n      textures[i].name = textureUrls[i];\n      textures[i].encoding = sRGBEncoding;\n    }\n\n    return textures;\n  }\n\n  function createPart(geometry, skinMap) {\n    var materialWireframe = new MeshLambertMaterial({\n      color: 0xffaa00,\n      wireframe: true,\n      morphTargets: true,\n      morphNormals: true\n    });\n    var materialTexture = new MeshLambertMaterial({\n      color: 0xffffff,\n      wireframe: false,\n      map: skinMap,\n      morphTargets: true,\n      morphNormals: true\n    }); //\n\n    var mesh = new MorphBlendMesh(geometry, materialTexture);\n    mesh.rotation.y = -Math.PI / 2; //\n\n    mesh.materialTexture = materialTexture;\n    mesh.materialWireframe = materialWireframe; //\n\n    mesh.autoCreateAnimations(scope.animationFPS);\n    return mesh;\n  }\n\n  function checkLoadingComplete() {\n    scope.loadCounter -= 1;\n    if (scope.loadCounter === 0) scope.onLoadComplete();\n  }\n\n  function exponentialEaseOut(k) {\n    return k === 1 ? 1 : -Math.pow(2, -10 * k) + 1;\n  }\n};\n\nexport { MD2CharacterComplex };","map":{"version":3,"sources":["/Projects/arrayftw/node_modules/three-stdlib/misc/MD2CharacterComplex.js"],"names":["Object3D","Box3","MathUtils","TextureLoader","UVMapping","sRGBEncoding","MeshLambertMaterial","MD2Loader","MorphBlendMesh","MD2CharacterComplex","scope","scale","animationFPS","transitionFrames","maxSpeed","maxReverseSpeed","frontAcceleration","backAcceleration","frontDecceleration","angularSpeed","root","meshBody","meshWeapon","controls","skinsBody","skinsWeapon","weapons","currentSkin","undefined","onLoadComplete","meshes","animations","loadCounter","speed","bodyOrientation","walkSpeed","crouchSpeed","activeAnimation","oldAnimation","enableShadows","enable","i","length","castShadow","receiveShadow","setVisible","visible","shareParts","original","mesh","createPart","geometry","set","position","y","add","push","name","loadParts","config","skins","weaponsTextures","loadTextures","baseUrl","loader","load","body","geo","boundingBox","setFromBufferAttribute","attributes","min","checkLoadingComplete","generateCallback","index","setPlaybackRate","rate","duration","baseDuration","setWireframe","wireframeEnabled","material","materialWireframe","materialTexture","setSkin","wireframe","map","setWeapon","activeWeapon","playAnimation","setAnimationTime","getAnimationTime","setAnimation","animationName","setAnimationWeight","blendCounter","update","delta","updateMovementModel","updateBehaviors","updateAnimations","mix","moveAnimation","idleAnimation","crouch","jump","attack","moveForward","moveBackward","moveLeft","moveRight","Math","abs","setAnimationDirectionForward","setAnimationDirectionBackward","clamp","dir","k","exponentialEaseOut","forwardDelta","x","sin","z","cos","rotation","textureUrls","textureLoader","textures","mapping","encoding","skinMap","color","morphTargets","morphNormals","PI","autoCreateAnimations","pow"],"mappings":"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","sourcesContent":["import { Object3D, Box3, MathUtils, TextureLoader, UVMapping, sRGBEncoding, MeshLambertMaterial } from 'three';\nimport { MD2Loader } from '../loaders/MD2Loader.js';\nimport { MorphBlendMesh } from './MorphBlendMesh.js';\n\nvar MD2CharacterComplex = function () {\n  var scope = this;\n  this.scale = 1; // animation parameters\n\n  this.animationFPS = 6;\n  this.transitionFrames = 15; // movement model parameters\n\n  this.maxSpeed = 275;\n  this.maxReverseSpeed = -275;\n  this.frontAcceleration = 600;\n  this.backAcceleration = 600;\n  this.frontDecceleration = 600;\n  this.angularSpeed = 2.5; // rig\n\n  this.root = new Object3D();\n  this.meshBody = null;\n  this.meshWeapon = null;\n  this.controls = null; // skins\n\n  this.skinsBody = [];\n  this.skinsWeapon = [];\n  this.weapons = [];\n  this.currentSkin = undefined; //\n\n  this.onLoadComplete = function () {}; // internals\n\n\n  this.meshes = [];\n  this.animations = {};\n  this.loadCounter = 0; // internal movement control variables\n\n  this.speed = 0;\n  this.bodyOrientation = 0;\n  this.walkSpeed = this.maxSpeed;\n  this.crouchSpeed = this.maxSpeed * 0.5; // internal animation parameters\n\n  this.activeAnimation = null;\n  this.oldAnimation = null; // API\n\n  this.enableShadows = function (enable) {\n    for (let i = 0; i < this.meshes.length; i++) {\n      this.meshes[i].castShadow = enable;\n      this.meshes[i].receiveShadow = enable;\n    }\n  };\n\n  this.setVisible = function (enable) {\n    for (let i = 0; i < this.meshes.length; i++) {\n      this.meshes[i].visible = enable;\n      this.meshes[i].visible = enable;\n    }\n  };\n\n  this.shareParts = function (original) {\n    this.animations = original.animations;\n    this.walkSpeed = original.walkSpeed;\n    this.crouchSpeed = original.crouchSpeed;\n    this.skinsBody = original.skinsBody;\n    this.skinsWeapon = original.skinsWeapon; // BODY\n\n    var mesh = createPart(original.meshBody.geometry, this.skinsBody[0]);\n    mesh.scale.set(this.scale, this.scale, this.scale);\n    this.root.position.y = original.root.position.y;\n    this.root.add(mesh);\n    this.meshBody = mesh;\n    this.meshes.push(mesh); // WEAPONS\n\n    for (let i = 0; i < original.weapons.length; i++) {\n      var meshWeapon = createPart(original.weapons[i].geometry, this.skinsWeapon[i]);\n      meshWeapon.scale.set(this.scale, this.scale, this.scale);\n      meshWeapon.visible = false;\n      meshWeapon.name = original.weapons[i].name;\n      this.root.add(meshWeapon);\n      this.weapons[i] = meshWeapon;\n      this.meshWeapon = meshWeapon;\n      this.meshes.push(meshWeapon);\n    }\n  };\n\n  this.loadParts = function (config) {\n    this.animations = config.animations;\n    this.walkSpeed = config.walkSpeed;\n    this.crouchSpeed = config.crouchSpeed;\n    this.loadCounter = config.weapons.length * 2 + config.skins.length + 1;\n    var weaponsTextures = [];\n\n    for (let i = 0; i < config.weapons.length; i++) weaponsTextures[i] = config.weapons[i][1]; // SKINS\n\n\n    this.skinsBody = loadTextures(config.baseUrl + 'skins/', config.skins);\n    this.skinsWeapon = loadTextures(config.baseUrl + 'skins/', weaponsTextures); // BODY\n\n    var loader = new MD2Loader();\n    loader.load(config.baseUrl + config.body, function (geo) {\n      var boundingBox = new Box3();\n      boundingBox.setFromBufferAttribute(geo.attributes.position);\n      scope.root.position.y = -scope.scale * boundingBox.min.y;\n      var mesh = createPart(geo, scope.skinsBody[0]);\n      mesh.scale.set(scope.scale, scope.scale, scope.scale);\n      scope.root.add(mesh);\n      scope.meshBody = mesh;\n      scope.meshes.push(mesh);\n      checkLoadingComplete();\n    }); // WEAPONS\n\n    var generateCallback = function (index, name) {\n      return function (geo) {\n        var mesh = createPart(geo, scope.skinsWeapon[index]);\n        mesh.scale.set(scope.scale, scope.scale, scope.scale);\n        mesh.visible = false;\n        mesh.name = name;\n        scope.root.add(mesh);\n        scope.weapons[index] = mesh;\n        scope.meshWeapon = mesh;\n        scope.meshes.push(mesh);\n        checkLoadingComplete();\n      };\n    };\n\n    for (let i = 0; i < config.weapons.length; i++) {\n      loader.load(config.baseUrl + config.weapons[i][0], generateCallback(i, config.weapons[i][0]));\n    }\n  };\n\n  this.setPlaybackRate = function (rate) {\n    if (this.meshBody) this.meshBody.duration = this.meshBody.baseDuration / rate;\n    if (this.meshWeapon) this.meshWeapon.duration = this.meshWeapon.baseDuration / rate;\n  };\n\n  this.setWireframe = function (wireframeEnabled) {\n    if (wireframeEnabled) {\n      if (this.meshBody) this.meshBody.material = this.meshBody.materialWireframe;\n      if (this.meshWeapon) this.meshWeapon.material = this.meshWeapon.materialWireframe;\n    } else {\n      if (this.meshBody) this.meshBody.material = this.meshBody.materialTexture;\n      if (this.meshWeapon) this.meshWeapon.material = this.meshWeapon.materialTexture;\n    }\n  };\n\n  this.setSkin = function (index) {\n    if (this.meshBody && this.meshBody.material.wireframe === false) {\n      this.meshBody.material.map = this.skinsBody[index];\n      this.currentSkin = index;\n    }\n  };\n\n  this.setWeapon = function (index) {\n    for (let i = 0; i < this.weapons.length; i++) this.weapons[i].visible = false;\n\n    var activeWeapon = this.weapons[index];\n\n    if (activeWeapon) {\n      activeWeapon.visible = true;\n      this.meshWeapon = activeWeapon;\n\n      if (this.activeAnimation) {\n        activeWeapon.playAnimation(this.activeAnimation);\n        this.meshWeapon.setAnimationTime(this.activeAnimation, this.meshBody.getAnimationTime(this.activeAnimation));\n      }\n    }\n  };\n\n  this.setAnimation = function (animationName) {\n    if (animationName === this.activeAnimation || !animationName) return;\n\n    if (this.meshBody) {\n      this.meshBody.setAnimationWeight(animationName, 0);\n      this.meshBody.playAnimation(animationName);\n      this.oldAnimation = this.activeAnimation;\n      this.activeAnimation = animationName;\n      this.blendCounter = this.transitionFrames;\n    }\n\n    if (this.meshWeapon) {\n      this.meshWeapon.setAnimationWeight(animationName, 0);\n      this.meshWeapon.playAnimation(animationName);\n    }\n  };\n\n  this.update = function (delta) {\n    if (this.controls) this.updateMovementModel(delta);\n\n    if (this.animations) {\n      this.updateBehaviors();\n      this.updateAnimations(delta);\n    }\n  };\n\n  this.updateAnimations = function (delta) {\n    var mix = 1;\n\n    if (this.blendCounter > 0) {\n      mix = (this.transitionFrames - this.blendCounter) / this.transitionFrames;\n      this.blendCounter -= 1;\n    }\n\n    if (this.meshBody) {\n      this.meshBody.update(delta);\n      this.meshBody.setAnimationWeight(this.activeAnimation, mix);\n      this.meshBody.setAnimationWeight(this.oldAnimation, 1 - mix);\n    }\n\n    if (this.meshWeapon) {\n      this.meshWeapon.update(delta);\n      this.meshWeapon.setAnimationWeight(this.activeAnimation, mix);\n      this.meshWeapon.setAnimationWeight(this.oldAnimation, 1 - mix);\n    }\n  };\n\n  this.updateBehaviors = function () {\n    var controls = this.controls;\n    var animations = this.animations;\n    var moveAnimation, idleAnimation; // crouch vs stand\n\n    if (controls.crouch) {\n      moveAnimation = animations['crouchMove'];\n      idleAnimation = animations['crouchIdle'];\n    } else {\n      moveAnimation = animations['move'];\n      idleAnimation = animations['idle'];\n    } // actions\n\n\n    if (controls.jump) {\n      moveAnimation = animations['jump'];\n      idleAnimation = animations['jump'];\n    }\n\n    if (controls.attack) {\n      if (controls.crouch) {\n        moveAnimation = animations['crouchAttack'];\n        idleAnimation = animations['crouchAttack'];\n      } else {\n        moveAnimation = animations['attack'];\n        idleAnimation = animations['attack'];\n      }\n    } // set animations\n\n\n    if (controls.moveForward || controls.moveBackward || controls.moveLeft || controls.moveRight) {\n      if (this.activeAnimation !== moveAnimation) {\n        this.setAnimation(moveAnimation);\n      }\n    }\n\n    if (Math.abs(this.speed) < 0.2 * this.maxSpeed && !(controls.moveLeft || controls.moveRight || controls.moveForward || controls.moveBackward)) {\n      if (this.activeAnimation !== idleAnimation) {\n        this.setAnimation(idleAnimation);\n      }\n    } // set animation direction\n\n\n    if (controls.moveForward) {\n      if (this.meshBody) {\n        this.meshBody.setAnimationDirectionForward(this.activeAnimation);\n        this.meshBody.setAnimationDirectionForward(this.oldAnimation);\n      }\n\n      if (this.meshWeapon) {\n        this.meshWeapon.setAnimationDirectionForward(this.activeAnimation);\n        this.meshWeapon.setAnimationDirectionForward(this.oldAnimation);\n      }\n    }\n\n    if (controls.moveBackward) {\n      if (this.meshBody) {\n        this.meshBody.setAnimationDirectionBackward(this.activeAnimation);\n        this.meshBody.setAnimationDirectionBackward(this.oldAnimation);\n      }\n\n      if (this.meshWeapon) {\n        this.meshWeapon.setAnimationDirectionBackward(this.activeAnimation);\n        this.meshWeapon.setAnimationDirectionBackward(this.oldAnimation);\n      }\n    }\n  };\n\n  this.updateMovementModel = function (delta) {\n    var controls = this.controls; // speed based on controls\n\n    if (controls.crouch) this.maxSpeed = this.crouchSpeed;else this.maxSpeed = this.walkSpeed;\n    this.maxReverseSpeed = -this.maxSpeed;\n    if (controls.moveForward) this.speed = MathUtils.clamp(this.speed + delta * this.frontAcceleration, this.maxReverseSpeed, this.maxSpeed);\n    if (controls.moveBackward) this.speed = MathUtils.clamp(this.speed - delta * this.backAcceleration, this.maxReverseSpeed, this.maxSpeed); // orientation based on controls\n    // (don't just stand while turning)\n\n    var dir = 1;\n\n    if (controls.moveLeft) {\n      this.bodyOrientation += delta * this.angularSpeed;\n      this.speed = MathUtils.clamp(this.speed + dir * delta * this.frontAcceleration, this.maxReverseSpeed, this.maxSpeed);\n    }\n\n    if (controls.moveRight) {\n      this.bodyOrientation -= delta * this.angularSpeed;\n      this.speed = MathUtils.clamp(this.speed + dir * delta * this.frontAcceleration, this.maxReverseSpeed, this.maxSpeed);\n    } // speed decay\n\n\n    if (!(controls.moveForward || controls.moveBackward)) {\n      if (this.speed > 0) {\n        var k = exponentialEaseOut(this.speed / this.maxSpeed);\n        this.speed = MathUtils.clamp(this.speed - k * delta * this.frontDecceleration, 0, this.maxSpeed);\n      } else {\n        var k = exponentialEaseOut(this.speed / this.maxReverseSpeed);\n        this.speed = MathUtils.clamp(this.speed + k * delta * this.backAcceleration, this.maxReverseSpeed, 0);\n      }\n    } // displacement\n\n\n    var forwardDelta = this.speed * delta;\n    this.root.position.x += Math.sin(this.bodyOrientation) * forwardDelta;\n    this.root.position.z += Math.cos(this.bodyOrientation) * forwardDelta; // steering\n\n    this.root.rotation.y = this.bodyOrientation;\n  }; // internal helpers\n\n\n  function loadTextures(baseUrl, textureUrls) {\n    var textureLoader = new TextureLoader();\n    var textures = [];\n\n    for (let i = 0; i < textureUrls.length; i++) {\n      textures[i] = textureLoader.load(baseUrl + textureUrls[i], checkLoadingComplete);\n      textures[i].mapping = UVMapping;\n      textures[i].name = textureUrls[i];\n      textures[i].encoding = sRGBEncoding;\n    }\n\n    return textures;\n  }\n\n  function createPart(geometry, skinMap) {\n    var materialWireframe = new MeshLambertMaterial({\n      color: 0xffaa00,\n      wireframe: true,\n      morphTargets: true,\n      morphNormals: true\n    });\n    var materialTexture = new MeshLambertMaterial({\n      color: 0xffffff,\n      wireframe: false,\n      map: skinMap,\n      morphTargets: true,\n      morphNormals: true\n    }); //\n\n    var mesh = new MorphBlendMesh(geometry, materialTexture);\n    mesh.rotation.y = -Math.PI / 2; //\n\n    mesh.materialTexture = materialTexture;\n    mesh.materialWireframe = materialWireframe; //\n\n    mesh.autoCreateAnimations(scope.animationFPS);\n    return mesh;\n  }\n\n  function checkLoadingComplete() {\n    scope.loadCounter -= 1;\n    if (scope.loadCounter === 0) scope.onLoadComplete();\n  }\n\n  function exponentialEaseOut(k) {\n    return k === 1 ? 1 : -Math.pow(2, -10 * k) + 1;\n  }\n};\n\nexport { MD2CharacterComplex };\n"]},"metadata":{},"sourceType":"module"}