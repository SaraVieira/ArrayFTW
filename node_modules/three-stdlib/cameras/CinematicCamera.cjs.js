"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("@babel/runtime/helpers/inheritsLoose"),t=require("three"),s=require("../shaders/BokehShader2.cjs.js");function i(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var r=i(e),o=function(e){function i(i,r,o,n){var h;(h=e.call(this,i,r,o,n)||this).type="CinematicCamera",h.postprocessing={enabled:!0},h.shaderSettings={rings:3,samples:4};var a=s.BokehDepthShader;return h.materialDepth=new t.ShaderMaterial({uniforms:a.uniforms,vertexShader:a.vertexShader,fragmentShader:a.fragmentShader}),h.materialDepth.uniforms.mNear.value=o,h.materialDepth.uniforms.mFar.value=n,h.setLens(),h.initPostProcessing(),h}r.default(i,e);var o=i.prototype;return o.setLens=function(e,t,s,i){void 0===e&&(e=35),void 0!==t&&(this.filmGauge=t),this.setFocalLength(e),void 0===s&&(s=8),void 0===i&&(i=.019),this.fNumber=s,this.coc=i,this.aperture=e/this.fNumber,this.hyperFocal=e*e/(this.aperture*this.coc)},o.linearize=function(e){var t=this.far,s=this.near;return-t*s/(e*(t-s)-t)},o.smoothstep=function(e,t,s){var i=this.saturate((s-e)/(t-e));return i*i*(3-2*i)},o.saturate=function(e){return Math.max(0,Math.min(1,e))},o.focusAt=function(e){void 0===e&&(e=20);var t=this.getFocalLength();this.focus=e,this.nearPoint=this.hyperFocal*this.focus/(this.hyperFocal+(this.focus-t)),this.farPoint=this.hyperFocal*this.focus/(this.hyperFocal-(this.focus-t)),this.depthOfField=this.farPoint-this.nearPoint,this.depthOfField<0&&(this.depthOfField=0),this.sdistance=this.smoothstep(this.near,this.far,this.focus),this.ldistance=this.linearize(1-this.sdistance),this.postprocessing.bokeh_uniforms.focalDepth.value=this.ldistance},o.initPostProcessing=function(){if(this.postprocessing.enabled){this.postprocessing.scene=new t.Scene,this.postprocessing.camera=new t.OrthographicCamera(window.innerWidth/-2,window.innerWidth/2,window.innerHeight/2,window.innerHeight/-2,-1e4,1e4),this.postprocessing.scene.add(this.postprocessing.camera);var e={minFilter:t.LinearFilter,magFilter:t.LinearFilter,format:t.RGBFormat};this.postprocessing.rtTextureDepth=new t.WebGLRenderTarget(window.innerWidth,window.innerHeight,e),this.postprocessing.rtTextureColor=new t.WebGLRenderTarget(window.innerWidth,window.innerHeight,e);var i=s.BokehShader2;this.postprocessing.bokeh_uniforms=t.UniformsUtils.clone(i.uniforms),this.postprocessing.bokeh_uniforms.tColor.value=this.postprocessing.rtTextureColor.texture,this.postprocessing.bokeh_uniforms.tDepth.value=this.postprocessing.rtTextureDepth.texture,this.postprocessing.bokeh_uniforms.manualdof.value=0,this.postprocessing.bokeh_uniforms.shaderFocus.value=0,this.postprocessing.bokeh_uniforms.fstop.value=2.8,this.postprocessing.bokeh_uniforms.showFocus.value=1,this.postprocessing.bokeh_uniforms.focalDepth.value=.1,this.postprocessing.bokeh_uniforms.znear.value=this.near,this.postprocessing.bokeh_uniforms.zfar.value=this.near,this.postprocessing.bokeh_uniforms.textureWidth.value=window.innerWidth,this.postprocessing.bokeh_uniforms.textureHeight.value=window.innerHeight,this.postprocessing.materialBokeh=new t.ShaderMaterial({uniforms:this.postprocessing.bokeh_uniforms,vertexShader:i.vertexShader,fragmentShader:i.fragmentShader,defines:{RINGS:this.shaderSettings.rings,SAMPLES:this.shaderSettings.samples,DEPTH_PACKING:1}}),this.postprocessing.quad=new t.Mesh(new t.PlaneGeometry(window.innerWidth,window.innerHeight),this.postprocessing.materialBokeh),this.postprocessing.quad.position.z=-500,this.postprocessing.scene.add(this.postprocessing.quad)}},o.renderCinematic=function(e,t){if(this.postprocessing.enabled){var s=t.getRenderTarget();t.clear(),e.overrideMaterial=null,t.setRenderTarget(this.postprocessing.rtTextureColor),t.clear(),t.render(e,this),e.overrideMaterial=this.materialDepth,t.setRenderTarget(this.postprocessing.rtTextureDepth),t.clear(),t.render(e,this),t.setRenderTarget(null),t.render(this.postprocessing.scene,this.postprocessing.camera),t.setRenderTarget(s)}},i}(t.PerspectiveCamera);exports.CinematicCamera=o;
