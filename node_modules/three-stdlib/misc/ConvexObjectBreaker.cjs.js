"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("three"),t=require("../geometries/ConvexGeometry.cjs.js");require("@babel/runtime/helpers/inheritsLoose"),require("../math/ConvexHull.cjs.js");var r,o=function(t,r){this.minSizeForBreak=t||1.4,this.smallDelta=r||1e-4,this.tempLine1=new e.Line3,this.tempPlane1=new e.Plane,this.tempPlane2=new e.Plane,this.tempPlane_Cut=new e.Plane,this.tempCM1=new e.Vector3,this.tempCM2=new e.Vector3,this.tempVector3=new e.Vector3,this.tempVector3_2=new e.Vector3,this.tempVector3_3=new e.Vector3,this.tempVector3_P0=new e.Vector3,this.tempVector3_P1=new e.Vector3,this.tempVector3_P2=new e.Vector3,this.tempVector3_N0=new e.Vector3,this.tempVector3_N1=new e.Vector3,this.tempVector3_AB=new e.Vector3,this.tempVector3_CB=new e.Vector3,this.tempResultObjects={object1:null,object2:null},this.segments=[];for(var o=0;o<900;o++)this.segments[o]=!1};o.prototype={constructor:o,prepareBreakableObject:function(e,t,r,o,s){e.geometry.isBufferGeometry||console.error("THREE.ConvexObjectBreaker.prepareBreakableObject(): Parameter object must have a BufferGeometry.");var n=e.userData;n.mass=t,n.velocity=r.clone(),n.angularVelocity=o.clone(),n.breakable=s},subdivideByImpact:function(e,t,r,o,s){var n=[],a=this.tempPlane1,i=this.tempPlane2;this.tempVector3.addVectors(t,r),a.setFromCoplanarPoints(t,e.position,this.tempVector3);var c=s+o,m=this;return function s(p,l,h,u){if(Math.random()<.05*u||u>c)n.push(p);else{var v=Math.PI;0===u?(i.normal.copy(a.normal),i.constant=a.constant):u<=o?(v=(h-l)*(.2+.6*Math.random())+l,m.tempVector3_2.copy(e.position).sub(t).applyAxisAngle(r,v).add(t),i.setFromCoplanarPoints(t,m.tempVector3,m.tempVector3_2)):(v=(.5*(1&u)+.2*(2-Math.random()))*Math.PI,m.tempVector3_2.copy(t).sub(p.position).applyAxisAngle(r,v).add(p.position),m.tempVector3_3.copy(r).add(p.position),i.setFromCoplanarPoints(p.position,m.tempVector3_3,m.tempVector3_2)),m.cutByPlane(p,i,m.tempResultObjects);var V=m.tempResultObjects.object1,y=m.tempResultObjects.object2;V&&s(V,l,v,u+1),y&&s(y,v,h,u+1)}}(e,0,2*Math.PI,0),n},cutByPlane:function(r,s,n){var a=r.geometry,i=a.attributes.position.array,c=a.attributes.normal.array,m=i.length/3,p=m/3,l=a.getIndex();function h(e,t){var r=3*e+t;return l?l[r]:r}l&&(p=(l=l.array).length/3);for(var u=[],v=[],V=this.smallDelta,y=m*m,d=0;d<y;d++)this.segments[d]=!1;for(var f=this.tempVector3_P0,b=this.tempVector3_P1,P=this.tempVector3_N0,g=this.tempVector3_N1,C=0;C<p-1;C++){var M=h(C,0),j=h(C,1),x=h(C,2);P.set(c[M],c[M]+1,c[M]+2);for(var _=C+1;_<p;_++){var w=h(_,0),B=h(_,1),O=h(_,2);g.set(c[w],c[w]+1,c[w]+2),1-P.dot(g)<V&&(M===w||M===B||M===O?j===w||j===B||j===O?(this.segments[M*m+j]=!0,this.segments[j*m+M]=!0):(this.segments[x*m+M]=!0,this.segments[M*m+x]=!0):j!==w&&j!==B&&j!==O||(this.segments[x*m+j]=!0,this.segments[j*m+x]=!0))}}var z=this.tempPlane_Cut;r.updateMatrix(),o.transformPlaneToLocalSpace(s,r.matrix,z);for(var k=0;k<p;k++)for(var I=h(k,0),F=h(k,1),L=h(k,2),q=0;q<3;q++){var D=0===q?I:1===q?F:L,S=0===q?F:1===q?L:I;if(!this.segments[D*m+S]){this.segments[D*m+S]=!0,this.segments[S*m+D]=!0,f.set(i[3*D],i[3*D+1],i[3*D+2]),b.set(i[3*S],i[3*S+1],i[3*S+2]);var T=0;(A=z.distanceToPoint(f))>V?(T=2,v.push(f.clone())):A<-V?(T=1,u.push(f.clone())):(T=3,u.push(f.clone()),v.push(f.clone()));var A,G=0;if((A=z.distanceToPoint(b))>V?(G=2,v.push(b.clone())):A<-V?(G=1,u.push(b.clone())):(G=3,u.push(b.clone()),v.push(b.clone())),1===T&&2===G||2===T&&1===G){this.tempLine1.start.copy(f),this.tempLine1.end.copy(b);var R=new e.Vector3;if(void 0===(R=z.intersectLine(this.tempLine1,R)))return console.error("Internal error: segment does not intersect plane."),n.segmentedObject1=null,n.segmentedObject2=null,0;u.push(R),v.push(R.clone())}}}var N=.5*r.userData.mass;this.tempCM1.set(0,0,0);var E=0,H=u.length;if(H>0){for(var J=0;J<H;J++)this.tempCM1.add(u[J]);this.tempCM1.divideScalar(H);for(var K=0;K<H;K++){(Y=u[K]).sub(this.tempCM1),E=Math.max(E,Y.x,Y.y,Y.z)}this.tempCM1.add(r.position)}this.tempCM2.set(0,0,0);var Q=0,U=v.length;if(U>0){for(var W=0;W<U;W++)this.tempCM2.add(v[W]);this.tempCM2.divideScalar(U);for(var X=0;X<U;X++){var Y;(Y=v[X]).sub(this.tempCM2),Q=Math.max(Q,Y.x,Y.y,Y.z)}this.tempCM2.add(r.position)}var Z=null,$=null,ee=0;return H>4&&((Z=new e.Mesh(new t.ConvexGeometry(u),r.material)).position.copy(this.tempCM1),Z.quaternion.copy(r.quaternion),this.prepareBreakableObject(Z,N,r.userData.velocity,r.userData.angularVelocity,2*E>this.minSizeForBreak),ee++),U>4&&(($=new e.Mesh(new t.ConvexGeometry(v),r.material)).position.copy(this.tempCM2),$.quaternion.copy(r.quaternion),this.prepareBreakableObject($,N,r.userData.velocity,r.userData.angularVelocity,2*Q>this.minSizeForBreak),ee++),n.object1=Z,n.object2=$,ee}},o.transformFreeVector=function(e,t){var r=e.x,o=e.y,s=e.z,n=t.elements;return e.x=n[0]*r+n[4]*o+n[8]*s,e.y=n[1]*r+n[5]*o+n[9]*s,e.z=n[2]*r+n[6]*o+n[10]*s,e},o.transformFreeVectorInverse=function(e,t){var r=e.x,o=e.y,s=e.z,n=t.elements;return e.x=n[0]*r+n[1]*o+n[2]*s,e.y=n[4]*r+n[5]*o+n[6]*s,e.z=n[8]*r+n[9]*o+n[10]*s,e},o.transformTiedVectorInverse=function(e,t){var r=e.x,o=e.y,s=e.z,n=t.elements;return e.x=n[0]*r+n[1]*o+n[2]*s-n[12],e.y=n[4]*r+n[5]*o+n[6]*s-n[13],e.z=n[8]*r+n[9]*o+n[10]*s-n[14],e},o.transformPlaneToLocalSpace=(r=new e.Vector3,function(e,t,s){s.normal.copy(e.normal),s.constant=e.constant;var n=o.transformTiedVectorInverse(e.coplanarPoint(r),t);o.transformFreeVectorInverse(s.normal,t),s.constant=-n.dot(s.normal)}),exports.ConvexObjectBreaker=o;
