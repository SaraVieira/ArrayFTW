"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var r=require("three");exports.calcBSplineDerivatives=function(a,e,t,i,o){for(var n=o<a?o:a,c=[],v=this.findSpan(a,i,e),l=this.calcBasisFunctionDerivatives(v,i,a,n,e),s=[],f=0;f<t.length;++f){var u=(d=t[f].clone()).w;d.x*=u,d.y*=u,d.z*=u,s[f]=d}for(var p=0;p<=n;++p){for(var d=s[v-a].clone().multiplyScalar(l[p][0]),h=1;h<=a;++h)d.add(s[v-a+h].clone().multiplyScalar(l[p][h]));c[p]=d}for(var S=n+1;S<=o+1;++S)c[S]=new r.Vector4(0,0,0);return c},exports.calcBSplinePoint=function(a,e,t,i){for(var o=this.findSpan(a,i,e),n=this.calcBasisFunctions(o,i,a,e),c=new r.Vector4(0,0,0,0),v=0;v<=a;++v){var l=t[o-a+v],s=n[v],f=l.w*s;c.x+=l.x*f,c.y+=l.y*f,c.z+=l.z*f,c.w+=l.w*s}return c},exports.calcBasisFunctionDerivatives=function(r,a,e,t,i){for(var o=[],n=0;n<=e;++n)o[n]=0;for(var c=[],v=0;v<=t;++v)c[v]=o.slice(0);for(var l=[],s=0;s<=e;++s)l[s]=o.slice(0);l[0][0]=1;for(var f=o.slice(0),u=o.slice(0),p=1;p<=e;++p){f[p]=a-i[r+1-p],u[p]=i[r+p]-a;for(var d=0,h=0;h<p;++h){var S=u[h+1],x=f[p-h];l[p][h]=S+x;var w=l[h][p-1]/l[p][h];l[h][p]=d+S*w,d=x*w}l[p][p]=d}for(var y=0;y<=e;++y)c[0][y]=l[y][e];for(var B=0;B<=e;++B){for(var D=0,z=1,F=[],m=0;m<=e;++m)F[m]=o.slice(0);F[0][0]=1;for(var V=1;V<=t;++V){var g=0,M=B-V,P=e-V;B>=V&&(F[z][0]=F[D][0]/l[P+1][M],g=F[z][0]*l[M][P]);for(var R=B-1<=P?V-1:e-B,b=M>=-1?1:-M;b<=R;++b)F[z][b]=(F[D][b]-F[D][b-1])/l[P+1][M+b],g+=F[z][b]*l[M+b][P];B<=P&&(F[z][V]=-F[D][V-1]/l[P+1][B],g+=F[z][V]*l[B][P]),c[V][B]=g;var C=D;D=z,z=C}}for(var I=e,K=1;K<=t;++K){for(var _=0;_<=e;++_)c[K][_]*=I;I*=e-K}return c},exports.calcBasisFunctions=function(r,a,e,t){var i=[],o=[],n=[];i[0]=1;for(var c=1;c<=e;++c){o[c]=a-t[r+1-c],n[c]=t[r+c]-a;for(var v=0,l=0;l<c;++l){var s=n[l+1],f=o[c-l],u=i[l]/(s+f);i[l]=v+s*u,v=f*u}i[c]=v}return i},exports.calcKoverI=function(r,a){for(var e=1,t=2;t<=r;++t)e*=t;for(var i=1,o=2;o<=a;++o)i*=o;for(var n=2;n<=r-a;++n)i*=n;return e/i},exports.calcNURBSDerivatives=function(r,a,e,t,i){var o=this.calcBSplineDerivatives(r,a,e,t,i);return this.calcRationalCurveDerivatives(o)},exports.calcRationalCurveDerivatives=function(a){for(var e=a.length,t=[],i=[],o=0;o<e;++o){var n=a[o];t[o]=new r.Vector3(n.x,n.y,n.z),i[o]=n.w}for(var c=[],v=0;v<e;++v){for(var l=t[v].clone(),s=1;s<=v;++s)l.sub(c[v-s].clone().multiplyScalar(this.calcKoverI(v,s)*i[s]));c[v]=l.divideScalar(i[0])}return c},exports.calcSurfacePoint=function(a,e,t,i,o,n,c,v){for(var l=this.findSpan(a,n,t),s=this.findSpan(e,c,i),f=this.calcBasisFunctions(l,n,a,t),u=this.calcBasisFunctions(s,c,e,i),p=[],d=0;d<=e;++d){p[d]=new r.Vector4(0,0,0,0);for(var h=0;h<=a;++h){var S=o[l-a+h][s-e+d].clone(),x=S.w;S.x*=x,S.y*=x,S.z*=x,p[d].add(S.multiplyScalar(f[h]))}}for(var w=new r.Vector4(0,0,0,0),y=0;y<=e;++y)w.add(p[y].multiplyScalar(u[y]));w.divideScalar(w.w),v.set(w.x,w.y,w.z)},exports.findSpan=function(r,a,e){var t=e.length-r-1;if(a>=e[t])return t-1;if(a<=e[r])return r;for(var i=r,o=t,n=Math.floor((i+o)/2);a<e[n]||a>=e[n+1];)a<e[n]?o=n:i=n,n=Math.floor((i+o)/2);return n};
