"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("three"),t=require("./Capsule.cjs.js"),n=function(){var n=new e.Vector3,r=new e.Vector3,i=new e.Plane,a=new e.Line3,s=new e.Line3,o=new e.Sphere,l=new t.Capsule;function h(e){this.triangles=[],this.box=e,this.subTrees=[]}return Object.assign(h.prototype,{addTriangle:function(t){return this.bounds||(this.bounds=new e.Box3),this.bounds.min.x=Math.min(this.bounds.min.x,t.a.x,t.b.x,t.c.x),this.bounds.min.y=Math.min(this.bounds.min.y,t.a.y,t.b.y,t.c.y),this.bounds.min.z=Math.min(this.bounds.min.z,t.a.z,t.b.z,t.c.z),this.bounds.max.x=Math.max(this.bounds.max.x,t.a.x,t.b.x,t.c.x),this.bounds.max.y=Math.max(this.bounds.max.y,t.a.y,t.b.y,t.c.y),this.bounds.max.z=Math.max(this.bounds.max.z,t.a.z,t.b.z,t.c.z),this.triangles.push(t),this},calcBox:function(){return this.box=this.bounds.clone(),this.box.min.x-=.01,this.box.min.y-=.01,this.box.min.z-=.01,this},split:function(t){if(this.box){for(var i,a,s,o=[],l=r.copy(this.box.max).sub(this.box.min).multiplyScalar(.5),u=0;u<2;u++)for(var c=0;c<2;c++)for(var g=0;g<2;g++)i=new e.Box3,a=n.set(u,c,g),i.min.copy(this.box.min).add(a.multiply(l)),i.max.copy(i.min).add(l),o.push(new h(i));for(;s=this.triangles.pop();)for(var d=0;d<o.length;d++)o[d].box.intersectsTriangle(s)&&o[d].triangles.push(s);for(var p=0;p<o.length;p++){var b=o[p].triangles.length;b>8&&t<16&&o[p].split(t+1),0!=b&&this.subTrees.push(o[p])}return this}},build:function(){return this.calcBox(),this.split(0),this},getRayTriangles:function(e,t){for(var n=0;n<this.subTrees.length;n++){var r=this.subTrees[n];if(e.intersectsBox(r.box))if(r.triangles.length>0)for(var i=0;i<r.triangles.length;i++)-1===t.indexOf(r.triangles[i])&&t.push(r.triangles[i]);else r.getRayTriangles(e,t)}return t},triangleCapsuleIntersect:function(e,t){var r,o,l,h;t.getPlane(i);var u=i.distanceToPoint(e.start)-e.radius,c=i.distanceToPoint(e.end)-e.radius;if(u>0&&c>0||u<-e.radius&&c<-e.radius)return!1;var g=Math.abs(u/(Math.abs(u)+Math.abs(c))),d=n.copy(e.start).lerp(e.end,g);if(t.containsPoint(d))return{normal:i.normal.clone(),point:d.clone(),depth:Math.abs(Math.min(u,c))};var p=e.radius*e.radius;l=a.set(e.start,e.end);for(var b=[[t.a,t.b],[t.b,t.c],[t.c,t.a]],f=0;f<b.length;f++){h=s.set(b[f][0],b[f][1]);var x=e.lineLineMinimumPoints(l,h);if(r=x[0],o=x[1],r.distanceToSquared(o)<p)return{normal:r.clone().sub(o).normalize(),point:o.clone(),depth:e.radius-r.distanceTo(o)}}return!1},triangleSphereIntersect:function(e,t){if(t.getPlane(i),!e.intersectsPlane(i))return!1;var s=Math.abs(i.distanceToSphere(e)),o=e.radius*e.radius-s*s,l=i.projectPoint(e.center,n);if(t.containsPoint(e.center))return{normal:i.normal.clone(),point:l.clone(),depth:Math.abs(i.distanceToSphere(e))};for(var h=[[t.a,t.b],[t.b,t.c],[t.c,t.a]],u=0;u<h.length;u++){a.set(h[u][0],h[u][1]),a.closestPointToPoint(l,!0,r);var c=r.distanceToSquared(e.center);if(c<o)return{normal:e.center.clone().sub(r).normalize(),point:r.clone(),depth:e.radius-Math.sqrt(c)}}return!1},getSphereTriangles:function(e,t){for(var n=0;n<this.subTrees.length;n++){var r=this.subTrees[n];if(e.intersectsBox(r.box))if(r.triangles.length>0)for(var i=0;i<r.triangles.length;i++)-1===t.indexOf(r.triangles[i])&&t.push(r.triangles[i]);else r.getSphereTriangles(e,t)}},getCapsuleTriangles:function(e,t){for(var n=0;n<this.subTrees.length;n++){var r=this.subTrees[n];if(e.intersectsBox(r.box))if(r.triangles.length>0)for(var i=0;i<r.triangles.length;i++)-1===t.indexOf(r.triangles[i])&&t.push(r.triangles[i]);else r.getCapsuleTriangles(e,t)}},sphereIntersect:function(e){o.copy(e);var t,n=[],r=!1;this.getSphereTriangles(e,n);for(var i=0;i<n.length;i++)(t=this.triangleSphereIntersect(o,n[i]))&&(r=!0,o.center.add(t.normal.multiplyScalar(t.depth)));if(r){var a=o.center.clone().sub(e.center),s=a.length();return{normal:a.normalize(),depth:s}}return!1},capsuleIntersect:function(t){l.copy(t);var r,i=[],a=!1;this.getCapsuleTriangles(l,i);for(var s=0;s<i.length;s++)(r=this.triangleCapsuleIntersect(l,i[s]))&&(a=!0,l.translate(r.normal.multiplyScalar(r.depth)));if(a){var o=l.getCenter(new e.Vector3).sub(t.getCenter(n)),h=o.length();return{normal:o.normalize(),depth:h}}return!1},rayIntersect:function(e){if(0!==e.direction.length()){var t,r,i,a=[],s=1e100;this.getRayTriangles(e,a);for(var o=0;o<a.length;o++)if(i=e.intersectTriangle(a[o].a,a[o].b,a[o].c,!0,n)){var l=i.sub(e.origin).length();s>l&&(r=i.clone().add(e.origin),s=l,t=a[o])}return s<1e100&&{distance:s,triangle:t,position:r}}},fromGraphNode:function(t){var n=this;return t.traverse((function(t){if("Mesh"===t.type){t.updateMatrix(),t.updateWorldMatrix();var r,i=!1;t.geometry.index?(i=!0,r=t.geometry.clone().toNonIndexed()):r=t.geometry;for(var a=r.attributes.position.array,s=t.matrixWorld,o=0;o<a.length;o+=9){var l=new e.Vector3(a[o],a[o+1],a[o+2]),h=new e.Vector3(a[o+3],a[o+4],a[o+5]),u=new e.Vector3(a[o+6],a[o+7],a[o+8]);l.applyMatrix4(s),h.applyMatrix4(s),u.applyMatrix4(s),n.addTriangle(new e.Triangle(l,h,u))}i&&r.dispose()}})),this.build(),this}}),h}();exports.Octree=n;
