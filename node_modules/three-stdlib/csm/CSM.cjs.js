"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var t=require("three"),e=require("./Frustum.cjs.js"),a=require("./Shader.cjs.js"),s=new t.Matrix4,i=new e,r=new t.Vector3,h=new t.Box3,n=[],o=[],c=function(){function c(a){a=a||{},this.camera=a.camera,this.parent=a.parent,this.cascades=a.cascades||3,this.maxFar=a.maxFar||1e5,this.mode=a.mode||"practical",this.shadowMapSize=a.shadowMapSize||2048,this.shadowBias=a.shadowBias||1e-6,this.lightDirection=a.lightDirection||new t.Vector3(1,-1,1).normalize(),this.lightIntensity=a.lightIntensity||1,this.lightNear=a.lightNear||1,this.lightFar=a.lightFar||2e3,this.lightMargin=a.lightMargin||200,this.customSplitsCallback=a.customSplitsCallback,this.fade=!1,this.mainFrustum=new e,this.frustums=[],this.breaks=[],this.lights=[],this.shaders=new Map,this.createLights(),this.updateFrustums(),this.injectInclude()}var d=c.prototype;return d.createLights=function(){for(var e=0;e<this.cascades;e++){var a=new t.DirectionalLight(16777215,this.lightIntensity);a.castShadow=!0,a.shadow.mapSize.width=this.shadowMapSize,a.shadow.mapSize.height=this.shadowMapSize,a.shadow.camera.near=this.lightNear,a.shadow.camera.far=this.lightFar,a.shadow.bias=this.shadowBias,this.parent.add(a),this.parent.add(a.target),this.lights.push(a)}},d.initCascades=function(){var t=this.camera;t.updateProjectionMatrix(),this.mainFrustum.setFromProjectionMatrix(t.projectionMatrix,this.maxFar),this.mainFrustum.split(this.breaks,this.frustums)},d.updateShadowBounds=function(){for(var t=this.frustums,e=0;e<t.length;e++){var a=this.lights[e].shadow.camera,s=this.frustums[e],i=s.vertices.near,r=s.vertices.far,h=r[0],n=void 0;n=h.distanceTo(r[2])>h.distanceTo(i[2])?r[2]:i[2];var o=h.distanceTo(n);if(this.fade){var c=this.camera,d=Math.max(c.far,this.maxFar),l=s.vertices.far[0].z/(d-c.near);o+=.25*Math.pow(l,2)*(d-c.near)}a.left=-o/2,a.right=o/2,a.top=o/2,a.bottom=-o/2,a.updateProjectionMatrix()}},d.getBreaks=function(){var e=this.camera,a=Math.min(e.far,this.maxFar);switch(this.breaks.length=0,this.mode){case"uniform":s(this.cascades,e.near,a,this.breaks);break;case"logarithmic":i(this.cascades,e.near,a,this.breaks);break;case"practical":!function(e,a,r,h,c){n.length=0,o.length=0,i(e,a,r,o),s(e,a,r,n);for(var d=1;d<e;d++)c.push(t.MathUtils.lerp(n[d-1],o[d-1],h));c.push(1)}(this.cascades,e.near,a,.5,this.breaks);break;case"custom":void 0===this.customSplitsCallback&&console.error("CSM: Custom split scheme callback not defined."),this.customSplitsCallback(this.cascades,e.near,a,this.breaks)}function s(t,e,a,s){for(var i=1;i<t;i++)s.push((e+(a-e)*i/t)/a);s.push(1)}function i(t,e,a,s){for(var i=1;i<t;i++)s.push(e*Math.pow(a/e,i/t)/a);s.push(1)}},d.update=function(){for(var t=this.camera,e=this.frustums,a=0;a<e.length;a++){var n=this.lights[a],o=n.shadow.camera,c=(o.right-o.left)/this.shadowMapSize,d=(o.top-o.bottom)/this.shadowMapSize;n.shadow.camera.updateMatrixWorld(!0),s.multiplyMatrices(n.shadow.camera.matrixWorldInverse,t.matrixWorld),e[a].toSpace(s,i);var l=i.vertices.near,u=i.vertices.far;h.makeEmpty();for(var m=0;m<4;m++)h.expandByPoint(l[m]),h.expandByPoint(u[m]);h.getCenter(r),r.z=h.max.z+this.lightMargin,r.x=Math.floor(r.x/c)*c,r.y=Math.floor(r.y/d)*d,r.applyMatrix4(n.shadow.camera.matrixWorld),n.position.copy(r),n.target.position.copy(r),n.target.position.x+=this.lightDirection.x,n.target.position.y+=this.lightDirection.y,n.target.position.z+=this.lightDirection.z}},d.injectInclude=function(){t.ShaderChunk.lights_fragment_begin=a.lights_fragment_begin,t.ShaderChunk.lights_pars_begin=a.lights_pars_begin},d.setupMaterial=function(t){t.defines=t.defines||{},t.defines.USE_CSM=1,t.defines.CSM_CASCADES=this.cascades,this.fade&&(t.defines.CSM_FADE="");var e=[],a=this,s=this.shaders;t.onBeforeCompile=function(i){var r=Math.min(a.camera.far,a.maxFar);a.getExtendedBreaks(e),i.uniforms.CSM_cascades={value:e},i.uniforms.cameraNear={value:a.camera.near},i.uniforms.shadowFar={value:r},s.set(t,i)},s.set(t,null)},d.updateUniforms=function(){var t=Math.min(this.camera.far,this.maxFar);this.shaders.forEach((function(e,a){if(null!==e){var s=e.uniforms;this.getExtendedBreaks(s.CSM_cascades.value),s.cameraNear.value=this.camera.near,s.shadowFar.value=t}!this.fade&&"CSM_FADE"in a.defines?(delete a.defines.CSM_FADE,a.needsUpdate=!0):this.fade&&!("CSM_FADE"in a.defines)&&(a.defines.CSM_FADE="",a.needsUpdate=!0)}),this)},d.getExtendedBreaks=function(e){for(;e.length<this.breaks.length;)e.push(new t.Vector2);e.length=this.breaks.length;for(var a=0;a<this.cascades;a++){var s=this.breaks[a],i=this.breaks[a-1]||0;e[a].x=i,e[a].y=s}},d.updateFrustums=function(){this.getBreaks(),this.initCascades(),this.updateShadowBounds(),this.updateUniforms()},d.remove=function(){for(var t=0;t<this.lights.length;t++)this.parent.remove(this.lights[t])},d.dispose=function(){var t=this.shaders;t.forEach((function(t,e){delete e.onBeforeCompile,delete e.defines.USE_CSM,delete e.defines.CSM_CASCADES,delete e.defines.CSM_FADE,null!==t&&(delete t.uniforms.CSM_cascades,delete t.uniforms.cameraNear,delete t.uniforms.shadowFar),e.needsUpdate=!0})),t.clear()},c}();exports.CSM=c;
