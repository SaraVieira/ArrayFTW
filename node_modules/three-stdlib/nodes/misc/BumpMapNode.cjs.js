"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e,t=require("../core/TempNode.cjs.js"),o=require("../inputs/FloatNode.cjs.js"),r=require("../core/FunctionNode.cjs.js"),s=require("../accessors/NormalNode.cjs.js"),d=require("../accessors/PositionNode.cjs.js");function a(e,r){t.TempNode.call(this,"v3"),this.value=e,this.scale=r||new o.FloatNode(1),this.toNormalMap=!1}require("three"),require("../core/Node.cjs.js"),require("../core/InputNode.cjs.js"),require("../core/NodeLib.cjs.js"),a.Nodes={dHdxy_fwd:e=new r.FunctionNode(["vec2 dHdxy_fwd( sampler2D bumpMap, vec2 vUv, float bumpScale ) {","\tvec2 dSTdx = dFdx( vUv );","\tvec2 dSTdy = dFdy( vUv );","\tfloat Hll = bumpScale * texture2D( bumpMap, vUv ).x;","\tfloat dBx = bumpScale * texture2D( bumpMap, vUv + dSTdx ).x - Hll;","\tfloat dBy = bumpScale * texture2D( bumpMap, vUv + dSTdy ).x - Hll;","\treturn vec2( dBx, dBy );","}"].join("\n"),null,{derivatives:!0}),perturbNormalArb:new r.FunctionNode(["vec3 perturbNormalArb( vec3 surf_pos, vec3 surf_norm, vec2 dHdxy ) {","\tvec3 vSigmaX = vec3( dFdx( surf_pos.x ), dFdx( surf_pos.y ), dFdx( surf_pos.z ) );","\tvec3 vSigmaY = vec3( dFdy( surf_pos.x ), dFdy( surf_pos.y ), dFdy( surf_pos.z ) );","\tvec3 vN = surf_norm;","\tvec3 R1 = cross( vSigmaY, vN );","\tvec3 R2 = cross( vN, vSigmaX );","\tfloat fDet = dot( vSigmaX, R1 );","\tfDet *= ( float( gl_FrontFacing ) * 2.0 - 1.0 );","\tvec3 vGrad = sign( fDet ) * ( dHdxy.x * R1 + dHdxy.y * R2 );","\treturn normalize( abs( fDet ) * surf_norm - vGrad );","}"].join("\n"),[e],{derivatives:!0}),bumpToNormal:new r.FunctionNode(["vec3 bumpToNormal( sampler2D bumpMap, vec2 uv, float scale ) {","\tvec2 dSTdx = dFdx( uv );","\tvec2 dSTdy = dFdy( uv );","\tfloat Hll = texture2D( bumpMap, uv ).x;","\tfloat dBx = texture2D( bumpMap, uv + dSTdx ).x - Hll;","\tfloat dBy = texture2D( bumpMap, uv + dSTdy ).x - Hll;","\treturn vec3( .5 - ( dBx * scale ), .5 - ( dBy * scale ), 1.0 );","}"].join("\n"),null,{derivatives:!0})},a.prototype=Object.create(t.TempNode.prototype),a.prototype.constructor=a,a.prototype.nodeType="BumpMap",a.prototype.hashProperties=["toNormalMap"],a.prototype.generate=function(e,t){if(e.isShader("fragment")){if(this.toNormalMap){var o=e.include(a.Nodes.bumpToNormal);return e.format(o+"( "+this.value.build(e,"sampler2D")+", "+this.value.uv.build(e,"v2")+", "+this.scale.build(e,"f")+" )",this.getType(e),t)}var r=e.include(a.Nodes.dHdxy_fwd),u=e.include(a.Nodes.perturbNormalArb);this.normal=this.normal||new s.NormalNode,this.position=this.position||new d.PositionNode(d.PositionNode.VIEW);var i=r+"( "+this.value.build(e,"sampler2D")+", "+this.value.uv.build(e,"v2")+", "+this.scale.build(e,"f")+" )";return e.format(u+"( -"+this.position.build(e,"v3")+", "+this.normal.build(e,"v3")+", "+i+" )",this.getType(e),t)}return console.warn("THREE.BumpMapNode is not compatible with "+e.shader+" shader."),e.format("vec3( 0.0 )",this.getType(e),t)},a.prototype.copy=function(e){return t.TempNode.prototype.copy.call(this,e),this.value=e.value,this.scale=e.scale,this},a.prototype.toJSON=function(e){var t=this.getJSONNode(e);return t||((t=this.createJSONNode(e)).value=this.value.toJSON(e).uuid,t.scale=this.scale.toJSON(e).uuid),t},exports.BumpMapNode=a;
