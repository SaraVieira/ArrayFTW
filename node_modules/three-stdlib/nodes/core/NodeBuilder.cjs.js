"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("three"),t=require("./NodeUniform.cjs.js"),r=require("./NodeUtils.cjs.js"),i=require("./NodeLib.cjs.js"),n=require("./FunctionNode.cjs.js"),s=require("./ConstNode.cjs.js"),o=require("./StructNode.cjs.js"),a=require("../inputs/Vector2Node.cjs.js"),d=require("../inputs/Vector3Node.cjs.js"),c=require("../inputs/Vector4Node.cjs.js"),u=require("../inputs/TextureNode.cjs.js"),h=require("../inputs/CubeTextureNode.cjs.js"),f=require("../misc/TextureCubeNode.cjs.js");require("./TempNode.cjs.js"),require("./Node.cjs.js"),require("./InputNode.cjs.js"),require("../accessors/UVNode.cjs.js"),require("../utils/ColorSpaceNode.cjs.js"),require("../inputs/FloatNode.cjs.js"),require("./ExpressionNode.cjs.js"),require("../accessors/ReflectNode.cjs.js"),require("../accessors/PositionNode.cjs.js"),require("../accessors/NormalNode.cjs.js"),require("../misc/TextureCubeUVNode.cjs.js"),require("./FunctionCallNode.cjs.js"),require("../math/OperatorNode.cjs.js"),require("../math/MathNode.cjs.js");var v=r.NodeUtils.elements,l=["float","vec2","vec3","vec4"],g={float:"f",vec2:"v2",vec3:"v3",vec4:"v4",mat4:"v4",int:"i",bool:"b"},m={t:"sampler2D",tc:"samplerCube",b:"bool",i:"int",f:"float",c:"vec3",v2:"vec2",v3:"vec3",v4:"vec4",m3:"mat3",m4:"mat4"};function C(){this.slots=[],this.caches=[],this.contexts=[],this.keywords={},this.nodeData={},this.requires={uv:[],color:[],lights:!1,fog:!1,transparent:!1,irradiance:!1},this.includes={consts:[],functions:[],structs:[]},this.attributes={},this.prefixCode=["#ifdef TEXTURE_LOD_EXT","\t#define texCube(a, b) textureCube(a, b)","\t#define texCubeBias(a, b, c) textureCubeLodEXT(a, b, c)","\t#define tex2D(a, b) texture2D(a, b)","\t#define tex2DBias(a, b, c) texture2DLodEXT(a, b, c)","#else","\t#define texCube(a, b) textureCube(a, b)","\t#define texCubeBias(a, b, c) textureCube(a, b, c)","\t#define tex2D(a, b) texture2D(a, b)","\t#define tex2DBias(a, b, c) texture2D(a, b, c)","#endif","#include <packing>","#include <common>"].join("\n"),this.parsCode={vertex:"",fragment:""},this.code={vertex:"",fragment:""},this.nodeCode={vertex:"",fragment:""},this.resultCode={vertex:"",fragment:""},this.finalCode={vertex:"",fragment:""},this.inputs={uniforms:{list:[],vertex:[],fragment:[]},vars:{varying:[],vertex:[],fragment:[]}},this.defines={},this.uniforms={},this.extensions={},this.updaters=[],this.nodes=[],this.analyzing=!1}C.prototype={constructor:C,build:function(e,t){this.buildShader("vertex",e),this.buildShader("fragment",t);for(var r=0;r<this.requires.uv.length;r++)if(this.requires.uv[r]){var i=r>0?r+1:"";this.addVaryCode("varying vec2 vUv"+i+";"),r>0&&this.addVertexParsCode("attribute vec2 uv"+i+";"),this.addVertexFinalCode("vUv"+i+" = uv"+i+";")}return this.requires.color[0]&&(this.addVaryCode("varying vec4 vColor;"),this.addVertexParsCode("attribute vec4 color;"),this.addVertexFinalCode("vColor = color;")),this.requires.color[1]&&(this.addVaryCode("varying vec4 vColor2;"),this.addVertexParsCode("attribute vec4 color2;"),this.addVertexFinalCode("vColor2 = color2;")),this.requires.position&&(this.addVaryCode("varying vec3 vPosition;"),this.addVertexFinalCode("vPosition = transformed;")),this.requires.worldPosition&&(this.addVaryCode("varying vec3 vWPosition;"),this.addVertexFinalCode("vWPosition = ( modelMatrix * vec4( transformed, 1.0 ) ).xyz;")),this.requires.normal&&(this.addVaryCode("varying vec3 vObjectNormal;"),this.addVertexFinalCode("vObjectNormal = normal;")),this.requires.worldNormal&&(this.addVaryCode("varying vec3 vWNormal;"),this.addVertexFinalCode("vWNormal = inverseTransformDirection( transformedNormal, viewMatrix ).xyz;")),this},buildShader:function(e,t){this.resultCode[e]=t.build(this.setShader(e),"v4")},setMaterial:function(e,t){return this.material=e,this.renderer=t,this.requires.lights=e.lights,this.requires.fog=e.fog,this.mergeDefines(e.defines),this},addFlow:function(e,t,r){return this.addSlot(e).addCache(t).addContext(r)},removeFlow:function(){return this.removeSlot().removeCache().removeContext()},addCache:function(e){return this.cache=e||"",this.caches.push(this.cache),this},removeCache:function(){return this.caches.pop(),this.cache=this.caches[this.caches.length-1]||"",this},addContext:function(e){return this.context=Object.assign({},this.context,e),this.context.extra=this.context.extra||{},this.contexts.push(this.context),this},removeContext:function(){return this.contexts.pop(),this.context=this.contexts[this.contexts.length-1]||{},this},addSlot:function(e){return this.slot=e||"",this.slots.push(this.slot),this},removeSlot:function(){return this.slots.pop(),this.slot=this.slots[this.slots.length-1]||"",this},addVertexCode:function(e){this.addCode(e,"vertex")},addFragmentCode:function(e){this.addCode(e,"fragment")},addCode:function(e,t){this.code[t||this.shader]+=e+"\n"},addVertexNodeCode:function(e){this.addNodeCode(e,"vertex")},addFragmentNodeCode:function(e){this.addNodeCode(e,"fragment")},addNodeCode:function(e,t){this.nodeCode[t||this.shader]+=e+"\n"},clearNodeCode:function(e){e=e||this.shader;var t=this.nodeCode[e];return this.nodeCode[e]="",t},clearVertexNodeCode:function(){return this.clearNodeCode("vertex")},clearFragmentNodeCode:function(){return this.clearNodeCode("fragment")},addVertexFinalCode:function(e){this.addFinalCode(e,"vertex")},addFragmentFinalCode:function(e){this.addFinalCode(e,"fragment")},addFinalCode:function(e,t){this.finalCode[t||this.shader]+=e+"\n"},addVertexParsCode:function(e){this.addParsCode(e,"vertex")},addFragmentParsCode:function(e){this.addParsCode(e,"fragment")},addParsCode:function(e,t){this.parsCode[t||this.shader]+=e+"\n"},addVaryCode:function(e){this.addVertexParsCode(e),this.addFragmentParsCode(e)},isCache:function(e){return-1!==this.caches.indexOf(e)},isSlot:function(e){return-1!==this.slots.indexOf(e)},define:function(e,t){this.defines[e]=void 0===t?1:t},require:function(e){this.requires[e]=!0},isDefined:function(e){return void 0!==this.defines[e]},getVar:function(e,t,r,i,n,s){void 0===i&&(i="varying"),void 0===n&&(n="V"),void 0===s&&(s="");var o=this.getVars(i),a=o[e];if(!a){var d=o.length;a={name:r||"node"+n+d+(s?"_"+s:""),type:t},o.push(a),o[e]=a}return a},getTempVar:function(e,t,r,i){return this.getVar(e,t,r,this.shader,"T",i)},getAttribute:function(e,t){if(!this.attributes[e]){var r=this.getVar(e,t);this.addVertexParsCode("attribute "+t+" "+e+";"),this.addVertexFinalCode(r.name+" = "+e+";"),this.attributes[e]={varying:r,name:e,type:t}}return this.attributes[e]},getCode:function(e){return[this.prefixCode,this.parsCode[e],this.getVarListCode(this.getVars("varying"),"varying"),this.getVarListCode(this.inputs.uniforms[e],"uniform"),this.getIncludesCode("consts",e),this.getIncludesCode("structs",e),this.getIncludesCode("functions",e),"void main() {",this.getVarListCode(this.getVars(e)),this.code[e],this.resultCode[e],this.finalCode[e],"}"].join("\n")},getVarListCode:function(e,t){t=t||"";for(var r="",i=0,n=e.length;i<n;++i){var s=e[i],o=s.type,a=s.name,d=this.getFormatByType(o);if(void 0===d)throw new Error("Node pars "+d+" not found.");r+=t+" "+d+" "+a+";\n"}return r},getVars:function(e){return this.inputs.vars[e||this.shader]},getNodeData:function(e){var t=e.isNode?e.uuid:e;return this.nodeData[t]=this.nodeData[t]||{}},createUniform:function(e,r,i,n,s,o){var a=this.inputs.uniforms,d=a.list.length,c=new t.NodeUniform({type:r,name:n||"nodeU"+d+(o?"_"+o:""),node:i,needsUpdate:s});return a.list.push(c),a[e].push(c),a[e][c.name]=c,this.uniforms[c.name]=c,c},createVertexUniform:function(e,t,r,i,n){return this.createUniform("vertex",e,t,r,i,n)},createFragmentUniform:function(e,t,r,i,n){return this.createUniform("fragment",e,t,r,i,n)},include:function(e,t,r){var a;if(e="string"==typeof e?i.NodeLib.get(e):e,!1===this.context.include)return e.name;e instanceof n.FunctionNode?a=this.includes.functions:e instanceof s.ConstNode?a=this.includes.consts:e instanceof o.StructNode&&(a=this.includes.structs);var d=a[this.shader]=a[this.shader]||[];if(e){var c=d[e.name];if(c||(c=d[e.name]={node:e,deps:[]},d.push(c),c.src=e.build(this,"source")),e instanceof n.FunctionNode&&t&&d[t.name]&&-1==d[t.name].deps.indexOf(e)&&(d[t.name].deps.push(e),e.includes&&e.includes.length)){var u=0;do{this.include(e.includes[u++],t)}while(u<e.includes.length)}return r&&(c.src=r),e.name}throw new Error("Include not found.")},colorToVectorProperties:function(e){return e.replace("r","x").replace("g","y").replace("b","z").replace("a","w")},colorToVector:function(e){return e.replace(/c/g,"v3")},getIncludes:function(e,t){return this.includes[e][t||this.shader]},getIncludesCode:function(){function e(e,t){return e.deps.length-t.deps.length}return function(t,r){if(!(n=this.getIncludes(t,r)))return"";for(var i="",n=n.sort(e),s=0;s<n.length;s++)n[s].src&&(i+=n[s].src+"\n");return i}}(),getConstructorFromLength:function(e){return l[e-1]},isTypeMatrix:function(e){return/^m/.test(e)},getTypeLength:function(e){return"f"===e?1:parseInt(this.colorToVector(e).substr(1))},getTypeFromLength:function(e){return 1===e?"f":"v"+e},findNode:function(){for(var e=0;e<arguments.length;e++){var t=arguments[e];if(void 0!==t&&t.isNode)return t}},resolve:function(){for(var t=0;t<arguments.length;t++){var r=arguments[t];if(void 0!==r){if(r.isNode)return r;if(r.isTexture)switch(r.mapping){case e.CubeReflectionMapping:case e.CubeRefractionMapping:return new h.CubeTextureNode(r);case e.CubeUVReflectionMapping:case e.CubeUVRefractionMapping:return new f.TextureCubeNode(new u.TextureNode(r));default:return new u.TextureNode(r)}else{if(r.isVector2)return new a.Vector2Node(r);if(r.isVector3)return new d.Vector3Node(r);if(r.isVector4)return new c.Vector4Node(r)}}}},format:function(e,t,r){switch(this.colorToVector(r+" <- "+t)){case"f <- v2":case"f <- v3":case"f <- v4":return e+".x";case"f <- i":case"f <- b":return"float( "+e+" )";case"v2 <- f":return"vec2( "+e+" )";case"v2 <- v3":case"v2 <- v4":return e+".xy";case"v2 <- i":case"v2 <- b":return"vec2( float( "+e+" ) )";case"v3 <- f":return"vec3( "+e+" )";case"v3 <- v2":return"vec3( "+e+", 0.0 )";case"v3 <- v4":return e+".xyz";case"v3 <- i":case"v3 <- b":return"vec2( float( "+e+" ) )";case"v4 <- f":return"vec4( "+e+" )";case"v4 <- v2":return"vec4( "+e+", 0.0, 1.0 )";case"v4 <- v3":return"vec4( "+e+", 1.0 )";case"v4 <- i":case"v4 <- b":return"vec4( float( "+e+" ) )";case"i <- f":case"i <- b":return"int( "+e+" )";case"i <- v2":case"i <- v3":case"i <- v4":return"int( "+e+".x )";case"b <- f":return"( "+e+" != 0.0 )";case"b <- v2":return"( "+e+" != vec2( 0.0 ) )";case"b <- v3":return"( "+e+" != vec3( 0.0 ) )";case"b <- v4":return"( "+e+" != vec4( 0.0 ) )";case"b <- i":return"( "+e+" != 0 )"}return e},getTypeByFormat:function(e){return g[e]||e},getFormatByType:function(e){return m[e]||e},getUuid:function(e,t){return(t=void 0===t||t)&&this.cache&&(e=this.cache+"-"+e),e},getElementByIndex:function(e){return v[e]},getIndexByElement:function(e){return v.indexOf(e)},isShader:function(e){return this.shader===e},setShader:function(e){return this.shader=e,this},mergeDefines:function(e){for(var t in e)this.defines[t]=e[t];return this.defines},mergeUniform:function(e){for(var t in e)this.uniforms[t]=e[t];return this.uniforms},getTextureEncodingFromMap:function(t){var r;return t?t.isTexture?r=t.encoding:t.isWebGLRenderTarget&&(console.warn("THREE.WebGLPrograms.getTextureEncodingFromMap: don't use render targets as textures. Use their .texture property instead."),r=t.texture.encoding):r=e.LinearEncoding,r===e.LinearEncoding&&this.context.gamma&&(r=e.GammaEncoding),r}},exports.NodeBuilder=C;
