"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("three"),t=function(){function t(e,t){this.mesh=e,this.iks=t||[],this._valid()}var r,i,o,n,a,s,l,h,c,p;function d(t,r){e.Object3D.call(this),this.root=t,this.iks=r||[],this.matrix.copy(t.matrixWorld),this.matrixAutoUpdate=!1,this.sphereGeometry=new e.SphereGeometry(.25,16,8),this.targetSphereMaterial=new e.MeshBasicMaterial({color:new e.Color(16746632),depthTest:!1,depthWrite:!1,transparent:!0}),this.effectorSphereMaterial=new e.MeshBasicMaterial({color:new e.Color(8978312),depthTest:!1,depthWrite:!1,transparent:!0}),this.linkSphereMaterial=new e.MeshBasicMaterial({color:new e.Color(8947967),depthTest:!1,depthWrite:!1,transparent:!0}),this.lineMaterial=new e.LineBasicMaterial({color:new e.Color(16711680),depthTest:!1,depthWrite:!1,transparent:!0}),this._init()}return t.prototype={constructor:t,update:(r=new e.Quaternion,i=new e.Vector3,o=new e.Vector3,n=new e.Vector3,a=new e.Vector3,s=new e.Vector3,l=new e.Quaternion,h=new e.Vector3,c=new e.Vector3,p=new e.Vector3,function(){for(var e=this.mesh.skeleton.bones,t=this.iks,d=Math,u=0,m=t.length;u<m;u++){var v=t[u],f=e[v.effector],x=e[v.target];i.setFromMatrixPosition(x.matrixWorld);for(var M=v.links,w=void 0!==v.iteration?v.iteration:1,y=0;y<w;y++){for(var g=!1,k=0,b=M.length;k<b;k++){var V=e[M[k].index];if(!1===M[k].enabled)break;var W=M[k].limitation,A=M[k].rotationMin,S=M[k].rotationMax;V.matrixWorld.decompose(s,l,h),l.invert(),n.setFromMatrixPosition(f.matrixWorld),a.subVectors(n,s),a.applyQuaternion(l),a.normalize(),o.subVectors(i,s),o.applyQuaternion(l),o.normalize();var C=o.dot(a);if(C>1?C=1:C<-1&&(C=-1),!((C=d.acos(C))<1e-5)){if(void 0!==v.minAngle&&C<v.minAngle&&(C=v.minAngle),void 0!==v.maxAngle&&C>v.maxAngle&&(C=v.maxAngle),c.crossVectors(a,o),c.normalize(),r.setFromAxisAngle(c,C),V.quaternion.multiply(r),void 0!==W){var D=V.quaternion.w;D>1&&(D=1);var F=d.sqrt(1-D*D);V.quaternion.set(W.x*F,W.y*F,W.z*F,D)}void 0!==A&&V.rotation.setFromVector3(V.rotation.toVector3(p).max(A)),void 0!==S&&V.rotation.setFromVector3(V.rotation.toVector3(p).min(S)),V.updateMatrixWorld(!0),g=!0}}if(!g)break}}return this}),createHelper:function(){return new d(this.mesh,this.mesh.geometry.userData.MMD.iks)},_valid:function(){for(var e=this.iks,t=this.mesh.skeleton.bones,r=0,i=e.length;r<i;r++){var o=e[r],n=t[o.effector],a=o.links,s=void 0,l=void 0;s=n;for(var h=0,c=a.length;h<c;h++)l=t[a[h].index],s.parent!==l&&console.warn("THREE.CCDIKSolver: bone "+s.name+" is not the child of bone "+l.name),s=l}}},d.prototype=Object.assign(Object.create(e.Object3D.prototype),{constructor:d,updateMatrixWorld:function(){var t=new e.Matrix4,r=new e.Vector3;function i(e,t){return r.setFromMatrixPosition(e.matrixWorld).applyMatrix4(t)}function o(e,t,r,o){var n=i(r,o);e[3*t+0]=n.x,e[3*t+1]=n.y,e[3*t+2]=n.z}return function(r){var n=this.root;if(this.visible){var a=0,s=this.iks,l=n.skeleton.bones;t.copy(n.matrixWorld).invert();for(var h=0,c=s.length;h<c;h++){var p=s[h],d=l[p.target],u=l[p.effector],m=this.children[a++],v=this.children[a++];m.position.copy(i(d,t)),v.position.copy(i(u,t));for(var f=0,x=p.links.length;f<x;f++){var M=l[p.links[f].index];this.children[a++].position.copy(i(M,t))}var w=this.children[a++],y=w.geometry.attributes.position.array;o(y,0,d,t),o(y,1,u,t);for(var g=0,k=p.links.length;g<k;g++){o(y,g+2,M=l[p.links[g].index],t)}w.geometry.attributes.position.needsUpdate=!0}}this.matrix.copy(n.matrixWorld),e.Object3D.prototype.updateMatrixWorld.call(this,r)}}(),_init:function(){var t=this,r=this.iks;function i(r){return new e.Line(function(t){var r=new e.BufferGeometry,i=new Float32Array(3*(2+t.links.length));return r.setAttribute("position",new e.BufferAttribute(i,3)),r}(r),t.lineMaterial)}for(var o=0,n=r.length;o<n;o++){var a=r[o];this.add(new e.Mesh(t.sphereGeometry,t.targetSphereMaterial)),this.add(new e.Mesh(t.sphereGeometry,t.effectorSphereMaterial));for(var s=0,l=a.links.length;s<l;s++)this.add(new e.Mesh(t.sphereGeometry,t.linkSphereMaterial));this.add(i(a))}}}),t}();exports.CCDIKSolver=t;
