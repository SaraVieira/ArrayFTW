"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var t=require("three"),e=function(){function e(e,i,o,s){if("undefined"==typeof Ammo)throw new Error("THREE.MMDPhysics: Import ammo.js https://github.com/kripken/ammo.js");o=o||[],s=s||{},this.manager=new r,this.mesh=e,this.unitStep=void 0!==s.unitStep?s.unitStep:1/65,this.maxStepNum=void 0!==s.maxStepNum?s.maxStepNum:3,this.gravity=new t.Vector3(0,-98,0),void 0!==s.gravity&&this.gravity.copy(s.gravity),this.world=void 0!==s.world?s.world:null,this.bodies=[],this.constraints=[],this._init(e,i,o)}function r(){this.threeVector3s=[],this.threeMatrix4s=[],this.threeQuaternions=[],this.threeEulers=[],this.transforms=[],this.quaternions=[],this.vector3s=[]}function i(t,e,r,i){this.mesh=t,this.world=e,this.params=r,this.manager=i,this.body=null,this.bone=null,this.boneOffsetForm=null,this.boneOffsetFormInverse=null,this._init()}function o(t,e,r,i,o,s){this.mesh=t,this.world=e,this.bodyA=r,this.bodyB=i,this.params=o,this.manager=s,this.constraint=null,this._init()}function s(e,r){t.Object3D.call(this),this.root=e,this.physics=r,this.matrix.copy(e.matrixWorld),this.matrixAutoUpdate=!1,this.materials=[],this.materials.push(new t.MeshBasicMaterial({color:new t.Color(16746632),wireframe:!0,depthTest:!1,depthWrite:!1,opacity:.25,transparent:!0})),this.materials.push(new t.MeshBasicMaterial({color:new t.Color(8978312),wireframe:!0,depthTest:!1,depthWrite:!1,opacity:.25,transparent:!0})),this.materials.push(new t.MeshBasicMaterial({color:new t.Color(8947967),wireframe:!0,depthTest:!1,depthWrite:!1,opacity:.25,transparent:!0})),this._init()}var n,a,h,c;return e.prototype={constructor:e,update:function(t){var e,r=this.manager,i=this.mesh,o=!1,s=r.allocThreeVector3(),n=r.allocThreeQuaternion(),a=r.allocThreeVector3();return i.matrixWorld.decompose(s,n,a),1===a.x&&1===a.y&&1===a.z||(o=!0),o&&(null!==(e=i.parent)&&(i.parent=null),a.copy(this.mesh.scale),i.scale.set(1,1,1),i.updateMatrixWorld(!0)),this._updateRigidBodies(),this._stepSimulation(t),this._updateBones(),o&&(null!==e&&(i.parent=e),i.scale.copy(a)),r.freeThreeVector3(a),r.freeThreeQuaternion(n),r.freeThreeVector3(s),this},reset:function(){for(var t=0,e=this.bodies.length;t<e;t++)this.bodies[t].reset();return this},warmup:function(t){for(var e=0;e<t;e++)this.update(1/60);return this},setGravity:function(t){return this.world.setGravity(new Ammo.btVector3(t.x,t.y,t.z)),this.gravity.copy(t),this},createHelper:function(){return new s(this.mesh,this)},_init:function(t,e,r){var i=this.manager,o=t.parent;null!==o&&(o=null);var s=i.allocThreeVector3(),n=i.allocThreeQuaternion(),a=i.allocThreeVector3();s.copy(t.position),n.copy(t.quaternion),a.copy(t.scale),t.position.set(0,0,0),t.quaternion.set(0,0,0,1),t.scale.set(1,1,1),t.updateMatrixWorld(!0),null===this.world&&(this.world=this._createWorld(),this.setGravity(this.gravity)),this._initRigidBodies(e),this._initConstraints(r),null!==o&&(t.parent=o),t.position.copy(s),t.quaternion.copy(n),t.scale.copy(a),t.updateMatrixWorld(!0),this.reset(),i.freeThreeVector3(s),i.freeThreeQuaternion(n),i.freeThreeVector3(a)},_createWorld:function(){var t=new Ammo.btDefaultCollisionConfiguration,e=new Ammo.btCollisionDispatcher(t),r=new Ammo.btDbvtBroadphase,i=new Ammo.btSequentialImpulseConstraintSolver;return new Ammo.btDiscreteDynamicsWorld(e,r,i,t)},_initRigidBodies:function(t){for(var e=0,r=t.length;e<r;e++)this.bodies.push(new i(this.mesh,this.world,t[e],this.manager))},_initConstraints:function(t){for(var e=0,r=t.length;e<r;e++){var i=t[e],s=this.bodies[i.rigidBodyIndex1],n=this.bodies[i.rigidBodyIndex2];this.constraints.push(new o(this.mesh,this.world,s,n,i,this.manager))}},_stepSimulation:function(t){var e=this.unitStep,r=t,i=1+(t/e|0);r<e&&(r=e,i=1),i>this.maxStepNum&&(i=this.maxStepNum),this.world.stepSimulation(r,i,e)},_updateRigidBodies:function(){for(var t=0,e=this.bodies.length;t<e;t++)this.bodies[t].updateFromBone()},_updateBones:function(){for(var t=0,e=this.bodies.length;t<e;t++)this.bodies[t].updateBone()}},r.prototype={constructor:r,allocThreeVector3:function(){return this.threeVector3s.length>0?this.threeVector3s.pop():new t.Vector3},freeThreeVector3:function(t){this.threeVector3s.push(t)},allocThreeMatrix4:function(){return this.threeMatrix4s.length>0?this.threeMatrix4s.pop():new t.Matrix4},freeThreeMatrix4:function(t){this.threeMatrix4s.push(t)},allocThreeQuaternion:function(){return this.threeQuaternions.length>0?this.threeQuaternions.pop():new t.Quaternion},freeThreeQuaternion:function(t){this.threeQuaternions.push(t)},allocThreeEuler:function(){return this.threeEulers.length>0?this.threeEulers.pop():new t.Euler},freeThreeEuler:function(t){this.threeEulers.push(t)},allocTransform:function(){return this.transforms.length>0?this.transforms.pop():new Ammo.btTransform},freeTransform:function(t){this.transforms.push(t)},allocQuaternion:function(){return this.quaternions.length>0?this.quaternions.pop():new Ammo.btQuaternion},freeQuaternion:function(t){this.quaternions.push(t)},allocVector3:function(){return this.vector3s.length>0?this.vector3s.pop():new Ammo.btVector3},freeVector3:function(t){this.vector3s.push(t)},setIdentity:function(t){t.setIdentity()},getBasis:function(t){var e=this.allocQuaternion();return t.getBasis().getRotation(e),e},getBasisAsMatrix3:function(t){var e=this.getBasis(t),r=this.quaternionToMatrix3(e);return this.freeQuaternion(e),r},getOrigin:function(t){return t.getOrigin()},setOrigin:function(t,e){t.getOrigin().setValue(e.x(),e.y(),e.z())},copyOrigin:function(t,e){var r=e.getOrigin();this.setOrigin(t,r)},setBasis:function(t,e){t.setRotation(e)},setBasisFromMatrix3:function(t,e){var r=this.matrix3ToQuaternion(e);this.setBasis(t,r),this.freeQuaternion(r)},setOriginFromArray3:function(t,e){t.getOrigin().setValue(e[0],e[1],e[2])},setOriginFromThreeVector3:function(t,e){t.getOrigin().setValue(e.x,e.y,e.z)},setBasisFromArray3:function(t,e){var r=this.allocThreeQuaternion(),i=this.allocThreeEuler();i.set(e[0],e[1],e[2]),this.setBasisFromThreeQuaternion(t,r.setFromEuler(i)),this.freeThreeEuler(i),this.freeThreeQuaternion(r)},setBasisFromThreeQuaternion:function(t,e){var r=this.allocQuaternion();r.setX(e.x),r.setY(e.y),r.setZ(e.z),r.setW(e.w),this.setBasis(t,r),this.freeQuaternion(r)},multiplyTransforms:function(t,e){var r=this.allocTransform();this.setIdentity(r);var i=this.getBasisAsMatrix3(t),o=this.getBasisAsMatrix3(e),s=this.getOrigin(t),n=this.getOrigin(e),a=this.multiplyMatrix3ByVector3(i,n),h=this.addVector3(a,s);this.setOrigin(r,h);var c=this.multiplyMatrices3(i,o);return this.setBasisFromMatrix3(r,c),this.freeVector3(a),this.freeVector3(h),r},inverseTransform:function(t){var e=this.allocTransform(),r=this.getBasisAsMatrix3(t),i=this.getOrigin(t),o=this.transposeMatrix3(r),s=this.negativeVector3(i),n=this.multiplyMatrix3ByVector3(o,s);return this.setOrigin(e,n),this.setBasisFromMatrix3(e,o),this.freeVector3(s),this.freeVector3(n),e},multiplyMatrices3:function(t,e){var r=[],i=this.rowOfMatrix3(t,0),o=this.rowOfMatrix3(t,1),s=this.rowOfMatrix3(t,2),n=this.columnOfMatrix3(e,0),a=this.columnOfMatrix3(e,1),h=this.columnOfMatrix3(e,2);return r[0]=this.dotVectors3(i,n),r[1]=this.dotVectors3(i,a),r[2]=this.dotVectors3(i,h),r[3]=this.dotVectors3(o,n),r[4]=this.dotVectors3(o,a),r[5]=this.dotVectors3(o,h),r[6]=this.dotVectors3(s,n),r[7]=this.dotVectors3(s,a),r[8]=this.dotVectors3(s,h),this.freeVector3(i),this.freeVector3(o),this.freeVector3(s),this.freeVector3(n),this.freeVector3(a),this.freeVector3(h),r},addVector3:function(t,e){var r=this.allocVector3();return r.setValue(t.x()+e.x(),t.y()+e.y(),t.z()+e.z()),r},dotVectors3:function(t,e){return t.x()*e.x()+t.y()*e.y()+t.z()*e.z()},rowOfMatrix3:function(t,e){var r=this.allocVector3();return r.setValue(t[3*e+0],t[3*e+1],t[3*e+2]),r},columnOfMatrix3:function(t,e){var r=this.allocVector3();return r.setValue(t[e+0],t[e+3],t[e+6]),r},negativeVector3:function(t){var e=this.allocVector3();return e.setValue(-t.x(),-t.y(),-t.z()),e},multiplyMatrix3ByVector3:function(t,e){var r=this.allocVector3(),i=this.rowOfMatrix3(t,0),o=this.rowOfMatrix3(t,1),s=this.rowOfMatrix3(t,2),n=this.dotVectors3(i,e),a=this.dotVectors3(o,e),h=this.dotVectors3(s,e);return r.setValue(n,a,h),this.freeVector3(i),this.freeVector3(o),this.freeVector3(s),r},transposeMatrix3:function(t){var e=[];return e[0]=t[0],e[1]=t[3],e[2]=t[6],e[3]=t[1],e[4]=t[4],e[5]=t[7],e[6]=t[2],e[7]=t[5],e[8]=t[8],e},quaternionToMatrix3:function(t){var e=[],r=t.x(),i=t.y(),o=t.z(),s=t.w(),n=r*r,a=i*i,h=o*o,c=r*i,l=i*o,u=o*r,m=r*s,f=i*s,p=o*s;return e[0]=1-2*(a+h),e[1]=2*(c-p),e[2]=2*(u+f),e[3]=2*(c+p),e[4]=1-2*(h+n),e[5]=2*(l-m),e[6]=2*(u-f),e[7]=2*(l+m),e[8]=1-2*(n+a),e},matrix3ToQuaternion:function(t){var e,r,i,o,s,n=t[0]+t[4]+t[8];n>0?(s=.25*(e=2*Math.sqrt(n+1)),r=(t[7]-t[5])/e,i=(t[2]-t[6])/e,o=(t[3]-t[1])/e):t[0]>t[4]&&t[0]>t[8]?(e=2*Math.sqrt(1+t[0]-t[4]-t[8]),s=(t[7]-t[5])/e,r=.25*e,i=(t[1]+t[3])/e,o=(t[2]+t[6])/e):t[4]>t[8]?(e=2*Math.sqrt(1+t[4]-t[0]-t[8]),s=(t[2]-t[6])/e,r=(t[1]+t[3])/e,i=.25*e,o=(t[5]+t[7])/e):(e=2*Math.sqrt(1+t[8]-t[0]-t[4]),s=(t[3]-t[1])/e,r=(t[2]+t[6])/e,i=(t[5]+t[7])/e,o=.25*e);var a=this.allocQuaternion();return a.setX(r),a.setY(i),a.setZ(o),a.setW(s),a}},i.prototype={constructor:e.RigidBody,reset:function(){return this._setTransformFromBone(),this},updateFromBone:function(){return-1!==this.params.boneIndex&&0===this.params.type&&this._setTransformFromBone(),this},updateBone:function(){return 0===this.params.type||-1===this.params.boneIndex||(this._updateBoneRotation(),1===this.params.type&&this._updateBonePosition(),this.bone.updateMatrixWorld(!0),2===this.params.type&&this._setPositionFromBone()),this},_init:function(){var e=this.manager,r=this.params,i=this.mesh.skeleton.bones,o=-1===r.boneIndex?new t.Bone:i[r.boneIndex],s=function(t){switch(t.shapeType){case 0:return new Ammo.btSphereShape(t.width);case 1:return new Ammo.btBoxShape(new Ammo.btVector3(t.width,t.height,t.depth));case 2:return new Ammo.btCapsuleShape(t.width,t.height);default:throw"unknown shape type "+t.shapeType}}(r),n=0===r.type?0:r.weight,a=e.allocVector3();a.setValue(0,0,0),0!==n&&s.calculateLocalInertia(n,a);var h=e.allocTransform();e.setIdentity(h),e.setOriginFromArray3(h,r.position),e.setBasisFromArray3(h,r.rotation);var c=e.allocThreeVector3(),l=e.allocTransform();e.setIdentity(l),e.setOriginFromThreeVector3(l,o.getWorldPosition(c));var u=e.multiplyTransforms(l,h),m=new Ammo.btDefaultMotionState(u),f=new Ammo.btRigidBodyConstructionInfo(n,m,s,a);f.set_m_friction(r.friction),f.set_m_restitution(r.restitution);var p=new Ammo.btRigidBody(f);0===r.type&&(p.setCollisionFlags(2|p.getCollisionFlags()),p.setActivationState(4)),p.setDamping(r.positionDamping,r.rotationDamping),p.setSleepingThresholds(0,0),this.world.addRigidBody(p,1<<r.groupIndex,r.groupTarget),this.body=p,this.bone=o,this.boneOffsetForm=h,this.boneOffsetFormInverse=e.inverseTransform(h),e.freeVector3(a),e.freeTransform(u),e.freeTransform(l),e.freeThreeVector3(c)},_getBoneTransform:function(){var t=this.manager,e=t.allocThreeVector3(),r=t.allocThreeQuaternion(),i=t.allocThreeVector3();this.bone.matrixWorld.decompose(e,r,i);var o=t.allocTransform();t.setOriginFromThreeVector3(o,e),t.setBasisFromThreeQuaternion(o,r);var s=t.multiplyTransforms(o,this.boneOffsetForm);return t.freeTransform(o),t.freeThreeVector3(i),t.freeThreeQuaternion(r),t.freeThreeVector3(e),s},_getWorldTransformForBone:function(){var t=this.manager,e=this.body.getCenterOfMassTransform();return t.multiplyTransforms(e,this.boneOffsetFormInverse)},_setTransformFromBone:function(){var t=this.manager,e=this._getBoneTransform();this.body.setCenterOfMassTransform(e),this.body.getMotionState().setWorldTransform(e),t.freeTransform(e)},_setPositionFromBone:function(){var t=this.manager,e=this._getBoneTransform(),r=t.allocTransform();this.body.getMotionState().getWorldTransform(r),t.copyOrigin(r,e),this.body.setCenterOfMassTransform(r),this.body.getMotionState().setWorldTransform(r),t.freeTransform(r),t.freeTransform(e)},_updateBoneRotation:function(){var t=this.manager,e=this._getWorldTransformForBone(),r=t.getBasis(e),i=t.allocThreeQuaternion(),o=t.allocThreeQuaternion(),s=t.allocThreeQuaternion();i.set(r.x(),r.y(),r.z(),r.w()),o.setFromRotationMatrix(this.bone.matrixWorld),o.conjugate(),o.multiply(i),s.setFromRotationMatrix(this.bone.matrix),this.bone.quaternion.copy(o.multiply(s).normalize()),t.freeThreeQuaternion(i),t.freeThreeQuaternion(o),t.freeThreeQuaternion(s),t.freeQuaternion(r),t.freeTransform(e)},_updateBonePosition:function(){var t=this.manager,e=this._getWorldTransformForBone(),r=t.allocThreeVector3(),i=t.getOrigin(e);r.set(i.x(),i.y(),i.z()),this.bone.parent&&this.bone.parent.worldToLocal(r),this.bone.position.copy(r),t.freeThreeVector3(r),t.freeTransform(e)}},o.prototype={constructor:o,_init:function(){var t=this.manager,e=this.params,r=this.bodyA,i=this.bodyB,o=t.allocTransform();t.setIdentity(o),t.setOriginFromArray3(o,e.position),t.setBasisFromArray3(o,e.rotation);var s=t.allocTransform(),n=t.allocTransform();r.body.getMotionState().getWorldTransform(s),i.body.getMotionState().getWorldTransform(n);var a=t.inverseTransform(s),h=t.inverseTransform(n),c=t.multiplyTransforms(a,o),l=t.multiplyTransforms(h,o),u=new Ammo.btGeneric6DofSpringConstraint(r.body,i.body,c,l,!0),m=t.allocVector3(),f=t.allocVector3(),p=t.allocVector3(),d=t.allocVector3();m.setValue(e.translationLimitation1[0],e.translationLimitation1[1],e.translationLimitation1[2]),f.setValue(e.translationLimitation2[0],e.translationLimitation2[1],e.translationLimitation2[2]),p.setValue(e.rotationLimitation1[0],e.rotationLimitation1[1],e.rotationLimitation1[2]),d.setValue(e.rotationLimitation2[0],e.rotationLimitation2[1],e.rotationLimitation2[2]),u.setLinearLowerLimit(m),u.setLinearUpperLimit(f),u.setAngularLowerLimit(p),u.setAngularUpperLimit(d);for(var g=0;g<3;g++)0!==e.springPosition[g]&&(u.enableSpring(g,!0),u.setStiffness(g,e.springPosition[g]));for(var y=0;y<3;y++)0!==e.springRotation[y]&&(u.enableSpring(y+3,!0),u.setStiffness(y+3,e.springRotation[y]));if(void 0!==u.setParam)for(var T=0;T<6;T++)u.setParam(2,.475,T);this.world.addConstraint(u,!0),this.constraint=u,t.freeTransform(o),t.freeTransform(s),t.freeTransform(n),t.freeTransform(a),t.freeTransform(h),t.freeTransform(c),t.freeTransform(l),t.freeVector3(m),t.freeVector3(f),t.freeVector3(p),t.freeVector3(d)}},s.prototype=Object.assign(Object.create(t.Object3D.prototype),{constructor:s,updateMatrixWorld:(n=new t.Vector3,a=new t.Quaternion,h=new t.Vector3,c=new t.Matrix4,function(e){var r=this.root;if(this.visible){var i=this.physics.bodies;c.copy(r.matrixWorld).decompose(n,a,h).compose(n,a,h.set(1,1,1)).invert();for(var o=0,s=i.length;o<s;o++){var l=i[o].body,u=this.children[o],m=l.getCenterOfMassTransform(),f=m.getOrigin(),p=m.getRotation();u.position.set(f.x(),f.y(),f.z()).applyMatrix4(c),u.quaternion.setFromRotationMatrix(c).multiply(a.set(p.x(),p.y(),p.z(),p.w()))}}this.matrix.copy(r.matrixWorld).decompose(n,a,h).compose(n,a,h.set(1,1,1)),t.Object3D.prototype.updateMatrixWorld.call(this,e)}),_init:function(){var e=this.physics.bodies;function r(e){switch(e.shapeType){case 0:return new t.SphereGeometry(e.width,16,8);case 1:return new t.BoxGeometry(2*e.width,2*e.height,2*e.depth,8,8,8);case 2:return new i(e.width,e.height,16,8);default:return null}}function i(e,r,i,o){var s=new t.CylinderGeometry(e,e,r,i,o,!0),n=new t.Mesh(new t.SphereGeometry(e,i,o,0,2*Math.PI,0,Math.PI/2)),a=new t.Mesh(new t.SphereGeometry(e,i,o,0,2*Math.PI,Math.PI/2,Math.PI/2));return n.position.set(0,r/2,0),a.position.set(0,-r/2,0),n.updateMatrix(),a.updateMatrix(),s.merge(n.geometry,n.matrix),s.merge(a.geometry,a.matrix),s}for(var o=0,s=e.length;o<s;o++){var n=e[o].params;this.add(new t.Mesh(r(n),this.materials[n.type]))}}}),e}();exports.MMDPhysics=e;
