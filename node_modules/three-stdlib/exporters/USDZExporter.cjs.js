"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("@babel/runtime/helpers/asyncToGenerator"),n=require("fflate");function t(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var r=t(e),u=function(){function e(){}return e.prototype.parse=function(){var e=r.default(regeneratorRuntime.mark((function e(t){var r,u,o,s,l,c,d,h,x,v,g,M;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:r='#usda 1.0\n(\n    customLayerData = {\n        string creator = "Three.js USDZExporter"\n    }\n    metersPerUnit = 1\n    upAxis = "Y"\n)\n\n',u={},o={},t.traverse((function(e){if(e.isMesh){var n=e.geometry,t=e.material;u[t.uuid]=t,null!==t.map&&(o[t.map.uuid]=t.map),null!==t.normalMap&&(o[t.normalMap.uuid]=t.normalMap),null!==t.aoMap&&(o[t.aoMap.uuid]=t.aoMap),null!==t.roughnessMap&&(o[t.roughnessMap.uuid]=t.roughnessMap),null!==t.metalnessMap&&(o[t.metalnessMap.uuid]=t.metalnessMap),null!==t.emissiveMap&&(o[t.emissiveMap.uuid]=t.emissiveMap),r+=a(e,p(n,t))}})),r+=f(u),r+=m(o),s={"model.usda":n.strToU8(r)},e.t0=regeneratorRuntime.keys(o);case 8:if((e.t1=e.t0()).done){e.next=16;break}return l=e.t1.value,c=o[l],e.next=13,i(c.image);case 13:s["textures/Texture_"+c.id+".jpg"]=e.sent,e.next=8;break;case 16:for(h in d=0,s)x=s[h],v=34+h.length,4!==(g=63&(d+=v))&&(M=new Uint8Array(64-g),s[h]=[x,{extra:{12345:M}}]),d=x.length;return e.abrupt("return",n.zipSync(s,{level:0}));case 19:case"end":return e.stop()}}),e)})));return function(n){return e.apply(this,arguments)}}(),e}();function i(e){return o.apply(this,arguments)}function o(){return(o=r.default(regeneratorRuntime.mark((function e(n){var t,r,u;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!("undefined"!=typeof HTMLImageElement&&n instanceof HTMLImageElement||"undefined"!=typeof HTMLCanvasElement&&n instanceof HTMLCanvasElement||"undefined"!=typeof OffscreenCanvas&&n instanceof OffscreenCanvas||"undefined"!=typeof ImageBitmap&&n instanceof ImageBitmap)){e.next=15;break}return t=1024/Math.max(n.width,n.height),(r=document.createElement("canvas")).width=n.width*Math.min(1,t),r.height=n.height*Math.min(1,t),r.getContext("2d").drawImage(n,0,0,r.width,r.height),e.next=9,new Promise((function(e){return r.toBlob(e,"image/jpeg",1)}));case 9:return u=e.sent,e.t0=Uint8Array,e.next=13,u.arrayBuffer();case 13:return e.t1=e.sent,e.abrupt("return",new e.t0(e.t1));case 15:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function a(e,n){var t,r;return'def Xform "'+("Object_"+e.id)+'"\n{\n    matrix4d xformOp:transform = '+(t=e.matrixWorld,"( "+s(r=t.elements,0)+", "+s(r,4)+", "+s(r,8)+", "+s(r,12)+" )")+'\n    uniform token[] xformOpOrder = ["xformOp:transform"]\n\n    '+n+"\n}\n\n"}function s(e,n){return"("+e[n+0]+", "+e[n+1]+", "+e[n+2]+", "+e[n+3]+")"}function p(e,n){var t="Geometry_"+e.id,r=e.attributes,u=r.position.count;return"uv2"in r&&console.warn("THREE.USDZExporter: uv2 not supported yet."),'def Mesh "'+t+'"\n    {\n        int[] faceVertexCounts = ['+function(e){var n=null!==e.index?e.index.array.length:e.attributes.position.count;return Array(n/3).fill(3).join(", ")}(e)+"]\n        int[] faceVertexIndices = ["+function(e){if(null!==e.index)return e.index.array.join(", ");for(var n=[],t=e.attributes.position.count,r=0;r<t;r++)n.push(r);return n.join(", ")}(e)+"]\n        rel material:binding = </Materials/Material_"+n.id+">\n        normal3f[] normals = ["+l(r.normal,u)+'] (\n            interpolation = "vertex"\n        )\n        point3f[] points = ['+l(r.position,u)+"]\n        float2[] primvars:st = ["+function(e,n){if(void 0===e)return console.warn("USDZExporter: UVs missing."),Array(n).fill("(0, 0)").join(", ");for(var t=[],r=e.array,u=0;u<r.length;u+=2)t.push("("+r[u+0].toPrecision(7)+", "+(1-r[u+1].toPrecision(7))+")");return t.join(", ")}(r.uv,u)+'] (\n            interpolation = "vertex"\n        )\n        uniform token subdivisionScheme = "none"\n    }\n'}function l(e,n){if(void 0===e)return console.warn("USDZExporter: Normals missing."),Array(n).fill("(0, 0, 0)").join(", ");for(var t=[],r=e.array,u=0;u<r.length;u+=3)t.push("("+r[u+0].toPrecision(7)+", "+r[u+1].toPrecision(7)+", "+r[u+2].toPrecision(7)+")");return t.join(", ")}function f(e){var n=[];for(var t in e){var r=e[t];n.push(c(r))}return'def "Materials"\n{\n'+n.join("")+"\n}\n\n"}function c(e){var n="            ",t=[];return null!==e.map?t.push(n+"color3f inputs:diffuseColor.connect = </Textures/Texture_"+e.map.id+".outputs:rgb>"):t.push(n+"color3f inputs:diffuseColor = "+h(e.color)),null!==e.emissiveMap?t.push(n+"color3f inputs:emissiveColor.connect = </Textures/Texture_"+e.emissiveMap.id+".outputs:rgb>"):e.emissive.getHex()>0&&t.push(n+"color3f inputs:emissiveColor = "+h(e.emissive)),null!==e.normalMap&&t.push(n+"normal3f inputs:normal.connect = </Textures/Texture_"+e.normalMap.id+".outputs:rgb>"),null!==e.aoMap&&t.push(n+"float inputs:occlusion.connect = </Textures/Texture_"+e.aoMap.id+".outputs:r>"),null!==e.roughnessMap?t.push(n+"float inputs:roughness.connect = </Textures/Texture_"+e.roughnessMap.id+".outputs:g>"):t.push(n+"float inputs:roughness = "+e.roughness),null!==e.metalnessMap?t.push(n+"float inputs:metallic.connect = </Textures/Texture_"+e.metalnessMap.id+".outputs:b>"):t.push(n+"float inputs:metallic = "+e.metalness),'\n    def Material "Material_'+e.id+'"\n    {\n        token outputs:surface.connect = </Materials/Material_'+e.id+'/PreviewSurface.outputs:surface>\n\n        def Shader "PreviewSurface"\n        {\n            uniform token info:id = "UsdPreviewSurface"\n'+t.join("\n")+"\n            int inputs:useSpecularWorkflow = 0\n            token outputs:surface\n        }\n    }\n"}function m(e){var n=[];for(var t in e){var r=e[t];n.push(d(r))}return'def "Textures"\n{\n'+n.join("")+"\n}\n\n"}function d(e){return'\n    def Shader "Texture_'+e.id+'"\n    {\n        uniform token info:id = "UsdUVTexture"\n        asset inputs:file = @textures/Texture_'+e.id+'.jpg@\n        token inputs:wrapS = "repeat"\n        token inputs:wrapT = "repeat"\n        float outputs:r\n        float outputs:g\n        float outputs:b\n        float3 outputs:rgb\n    }\n'}function h(e){return"("+e.r+", "+e.g+", "+e.b+")"}exports.USDZExporter=u;
