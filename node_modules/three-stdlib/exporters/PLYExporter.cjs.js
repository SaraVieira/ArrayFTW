"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var t=require("three"),e=function(){};e.prototype={constructor:e,parse:function(e,n,r){function i(t){e.traverse((function(e){if(!0===e.isMesh){var n=e,r=n.geometry;if(!0!==r.isBufferGeometry)throw new Error("THREE.PLYExporter: Geometry is not of type THREE.BufferGeometry.");!0===r.hasAttribute("position")&&t(n,r)}}))}n&&"object"==typeof n&&(console.warn('THREE.PLYExporter: The options parameter is now the third argument to the "parse" function. See the documentation for the new API.'),r=n,n=void 0);var o=(r=Object.assign({binary:!1,excludeAttributes:[],littleEndian:!1},r)).excludeAttributes,l=!1,a=!1,u=!1,s=0,f=0;e.traverse((function(t){if(!0===t.isMesh){var e=t.geometry;if(!0!==e.isBufferGeometry)throw new Error("THREE.PLYExporter: Geometry is not of type THREE.BufferGeometry.");var n=e.getAttribute("position"),r=e.getAttribute("normal"),i=e.getAttribute("uv"),o=e.getAttribute("color"),d=e.getIndex();if(void 0===n)return;s+=n.count,f+=d?d.count/3:n.count/3,void 0!==r&&(l=!0),void 0!==i&&(u=!0),void 0!==o&&(a=!0)}}));var d=-1===o.indexOf("index");if(l=l&&-1===o.indexOf("normal"),a=a&&-1===o.indexOf("color"),u=u&&-1===o.indexOf("uv"),d&&f!==Math.floor(f))return console.error("PLYExporter: Failed to generate a valid PLY file with triangle indices because the number of indices is not divisible by 3."),null;var g="ply\nformat "+(r.binary?r.littleEndian?"binary_little_endian":"binary_big_endian":"ascii")+" 1.0\nelement vertex "+s+"\nproperty float x\nproperty float y\nproperty float z\n";!0===l&&(g+="property float nx\nproperty float ny\nproperty float nz\n"),!0===u&&(g+="property float s\nproperty float t\n"),!0===a&&(g+="property uchar red\nproperty uchar green\nproperty uchar blue\n"),!0===d&&(g+="element face "+f+"\nproperty list uchar int vertex_index\n"),g+="end_header\n";var p=new t.Vector3,c=new t.Matrix3,y=null;if(!0===r.binary){var x=(new TextEncoder).encode(g),E=s*(12+(l?12:0)+(a?3:0)+(u?8:0)),v=d?13*f:0,b=new DataView(new ArrayBuffer(x.length+E+v));new Uint8Array(b.buffer).set(x,0);var h=x.length,m=x.length+E,A=0;i((function(t,e){var n=e.getAttribute("position"),i=e.getAttribute("normal"),o=e.getAttribute("uv"),s=e.getAttribute("color"),f=e.getIndex();c.getNormalMatrix(t.matrixWorld);for(var g=0,y=n.count;g<y;g++)p.x=n.getX(g),p.y=n.getY(g),p.z=n.getZ(g),p.applyMatrix4(t.matrixWorld),b.setFloat32(h,p.x,r.littleEndian),h+=4,b.setFloat32(h,p.y,r.littleEndian),h+=4,b.setFloat32(h,p.z,r.littleEndian),h+=4,!0===l&&(null!=i?(p.x=i.getX(g),p.y=i.getY(g),p.z=i.getZ(g),p.applyMatrix3(c).normalize(),b.setFloat32(h,p.x,r.littleEndian),h+=4,b.setFloat32(h,p.y,r.littleEndian),h+=4,b.setFloat32(h,p.z,r.littleEndian),h+=4):(b.setFloat32(h,0,r.littleEndian),h+=4,b.setFloat32(h,0,r.littleEndian),h+=4,b.setFloat32(h,0,r.littleEndian),h+=4)),!0===u&&(null!=o?(b.setFloat32(h,o.getX(g),r.littleEndian),h+=4,b.setFloat32(h,o.getY(g),r.littleEndian),h+=4):!1!==u&&(b.setFloat32(h,0,r.littleEndian),h+=4,b.setFloat32(h,0,r.littleEndian),h+=4)),!0===a&&(null!=s?(b.setUint8(h,Math.floor(255*s.getX(g))),h+=1,b.setUint8(h,Math.floor(255*s.getY(g))),h+=1,b.setUint8(h,Math.floor(255*s.getZ(g))),h+=1):(b.setUint8(h,255),h+=1,b.setUint8(h,255),h+=1,b.setUint8(h,255),h+=1));if(!0===d)if(null!==f)for(var x=0,E=f.count;x<E;x+=3)b.setUint8(m,3),m+=1,b.setUint32(m,f.getX(x+0)+A,r.littleEndian),m+=4,b.setUint32(m,f.getX(x+1)+A,r.littleEndian),m+=4,b.setUint32(m,f.getX(x+2)+A,r.littleEndian),m+=4;else for(var v=0,M=n.count;v<M;v+=3)b.setUint8(m,3),m+=1,b.setUint32(m,A+v,r.littleEndian),m+=4,b.setUint32(m,A+v+1,r.littleEndian),m+=4,b.setUint32(m,A+v+2,r.littleEndian),m+=4;A+=n.count})),y=b.buffer}else{A=0;var M="",w="";i((function(t,e){var n=e.getAttribute("position"),r=e.getAttribute("normal"),i=e.getAttribute("uv"),o=e.getAttribute("color"),s=e.getIndex();c.getNormalMatrix(t.matrixWorld);for(var g=0,y=n.count;g<y;g++){p.x=n.getX(g),p.y=n.getY(g),p.z=n.getZ(g),p.applyMatrix4(t.matrixWorld);var x=p.x+" "+p.y+" "+p.z;!0===l&&(null!=r?(p.x=r.getX(g),p.y=r.getY(g),p.z=r.getZ(g),p.applyMatrix3(c).normalize(),x+=" "+p.x+" "+p.y+" "+p.z):x+=" 0 0 0"),!0===u&&(null!=i?x+=" "+i.getX(g)+" "+i.getY(g):!1!==u&&(x+=" 0 0")),!0===a&&(x+=null!=o?" "+Math.floor(255*o.getX(g))+" "+Math.floor(255*o.getY(g))+" "+Math.floor(255*o.getZ(g)):" 255 255 255"),M+=x+"\n"}if(!0===d){if(null!==s)for(var E=0,v=s.count;E<v;E+=3)w+="3 "+(s.getX(E+0)+A),w+=" "+(s.getX(E+1)+A),w+=" "+(s.getX(E+2)+A)+"\n";else for(var b=0,h=n.count;b<h;b+=3)w+="3 "+(A+b)+" "+(A+b+1)+" "+(A+b+2)+"\n";f+=s?s.count/3:n.count/3}A+=n.count})),y=""+g+M+(d?w+"\n":"\n")}return"function"==typeof n&&requestAnimationFrame((function(){return n(y)})),y}},exports.PLYExporter=e;
