"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("three"),t=function(){function t(){this.pluginCallbacks=[],this.register((function(e){return new R(e)})),this.register((function(e){return new F(e)})),this.register((function(e){return new N(e)}))}t.prototype={constructor:t,register:function(e){return-1===this.pluginCallbacks.indexOf(e)&&this.pluginCallbacks.push(e),this},unregister:function(e){return-1!==this.pluginCallbacks.indexOf(e)&&this.pluginCallbacks.splice(this.pluginCallbacks.indexOf(e),1),this},parse:function(e,t,r){for(var s=new S,i=[],n=0,a=this.pluginCallbacks.length;n<a;n++)i.push(this.pluginCallbacks[n](s));s.setPlugins(i),s.write(e,t,r)}};var r=0,s=1,i=2,n=3,a=4,o=5121,l=5123,u=5126,h=5125,p=34962,c=34963,f=9728,m=9729,g=9984,d=9985,v=9986,y=9987,b=33071,x=33648,w=10497,T={};T[e.NearestFilter]=f,T[e.NearestMipmapNearestFilter]=g,T[e.NearestMipmapLinearFilter]=v,T[e.LinearFilter]=m,T[e.LinearMipmapNearestFilter]=d,T[e.LinearMipmapLinearFilter]=y,T[e.ClampToEdgeWrapping]=b,T[e.RepeatWrapping]=w,T[e.MirroredRepeatWrapping]=x;var M={scale:"scale",position:"translation",quaternion:"rotation",morphTargetInfluences:"weights"};function A(e,t){return e.length===t.length&&e.every((function(e,r){return e===t[r]}))}function E(e){return 4*Math.ceil(e/4)}function I(e,t){t=t||0;var r=E(e.byteLength);if(r!==e.byteLength){var s=new Uint8Array(r);if(s.set(new Uint8Array(e)),0!==t)for(var i=e.byteLength;i<r;i++)s[i]=t;return s.buffer}return e}var L=null;function S(){this.plugins=[],this.options={},this.pending=[],this.buffers=[],this.byteOffset=0,this.buffers=[],this.nodeMap=new Map,this.skins=[],this.extensionsUsed={},this.uids=new Map,this.uid=0,this.json={asset:{version:"2.0",generator:"THREE.GLTFExporter"}},this.cache={meshes:new Map,attributes:new Map,attributesNormalized:new Map,materials:new Map,textures:new Map,images:new Map}}function R(e){this.writer=e,this.name="KHR_lights_punctual"}function F(e){this.writer=e,this.name="KHR_materials_unlit"}function N(e){this.writer=e,this.name="KHR_materials_pbrSpecularGlossiness"}return S.prototype={constructor:S,setPlugins:function(e){this.plugins=e},write:function(e,t,r){this.options=Object.assign({},{binary:!1,trs:!1,onlyVisible:!0,truncateDrawRange:!0,embedImages:!0,maxTextureSize:1/0,animations:[],includeCustomExtensions:!1},r),this.options.animations.length>0&&(this.options.trs=!0),this.processInput(e);var s=this;Promise.all(this.pending).then((function(){var e,r=s.buffers,i=s.json,n=s.options,a=s.extensionsUsed,o=new Blob(r,{type:"application/octet-stream"}),l=Object.keys(a);(l.length>0&&(i.extensionsUsed=l),i.buffers&&i.buffers.length>0&&(i.buffers[0].byteLength=o.size),!0===n.binary)?((e=new window.FileReader).readAsArrayBuffer(o),e.onloadend=function(){var r=I(e.result),s=new DataView(new ArrayBuffer(8));s.setUint32(0,r.byteLength,!0),s.setUint32(4,5130562,!0);var n=I(function(e){if(void 0!==window.TextEncoder)return(new TextEncoder).encode(e).buffer;for(var t=new Uint8Array(new ArrayBuffer(e.length)),r=0,s=e.length;r<s;r++){var i=e.charCodeAt(r);t[r]=i>255?32:i}return t.buffer}(JSON.stringify(i)),32),a=new DataView(new ArrayBuffer(8));a.setUint32(0,n.byteLength,!0),a.setUint32(4,1313821514,!0);var o=new ArrayBuffer(12),l=new DataView(o);l.setUint32(0,1179937895,!0),l.setUint32(4,2,!0);var u=12+a.byteLength+n.byteLength+s.byteLength+r.byteLength;l.setUint32(8,u,!0);var h=new Blob([o,a,n,s,r],{type:"application/octet-stream"}),p=new window.FileReader;p.readAsArrayBuffer(h),p.onloadend=function(){t(p.result)}}):i.buffers&&i.buffers.length>0?((e=new window.FileReader).readAsDataURL(o),e.onloadend=function(){var r=e.result;i.buffers[0].uri=r,t(i)}):t(i)}))},serializeUserData:function(e,t){if(0!==Object.keys(e.userData).length){var r=this.options,s=this.extensionsUsed;try{var i=JSON.parse(JSON.stringify(e.userData));if(r.includeCustomExtensions&&i.gltfExtensions){for(var n in void 0===t.extensions&&(t.extensions={}),i.gltfExtensions)t.extensions[n]=i.gltfExtensions[n],s[n]=!0;delete i.gltfExtensions}Object.keys(i).length>0&&(t.extras=i)}catch(t){console.warn("THREE.GLTFExporter: userData of '"+e.name+"' won't be serialized because of JSON.stringify error - "+t.message)}}},getUID:function(e){return this.uids.has(e)||this.uids.set(e,this.uid++),this.uids.get(e)},isNormalizedNormalAttribute:function(t){if(this.cache.attributesNormalized.has(t))return!1;for(var r=new e.Vector3,s=0,i=t.count;s<i;s++)if(Math.abs(r.fromBufferAttribute(t,s).length()-1)>5e-4)return!1;return!0},createNormalizedNormalAttribute:function(t){var r=this.cache;if(r.attributesNormalized.has(t))return r.attributesNormalized.get(t);for(var s=t.clone(),i=new e.Vector3,n=0,a=s.count;n<a;n++)i.fromBufferAttribute(s,n),0===i.x&&0===i.y&&0===i.z?i.setX(1):i.normalize(),s.setXYZ(n,i.x,i.y,i.z);return r.attributesNormalized.set(t,s),s},applyTextureTransform:function(e,t){var r=!1,s={};0===t.offset.x&&0===t.offset.y||(s.offset=t.offset.toArray(),r=!0),0!==t.rotation&&(s.rotation=t.rotation,r=!0),1===t.repeat.x&&1===t.repeat.y||(s.scale=t.repeat.toArray(),r=!0),r&&(e.extensions=e.extensions||{},e.extensions.KHR_texture_transform=s,this.extensionsUsed.KHR_texture_transform=!0)},processBuffer:function(e){var t=this.json,r=this.buffers;return t.buffers||(t.buffers=[{byteLength:0}]),r.push(e),0},processBufferView:function(e,t,r,s,i){var n,a=this.json;a.bufferViews||(a.bufferViews=[]),n=t===o?1:t===l?2:4;for(var c=E(s*e.itemSize*n),f=new DataView(new ArrayBuffer(c)),m=0,g=r;g<r+s;g++)for(var d=0;d<e.itemSize;d++){var v=void 0;e.itemSize>4?v=e.array[g*e.itemSize+d]:0===d?v=e.getX(g):1===d?v=e.getY(g):2===d?v=e.getZ(g):3===d&&(v=e.getW(g)),t===u?f.setFloat32(m,v,!0):t===h?f.setUint32(m,v,!0):t===l?f.setUint16(m,v,!0):t===o&&f.setUint8(m,v),m+=n}var y={buffer:this.processBuffer(f.buffer),byteOffset:this.byteOffset,byteLength:c};return void 0!==i&&(y.target=i),i===p&&(y.byteStride=e.itemSize*n),this.byteOffset+=c,a.bufferViews.push(y),{id:a.bufferViews.length-1,byteLength:0}},processBufferViewImage:function(e){var t=this,r=t.json;return r.bufferViews||(r.bufferViews=[]),new Promise((function(s){var i=new window.FileReader;i.readAsArrayBuffer(e),i.onloadend=function(){var e=I(i.result),n={buffer:t.processBuffer(e),byteOffset:t.byteOffset,byteLength:e.byteLength};t.byteOffset+=e.byteLength,s(r.bufferViews.push(n)-1)}}))},processAccessor:function(e,t,r,s){var i,n=this.options,a=this.json;if(e.array.constructor===Float32Array)i=u;else if(e.array.constructor===Uint32Array)i=h;else if(e.array.constructor===Uint16Array)i=l;else{if(e.array.constructor!==Uint8Array)throw new Error("THREE.GLTFExporter: Unsupported bufferAttribute component type.");i=o}if(void 0===r&&(r=0),void 0===s&&(s=e.count),n.truncateDrawRange&&void 0!==t&&null===t.index){var f=r+s,m=t.drawRange.count===1/0?e.count:t.drawRange.start+t.drawRange.count;r=Math.max(r,t.drawRange.start),(s=Math.min(f,m)-r)<0&&(s=0)}if(0===s)return null;var g,d=function(e,t,r){for(var s={min:new Array(e.itemSize).fill(Number.POSITIVE_INFINITY),max:new Array(e.itemSize).fill(Number.NEGATIVE_INFINITY)},i=t;i<t+r;i++)for(var n=0;n<e.itemSize;n++){var a=void 0;e.itemSize>4?a=e.array[i*e.itemSize+n]:0===n?a=e.getX(i):1===n?a=e.getY(i):2===n?a=e.getZ(i):3===n&&(a=e.getW(i)),s.min[n]=Math.min(s.min[n],a),s.max[n]=Math.max(s.max[n],a)}return s}(e,r,s);void 0!==t&&(g=e===t.index?c:p);var v=this.processBufferView(e,i,r,s,g),y={bufferView:v.id,byteOffset:v.byteOffset,componentType:i,count:s,max:d.max,min:d.min,type:{1:"SCALAR",2:"VEC2",3:"VEC3",4:"VEC4",16:"MAT4"}[e.itemSize]};return!0===e.normalized&&(y.normalized=!0),a.accessors||(a.accessors=[]),a.accessors.push(y)-1},processImage:function(t,r,s){var i=this,n=i.cache,a=i.json,o=i.options,l=i.pending;n.images.has(t)||n.images.set(t,{});var u=n.images.get(t),h=r===e.RGBAFormat?"image/png":"image/jpeg",p=h+":flipY/"+s.toString();if(void 0!==u[p])return u[p];a.images||(a.images=[]);var c={mimeType:h};if(o.embedImages){var f=L=L||document.createElement("canvas");f.width=Math.min(t.width,o.maxTextureSize),f.height=Math.min(t.height,o.maxTextureSize);var m=f.getContext("2d");if(!0===s&&(m.translate(0,f.height),m.scale(1,-1)),"undefined"!=typeof HTMLImageElement&&t instanceof HTMLImageElement||"undefined"!=typeof HTMLCanvasElement&&t instanceof HTMLCanvasElement||"undefined"!=typeof OffscreenCanvas&&t instanceof OffscreenCanvas||"undefined"!=typeof ImageBitmap&&t instanceof ImageBitmap)m.drawImage(t,0,0,f.width,f.height);else{r!==e.RGBAFormat&&r!==e.RGBFormat&&console.error("GLTFExporter: Only RGB and RGBA formats are supported."),(t.width>o.maxTextureSize||t.height>o.maxTextureSize)&&console.warn("GLTFExporter: Image size is bigger than maxTextureSize",t);var g=t.data;if(r===e.RGBFormat){g=new Uint8ClampedArray(t.height*t.width*4);for(var d=0,v=0;d<g.length;d+=4,v+=3)g[d+0]=t.data[v+0],g[d+1]=t.data[v+1],g[d+2]=t.data[v+2],g[d+3]=255}m.putImageData(new ImageData(g,t.width,t.height),0,0)}!0===o.binary?l.push(new Promise((function(e){f.toBlob((function(t){i.processBufferViewImage(t).then((function(t){c.bufferView=t,e()}))}),h)}))):c.uri=f.toDataURL(h)}else c.uri=t.src;var y=a.images.push(c)-1;return u[p]=y,y},processSampler:function(e){var t=this.json;t.samplers||(t.samplers=[]);var r={magFilter:T[e.magFilter],minFilter:T[e.minFilter],wrapS:T[e.wrapS],wrapT:T[e.wrapT]};return t.samplers.push(r)-1},processTexture:function(e){var t=this.cache,r=this.json;if(t.textures.has(e))return t.textures.get(e);r.textures||(r.textures=[]);var s={sampler:this.processSampler(e),source:this.processImage(e.image,e.format,e.flipY)};e.name&&(s.name=e.name),this._invokeAll((function(t){t.writeTexture&&t.writeTexture(e,s)}));var i=r.textures.push(s)-1;return t.textures.set(e,i),i},processMaterial:function(t){var r=this.cache,s=this.json;if(r.materials.has(t))return r.materials.get(t);if(t.isShaderMaterial)return console.warn("GLTFExporter: THREE.ShaderMaterial not supported."),null;s.materials||(s.materials=[]);var i={pbrMetallicRoughness:{}};!0!==t.isMeshStandardMaterial&&!0!==t.isMeshBasicMaterial&&console.warn("GLTFExporter: Use MeshStandardMaterial or MeshBasicMaterial for best results.");var n=t.color.toArray().concat([t.opacity]);if(A(n,[1,1,1,1])||(i.pbrMetallicRoughness.baseColorFactor=n),t.isMeshStandardMaterial?(i.pbrMetallicRoughness.metallicFactor=t.metalness,i.pbrMetallicRoughness.roughnessFactor=t.roughness):(i.pbrMetallicRoughness.metallicFactor=.5,i.pbrMetallicRoughness.roughnessFactor=.5),t.metalnessMap||t.roughnessMap)if(t.metalnessMap===t.roughnessMap){var a={index:this.processTexture(t.metalnessMap)};this.applyTextureTransform(a,t.metalnessMap),i.pbrMetallicRoughness.metallicRoughnessTexture=a}else console.warn("THREE.GLTFExporter: Ignoring metalnessMap and roughnessMap because they are not the same Texture.");if(t.map){var o={index:this.processTexture(t.map)};this.applyTextureTransform(o,t.map),i.pbrMetallicRoughness.baseColorTexture=o}if(t.emissive){var l=t.emissive.clone().multiplyScalar(t.emissiveIntensity).toArray();if(A(l,[0,0,0])||(i.emissiveFactor=l),t.emissiveMap){var u={index:this.processTexture(t.emissiveMap)};this.applyTextureTransform(u,t.emissiveMap),i.emissiveTexture=u}}if(t.normalMap){var h={index:this.processTexture(t.normalMap)};t.normalScale&&-1!==t.normalScale.x&&(t.normalScale.x!==t.normalScale.y&&console.warn("THREE.GLTFExporter: Normal scale components are different, ignoring Y and exporting X."),h.scale=t.normalScale.x),this.applyTextureTransform(h,t.normalMap),i.normalTexture=h}if(t.aoMap){var p={index:this.processTexture(t.aoMap),texCoord:1};1!==t.aoMapIntensity&&(p.strength=t.aoMapIntensity),this.applyTextureTransform(p,t.aoMap),i.occlusionTexture=p}t.transparent?i.alphaMode="BLEND":t.alphaTest>0&&(i.alphaMode="MASK",i.alphaCutoff=t.alphaTest),t.side===e.DoubleSide&&(i.doubleSided=!0),""!==t.name&&(i.name=t.name),this.serializeUserData(t,i),this._invokeAll((function(e){e.writeMaterial&&e.writeMaterial(t,i)}));var c=s.materials.push(i)-1;return r.materials.set(t,c),c},processMesh:function(t){var o=this.cache,l=this.json,u=[t.geometry.uuid];if(Array.isArray(t.material))for(var h=0,p=t.material.length;h<p;h++)u.push(t.material[h].uuid);else u.push(t.material.uuid);var c=u.join(":");if(o.meshes.has(c))return o.meshes.get(c);var f,m=t.geometry;if(f=t.isLineSegments?s:t.isLineLoop?i:t.isLine?n:t.isPoints?r:t.material.wireframe?s:a,!0!==m.isBufferGeometry)throw new Error("THREE.GLTFExporter: Geometry is not of type THREE.BufferGeometry.");var g={},d={},v=[],y=[],b={uv:"TEXCOORD_0",uv2:"TEXCOORD_1",color:"COLOR_0",skinWeight:"WEIGHTS_0",skinIndex:"JOINTS_0"},x=m.getAttribute("normal");void 0===x||this.isNormalizedNormalAttribute(x)||(console.warn("THREE.GLTFExporter: Creating normalized normal attribute from the non-normalized one."),m.setAttribute("normal",this.createNormalizedNormalAttribute(x)));var w=null;for(var T in m.attributes)if("morph"!==T.substr(0,5)){var M=m.attributes[T];T=b[T]||T.toUpperCase();if(/^(POSITION|NORMAL|TANGENT|TEXCOORD_\d+|COLOR_\d+|JOINTS_\d+|WEIGHTS_\d+)$/.test(T)||(T="_"+T),o.attributes.has(this.getUID(M)))d[T]=o.attributes.get(this.getUID(M));else{w=null;var A=M.array;"JOINTS_0"!==T||A instanceof Uint16Array||A instanceof Uint8Array||(console.warn('GLTFExporter: Attribute "skinIndex" converted to type UNSIGNED_SHORT.'),w=new e.BufferAttribute(new Uint16Array(A),M.itemSize,M.normalized));var E=this.processAccessor(w||M,m);null!==E&&(d[T]=E,o.attributes.set(this.getUID(M),E))}}if(void 0!==x&&m.setAttribute("normal",x),0===Object.keys(d).length)return null;if(void 0!==t.morphTargetInfluences&&t.morphTargetInfluences.length>0){var I=[],L=[],S={};if(void 0!==t.morphTargetDictionary)for(var R in t.morphTargetDictionary)S[t.morphTargetDictionary[R]]=R;for(var F=0;F<t.morphTargetInfluences.length;++F){var N={},U=!1;for(var B in m.morphAttributes)if("position"===B||"normal"===B){M=m.morphAttributes[B][F];var C=B.toUpperCase(),O=m.attributes[B];if(o.attributes.has(this.getUID(M)))N[C]=o.attributes.get(this.getUID(M));else{var k=M.clone();if(!m.morphTargetsRelative)for(var z=0,D=M.count;z<D;z++)k.setXYZ(z,M.getX(z)-O.getX(z),M.getY(z)-O.getY(z),M.getZ(z)-O.getZ(z));N[C]=this.processAccessor(k,m),o.attributes.set(this.getUID(O),N[C])}}else U||(console.warn("GLTFExporter: Only POSITION and NORMAL morph are supported."),U=!0);y.push(N),I.push(t.morphTargetInfluences[F]),void 0!==t.morphTargetDictionary&&L.push(S[F])}g.weights=I,L.length>0&&(g.extras={},g.extras.targetNames=L)}var G=Array.isArray(t.material);if(G&&0===m.groups.length)return null;for(var _=G?t.material:[t.material],V=G?m.groups:[{materialIndex:0,start:void 0,count:void 0}],j=0,H=V.length;j<H;j++){var P={mode:f,attributes:d};if(this.serializeUserData(m,P),y.length>0&&(P.targets=y),null!==m.index){var X=this.getUID(m.index);void 0===V[j].start&&void 0===V[j].count||(X+=":"+V[j].start+":"+V[j].count),o.attributes.has(X)?P.indices=o.attributes.get(X):(P.indices=this.processAccessor(m.index,m,V[j].start,V[j].count),o.attributes.set(X,P.indices)),null===P.indices&&delete P.indices}var Y=this.processMaterial(_[V[j].materialIndex]);null!==Y&&(P.material=Y),v.push(P)}g.primitives=v,l.meshes||(l.meshes=[]),this._invokeAll((function(e){e.writeMesh&&e.writeMesh(t,g)}));var K=l.meshes.push(g)-1;return o.meshes.set(c,K),K},processCamera:function(t){var r=this.json;r.cameras||(r.cameras=[]);var s=t.isOrthographicCamera,i={type:s?"orthographic":"perspective"};return s?i.orthographic={xmag:2*t.right,ymag:2*t.top,zfar:t.far<=0?.001:t.far,znear:t.near<0?0:t.near}:i.perspective={aspectRatio:t.aspect,yfov:e.MathUtils.degToRad(t.fov),zfar:t.far<=0?.001:t.far,znear:t.near<0?0:t.near},""!==t.name&&(i.name=t.type),r.cameras.push(i)-1},processAnimation:function(r,s){var i=this.json,n=this.nodeMap;i.animations||(i.animations=[]);for(var a=(r=t.Utils.mergeMorphTargetTracks(r.clone(),s)).tracks,o=[],l=[],u=0;u<a.length;++u){var h=a[u],p=e.PropertyBinding.parseTrackName(h.name),c=e.PropertyBinding.findNode(s,p.nodeName),f=M[p.propertyName];if("bones"===p.objectName&&(c=!0===c.isSkinnedMesh?c.skeleton.getBoneByName(p.objectIndex):void 0),!c||!f)return console.warn('THREE.GLTFExporter: Could not export animation track "%s".',h.name),null;var m=h.values.length/h.times.length;f===M.morphTargetInfluences&&(m/=c.morphTargetInfluences.length);var g=void 0;!0===h.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline?(g="CUBICSPLINE",m/=3):g=h.getInterpolation()===e.InterpolateDiscrete?"STEP":"LINEAR",l.push({input:this.processAccessor(new e.BufferAttribute(h.times,1)),output:this.processAccessor(new e.BufferAttribute(h.values,m)),interpolation:g}),o.push({sampler:l.length-1,target:{node:n.get(c),path:f}})}return i.animations.push({name:r.name||"clip_"+i.animations.length,samplers:l,channels:o}),i.animations.length-1},processSkin:function(t){var r=this.json,s=this.nodeMap,i=r.nodes[s.get(t)],n=t.skeleton;if(void 0===n)return null;var a=t.skeleton.bones[0];if(void 0===a)return null;for(var o=[],l=new Float32Array(16*n.bones.length),u=new e.Matrix4,h=0;h<n.bones.length;++h)o.push(s.get(n.bones[h])),u.copy(n.boneInverses[h]),u.multiply(t.bindMatrix).toArray(l,16*h);return void 0===r.skins&&(r.skins=[]),r.skins.push({inverseBindMatrices:this.processAccessor(new e.BufferAttribute(l,16)),joints:o,skeleton:s.get(a)}),i.skin=r.skins.length-1},processNode:function(e){var t=this.json,r=this.options,s=this.nodeMap;t.nodes||(t.nodes=[]);var i={};if(r.trs){var n=e.quaternion.toArray(),a=e.position.toArray(),o=e.scale.toArray();A(n,[0,0,0,1])||(i.rotation=n),A(a,[0,0,0])||(i.translation=a),A(o,[1,1,1])||(i.scale=o)}else e.matrixAutoUpdate&&e.updateMatrix(),!1===A(e.matrix.elements,[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1])&&(i.matrix=e.matrix.elements);if(""!==e.name&&(i.name=String(e.name)),this.serializeUserData(e,i),e.isMesh||e.isLine||e.isPoints){var l=this.processMesh(e);null!==l&&(i.mesh=l)}else e.isCamera&&(i.camera=this.processCamera(e));if(e.isSkinnedMesh&&this.skins.push(e),e.children.length>0){for(var u=[],h=0,p=e.children.length;h<p;h++){var c=e.children[h];if(c.visible||!1===r.onlyVisible)null!==(f=this.processNode(c))&&u.push(f)}u.length>0&&(i.children=u)}this._invokeAll((function(t){t.writeNode&&t.writeNode(e,i)}));var f=t.nodes.push(i)-1;return s.set(e,f),f},processScene:function(e){var t=this.json,r=this.options;t.scenes||(t.scenes=[],t.scene=0);var s={};""!==e.name&&(s.name=e.name),t.scenes.push(s);for(var i=[],n=0,a=e.children.length;n<a;n++){var o=e.children[n];if(o.visible||!1===r.onlyVisible){var l=this.processNode(o);null!==l&&i.push(l)}}i.length>0&&(s.nodes=i),this.serializeUserData(e,s)},processObjects:function(t){var r=new e.Scene;r.name="AuxScene";for(var s=0;s<t.length;s++)r.children.push(t[s]);this.processScene(r)},processInput:function(t){var r=this.options;t=t instanceof Array?t:[t],this._invokeAll((function(e){e.beforeParse&&e.beforeParse(t)}));for(var s=[],i=0;i<t.length;i++)t[i]instanceof e.Scene?this.processScene(t[i]):s.push(t[i]);s.length>0&&this.processObjects(s);for(var n=0;n<this.skins.length;++n)this.processSkin(this.skins[n]);for(var a=0;a<r.animations.length;++a)this.processAnimation(r.animations[a],t[0]);this._invokeAll((function(e){e.afterParse&&e.afterParse(t)}))},_invokeAll:function(e){for(var t=0,r=this.plugins.length;t<r;t++)e(this.plugins[t])}},R.prototype={constructor:R,writeNode:function(e,t){if(e.isLight)if(e.isDirectionalLight||e.isPointLight||e.isSpotLight){var r=this.writer,s=r.json,i=r.extensionsUsed,n={};e.name&&(n.name=e.name),n.color=e.color.toArray(),n.intensity=e.intensity,e.isDirectionalLight?n.type="directional":e.isPointLight?(n.type="point",e.distance>0&&(n.range=e.distance)):e.isSpotLight&&(n.type="spot",e.distance>0&&(n.range=e.distance),n.spot={},n.spot.innerConeAngle=(e.penumbra-1)*e.angle*-1,n.spot.outerConeAngle=e.angle),void 0!==e.decay&&2!==e.decay&&console.warn("THREE.GLTFExporter: Light decay may be lost. glTF is physically-based, and expects light.decay=2."),!e.target||e.target.parent===e&&0===e.target.position.x&&0===e.target.position.y&&-1===e.target.position.z||console.warn("THREE.GLTFExporter: Light direction may be lost. For best results, make light.target a child of the light with position 0,0,-1."),i[this.name]||(s.extensions=s.extensions||{},s.extensions[this.name]={lights:[]},i[this.name]=!0);var a=s.extensions[this.name].lights;a.push(n),t.extensions=t.extensions||{},t.extensions[this.name]={light:a.length-1}}else console.warn("THREE.GLTFExporter: Only directional, point, and spot lights are supported.",e)}},F.prototype={constructor:F,writeMaterial:function(e,t){if(e.isMeshBasicMaterial){var r=this.writer.extensionsUsed;t.extensions=t.extensions||{},t.extensions[this.name]={},r[this.name]=!0,t.pbrMetallicRoughness.metallicFactor=0,t.pbrMetallicRoughness.roughnessFactor=.9}}},N.prototype={constructor:N,writeMaterial:function(e,t){if(e.isGLTFSpecularGlossinessMaterial){var r=this.writer,s=r.extensionsUsed,i={};t.pbrMetallicRoughness.baseColorFactor&&(i.diffuseFactor=t.pbrMetallicRoughness.baseColorFactor);var n=[1,1,1];if(e.specular.toArray(n,0),i.specularFactor=n,i.glossinessFactor=e.glossiness,t.pbrMetallicRoughness.baseColorTexture&&(i.diffuseTexture=t.pbrMetallicRoughness.baseColorTexture),e.specularMap){var a={index:r.processTexture(e.specularMap)};r.applyTextureTransform(a,e.specularMap),i.specularGlossinessTexture=a}t.extensions=t.extensions||{},t.extensions[this.name]=i,s[this.name]=!0}}},t.Utils={insertKeyframe:function(e,t){var r,s=.001,i=e.getValueSize(),n=new e.TimeBufferType(e.times.length+1),a=new e.ValueBufferType(e.values.length+i),o=e.createInterpolant(new e.ValueBufferType(i));if(0===e.times.length){n[0]=t;for(var l=0;l<i;l++)a[l]=0;r=0}else if(t<e.times[0]){if(Math.abs(e.times[0]-t)<s)return 0;n[0]=t,n.set(e.times,1),a.set(o.evaluate(t),0),a.set(e.values,i),r=0}else if(t>e.times[e.times.length-1]){if(Math.abs(e.times[e.times.length-1]-t)<s)return e.times.length-1;n[n.length-1]=t,n.set(e.times,0),a.set(e.values,0),a.set(o.evaluate(t),e.values.length),r=n.length-1}else for(var u=0;u<e.times.length;u++){if(Math.abs(e.times[u]-t)<s)return u;if(e.times[u]<t&&e.times[u+1]>t){n.set(e.times.slice(0,u+1),0),n[u+1]=t,n.set(e.times.slice(u+1),u+2),a.set(e.values.slice(0,(u+1)*i),0),a.set(o.evaluate(t),(u+1)*i),a.set(e.values.slice((u+1)*i),(u+2)*i),r=u+1;break}}return e.times=n,e.values=a,r},mergeMorphTargetTracks:function(t,r){for(var s=[],i={},n=t.tracks,a=0;a<n.length;++a){var o=n[a],l=e.PropertyBinding.parseTrackName(o.name),u=e.PropertyBinding.findNode(r,l.nodeName);if("morphTargetInfluences"===l.propertyName&&void 0!==l.propertyIndex){if(o.createInterpolant!==o.InterpolantFactoryMethodDiscrete&&o.createInterpolant!==o.InterpolantFactoryMethodLinear){if(o.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline)throw new Error("THREE.GLTFExporter: Cannot merge tracks with glTF CUBICSPLINE interpolation.");console.warn("THREE.GLTFExporter: Morph target interpolation mode not yet supported. Using LINEAR instead."),(o=o.clone()).setInterpolation(e.InterpolateLinear)}var h=u.morphTargetInfluences.length,p=u.morphTargetDictionary[l.propertyIndex];if(void 0===p)throw new Error("THREE.GLTFExporter: Morph target name not found: "+l.propertyIndex);var c=void 0;if(void 0!==i[u.uuid]){var f=o.createInterpolant(new o.ValueBufferType(1));c=i[u.uuid];for(var m=0;m<c.times.length;m++)c.values[m*h+p]=f.evaluate(c.times[m]);for(var g=0;g<o.times.length;g++){var d=this.insertKeyframe(c,o.times[g]);c.values[d*h+p]=o.values[g]}}else{for(var v=new((c=o.clone()).ValueBufferType)(h*c.times.length),y=0;y<c.times.length;y++)v[y*h+p]=c.values[y];c.name=(l.nodeName||"")+".morphTargetInfluences",c.values=v,i[u.uuid]=c,s.push(c)}}else s.push(o)}return t.tracks=s,t}},t}();exports.GLTFExporter=t;
