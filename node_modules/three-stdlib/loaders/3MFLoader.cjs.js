"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("three"),t=require("fflate"),r=function(t){e.Loader.call(this,t),this.availableExtensions=[]};r.prototype=Object.assign(Object.create(e.Loader.prototype),{constructor:r,load:function(t,r,a,i){var n=this,o=new e.FileLoader(n.manager);o.setPath(n.path),o.setResponseType("arraybuffer"),o.setRequestHeader(n.requestHeader),o.setWithCredentials(n.withCredentials),o.load(t,(function(e){try{r(n.parse(e))}catch(e){i?i(e):console.error(e),n.manager.itemError(t)}}),a,i)},parse:function(r){var a=this,i=new e.TextureLoader(this.manager);function n(e){for(var t=[],r=(new DOMParser).parseFromString(e,"application/xml").querySelectorAll("Relationship"),a=0;a<r.length;a++){var i=r[a],n={target:i.getAttribute("Target"),id:i.getAttribute("Id"),type:i.getAttribute("Type")};t.push(n)}return t}function o(e){for(var t={id:e.getAttribute("id"),basematerials:[]},r=e.querySelectorAll("base"),a=0;a<r.length;a++){var i=p(r[a]);i.index=a,t.basematerials.push(i)}return t}function s(e){for(var t={id:e.getAttribute("id"),texid:e.getAttribute("texid"),displaypropertiesid:e.getAttribute("displaypropertiesid")},r=e.querySelectorAll("tex2coord"),a=[],i=0;i<r.length;i++){var n=r[i],o=n.getAttribute("u"),s=n.getAttribute("v");a.push(parseFloat(o),parseFloat(s))}return t.uvs=new Float32Array(a),t}function u(t){for(var r={id:t.getAttribute("id"),displaypropertiesid:t.getAttribute("displaypropertiesid")},a=t.querySelectorAll("color"),i=[],n=new e.Color,o=0;o<a.length;o++){var s=a[o].getAttribute("color");n.setStyle(s.substring(0,7)),n.convertSRGBToLinear(),i.push(n.r,n.g,n.b)}return r.colors=new Float32Array(i),r}function l(e){for(var t={id:e.getAttribute("id")},r=e.querySelectorAll("pbmetallic"),a=[],i=0;i<r.length;i++){var n=r[i];a.push({name:n.getAttribute("name"),metallicness:parseFloat(n.getAttribute("metallicness")),roughness:parseFloat(n.getAttribute("roughness"))})}return t.data=a,t}function p(e){var t={};return t.name=e.getAttribute("name"),t.displaycolor=e.getAttribute("displaycolor"),t.displaypropertiesid=e.getAttribute("displaypropertiesid"),t}function c(e){var t={};t.objectId=e.getAttribute("objectid");var r=e.getAttribute("transform");return r&&(t.transform=d(r)),t}function d(t){var r=[];t.split(" ").forEach((function(e){r.push(parseFloat(e))}));var a=new e.Matrix4;return a.set(r[0],r[3],r[6],r[9],r[1],r[4],r[7],r[10],r[2],r[5],r[8],r[11],0,0,0,1),a}function v(e){var t={type:e.getAttribute("type")},r=e.getAttribute("id");r&&(t.id=r);var a=e.getAttribute("pid");a&&(t.pid=a);var i=e.getAttribute("pindex");i&&(t.pindex=i);var n=e.getAttribute("thumbnail");n&&(t.thumbnail=n);var o=e.getAttribute("partnumber");o&&(t.partnumber=o);var s=e.getAttribute("name");s&&(t.name=s);var u=e.querySelector("mesh");u&&(t.mesh=function(e){for(var t={},r=[],a=e.querySelectorAll("vertices vertex"),i=0;i<a.length;i++){var n=a[i],o=n.getAttribute("x"),s=n.getAttribute("y"),u=n.getAttribute("z");r.push(parseFloat(o),parseFloat(s),parseFloat(u))}t.vertices=new Float32Array(r);for(var l=[],p=[],c=e.querySelectorAll("triangles triangle"),d=0;d<c.length;d++){var v=c[d],h=v.getAttribute("v1"),g=v.getAttribute("v2"),f=v.getAttribute("v3"),b=v.getAttribute("p1"),m=v.getAttribute("p2"),A=v.getAttribute("p3"),y=v.getAttribute("pid"),x={};x.v1=parseInt(h,10),x.v2=parseInt(g,10),x.v3=parseInt(f,10),p.push(x.v1,x.v2,x.v3),b&&(x.p1=parseInt(b,10)),m&&(x.p2=parseInt(m,10)),A&&(x.p3=parseInt(A,10)),y&&(x.pid=y),0<Object.keys(x).length&&l.push(x)}return t.triangleProperties=l,t.triangles=new Uint32Array(p),t}(u));var l=e.querySelector("components");return l&&(t.components=function(e){for(var t=[],r=e.querySelectorAll("component"),a=0;a<r.length;a++){var i=c(r[a]);t.push(i)}return t}(l)),t}function h(e){var t={unit:e.getAttribute("unit")||"millimeter"},r=e.querySelectorAll("metadata");r&&(t.metadata=function(e){for(var t={},r=0;r<e.length;r++){var a=e[r],i=a.getAttribute("name");0<=["Title","Designer","Description","Copyright","LicenseTerms","Rating","CreationDate","ModificationDate"].indexOf(i)&&(t[i]=a.textContent)}return t}(r));var a=e.querySelector("resources");a&&(t.resources=function(e){for(var t={basematerials:{}},r=e.querySelectorAll("basematerials"),a=0;a<r.length;a++){var i=o(r[a]);t.basematerials[i.id]=i}t.texture2d={};for(var n,p=e.querySelectorAll("texture2d"),c=0;c<p.length;c++){var d={id:(n=p[c]).getAttribute("id"),path:n.getAttribute("path"),contenttype:n.getAttribute("contenttype"),tilestyleu:n.getAttribute("tilestyleu"),tilestylev:n.getAttribute("tilestylev"),filter:n.getAttribute("filter")};t.texture2d[d.id]=d}t.colorgroup={};for(var h=e.querySelectorAll("colorgroup"),g=0;g<h.length;g++){var f=u(h[g]);t.colorgroup[f.id]=f}t.pbmetallicdisplayproperties={};for(var b=e.querySelectorAll("pbmetallicdisplayproperties"),m=0;m<b.length;m++){var A=l(b[m]);t.pbmetallicdisplayproperties[A.id]=A}t.texture2dgroup={};for(var y=e.querySelectorAll("texture2dgroup"),x=0;x<y.length;x++){var w=s(y[x]);t.texture2dgroup[w.id]=w}t.object={};for(var F=e.querySelectorAll("object"),S=0;S<F.length;S++){var M=v(F[S]);t.object[M.id]=M}return t}(a));var i=e.querySelector("build");return i&&(t.build=function(e){for(var t=[],r=e.querySelectorAll("item"),a=0;a<r.length;a++){var i=r[a],n={objectId:i.getAttribute("objectid")},o=i.getAttribute("transform");o&&(n.transform=d(o)),t.push(n)}return t}(i)),t}function g(t,r,a,n){var o=t.texid,s=a.resources.texture2d[o];if(s){var u=n[s.path],l=s.contenttype,p=new Blob([u],{type:l}),c=URL.createObjectURL(p),d=i.load(c,(function(){URL.revokeObjectURL(c)}));switch(d.encoding=e.sRGBEncoding,s.tilestyleu){case"wrap":d.wrapS=e.RepeatWrapping;break;case"mirror":d.wrapS=e.MirroredRepeatWrapping;break;case"none":case"clamp":d.wrapS=e.ClampToEdgeWrapping;break;default:d.wrapS=e.RepeatWrapping}switch(s.tilestylev){case"wrap":d.wrapT=e.RepeatWrapping;break;case"mirror":d.wrapT=e.MirroredRepeatWrapping;break;case"none":case"clamp":d.wrapT=e.ClampToEdgeWrapping;break;default:d.wrapT=e.RepeatWrapping}switch(s.filter){case"auto":d.magFilter=e.LinearFilter,d.minFilter=e.LinearMipmapLinearFilter;break;case"linear":d.magFilter=e.LinearFilter,d.minFilter=e.LinearFilter;break;case"nearest":d.magFilter=e.NearestFilter,d.minFilter=e.NearestFilter;break;default:d.magFilter=e.LinearFilter,d.minFilter=e.LinearMipmapLinearFilter}return d}return null}function f(t,r,a,i,n,o){for(var s=o.pindex,u={},l=0,p=r.length;l<p;l++){var c=void 0!==(L=r[l]).p1?L.p1:s;void 0===u[c]&&(u[c]=[]),u[c].push(L)}for(var d=Object.keys(u),v=[],h=0,g=d.length;h<g;h++){for(var f=d[h],b=u[f],m=w(t.basematerials[f],j,a,n,o,F),A=new e.BufferGeometry,y=[],x=i.vertices,S=0,M=b.length;S<M;S++){var L=b[S];y.push(x[3*L.v1+0]),y.push(x[3*L.v1+1]),y.push(x[3*L.v1+2]),y.push(x[3*L.v2+0]),y.push(x[3*L.v2+1]),y.push(x[3*L.v2+2]),y.push(x[3*L.v3+0]),y.push(x[3*L.v3+1]),y.push(x[3*L.v3+2])}A.setAttribute("position",new e.Float32BufferAttribute(y,3));var q=new e.Mesh(A,m);v.push(q)}return v}function b(t,r,a,i,n,o){for(var s=new e.BufferGeometry,u=[],l=[],p=i.vertices,c=t.uvs,d=0,v=r.length;d<v;d++){var h=r[d];u.push(p[3*h.v1+0]),u.push(p[3*h.v1+1]),u.push(p[3*h.v1+2]),u.push(p[3*h.v2+0]),u.push(p[3*h.v2+1]),u.push(p[3*h.v2+2]),u.push(p[3*h.v3+0]),u.push(p[3*h.v3+1]),u.push(p[3*h.v3+2]),l.push(c[2*h.p1+0]),l.push(c[2*h.p1+1]),l.push(c[2*h.p2+0]),l.push(c[2*h.p2+1]),l.push(c[2*h.p3+0]),l.push(c[2*h.p3+1])}s.setAttribute("position",new e.Float32BufferAttribute(u,3)),s.setAttribute("uv",new e.Float32BufferAttribute(l,2));var f=w(t,j,a,n,o,g),b=new e.MeshPhongMaterial({map:f,flatShading:!0});return new e.Mesh(s,b)}function m(t,r,a,i,n){for(var o=new e.BufferGeometry,s=[],u=[],l=i.vertices,p=t.colors,c=0,d=r.length;c<d;c++){var v=r[c],h=v.v1,g=v.v2,f=v.v3;s.push(l[3*h+0]),s.push(l[3*h+1]),s.push(l[3*h+2]),s.push(l[3*g+0]),s.push(l[3*g+1]),s.push(l[3*g+2]),s.push(l[3*f+0]),s.push(l[3*f+1]),s.push(l[3*f+2]);var b=void 0!==v.p1?v.p1:n.pindex,m=void 0!==v.p2?v.p2:b,A=void 0!==v.p3?v.p3:b;u.push(p[3*b+0]),u.push(p[3*b+1]),u.push(p[3*b+2]),u.push(p[3*m+0]),u.push(p[3*m+1]),u.push(p[3*m+2]),u.push(p[3*A+0]),u.push(p[3*A+1]),u.push(p[3*A+2])}o.setAttribute("position",new e.Float32BufferAttribute(s,3)),o.setAttribute("color",new e.Float32BufferAttribute(u,3));var y=new e.MeshPhongMaterial({vertexColors:!0,flatShading:!0});return new e.Mesh(o,y)}function A(t){var r=new e.BufferGeometry;r.setIndex(new e.BufferAttribute(t.triangles,1)),r.setAttribute("position",new e.BufferAttribute(t.vertices,3));var a=new e.MeshPhongMaterial({color:11184895,flatShading:!0});return new e.Mesh(r,a)}function y(e,t){return void 0!==t.resources.texture2dgroup[e]?"texture":void 0!==t.resources.basematerials[e]?"material":void 0!==t.resources.colorgroup[e]?"vertexColors":"default"===e?"default":void 0}function x(t,r,a,i,n){for(var o=new e.Group,s=function(e,t,r,a,i){for(var n=Object.keys(e),o=[],s=0,u=n.length;s<u;s++){var l=n[s],p=e[l];switch(y(l,t)){case"material":for(var c=f(t.resources.basematerials[l],p,t,r,a,i),d=0,v=c.length;d<v;d++)o.push(c[d]);break;case"texture":var h=t.resources.texture2dgroup[l];o.push(b(h,p,t,r,a,i));break;case"vertexColors":var g=t.resources.colorgroup[l];o.push(m(g,p,0,r,i));break;case"default":o.push(A(r));break;default:console.error("THREE.3MFLoader: Unsupported resource type.")}}return o}(function(e,t,r){for(var a={},i=t.triangleProperties,n=r.pid,o=0,s=i.length;o<s;o++){var u=i[o],l=void 0!==u.pid?u.pid:n;void 0===l&&(l="default"),void 0===a[l]&&(a[l]=[]),a[l].push(u)}return a}(0,t,n),a,t,i,n),u=0,l=s.length;u<l;u++)o.add(s[u]);return o}function w(e,t,r,a,i,n){return void 0!==e.build||(e.build=n(e,t,r,a,i)),e.build}function F(t,r,a){var i,n=t.displaypropertiesid,o=a.resources.pbmetallicdisplayproperties;if(null!==n&&void 0!==o[n]){var s=o[n].data[t.index];i=new e.MeshStandardMaterial({flatShading:!0,roughness:s.roughness,metalness:s.metallicness})}else i=new e.MeshPhongMaterial({flatShading:!0});i.name=t.name;var u=t.displaycolor,l=u.substring(0,7);return i.color.setStyle(l),i.color.convertSRGBToLinear(),9===u.length&&(i.opacity=parseInt(u.charAt(7)+u.charAt(8),16)/255),i}function S(t,r,a,i){for(var n=new e.Group,o=0;o<t.length;o++){var s=t[o],u=r[s.objectId];void 0===u&&(M(s.objectId,r,a,i),u=r[s.objectId]);var l=u.clone(),p=s.transform;p&&l.applyMatrix4(p),n.add(l)}return n}function M(e,t,r,i){var n=r.resources.object[e];if(n.mesh){var o=n.mesh;!function(e,t,r){if(e){for(var i=[],n=Object.keys(e),o=0;o<n.length;o++)for(var s=n[o],u=0;u<a.availableExtensions.length;u++)(p=a.availableExtensions[u]).ns===s&&i.push(p);for(var l=0;l<i.length;l++){var p;(p=i[l]).apply(r,e[p.ns],t)}}}(r.extensions,o,r.xml),t[n.id]=w(o,t,r,i,n,x)}else{var s=n.components;t[n.id]=w(s,t,r,i,n,S)}}var L=function(r){var a,i,o,s,u=null,l=null,p=[],c=[],d={},v={};try{u=t.unzipSync(new Uint8Array(r))}catch(e){if(e instanceof ReferenceError)return console.error("THREE.3MFLoader: fflate missing and file is compressed."),null}for(l in u)l.match(/\_rels\/.rels$/)?a=l:l.match(/3D\/_rels\/.*\.model\.rels$/)?i=l:l.match(/^3D\/.*\.model$/)?p.push(l):l.match(/^3D\/Metadata\/.*\.xml$/)||(l.match(/^3D\/Textures?\/.*/)?c.push(l):l.match(/^3D\/Other\/.*/));var g=u[a];if(o=n(e.LoaderUtils.decodeText(g)),i){g=u[i];s=n(e.LoaderUtils.decodeText(g))}for(var f=0;f<p.length;f++){var b=p[f],m=u[b],A=e.LoaderUtils.decodeText(m),y=(new DOMParser).parseFromString(A,"application/xml");"model"!==y.documentElement.nodeName.toLowerCase()&&console.error("THREE.3MFLoader: Error loading 3MF - no 3MF document found: ",b);for(var x=y.querySelector("model"),w={},F=0;F<x.attributes.length;F++){var S=x.attributes[F];S.name.match(/^xmlns:(.+)$/)&&(w[S.value]=RegExp.$1)}var M=h(x);M.xml=x,0<Object.keys(w).length&&(M.extensions=w),d[b]=M}for(var L=0;L<c.length;L++){var j=c[L];v[j]=u[j].buffer}return{rels:o,modelRels:s,model:d,printTicket:{},texture:v,other:{}}}(r),j=function(e){var t=e.model,r=e.modelRels,a={},i=Object.keys(t),n={};if(r)for(var o=0,s=r.length;o<s;o++){var u=r[o],l=u.target.substring(1);e.texture[l]&&(n[u.target]=e.texture[l])}for(var p=0;p<i.length;p++)for(var c=t[i[p]],d=Object.keys(c.resources.object),v=0;v<d.length;v++){M(d[v],a,c,n)}return a}(L);return function(t,r){for(var a=new e.Group,i=function(e){for(var t=0;t<e.length;t++){var r=e[t];if("model"===r.target.split(".").pop().toLowerCase())return r}}(r.rels),n=r.model[i.target.substring(1)].build,o=0;o<n.length;o++){var s=n[o],u=t[s.objectId],l=s.transform;l&&u.applyMatrix4(l),a.add(u)}return a}(j,L)},addExtension:function(e){this.availableExtensions.push(e)}}),exports.ThreeMFLoader=r;
