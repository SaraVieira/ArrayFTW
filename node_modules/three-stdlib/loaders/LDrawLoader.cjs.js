"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("three"),t=function(){var t=new e.Vector3,r=new e.Vector3;function a(e){return/primitive/i.test(e)||"Subpart"===e}function n(e,t){this.line=e,this.lineLength=e.length,this.currentCharIndex=0,this.currentChar=" ",this.lineNumber=t}function i(e,t){return e.colourCode===t.colourCode?0:e.colourCode<t.colourCode?-1:1}function o(t,r,a){t.sort(i);for(var n=[],o=[],s=[],l=new e.BufferGeometry,c=null,u=0,d=0,p=0,h=t.length;p<h;p++){var g=t[p],v=g.v0,m=g.v1;if(n.push(v.x,v.y,v.z,m.x,m.y,m.z),3===r){n.push(g.v2.x,g.v2.y,g.v2.z);var f=g.n0||g.faceNormal,b=g.n1||g.faceNormal,C=g.n2||g.faceNormal;o.push(f.x,f.y,f.z),o.push(b.x,b.y,b.z),o.push(C.x,C.y,C.z)}c!==g.material?(null!==c&&l.addGroup(u,d,s.length-1),s.push(g.material),c=g.material,u=p*r,d=r):d+=r}d>0&&l.addGroup(u,1/0,s.length-1),l.setAttribute("position",new e.Float32BufferAttribute(n,3)),3===r&&l.setAttribute("normal",new e.Float32BufferAttribute(o,3));var S=null;if(2===r?S=new e.LineSegments(l,s):3===r&&(S=new e.Mesh(l,s)),a){S.isConditionalLine=!0;for(var L=new Float32Array(3*t.length*2),_=new Float32Array(3*t.length*2),E=new Float32Array(3*t.length*2),T=0,I=t.length;T<I;T++){var N=t[T],x=N.c0,M=N.c1,w=(v=N.v0,m=N.v1,3*T*2);L[w+0]=x.x,L[w+1]=x.y,L[w+2]=x.z,L[w+3]=x.x,L[w+4]=x.y,L[w+5]=x.z,_[w+0]=M.x,_[w+1]=M.y,_[w+2]=M.z,_[w+3]=M.x,_[w+4]=M.y,_[w+5]=M.z,E[w+0]=m.x-v.x,E[w+1]=m.y-v.y,E[w+2]=m.z-v.z,E[w+3]=m.x-v.x,E[w+4]=m.y-v.y,E[w+5]=m.z-v.z}l.setAttribute("control0",new e.BufferAttribute(L,3,!1)),l.setAttribute("control1",new e.BufferAttribute(_,3,!1)),l.setAttribute("direction",new e.BufferAttribute(E,3,!1))}return S}function s(t){e.Loader.call(this,t),this.parseScopesStack=null,this.materials=[],this.subobjectCache={},this.fileMap=null,this.setMaterials([this.parseColourMetaDirective(new n("Main_Colour CODE 16 VALUE #FF8080 EDGE #333333")),this.parseColourMetaDirective(new n("Edge_Colour CODE 24 VALUE #A0A0A0 EDGE #333333"))]),this.separateObjects=!1,this.smoothNormals=!0}return n.prototype={constructor:n,seekNonSpace:function(){for(;this.currentCharIndex<this.lineLength;){if(this.currentChar=this.line.charAt(this.currentCharIndex)," "!==this.currentChar&&"\t"!==this.currentChar)return;this.currentCharIndex++}},getToken:function(){for(var e=this.currentCharIndex++;this.currentCharIndex<this.lineLength&&(this.currentChar=this.line.charAt(this.currentCharIndex)," "!==this.currentChar&&"\t"!==this.currentChar);)this.currentCharIndex++;var t=this.currentCharIndex;return this.seekNonSpace(),this.line.substring(e,t)},getRemainingString:function(){return this.line.substring(this.currentCharIndex,this.lineLength)},isAtTheEnd:function(){return this.currentCharIndex>=this.lineLength},setToEnd:function(){this.currentCharIndex=this.lineLength},getLineNumberString:function(){return this.lineNumber>=0?" at line "+this.lineNumber:""}},s.FINISH_TYPE_DEFAULT=0,s.FINISH_TYPE_CHROME=1,s.FINISH_TYPE_PEARLESCENT=2,s.FINISH_TYPE_RUBBER=3,s.FINISH_TYPE_MATTE_METALLIC=4,s.FINISH_TYPE_METAL=5,s.FILE_LOCATION_AS_IS=0,s.FILE_LOCATION_TRY_PARTS=1,s.FILE_LOCATION_TRY_P=2,s.FILE_LOCATION_TRY_MODELS=3,s.FILE_LOCATION_TRY_RELATIVE=4,s.FILE_LOCATION_TRY_ABSOLUTE=5,s.FILE_LOCATION_NOT_FOUND=6,s.prototype=Object.assign(Object.create(e.Loader.prototype),{constructor:s,load:function(t,r,a,n){this.fileMap||(this.fileMap={});var i=this,o=new e.FileLoader(this.manager);o.setPath(this.path),o.setRequestHeader(this.requestHeader),o.setWithCredentials(this.withCredentials),o.load(t,(function(e){i.processObject(e,r,null,t)}),a,n)},parse:function(e,t,r){this.processObject(e,r,null,t)},setMaterials:function(e){return this.parseScopesStack=[],this.newParseScopeLevel(e),this.getCurrentParseScope().isFromParse=!1,this.materials=e,this},setFileMap:function(e){return this.fileMap=e,this},newParseScopeLevel:function(t){var r={};if(t)for(var a=0,n=t.length;a<n;a++){var i=t[a];r[i.userData.code]=i}var o=this.getCurrentParseScope(),s={lib:r,url:null,subobjects:null,numSubobjects:0,subobjectIndex:0,inverted:!1,category:null,keywords:null,currentFileName:null,mainColourCode:o?o.mainColourCode:"16",mainEdgeColourCode:o?o.mainEdgeColourCode:"24",currentMatrix:new e.Matrix4,matrix:new e.Matrix4,isFromParse:!0,triangles:null,lineSegments:null,conditionalSegments:null,startingConstructionStep:!1};return this.parseScopesStack.push(s),s},removeScopeLevel:function(){return this.parseScopesStack.pop(),this},addMaterial:function(e){var t=this.getCurrentParseScope().lib;return t[e.userData.code]||this.materials.push(e),t[e.userData.code]=e,this},getMaterial:function(e){if(e.startsWith("0x2")){var t=e.substring(3);return this.parseColourMetaDirective(new n("Direct_Color_"+t+" CODE -1 VALUE #"+t+" EDGE #"+t))}for(var r=this.parseScopesStack.length-1;r>=0;r--){var a=this.parseScopesStack[r].lib[e];if(a)return a}return null},getParentParseScope:function(){return this.parseScopesStack.length>1?this.parseScopesStack[this.parseScopesStack.length-2]:null},getCurrentParseScope:function(){return this.parseScopesStack.length>0?this.parseScopesStack[this.parseScopesStack.length-1]:null},parseColourMetaDirective:function(t){var r=null,a=16711935,i=16711935,o=1,l=!1,c=0,u=s.FINISH_TYPE_DEFAULT,d=!0,p=null,h=t.getToken();if(!h)throw'LDrawLoader: Material name was expected after "!COLOUR tag'+t.getLineNumberString()+".";for(var g=null;g=t.getToken();)switch(g.toUpperCase()){case"CODE":r=t.getToken();break;case"VALUE":if((a=t.getToken()).startsWith("0x"))a="#"+a.substring(2);else if(!a.startsWith("#"))throw"LDrawLoader: Invalid colour while parsing material"+t.getLineNumberString()+".";break;case"EDGE":if((i=t.getToken()).startsWith("0x"))i="#"+i.substring(2);else if(!i.startsWith("#")){if(!(p=this.getMaterial(i)))throw"LDrawLoader: Invalid edge colour while parsing material"+t.getLineNumberString()+".";p=p.userData.edgeMaterial}break;case"ALPHA":if(o=parseInt(t.getToken()),isNaN(o))throw"LDrawLoader: Invalid alpha value in material definition"+t.getLineNumberString()+".";(o=Math.max(0,Math.min(1,o/255)))<1&&(l=!0);break;case"LUMINANCE":if(c=parseInt(t.getToken()),isNaN(c))throw"LDrawLoader: Invalid luminance value in material definition"+n.getLineNumberString()+".";c=Math.max(0,Math.min(1,c/255));break;case"CHROME":u=s.FINISH_TYPE_CHROME;break;case"PEARLESCENT":u=s.FINISH_TYPE_PEARLESCENT;break;case"RUBBER":u=s.FINISH_TYPE_RUBBER;break;case"MATTE_METALLIC":u=s.FINISH_TYPE_MATTE_METALLIC;break;case"METAL":u=s.FINISH_TYPE_METAL;break;case"MATERIAL":t.setToEnd();break;default:throw'LDrawLoader: Unknown token "'+g+'" while parsing material'+t.getLineNumberString()+"."}var v=null;switch(u){case s.FINISH_TYPE_DEFAULT:v=new e.MeshStandardMaterial({color:a,roughness:.3,envMapIntensity:.3,metalness:0});break;case s.FINISH_TYPE_PEARLESCENT:var m=new e.Color(a),f=m.getHSL({h:0,s:0,l:0});f.h=(f.h+.5)%1,f.l=Math.min(1,f.l+.7*(1-f.l)),m.setHSL(f.h,f.s,f.l),v=new e.MeshPhongMaterial({color:a,specular:m,shininess:10,reflectivity:.3});break;case s.FINISH_TYPE_CHROME:v=new e.MeshStandardMaterial({color:a,roughness:0,metalness:1});break;case s.FINISH_TYPE_RUBBER:v=new e.MeshStandardMaterial({color:a,roughness:.9,metalness:0}),d=!1;break;case s.FINISH_TYPE_MATTE_METALLIC:v=new e.MeshStandardMaterial({color:a,roughness:.8,metalness:.4});break;case s.FINISH_TYPE_METAL:v=new e.MeshStandardMaterial({color:a,roughness:.2,metalness:.85})}return v.transparent=l,v.premultipliedAlpha=!0,v.opacity=o,v.depthWrite=!l,v.polygonOffset=!0,v.polygonOffsetFactor=1,v.userData.canHaveEnvMap=d,0!==c&&v.emissive.set(v.color).multiplyScalar(c),p||((p=new e.LineBasicMaterial({color:i,transparent:l,opacity:o,depthWrite:!l})).userData.code=r,p.name=h+" - Edge",p.userData.canHaveEnvMap=!1,p.userData.conditionalEdgeMaterial=new e.ShaderMaterial({vertexShader:"\n\tattribute vec3 control0;\n\tattribute vec3 control1;\n\tattribute vec3 direction;\n\tvarying float discardFlag;\n\n\t#include <common>\n\t#include <color_pars_vertex>\n\t#include <fog_pars_vertex>\n\t#include <logdepthbuf_pars_vertex>\n\t#include <clipping_planes_pars_vertex>\n\tvoid main() {\n\t\t#include <color_vertex>\n\n\t\tvec4 mvPosition = modelViewMatrix * vec4( position, 1.0 );\n\t\tgl_Position = projectionMatrix * mvPosition;\n\n\t\t// Transform the line segment ends and control points into camera clip space\n\t\tvec4 c0 = projectionMatrix * modelViewMatrix * vec4( control0, 1.0 );\n\t\tvec4 c1 = projectionMatrix * modelViewMatrix * vec4( control1, 1.0 );\n\t\tvec4 p0 = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n\t\tvec4 p1 = projectionMatrix * modelViewMatrix * vec4( position + direction, 1.0 );\n\n\t\tc0.xy /= c0.w;\n\t\tc1.xy /= c1.w;\n\t\tp0.xy /= p0.w;\n\t\tp1.xy /= p1.w;\n\n\t\t// Get the direction of the segment and an orthogonal vector\n\t\tvec2 dir = p1.xy - p0.xy;\n\t\tvec2 norm = vec2( -dir.y, dir.x );\n\n\t\t// Get control point directions from the line\n\t\tvec2 c0dir = c0.xy - p1.xy;\n\t\tvec2 c1dir = c1.xy - p1.xy;\n\n\t\t// If the vectors to the controls points are pointed in different directions away\n\t\t// from the line segment then the line should not be drawn.\n\t\tfloat d0 = dot( normalize( norm ), normalize( c0dir ) );\n\t\tfloat d1 = dot( normalize( norm ), normalize( c1dir ) );\n\t\tdiscardFlag = float( sign( d0 ) != sign( d1 ) );\n\n\t\t#include <logdepthbuf_vertex>\n\t\t#include <clipping_planes_vertex>\n\t\t#include <fog_vertex>\n\t}\n\t",fragmentShader:"\n\tuniform vec3 diffuse;\n\tuniform float opacity;\n\tvarying float discardFlag;\n\n\t#include <common>\n\t#include <color_pars_fragment>\n\t#include <fog_pars_fragment>\n\t#include <logdepthbuf_pars_fragment>\n\t#include <clipping_planes_pars_fragment>\n\tvoid main() {\n\n\t\tif ( discardFlag > 0.5 ) discard;\n\n\t\t#include <clipping_planes_fragment>\n\t\tvec3 outgoingLight = vec3( 0.0 );\n\t\tvec4 diffuseColor = vec4( diffuse, opacity );\n\t\t#include <logdepthbuf_fragment>\n\t\t#include <color_fragment>\n\t\toutgoingLight = diffuseColor.rgb; // simple shader\n\t\tgl_FragColor = vec4( outgoingLight, diffuseColor.a );\n\t\t#include <tonemapping_fragment>\n\t\t#include <encodings_fragment>\n\t\t#include <fog_fragment>\n\t\t#include <premultiplied_alpha_fragment>\n\t}\n\t",uniforms:e.UniformsUtils.merge([e.UniformsLib.fog,{diffuse:{value:new e.Color(i)},opacity:{value:o}}]),fog:!0,transparent:l,depthWrite:!l}),p.userData.conditionalEdgeMaterial.userData.canHaveEnvMap=!1),v.userData.code=r,v.name=h,v.userData.edgeMaterial=p,v},objectParse:function(i){var o,l,c,u=this.getParentParseScope(),d=u.mainColourCode,p=u.mainEdgeColourCode,h=this.getCurrentParseScope(),g=[],v=null,m=null;-1!==i.indexOf("\r\n")&&(i=i.replace(/\r\n/g,"\n"));var f=i.split("\n"),b=f.length,C=0,S=!1,L=null,_=null,E=!1,T=!0,I=!1,N=!0,x="",M=!1,w=this;function F(e,t){var r=e.getToken();t||"16"!==r||(r=d),t&&"24"===r&&(r=p);var a=w.getMaterial(r);if(!a)throw'LDrawLoader: Unknown colour code "'+r+'" is used'+e.getLineNumberString()+" but it was not defined previously.";return a}function k(t){var r=new e.Vector3(parseFloat(t.getToken()),parseFloat(t.getToken()),parseFloat(t.getToken()));return w.separateObjects||r.applyMatrix4(h.currentMatrix),r}for(C=0;C<b;C++){var O=f[C];if(0!==O.length)if(S)O.startsWith("0 FILE ")?(this.subobjectCache[L.toLowerCase()]=_,L=O.substring(7),_=""):_+=O+"\n";else{var A=new n(O,C+1);if(A.seekNonSpace(),!A.isAtTheEnd()){var y=A.getToken();switch(y){case"0":var D=A.getToken();if(D)switch(D){case"!LDRAW_ORG":x=A.getToken(),h.triangles=[],h.lineSegments=[],h.conditionalSegments=[],h.type=x,(!u.isFromParse||w.separateObjects&&!a(x))&&(h.groupObject=new e.Group,h.groupObject.userData.startingConstructionStep=h.startingConstructionStep),(Q=h.matrix).determinant()<0&&(w.separateObjects&&a(x)||!w.separateObjects)&&(h.inverted=!h.inverted),o=h.triangles,l=h.lineSegments,c=h.conditionalSegments;break;case"!COLOUR":(j=this.parseColourMetaDirective(A))?this.addMaterial(j):console.warn("LDrawLoader: Error parsing material"+A.getLineNumberString());break;case"!CATEGORY":v=A.getToken();break;case"!KEYWORDS":var P=A.getRemainingString().split(",");P.length>0&&(m||(m=[]),P.forEach((function(e){m.push(e.trim())})));break;case"FILE":C>0&&(S=!0,L=A.getRemainingString(),_="",E=!1,T=!0);break;case"BFC":for(;!A.isAtTheEnd();){var R=A.getToken();switch(R){case"CERTIFY":case"NOCERTIFY":E="CERTIFY"===R,T=!0;break;case"CW":case"CCW":T="CCW"===R;break;case"INVERTNEXT":I=!0;break;case"CLIP":case"NOCLIP":N="CLIP"===R;break;default:console.warn('THREE.LDrawLoader: BFC directive "'+R+'" is unknown.')}}break;case"STEP":M=!0}break;case"1":var j=F(A),H=parseFloat(A.getToken()),Y=parseFloat(A.getToken()),U=parseFloat(A.getToken()),V=parseFloat(A.getToken()),z=parseFloat(A.getToken()),B=parseFloat(A.getToken()),W=parseFloat(A.getToken()),G=parseFloat(A.getToken()),q=parseFloat(A.getToken()),K=parseFloat(A.getToken()),X=parseFloat(A.getToken()),J=parseFloat(A.getToken()),Q=(new e.Matrix4).set(V,z,B,H,W,G,q,Y,K,X,J,U,0,0,0,1),Z=A.getRemainingString().trim().replace(/\\/g,"/");w.fileMap[Z]?Z=w.fileMap[Z]:Z.startsWith("s/")?Z="parts/"+Z:Z.startsWith("48/")&&(Z="p/"+Z),g.push({material:j,matrix:Q,fileName:Z,originalFileName:Z,locationState:s.FILE_LOCATION_AS_IS,url:null,triedLowerCase:!1,inverted:I!==h.inverted,startingConstructionStep:M}),I=!1;break;case"2":var $={material:(j=F(A,!0)).userData.edgeMaterial,colourCode:j.userData.code,v0:k(A),v1:k(A)};l.push($);break;case"5":$={material:(j=F(A,!0)).userData.edgeMaterial.userData.conditionalEdgeMaterial,colourCode:j.userData.code,v0:k(A),v1:k(A),c0:k(A),c1:k(A)};c.push($);break;case"3":j=F(A);var ee=!E||!N;!0===(T!==h.inverted)?(te=k(A),re=k(A),ae=k(A)):(ae=k(A),re=k(A),te=k(A)),t.subVectors(re,te),r.subVectors(ae,re),ie=(new e.Vector3).crossVectors(t,r).normalize(),o.push({material:j,colourCode:j.userData.code,v0:te,v1:re,v2:ae,faceNormal:ie,n0:null,n1:null,n2:null}),!0===ee&&o.push({material:j,colourCode:j.userData.code,v0:te,v1:ae,v2:re,faceNormal:ie,n0:null,n1:null,n2:null});break;case"4":var te,re,ae,ne,ie;j=F(A),ee=!E||!N;!0===(T!==h.inverted)?(te=k(A),re=k(A),ae=k(A),ne=k(A)):(ne=k(A),ae=k(A),re=k(A),te=k(A)),t.subVectors(re,te),r.subVectors(ae,re),ie=(new e.Vector3).crossVectors(t,r).normalize(),o.push({material:j,colourCode:j.userData.code,v0:te,v1:re,v2:ae,faceNormal:ie,n0:null,n1:null,n2:null}),o.push({material:j,colourCode:j.userData.code,v0:te,v1:ae,v2:ne,faceNormal:ie,n0:null,n1:null,n2:null}),!0===ee&&(o.push({material:j,colourCode:j.userData.code,v0:te,v1:ae,v2:re,faceNormal:ie,n0:null,n1:null,n2:null}),o.push({material:j,colourCode:j.userData.code,v0:te,v1:ne,v2:ae,faceNormal:ie,n0:null,n1:null,n2:null}));break;default:throw'LDrawLoader: Unknown line type "'+y+'"'+A.getLineNumberString()+"."}}}}S&&(this.subobjectCache[L.toLowerCase()]=_),h.category=v,h.keywords=m,h.subobjects=g,h.numSubobjects=g.length,h.subobjectIndex=0},computeConstructionSteps:function(e){var t=0;e.traverse((function(e){e.isGroup&&(e.userData.startingConstructionStep&&t++,e.userData.constructionStep=t)})),e.userData.numConstructionSteps=t+1},processObject:function(n,i,l,c){var u=this,d=u.newParseScopeLevel();d.url=c;var p=u.getParentParseScope();l&&(d.currentMatrix.multiplyMatrices(p.currentMatrix,l.matrix),d.matrix.copy(l.matrix),d.inverted=l.inverted,d.startingConstructionStep=l.startingConstructionStep);var h=p.currentFileName;null!==h&&(h=p.currentFileName.toLowerCase()),void 0===u.subobjectCache[h]&&(u.subobjectCache[h]=n),u.objectParse(n);var g=0;function v(){if(++g===d.subobjects.length+1)!function(){u.smoothNormals&&"Part"===d.type&&function(e,t){function r(e){return~~(100*e.x)+","+~~(100*e.y)+","+~~(100*e.z)}function a(e,t){return r(e)+"_"+r(t)}for(var n=new Set,i={},o={},s=[],l=0,c=t.length;l<c;l++){var u=t[l],d=u.v0,p=u.v1;n.add(a(d,p)),n.add(a(p,d))}for(var h=0,g=e.length;h<g;h++)for(var v=e[h],m=0;m<3;m++){var f=(m+1)%3,b=a(d=v["v"+(T=m)],p=v["v"+f]);n.has(b)||(i[b]=v,o[b]=v)}for(;;){var C=Object.keys(i);if(0===C.length)break;for(var S=0,L=[o[C[0]]];S<L.length;){v=L[S],S++;var _=v.faceNormal;null===v.n0&&(v.n0=_.clone(),s.push(v.n0)),null===v.n1&&(v.n1=_.clone(),s.push(v.n1)),null===v.n2&&(v.n2=_.clone(),s.push(v.n2));for(var E=0;E<3;E++){var T;f=(E+1)%3,delete i[b=a(d=v["v"+(T=E)],p=v["v"+f])];var I=a(p,d),N=o[I];if(N){if(Math.abs(N.faceNormal.dot(v.faceNormal))<.25)continue;I in i&&(L.push(N),delete i[I]);for(var x=0;x<3;x++){var M=x,w=(x+1)%3;if(a(N["v"+M],N["v"+w])===I){if(null===N["n"+M]){var F=v["n"+f];N["n"+M]=F,F.add(N.faceNormal)}null===N["n"+w]&&(F=v["n"+T],N["n"+w]=F,F.add(N.faceNormal));break}}}}}}for(var k=0,O=s.length;k<O;k++)s[k].normalize()}(d.triangles,d.lineSegments);var e=!p.isFromParse;if(u.separateObjects&&!a(d.type)||e){var n=d.groupObject;d.triangles.length>0&&n.add(o(d.triangles,3)),d.lineSegments.length>0&&n.add(o(d.lineSegments,2)),d.conditionalSegments.length>0&&n.add(o(d.conditionalSegments,2,!0)),p.groupObject&&(n.name=d.fileName,n.userData.category=d.category,n.userData.keywords=d.keywords,d.matrix.decompose(n.position,n.quaternion,n.scale),p.groupObject.add(n))}else{for(var s=u.separateObjects,l=p.lineSegments,c=p.conditionalSegments,h=p.triangles,g=d.lineSegments,v=d.conditionalSegments,m=d.triangles,f=0,b=g.length;f<b;f++){var C=g[f];s&&(C.v0.applyMatrix4(d.matrix),C.v1.applyMatrix4(d.matrix)),l.push(C)}for(var S=0,L=v.length;S<L;S++){var _=v[S];s&&(_.v0.applyMatrix4(d.matrix),_.v1.applyMatrix4(d.matrix),_.c0.applyMatrix4(d.matrix),_.c1.applyMatrix4(d.matrix)),c.push(_)}for(var E=0,T=m.length;E<T;E++){var I=m[E];s&&(I.v0=I.v0.clone().applyMatrix4(d.matrix),I.v1=I.v1.clone().applyMatrix4(d.matrix),I.v2=I.v2.clone().applyMatrix4(d.matrix),t.subVectors(I.v1,I.v0),r.subVectors(I.v2,I.v1),I.faceNormal.crossVectors(t,r).normalize()),h.push(I)}}u.removeScopeLevel(),p.isFromParse||u.computeConstructionSteps(d.groupObject);i&&i(d.groupObject)}();else{var e=d.subobjects[d.subobjectIndex];Promise.resolve().then((function(){m(e)})),d.subobjectIndex++}}function m(t){d.mainColourCode=t.material.userData.code,d.mainEdgeColourCode=t.material.userData.edgeMaterial.userData.code,d.currentFileName=t.originalFileName;var r=u.subobjectCache[t.originalFileName.toLowerCase()];if(r)u.processObject(r,(function(e){f(e,t),v()}),t,c);else{var a=t.fileName,n=s.FILE_LOCATION_NOT_FOUND;switch(t.locationState){case s.FILE_LOCATION_AS_IS:n=t.locationState+1;break;case s.FILE_LOCATION_TRY_PARTS:a="parts/"+a,n=t.locationState+1;break;case s.FILE_LOCATION_TRY_P:a="p/"+a,n=t.locationState+1;break;case s.FILE_LOCATION_TRY_MODELS:a="models/"+a,n=t.locationState+1;break;case s.FILE_LOCATION_TRY_RELATIVE:a=c.substring(0,c.lastIndexOf("/")+1)+a,n=t.locationState+1;break;case s.FILE_LOCATION_TRY_ABSOLUTE:t.triedLowerCase?n=s.FILE_LOCATION_NOT_FOUND:(t.fileName=t.fileName.toLowerCase(),a=t.fileName,t.triedLowerCase=!0,n=s.FILE_LOCATION_AS_IS);break;case s.FILE_LOCATION_NOT_FOUND:return void console.warn('LDrawLoader: Subobject "'+t.originalFileName+'" could not be found.')}t.locationState=n,t.url=a;var i=new e.FileLoader(u.manager);i.setPath(u.path),i.setRequestHeader(u.requestHeader),i.setWithCredentials(u.withCredentials),i.load(a,(function(e){u.processObject(e,(function(e){f(e,t),v()}),t,c)}),void 0,(function(e){!function(e,t){m(t)}(0,t)}),t)}}function f(e,t){null!==e?u.fileMap[t.originalFileName]=t.url:m(t)}v()}}),s}();exports.LDrawLoader=t;
