"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("three"),t=require("./TGALoader.cjs.js"),r=function(t){e.Loader.call(this,t)};r.prototype=Object.assign(Object.create(e.Loader.prototype),{constructor:r,load:function(t,r,a,n){var i=this,s=""===i.path?e.LoaderUtils.extractUrlBase(t):i.path,o=new e.FileLoader(i.manager);o.setPath(i.path),o.setRequestHeader(i.requestHeader),o.setWithCredentials(i.withCredentials),o.load(t,(function(e){try{r(i.parse(e,s))}catch(e){n?n(e):console.error(e),i.manager.itemError(t)}}),a,n)},options:{set convertUpAxis(e){console.warn("THREE.ColladaLoader: options.convertUpAxis() has been removed. Up axis is converted automatically.")}},parse:function(r,a){function n(e,t){for(var r=[],a=e.childNodes,n=0,i=a.length;n<i;n++){var s=a[n];s.nodeName===t&&r.push(s)}return r}function i(e){if(0===e.length)return[];for(var t=e.trim().split(/\s+/),r=new Array(t.length),a=0,n=t.length;a<n;a++)r[a]=t[a];return r}function s(e){if(0===e.length)return[];for(var t=e.trim().split(/\s+/),r=new Array(t.length),a=0,n=t.length;a<n;a++)r[a]=parseFloat(t[a]);return r}function o(e){if(0===e.length)return[];for(var t=e.trim().split(/\s+/),r=new Array(t.length),a=0,n=t.length;a<n;a++)r[a]=parseInt(t[a]);return r}function c(e){return e.substring(1)}function l(e){return 0===Object.keys(e).length}function d(e){return void 0!==e&&!0===e.hasAttribute("meter")?parseFloat(e.getAttribute("meter")):1}function u(e){return void 0!==e?e.textContent:"Y_UP"}function f(e,t,r,a){var i=n(e,t)[0];if(void 0!==i)for(var s=n(i,r),o=0;o<s.length;o++)a(s[o])}function h(e,t){for(var r in e){e[r].build=t(e[r])}}function m(e,t){return void 0!==e.build||(e.build=t(e)),e.build}function p(e){for(var t={inputs:{}},r=0,a=e.childNodes.length;r<a;r++){var n=e.childNodes[r];if(1===n.nodeType)switch(n.nodeName){case"input":var i=c(n.getAttribute("source")),s=n.getAttribute("semantic");t.inputs[s]=i}}return t}function v(e){var t={},r=e.getAttribute("target").split("/"),a=r.shift(),n=r.shift(),i=-1!==n.indexOf("("),s=-1!==n.indexOf(".");if(s)r=n.split("."),n=r.shift(),t.member=r.shift();else if(i){var o=n.split("(");n=o.shift();for(var l=0;l<o.length;l++)o[l]=parseInt(o[l].replace(/\)/,""));t.indices=o}return t.id=a,t.sid=n,t.arraySyntax=i,t.memberSyntax=s,t.sampler=c(e.getAttribute("source")),t}function g(e){var t=[],r=e.channels,a=e.samplers,n=e.sources;for(var i in r)if(r.hasOwnProperty(i)){var s=r[i],o=a[s.sampler],c=o.inputs.INPUT,l=o.inputs.OUTPUT;k(y(s,n[c],n[l]),t)}return t}function b(e){return m(Ye.animations[e],g)}function y(e,t,r){var a,n,i,s,o,c,l=Ye.nodes[e.id],d=Se(l.id),u=l.transforms[e.sid],f=l.matrix.clone().transpose(),h={};switch(u){case"matrix":for(i=0,s=t.array.length;i<s;i++)if(a=t.array[i],n=i*r.stride,void 0===h[a]&&(h[a]={}),!0===e.arraySyntax){var m=r.array[n],p=e.indices[0]+4*e.indices[1];h[a][p]=m}else for(o=0,c=r.stride;o<c;o++)h[a][o]=r.array[n+o];break;case"translate":case"rotate":case"scale":console.warn('THREE.ColladaLoader: Animation transform type "%s" not yet implemented.',u)}var v=function(e,t){var r=[];for(var a in e)r.push({time:parseFloat(a),value:e[a]});r.sort(i);for(var n=0;n<16;n++)A(r,n,t.elements[n]);return r;function i(e,t){return e.time-t.time}}(h,f);return{name:d.uuid,keyframes:v}}var N=new e.Vector3,w=new e.Vector3,x=new e.Quaternion;function k(t,r){for(var a=t.keyframes,n=t.name,i=[],s=[],o=[],c=[],l=0,d=a.length;l<d;l++){var u=a[l],f=u.time,h=u.value;Ce.fromArray(h).transpose(),Ce.decompose(N,x,w),i.push(f),s.push(N.x,N.y,N.z),o.push(x.x,x.y,x.z,x.w),c.push(w.x,w.y,w.z)}return s.length>0&&r.push(new e.VectorKeyframeTrack(n+".position",i,s)),o.length>0&&r.push(new e.QuaternionKeyframeTrack(n+".quaternion",i,o)),c.length>0&&r.push(new e.VectorKeyframeTrack(n+".scale",i,c)),r}function A(e,t,r){var a,n,i,s=!0;for(n=0,i=e.length;n<i;n++)void 0===(a=e[n]).value[t]?a.value[t]=null:s=!1;if(!0===s)for(n=0,i=e.length;n<i;n++)(a=e[n]).value[t]=r;else!function(e,t){for(var r,a,n=0,i=e.length;n<i;n++){var s=e[n];if(null===s.value[t]){if(r=T(e,n,t),a=C(e,n,t),null===r){s.value[t]=a.value[t];continue}if(null===a){s.value[t]=r.value[t];continue}E(s,r,a,t)}}}(e,t)}function T(e,t,r){for(;t>=0;){var a=e[t];if(null!==a.value[r])return a;t--}return null}function C(e,t,r){for(;t<e.length;){var a=e[t];if(null!==a.value[r])return a;t++}return null}function E(e,t,r,a){r.time-t.time!=0?e.value[a]=(e.time-t.time)*(r.value[a]-t.value[a])/(r.time-t.time)+t.value[a]:e.value[a]=t.value[a]}function _(t){for(var r=[],a=t.name,n=t.end-t.start||-1,i=t.animations,s=0,o=i.length;s<o;s++)for(var c=b(i[s]),l=0,d=c.length;l<d;l++)r.push(c[l]);return new e.AnimationClip(a,n,r)}function M(e){return m(Ye.clips[e],_)}function L(e){for(var t={sources:{}},r=0,a=e.childNodes.length;r<a;r++){var n=e.childNodes[r];if(1===n.nodeType)switch(n.nodeName){case"bind_shape_matrix":t.bindShapeMatrix=s(n.textContent);break;case"source":var i=n.getAttribute("id");t.sources[i]=se(n);break;case"joints":t.joints=R(n);break;case"vertex_weights":t.vertexWeights=O(n)}}return t}function R(e){for(var t={inputs:{}},r=0,a=e.childNodes.length;r<a;r++){var n=e.childNodes[r];if(1===n.nodeType)switch(n.nodeName){case"input":var i=n.getAttribute("semantic"),s=c(n.getAttribute("source"));t.inputs[i]=s}}return t}function O(e){for(var t={inputs:{}},r=0,a=e.childNodes.length;r<a;r++){var n=e.childNodes[r];if(1===n.nodeType)switch(n.nodeName){case"input":var i=n.getAttribute("semantic"),s=c(n.getAttribute("source")),l=parseInt(n.getAttribute("offset"));t.inputs[i]={id:s,offset:l};break;case"vcount":t.vcount=o(n.textContent);break;case"v":t.v=o(n.textContent)}}return t}function j(t){var r={id:t.id},a=Ye.geometries[r.id];return void 0!==t.skin&&(r.skin=function(t){var r,a,n,i=4,s={joints:[],indices:{array:[],stride:i},weights:{array:[],stride:i}},o=t.sources,c=t.vertexWeights,l=c.vcount,d=c.v,u=c.inputs.JOINT.offset,f=c.inputs.WEIGHT.offset,h=t.sources[t.joints.inputs.JOINT],m=t.sources[t.joints.inputs.INV_BIND_MATRIX],p=o[c.inputs.WEIGHT.id].array,v=0;for(r=0,n=l.length;r<n;r++){var g=l[r],b=[];for(a=0;a<g;a++){var y=d[v+u],N=p[d[v+f]];b.push({index:y,weight:N}),v+=2}for(b.sort(A),a=0;a<i;a++){var w=b[a];void 0!==w?(s.indices.array.push(w.index),s.weights.array.push(w.weight)):(s.indices.array.push(0),s.weights.array.push(0))}}t.bindShapeMatrix?s.bindMatrix=(new e.Matrix4).fromArray(t.bindShapeMatrix).transpose():s.bindMatrix=(new e.Matrix4).identity();for(r=0,n=h.array.length;r<n;r++){var x=h.array[r],k=(new e.Matrix4).fromArray(m.array,r*m.stride).transpose();s.joints.push({name:x,boneInverse:k})}return s;function A(e,t){return t.weight-e.weight}}(t.skin),a.sources.skinIndices=r.skin.indices,a.sources.skinWeights=r.skin.weights),r}function q(e){return void 0!==e.build?e.build:e.init_from}function I(e){var t=Ye.images[e];return void 0!==t?m(t,q):(console.warn("THREE.ColladaLoader: Couldn't find image with ID:",e),null)}function U(e){for(var t={surfaces:{},samplers:{}},r=0,a=e.childNodes.length;r<a;r++){var n=e.childNodes[r];if(1===n.nodeType)switch(n.nodeName){case"newparam":S(n,t);break;case"technique":t.technique=B(n);break;case"extra":t.extra=G(n)}}return t}function S(e,t){for(var r=e.getAttribute("sid"),a=0,n=e.childNodes.length;a<n;a++){var i=e.childNodes[a];if(1===i.nodeType)switch(i.nodeName){case"surface":t.surfaces[r]=H(i);break;case"sampler2D":t.samplers[r]=F(i)}}}function H(e){for(var t={},r=0,a=e.childNodes.length;r<a;r++){var n=e.childNodes[r];if(1===n.nodeType)switch(n.nodeName){case"init_from":t.init_from=n.textContent}}return t}function F(e){for(var t={},r=0,a=e.childNodes.length;r<a;r++){var n=e.childNodes[r];if(1===n.nodeType)switch(n.nodeName){case"source":t.source=n.textContent}}return t}function B(e){for(var t={},r=0,a=e.childNodes.length;r<a;r++){var n=e.childNodes[r];if(1===n.nodeType)switch(n.nodeName){case"constant":case"lambert":case"blinn":case"phong":t.type=n.nodeName,t.parameters=P(n)}}return t}function P(e){for(var t={},r=0,a=e.childNodes.length;r<a;r++){var n=e.childNodes[r];if(1===n.nodeType)switch(n.nodeName){case"emission":case"diffuse":case"specular":case"bump":case"ambient":case"shininess":case"transparency":t[n.nodeName]=V(n);break;case"transparent":t[n.nodeName]={opaque:n.getAttribute("opaque"),data:V(n)}}}return t}function V(e){for(var t={},r=0,a=e.childNodes.length;r<a;r++){var n=e.childNodes[r];if(1===n.nodeType)switch(n.nodeName){case"color":t[n.nodeName]=s(n.textContent);break;case"float":t[n.nodeName]=parseFloat(n.textContent);break;case"texture":t[n.nodeName]={id:n.getAttribute("texture"),extra:D(n)}}}return t}function D(e){for(var t={technique:{}},r=0,a=e.childNodes.length;r<a;r++){var n=e.childNodes[r];if(1===n.nodeType)switch(n.nodeName){case"extra":W(n,t)}}return t}function W(e,t){for(var r=0,a=e.childNodes.length;r<a;r++){var n=e.childNodes[r];if(1===n.nodeType)switch(n.nodeName){case"technique":z(n,t)}}}function z(e,t){for(var r=0,a=e.childNodes.length;r<a;r++){var n=e.childNodes[r];if(1===n.nodeType)switch(n.nodeName){case"repeatU":case"repeatV":case"offsetU":case"offsetV":t.technique[n.nodeName]=parseFloat(n.textContent);break;case"wrapU":case"wrapV":"TRUE"===n.textContent.toUpperCase()?t.technique[n.nodeName]=1:"FALSE"===n.textContent.toUpperCase()?t.technique[n.nodeName]=0:t.technique[n.nodeName]=parseInt(n.textContent)}}}function G(e){for(var t={},r=0,a=e.childNodes.length;r<a;r++){var n=e.childNodes[r];if(1===n.nodeType)switch(n.nodeName){case"technique":t.technique=J(n)}}return t}function J(e){for(var t={},r=0,a=e.childNodes.length;r<a;r++){var n=e.childNodes[r];if(1===n.nodeType)switch(n.nodeName){case"double_sided":t[n.nodeName]=parseInt(n.textContent)}}return t}function X(e){return e}function K(t){var r,a,n=(r=t.url,m(Ye.effects[r],X)),i=n.profile.technique,s=n.profile.extra;switch(i.type){case"phong":case"blinn":a=new e.MeshPhongMaterial;break;case"lambert":a=new e.MeshLambertMaterial;break;default:a=new e.MeshBasicMaterial}function o(t){var r=n.profile.samplers[t.id],a=null;void 0!==r?a=I(n.profile.surfaces[r.source].init_from):(console.warn("THREE.ColladaLoader: Undefined sampler. Access image directly (see #12530)."),a=I(t.id));if(null!==a){var i=function(e){var t,r=e.slice(2+(e.lastIndexOf(".")-1>>>0));switch(r=r.toLowerCase()){case"tga":t=Ge;break;default:t=Xe}return t}(a);if(void 0!==i){var s=i.load(a),o=t.extra;if(void 0!==o&&void 0!==o.technique&&!1===l(o.technique)){var c=o.technique;s.wrapS=c.wrapU?e.RepeatWrapping:e.ClampToEdgeWrapping,s.wrapT=c.wrapV?e.RepeatWrapping:e.ClampToEdgeWrapping,s.offset.set(c.offsetU||0,c.offsetV||0),s.repeat.set(c.repeatU||1,c.repeatV||1)}else s.wrapS=e.RepeatWrapping,s.wrapT=e.RepeatWrapping;return s}return console.warn("THREE.ColladaLoader: Loader for texture %s not found.",a),null}return console.warn("THREE.ColladaLoader: Couldn't create texture with ID:",t.id),null}a.name=t.name||"";var c=i.parameters;for(var d in c){var u=c[d];switch(d){case"diffuse":u.color&&a.color.fromArray(u.color),u.texture&&(a.map=o(u.texture));break;case"specular":u.color&&a.specular&&a.specular.fromArray(u.color),u.texture&&(a.specularMap=o(u.texture));break;case"bump":u.texture&&(a.normalMap=o(u.texture));break;case"ambient":u.texture&&(a.lightMap=o(u.texture));break;case"shininess":u.float&&a.shininess&&(a.shininess=u.float);break;case"emission":u.color&&a.emissive&&a.emissive.fromArray(u.color),u.texture&&(a.emissiveMap=o(u.texture))}}var f=c.transparent,h=c.transparency;if(void 0===h&&f&&(h={float:1}),void 0===f&&h&&(f={opaque:"A_ONE",data:{color:[1,1,1,1]}}),f&&h)if(f.data.texture)a.transparent=!0;else{var p=f.data.color;switch(f.opaque){case"A_ONE":a.opacity=p[3]*h.float;break;case"RGB_ZERO":a.opacity=1-p[0]*h.float;break;case"A_ZERO":a.opacity=1-p[3]*h.float;break;case"RGB_ONE":a.opacity=p[0]*h.float;break;default:console.warn('THREE.ColladaLoader: Invalid opaque type "%s" of transparent tag.',f.opaque)}a.opacity<1&&(a.transparent=!0)}return void 0!==s&&void 0!==s.technique&&1===s.technique.double_sided&&(a.side=e.DoubleSide),a}function Z(e){return m(Ye.materials[e],K)}function Q(e){for(var t=0;t<e.childNodes.length;t++){var r=e.childNodes[t];switch(r.nodeName){case"technique_common":return Y(r)}}return{}}function Y(e){for(var t={},r=0;r<e.childNodes.length;r++){var a=e.childNodes[r];switch(a.nodeName){case"perspective":case"orthographic":t.technique=a.nodeName,t.parameters=$(a)}}return t}function $(e){for(var t={},r=0;r<e.childNodes.length;r++){var a=e.childNodes[r];switch(a.nodeName){case"xfov":case"yfov":case"xmag":case"ymag":case"znear":case"zfar":case"aspect_ratio":t[a.nodeName]=parseFloat(a.textContent)}}return t}function ee(t){var r;switch(t.optics.technique){case"perspective":r=new e.PerspectiveCamera(t.optics.parameters.yfov,t.optics.parameters.aspect_ratio,t.optics.parameters.znear,t.optics.parameters.zfar);break;case"orthographic":var a=t.optics.parameters.ymag,n=t.optics.parameters.xmag,i=t.optics.parameters.aspect_ratio;n=void 0===n?a*i:n,a=void 0===a?n/i:a,n*=.5,a*=.5,r=new e.OrthographicCamera(-n,n,a,-a,t.optics.parameters.znear,t.optics.parameters.zfar);break;default:r=new e.PerspectiveCamera}return r.name=t.name||"",r}function te(e){var t=Ye.cameras[e];return void 0!==t?m(t,ee):(console.warn("THREE.ColladaLoader: Couldn't find camera with ID:",e),null)}function re(e){for(var t={},r=0,a=e.childNodes.length;r<a;r++){var n=e.childNodes[r];if(1===n.nodeType)switch(n.nodeName){case"directional":case"point":case"spot":case"ambient":t.technique=n.nodeName,t.parameters=ae(n)}}return t}function ae(t){for(var r={},a=0,n=t.childNodes.length;a<n;a++){var i=t.childNodes[a];if(1===i.nodeType)switch(i.nodeName){case"color":var o=s(i.textContent);r.color=(new e.Color).fromArray(o);break;case"falloff_angle":r.falloffAngle=parseFloat(i.textContent);break;case"quadratic_attenuation":var c=parseFloat(i.textContent);r.distance=c?Math.sqrt(1/c):0}}return r}function ne(t){var r;switch(t.technique){case"directional":r=new e.DirectionalLight;break;case"point":r=new e.PointLight;break;case"spot":r=new e.SpotLight;break;case"ambient":r=new e.AmbientLight}return t.parameters.color&&r.color.copy(t.parameters.color),t.parameters.distance&&(r.distance=t.parameters.distance),r}function ie(e){var t=Ye.lights[e];return void 0!==t?m(t,ne):(console.warn("THREE.ColladaLoader: Couldn't find light with ID:",e),null)}function se(e){for(var t={array:[],stride:3},r=0;r<e.childNodes.length;r++){var a=e.childNodes[r];if(1===a.nodeType)switch(a.nodeName){case"float_array":t.array=s(a.textContent);break;case"Name_array":t.array=i(a.textContent);break;case"technique_common":var o=n(a,"accessor")[0];void 0!==o&&(t.stride=parseInt(o.getAttribute("stride")))}}return t}function oe(e){for(var t={},r=0;r<e.childNodes.length;r++){var a=e.childNodes[r];1===a.nodeType&&(t[a.getAttribute("semantic")]=c(a.getAttribute("source")))}return t}function ce(e){for(var t={type:e.nodeName,material:e.getAttribute("material"),count:parseInt(e.getAttribute("count")),inputs:{},stride:0,hasUV:!1},r=0,a=e.childNodes.length;r<a;r++){var n=e.childNodes[r];if(1===n.nodeType)switch(n.nodeName){case"input":var i=c(n.getAttribute("source")),s=n.getAttribute("semantic"),l=parseInt(n.getAttribute("offset")),d=parseInt(n.getAttribute("set")),u=d>0?s+d:s;t.inputs[u]={id:i,offset:l},t.stride=Math.max(t.stride,l+1),"TEXCOORD"===s&&(t.hasUV=!0);break;case"vcount":t.vcount=o(n.textContent);break;case"p":t.p=o(n.textContent)}}return t}function le(e){for(var t=0,r=0,a=e.length;r<a;r++){!0===e[r].hasUV&&t++}t>0&&t<e.length&&(e.uvsNeedsFix=!0)}function de(e){var t={},r=e.sources,a=e.vertices,n=e.primitives;if(0===n.length)return{};var i=function(e){for(var t={},r=0;r<e.length;r++){var a=e[r];void 0===t[a.type]&&(t[a.type]=[]),t[a.type].push(a)}return t}(n);for(var s in i){var o=i[s];le(o),t[s]=ue(o,r,a)}return t}function ue(t,r,a){for(var n={},i={array:[],stride:0},s={array:[],stride:0},o={array:[],stride:0},c={array:[],stride:0},l={array:[],stride:0},d=[],u=4,f=[],h=4,m=new e.BufferGeometry,p=[],v=0,g=0;g<t.length;g++){var b=t[g],y=b.inputs,N=0;switch(b.type){case"lines":case"linestrips":N=2*b.count;break;case"triangles":N=3*b.count;break;case"polylist":for(var w=0;w<b.count;w++){var x=b.vcount[w];switch(x){case 3:N+=3;break;case 4:N+=6;break;default:N+=3*(x-2)}}break;default:console.warn("THREE.ColladaLoader: Unknow primitive type:",b.type)}for(var k in m.addGroup(v,N,g),v+=N,b.material&&p.push(b.material),y){var A=y[k];switch(k){case"VERTEX":for(var T in a){var C=a[T];switch(T){case"POSITION":var E=i.array.length;if(fe(b,r[C],A.offset,i.array),i.stride=r[C].stride,r.skinWeights&&r.skinIndices&&(fe(b,r.skinIndices,A.offset,d),fe(b,r.skinWeights,A.offset,f)),!1===b.hasUV&&!0===t.uvsNeedsFix){N=(i.array.length-E)/i.stride;for(var _=0;_<N;_++)o.array.push(0,0)}break;case"NORMAL":fe(b,r[C],A.offset,s.array),s.stride=r[C].stride;break;case"COLOR":fe(b,r[C],A.offset,l.array),l.stride=r[C].stride;break;case"TEXCOORD":fe(b,r[C],A.offset,o.array),o.stride=r[C].stride;break;case"TEXCOORD1":fe(b,r[C],A.offset,c.array),o.stride=r[C].stride;break;default:console.warn('THREE.ColladaLoader: Semantic "%s" not handled in geometry build process.',T)}}break;case"NORMAL":fe(b,r[A.id],A.offset,s.array),s.stride=r[A.id].stride;break;case"COLOR":fe(b,r[A.id],A.offset,l.array),l.stride=r[A.id].stride;break;case"TEXCOORD":fe(b,r[A.id],A.offset,o.array),o.stride=r[A.id].stride;break;case"TEXCOORD1":fe(b,r[A.id],A.offset,c.array),c.stride=r[A.id].stride}}}return i.array.length>0&&m.setAttribute("position",new e.Float32BufferAttribute(i.array,i.stride)),s.array.length>0&&m.setAttribute("normal",new e.Float32BufferAttribute(s.array,s.stride)),l.array.length>0&&m.setAttribute("color",new e.Float32BufferAttribute(l.array,l.stride)),o.array.length>0&&m.setAttribute("uv",new e.Float32BufferAttribute(o.array,o.stride)),c.array.length>0&&m.setAttribute("uv2",new e.Float32BufferAttribute(c.array,c.stride)),d.length>0&&m.setAttribute("skinIndex",new e.Float32BufferAttribute(d,u)),f.length>0&&m.setAttribute("skinWeight",new e.Float32BufferAttribute(f,h)),n.data=m,n.type=t[0].type,n.materialKeys=p,n}function fe(e,t,r,a){var n=e.p,i=e.stride,s=e.vcount;function o(e){for(var t=n[e+r]*l,i=t+l;t<i;t++)a.push(c[t])}var c=t.array,l=t.stride;if(void 0!==e.vcount)for(var d=0,u=0,f=s.length;u<f;u++){var h=s[u];if(4===h){var m=d+1*i,p=d+2*i,v=d+3*i;o(d+0*i),o(m),o(v),o(m),o(p),o(v)}else if(3===h){m=d+1*i,p=d+2*i;o(d+0*i),o(m),o(p)}else if(h>4)for(var g=1,b=h-2;g<=b;g++){m=d+i*g,p=d+i*(g+1);o(d+0*i),o(m),o(p)}d+=i*h}else for(var y=0,N=n.length;y<N;y+=i)o(y)}function he(e){return m(Ye.geometries[e],de)}function me(e){return void 0!==e.build?e.build:e}function pe(e,t){for(var r=0;r<e.childNodes.length;r++){var a=e.childNodes[r];if(1===a.nodeType)switch(a.nodeName){case"joint":t.joints[a.getAttribute("sid")]=ve(a);break;case"link":t.links.push(be(a))}}}function ve(e){for(var t,r=0;r<e.childNodes.length;r++){var a=e.childNodes[r];if(1===a.nodeType)switch(a.nodeName){case"prismatic":case"revolute":t=ge(a)}}return t}function ge(t,r){r={sid:t.getAttribute("sid"),name:t.getAttribute("name")||"",axis:new e.Vector3,limits:{min:0,max:0},type:t.nodeName,static:!1,zeroPosition:0,middlePosition:0};for(var a=0;a<t.childNodes.length;a++){var n=t.childNodes[a];if(1===n.nodeType)switch(n.nodeName){case"axis":var i=s(n.textContent);r.axis.fromArray(i);break;case"limits":var o=n.getElementsByTagName("max")[0],c=n.getElementsByTagName("min")[0];r.limits.max=parseFloat(o.textContent),r.limits.min=parseFloat(c.textContent)}}return r.limits.min>=r.limits.max&&(r.static=!0),r.middlePosition=(r.limits.min+r.limits.max)/2,r}function be(e){for(var t={sid:e.getAttribute("sid"),name:e.getAttribute("name")||"",attachments:[],transforms:[]},r=0;r<e.childNodes.length;r++){var a=e.childNodes[r];if(1===a.nodeType)switch(a.nodeName){case"attachment_full":t.attachments.push(ye(a));break;case"matrix":case"translate":case"rotate":t.transforms.push(Ne(a))}}return t}function ye(e){for(var t={joint:e.getAttribute("joint").split("/").pop(),transforms:[],links:[]},r=0;r<e.childNodes.length;r++){var a=e.childNodes[r];if(1===a.nodeType)switch(a.nodeName){case"link":t.links.push(be(a));break;case"matrix":case"translate":case"rotate":t.transforms.push(Ne(a))}}return t}function Ne(t){var r={type:t.nodeName},a=s(t.textContent);switch(r.type){case"matrix":r.obj=new e.Matrix4,r.obj.fromArray(a).transpose();break;case"translate":r.obj=new e.Vector3,r.obj.fromArray(a);break;case"rotate":r.obj=new e.Vector3,r.obj.fromArray(a),r.angle=e.MathUtils.degToRad(a[3])}return r}function we(e,t){for(var r=0;r<e.childNodes.length;r++){var a=e.childNodes[r];if(1===a.nodeType)switch(a.nodeName){case"technique_common":xe(a,t)}}}function xe(e,t){for(var r=0;r<e.childNodes.length;r++){var a=e.childNodes[r];if(1===a.nodeType)switch(a.nodeName){case"inertia":t.inertia=s(a.textContent);break;case"mass":t.mass=s(a.textContent)[0]}}}function ke(e){for(var t={target:e.getAttribute("target").split("/").pop()},r=0;r<e.childNodes.length;r++){var a=e.childNodes[r];if(1===a.nodeType)switch(a.nodeName){case"axis":var n=a.getElementsByTagName("param")[0];t.axis=n.textContent;var i=t.axis.split("inst_").pop().split("axis")[0];t.jointIndex=i.substr(0,i.length-1)}}return t}function Ae(e){return void 0!==e.build?e.build:e}function Te(t){for(var r=[],a=Pe.querySelector('[id="'+t.id+'"]'),n=0;n<a.childNodes.length;n++){var i=a.childNodes[n];if(1===i.nodeType)switch(i.nodeName){case"matrix":var o=s(i.textContent),c=(new e.Matrix4).fromArray(o).transpose();r.push({sid:i.getAttribute("sid"),type:i.nodeName,obj:c});break;case"translate":case"scale":o=s(i.textContent);var l=(new e.Vector3).fromArray(o);r.push({sid:i.getAttribute("sid"),type:i.nodeName,obj:l});break;case"rotate":o=s(i.textContent),l=(new e.Vector3).fromArray(o);var d=e.MathUtils.degToRad(o[3]);r.push({sid:i.getAttribute("sid"),type:i.nodeName,obj:l,angle:d})}}return r}var Ce=new e.Matrix4,Ee=new e.Vector3;function _e(t){for(var r={name:t.getAttribute("name")||"",type:t.getAttribute("type"),id:t.getAttribute("id"),sid:t.getAttribute("sid"),matrix:new e.Matrix4,nodes:[],instanceCameras:[],instanceControllers:[],instanceLights:[],instanceGeometries:[],instanceNodes:[],transforms:{}},a=0;a<t.childNodes.length;a++){var n=t.childNodes[a];if(1===n.nodeType)switch(n.nodeName){case"node":r.nodes.push(n.getAttribute("id")),_e(n);break;case"instance_camera":r.instanceCameras.push(c(n.getAttribute("url")));break;case"instance_controller":r.instanceControllers.push(Me(n));break;case"instance_light":r.instanceLights.push(c(n.getAttribute("url")));break;case"instance_geometry":r.instanceGeometries.push(Me(n));break;case"instance_node":r.instanceNodes.push(c(n.getAttribute("url")));break;case"matrix":var i=s(n.textContent);r.matrix.multiply(Ce.fromArray(i).transpose()),r.transforms[n.getAttribute("sid")]=n.nodeName;break;case"translate":i=s(n.textContent);Ee.fromArray(i),r.matrix.multiply(Ce.makeTranslation(Ee.x,Ee.y,Ee.z)),r.transforms[n.getAttribute("sid")]=n.nodeName;break;case"rotate":i=s(n.textContent);var o=e.MathUtils.degToRad(i[3]);r.matrix.multiply(Ce.makeRotationAxis(Ee.fromArray(i),o)),r.transforms[n.getAttribute("sid")]=n.nodeName;break;case"scale":i=s(n.textContent);r.matrix.scale(Ee.fromArray(i)),r.transforms[n.getAttribute("sid")]=n.nodeName;break;case"extra":break;default:console.log(n)}}return Ue(r.id)?console.warn("THREE.ColladaLoader: There is already a node with ID %s. Exclude current node from further processing.",r.id):Ye.nodes[r.id]=r,r}function Me(e){for(var t={id:c(e.getAttribute("url")),materials:{},skeletons:[]},r=0;r<e.childNodes.length;r++){var a=e.childNodes[r];switch(a.nodeName){case"bind_material":for(var n=a.getElementsByTagName("instance_material"),i=0;i<n.length;i++){var s=n[i],o=s.getAttribute("symbol"),l=s.getAttribute("target");t.materials[o]=c(l)}break;case"skeleton":t.skeletons.push(c(a.textContent))}}return t}function Le(t,r){var a,n,i,s,o=[],c=[];for(a=0;a<t.length;a++){var l=t[a];if(Ue(l))Re(Se(l),r,o);else if(s=l,void 0!==Ye.visualScenes[s])for(var d=Ye.visualScenes[l].children,u=0;u<d.length;u++){var f=d[u];if("JOINT"===f.type)Re(Se(f.id),r,o)}else console.error("THREE.ColladaLoader: Unable to find root bone of skeleton with ID:",l)}for(a=0;a<r.length;a++)for(n=0;n<o.length;n++)if((i=o[n]).bone.name===r[a].name){c[a]=i,i.processed=!0;break}for(a=0;a<o.length;a++)!1===(i=o[a]).processed&&(c.push(i),i.processed=!0);var h=[],m=[];for(a=0;a<c.length;a++)i=c[a],h.push(i.bone),m.push(i.boneInverse);return new e.Skeleton(h,m)}function Re(t,r,a){t.traverse((function(t){if(!0===t.isBone){for(var n,i=0;i<r.length;i++){var s=r[i];if(s.name===t.name){n=s.boneInverse;break}}void 0===n&&(n=new e.Matrix4),a.push({bone:t,boneInverse:n,processed:!1})}}))}function Oe(t){for(var r,a=[],n=t.matrix,i=t.nodes,s=t.type,o=t.instanceCameras,c=t.instanceControllers,l=t.instanceLights,d=t.instanceGeometries,u=t.instanceNodes,f=0,h=i.length;f<h;f++)a.push(Se(i[f]));for(var p=0,v=o.length;p<v;p++){var g=te(o[p]);null!==g&&a.push(g.clone())}for(var b=0,y=c.length;b<y;b++)for(var N=c[b],w=(r=N.id,m(Ye.controllers[r],j)),x=Ie(he(w.id),N.materials),k=Le(N.skeletons,w.skin.joints),A=0,T=x.length;A<T;A++){var C;(C=x[A]).isSkinnedMesh&&(C.bind(k,w.skin.bindMatrix),C.normalizeSkinWeights()),a.push(C)}for(var E=0,_=l.length;E<_;E++){var M=ie(l[E]);null!==M&&a.push(M.clone())}for(var L=0,R=d.length;L<R;L++)for(var O=0,q=(x=Ie(he((N=d[L]).id),N.materials)).length;O<q;O++)a.push(x[O]);for(var I=0,U=u.length;I<U;I++)a.push(Se(u[I]).clone());if(0===i.length&&1===a.length)C=a[0];else{C="JOINT"===s?new e.Bone:new e.Group;for(var S=0;S<a.length;S++)C.add(a[S])}return C.name="JOINT"===s?t.sid:t.name,C.matrix.copy(n),C.matrix.decompose(C.position,C.quaternion,C.scale),C}var je=new e.MeshBasicMaterial({color:16711935});function qe(e,t){for(var r=[],a=0,n=e.length;a<n;a++){var i=t[e[a]];void 0===i?(console.warn("THREE.ColladaLoader: Material with key %s not found. Apply fallback material.",e[a]),r.push(je)):r.push(Z(i))}return r}function Ie(t,r){var a=[];for(var n in t){var i=t[n],s=qe(i.materialKeys,r);0===s.length&&("lines"===n||"linestrips"===n?s.push(new e.LineBasicMaterial):s.push(new e.MeshPhongMaterial));var o=void 0!==i.data.attributes.skinIndex;if(o)for(var c=0,l=s.length;c<l;c++)s[c].skinning=!0;var d,u=1===s.length?s[0]:s;switch(n){case"lines":d=new e.LineSegments(i.data,u);break;case"linestrips":d=new e.Line(i.data,u);break;case"triangles":case"polylist":d=o?new e.SkinnedMesh(i.data,u):new e.Mesh(i.data,u)}a.push(d)}return a}function Ue(e){return void 0!==Ye.nodes[e]}function Se(e){return m(Ye.nodes[e],Oe)}function He(t){var r=new e.Group;r.name=t.name;for(var a=t.children,n=0;n<a.length;n++){var i=a[n];r.add(Se(i.id))}return r}function Fe(e){return m(Ye.visualScenes[e],He)}if(0===r.length)return{scene:new e.Scene};var Be=(new DOMParser).parseFromString(r,"application/xml"),Pe=n(Be,"COLLADA")[0],Ve=Be.getElementsByTagName("parsererror")[0];if(void 0!==Ve){var De,We=n(Ve,"div")[0];return De=We?We.textContent:function(e){for(var t="",r=[e];r.length;){var a=r.shift();a.nodeType===Node.TEXT_NODE?t+=a.textContent:(t+="\n",r.push.apply(r,a.childNodes))}return t.trim()}(Ve),console.error("THREE.ColladaLoader: Failed to parse collada file.\n",De),null}var ze=Pe.getAttribute("version");console.log("THREE.ColladaLoader: File version",ze);var Ge,Je=function(e){return{unit:d(n(e,"unit")[0]),upAxis:u(n(e,"up_axis")[0])}}(n(Pe,"asset")[0]),Xe=new e.TextureLoader(this.manager);Xe.setPath(this.resourcePath||a).setCrossOrigin(this.crossOrigin),t.TGALoader&&(Ge=new t.TGALoader(this.manager)).setPath(this.resourcePath||a);var Ke=[],Ze={},Qe=0,Ye={animations:{},clips:{},controllers:{},images:{},effects:{},materials:{},cameras:{},lights:{},geometries:{},nodes:{},visualScenes:{},kinematicsModels:{},physicsModels:{},kinematicsScenes:{}};f(Pe,"library_animations","animation",(function t(r){for(var a={sources:{},samplers:{},channels:{}},n=!1,i=0,s=r.childNodes.length;i<s;i++){var o,c=r.childNodes[i];if(1===c.nodeType)switch(c.nodeName){case"source":o=c.getAttribute("id"),a.sources[o]=se(c);break;case"sampler":o=c.getAttribute("id"),a.samplers[o]=p(c);break;case"channel":o=c.getAttribute("target"),a.channels[o]=v(c);break;case"animation":t(c),n=!0;break;default:console.log(c)}}!1===n&&(Ye.animations[r.getAttribute("id")||e.MathUtils.generateUUID()]=a)})),f(Pe,"library_animation_clips","animation_clip",(function(e){for(var t={name:e.getAttribute("id")||"default",start:parseFloat(e.getAttribute("start")||0),end:parseFloat(e.getAttribute("end")||0),animations:[]},r=0,a=e.childNodes.length;r<a;r++){var n=e.childNodes[r];if(1===n.nodeType)switch(n.nodeName){case"instance_animation":t.animations.push(c(n.getAttribute("url")))}}Ye.clips[e.getAttribute("id")]=t})),f(Pe,"library_controllers","controller",(function(e){for(var t={},r=0,a=e.childNodes.length;r<a;r++){var n=e.childNodes[r];if(1===n.nodeType)switch(n.nodeName){case"skin":t.id=c(n.getAttribute("source")),t.skin=L(n);break;case"morph":t.id=c(n.getAttribute("source")),console.warn("THREE.ColladaLoader: Morph target animation not supported yet.")}}Ye.controllers[e.getAttribute("id")]=t})),f(Pe,"library_images","image",(function(e){var t={init_from:n(e,"init_from")[0].textContent};Ye.images[e.getAttribute("id")]=t})),f(Pe,"library_effects","effect",(function(e){for(var t={},r=0,a=e.childNodes.length;r<a;r++){var n=e.childNodes[r];if(1===n.nodeType)switch(n.nodeName){case"profile_COMMON":t.profile=U(n)}}Ye.effects[e.getAttribute("id")]=t})),f(Pe,"library_materials","material",(function(e){for(var t={name:e.getAttribute("name")},r=0,a=e.childNodes.length;r<a;r++){var n=e.childNodes[r];if(1===n.nodeType)switch(n.nodeName){case"instance_effect":t.url=c(n.getAttribute("url"))}}Ye.materials[e.getAttribute("id")]=t})),f(Pe,"library_cameras","camera",(function(e){for(var t={name:e.getAttribute("name")},r=0,a=e.childNodes.length;r<a;r++){var n=e.childNodes[r];if(1===n.nodeType)switch(n.nodeName){case"optics":t.optics=Q(n)}}Ye.cameras[e.getAttribute("id")]=t})),f(Pe,"library_lights","light",(function(e){for(var t={},r=0,a=e.childNodes.length;r<a;r++){var n=e.childNodes[r];if(1===n.nodeType)switch(n.nodeName){case"technique_common":t=re(n)}}Ye.lights[e.getAttribute("id")]=t})),f(Pe,"library_geometries","geometry",(function(e){var t={name:e.getAttribute("name"),sources:{},vertices:{},primitives:[]},r=n(e,"mesh")[0];if(void 0!==r){for(var a=0;a<r.childNodes.length;a++){var i=r.childNodes[a];if(1===i.nodeType){var s=i.getAttribute("id");switch(i.nodeName){case"source":t.sources[s]=se(i);break;case"vertices":t.vertices=oe(i);break;case"polygons":console.warn("THREE.ColladaLoader: Unsupported primitive type: ",i.nodeName);break;case"lines":case"linestrips":case"polylist":case"triangles":t.primitives.push(ce(i));break;default:console.log(i)}}}Ye.geometries[e.getAttribute("id")]=t}})),f(Pe,"library_nodes","node",_e),f(Pe,"library_visual_scenes","visual_scene",(function(e){var t={name:e.getAttribute("name"),children:[]};!function(e){for(var t=e.getElementsByTagName("node"),r=0;r<t.length;r++){var a=t[r];!1===a.hasAttribute("id")&&a.setAttribute("id","three_default_"+Qe++)}}(e);for(var r=n(e,"node"),a=0;a<r.length;a++)t.children.push(_e(r[a]));Ye.visualScenes[e.getAttribute("id")]=t})),f(Pe,"library_kinematics_models","kinematics_model",(function(e){for(var t={name:e.getAttribute("name")||"",joints:{},links:[]},r=0;r<e.childNodes.length;r++){var a=e.childNodes[r];if(1===a.nodeType)switch(a.nodeName){case"technique_common":pe(a,t)}}Ye.kinematicsModels[e.getAttribute("id")]=t})),f(Pe,"library_physics_models","physics_model",(function(e){for(var t={name:e.getAttribute("name")||"",rigidBodies:{}},r=0;r<e.childNodes.length;r++){var a=e.childNodes[r];if(1===a.nodeType)switch(a.nodeName){case"rigid_body":t.rigidBodies[a.getAttribute("name")]={},we(a,t.rigidBodies[a.getAttribute("name")])}}Ye.physicsModels[e.getAttribute("id")]=t})),f(Pe,"scene","instance_kinematics_scene",(function(e){for(var t={bindJointAxis:[]},r=0;r<e.childNodes.length;r++){var a=e.childNodes[r];if(1===a.nodeType)switch(a.nodeName){case"bind_joint_axis":t.bindJointAxis.push(ke(a))}}Ye.kinematicsScenes[c(e.getAttribute("url"))]=t})),h(Ye.animations,g),h(Ye.clips,_),h(Ye.controllers,j),h(Ye.images,q),h(Ye.effects,X),h(Ye.materials,K),h(Ye.cameras,ee),h(Ye.lights,ne),h(Ye.geometries,de),h(Ye.visualScenes,He),function(){var t=Ye.clips;if(!0===l(t)){if(!1===l(Ye.animations)){var r=[];for(var a in Ye.animations)for(var n=b(a),i=0,s=n.length;i<s;i++)r.push(n[i]);Ke.push(new e.AnimationClip("default",-1,r))}}else for(var o in t)Ke.push(M(o))}(),function(){var t=Object.keys(Ye.kinematicsModels)[0],r=Object.keys(Ye.kinematicsScenes)[0],a=Object.keys(Ye.visualScenes)[0];if(void 0!==t&&void 0!==r){for(var n,i=(n=t,m(Ye.kinematicsModels[n],me)),s=function(e){return m(Ye.kinematicsScenes[e],Ae)}(r),o=Fe(a),c=s.bindJointAxis,l={},d=0,u=c.length;d<u;d++){var f=c[d],h=Pe.querySelector('[sid="'+f.target+'"]');if(h){var p=h.parentElement;g(f.jointIndex,p)}}var v=new e.Matrix4;Ze={joints:i&&i.joints,getJointValue:function(e){var t=l[e];if(t)return t.position;console.warn("THREE.ColladaLoader: Joint "+e+" doesn't exist.")},setJointValue:function(t,r){var a=l[t];if(a){var n=a.joint;if(r>n.limits.max||r<n.limits.min)console.warn("THREE.ColladaLoader: Joint "+t+" value "+r+" outside of limits (min: "+n.limits.min+", max: "+n.limits.max+").");else if(n.static)console.warn("THREE.ColladaLoader: Joint "+t+" is static.");else{var i=a.object,s=n.axis,o=a.transforms;Ce.identity();for(var c=0;c<o.length;c++){var d=o[c];if(d.sid&&-1!==d.sid.indexOf(t))switch(n.type){case"revolute":Ce.multiply(v.makeRotationAxis(s,e.MathUtils.degToRad(r)));break;case"prismatic":Ce.multiply(v.makeTranslation(s.x*r,s.y*r,s.z*r));break;default:console.warn("THREE.ColladaLoader: Unknown joint type: "+n.type)}else switch(d.type){case"matrix":Ce.multiply(d.obj);break;case"translate":Ce.multiply(v.makeTranslation(d.obj.x,d.obj.y,d.obj.z));break;case"scale":Ce.scale(d.obj);break;case"rotate":Ce.multiply(v.makeRotationAxis(d.obj,d.angle))}}i.matrix.copy(Ce),i.matrix.decompose(i.position,i.quaternion,i.scale),l[t].position=r}}else console.log("THREE.ColladaLoader: "+t+" does not exist.")}}}function g(e,t){var r=t.getAttribute("name"),a=i.joints[e];o.traverse((function(n){n.name===r&&(l[e]={object:n,transforms:Te(t),joint:a,position:a.zeroPosition})}))}}();var $e=function(e){return Fe(c(n(e,"instance_visual_scene")[0].getAttribute("url")))}(n(Pe,"scene")[0]);return $e.animations=Ke,"Z_UP"===Je.upAxis&&$e.quaternion.setFromEuler(new e.Euler(-Math.PI/2,0,0)),$e.scale.multiplyScalar(Je.unit),{get animations(){return console.warn("THREE.ColladaLoader: Please access animations over scene.animations now."),Ke},kinematics:Ze,library:Ye,scene:$e}}}),exports.ColladaLoader=r;
