"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("three"),r=require("fflate"),a=function(r){e.DataTextureLoader.call(this,r),this.type=e.FloatType};a.prototype=Object.assign(Object.create(e.DataTextureLoader.prototype),{constructor:a,parse:function(a){var n=65536,t=14,i=65537,o=16384,f=Math.pow(2.7182818,2.2),l=new DataView(new ArrayBuffer(8));function s(e){if(0===e)return[e,0];l.setFloat64(0,e);var r=l.getUint32(0)>>>20&2047;0===r&&(l.setFloat64(0,e*Math.pow(2,64)),r=(l.getUint32(0)>>>20&2047)-64);var a=r-1022;return[function(e,r){for(var a=Math.min(3,Math.ceil(Math.abs(r)/1023)),n=e,t=0;t<a;t++)n*=Math.pow(2,Math.floor((r+t)/a));return n}(e,-a),a]}var u={l:0,c:0,lc:0};function v(e,r,a,n,t){for(;a<e;)r=r<<8|V(n,t),a+=8;a-=e,u.l=r>>a&(1<<e)-1,u.c=r,u.lc=a}var c=new Array(59);function h(e,r,a,n,t,o,f){for(var l=a,s=0,h=0;t<=o;t++){if(l.value-a.value>n)return!1;v(6,s,h,e,l);var w=u.l;if(s=u.c,h=u.lc,f[t]=w,63==w){if(l.value-a.value>n)throw"Something wrong with hufUnpackEncTable";v(8,s,h,e,l);var p=u.l+6;if(s=u.c,h=u.lc,t+p>o+1)throw"Something wrong with hufUnpackEncTable";for(;p--;)f[t++]=0;t--}else if(w>=59){if(t+(p=w-59+2)>o+1)throw"Something wrong with hufUnpackEncTable";for(;p--;)f[t++]=0;t--}}!function(e){for(var r=0;r<=58;++r)c[r]=0;for(var a=0;a<i;++a)c[e[a]]+=1;for(var n=0,t=58;t>0;--t){var o=n+c[t]>>1;c[t]=n,n=o}for(var f=0;f<i;++f){var l=e[f];l>0&&(e[f]=l|c[l]++<<6)}}(f)}function w(e){return 63&e}function p(e){return e>>6}var y={c:0,lc:0};function d(e,r,a,n){e=e<<8|V(a,n),r+=8,y.c=e,y.lc=r}var g={c:0,lc:0};function b(e,r,a,n,t,i,o,f,l,s){if(e==r){n<8&&(d(a,n,t,o),a=y.c,n=y.lc);var u=a>>(n-=8);u=new Uint8Array([u])[0];if(l.value+u>s)return!1;for(var v=f[l.value-1];u-- >0;)f[l.value++]=v}else{if(!(l.value<s))return!1;f[l.value++]=e}g.c=a,g.lc=n}function S(e){return 65535&e}function A(e){var r=S(e);return r>32767?r-65536:r}var U={a:0,b:0};function m(e,r){var a=A(e),n=A(r),t=a+(1&n)+(n>>1),i=t,o=t-n;U.a=i,U.b=o}function M(e,r){var a=S(e),n=S(r),t=a-(n>>1)&65535,i=n+t-32768&65535;U.a=i,U.b=t}function E(e,r,a,n,t,i,o){for(var f,l=o<16384,s=a>t?t:a,u=1;u<=s;)u<<=1;for(f=u>>=1,u>>=1;u>=1;){for(var v,c,h,w,p=0,y=p+i*(t-f),d=i*u,g=i*f,b=n*u,S=n*f;p<=y;p+=g){for(var A=p,E=p+n*(a-f);A<=E;A+=S){var O=A+b,C=(R=A+d)+b;l?(m(e[A+r],e[R+r]),v=U.a,h=U.b,m(e[O+r],e[C+r]),c=U.a,w=U.b,m(v,c),e[A+r]=U.a,e[O+r]=U.b,m(h,w),e[R+r]=U.a,e[C+r]=U.b):(M(e[A+r],e[R+r]),v=U.a,h=U.b,M(e[O+r],e[C+r]),c=U.a,w=U.b,M(v,c),e[A+r]=U.a,e[O+r]=U.b,M(h,w),e[R+r]=U.a,e[C+r]=U.b)}if(a&u){var R=A+d;l?m(e[A+r],e[R+r]):M(e[A+r],e[R+r]),v=U.a,e[R+r]=U.b,e[A+r]=v}}if(t&u)for(A=p,E=p+n*(a-f);A<=E;A+=S){O=A+b;l?m(e[A+r],e[O+r]):M(e[A+r],e[O+r]),v=U.a,e[O+r]=U.b,e[A+r]=v}f=u,u>>=1}return p}function O(e,r,a,n,f,l){var s=a.value,u=X(r,a),v=X(r,a);a.value+=4;var c=X(r,a);if(a.value+=4,u<0||u>=i||v<0||v>=i)throw"Something wrong with HUF_ENCSIZE";var S=new Array(i),A=new Array(o);if(function(e){for(var r=0;r<o;r++)e[r]={},e[r].len=0,e[r].lit=0,e[r].p=null}(A),h(e,0,a,n-(a.value-s),u,v,S),c>8*(n-(a.value-s)))throw"Something wrong with hufUncompress";!function(e,r,a,n){for(;r<=a;r++){var i=p(e[r]),o=w(e[r]);if(i>>o)throw"Invalid table entry";if(o>t){if((v=n[i>>o-t]).len)throw"Invalid table entry";if(v.lit++,v.p){var f=v.p;v.p=new Array(v.lit);for(var l=0;l<v.lit-1;++l)v.p[l]=f[l]}else v.p=new Array(1);v.p[v.lit-1]=r}else if(o)for(var s=0,u=1<<t-o;u>0;u--){var v;if((v=n[(i<<t-o)+s]).len||v.p)throw"Invalid table entry";v.len=o,v.lit=r,s++}}}(S,u,v,A),function(e,r,a,n,i,o,f,l,s,u){for(var v=0,c=0,h=l,S=Math.trunc(i.value+(o+7)/8);i.value<S;)for(d(v,c,a,i),v=y.c,c=y.lc;c>=t;)if((M=r[v>>c-t&16383]).len)c-=M.len,b(M.lit,f,v,c,a,0,i,s,u,h),v=g.c,c=g.lc;else{if(!M.p)throw"hufDecode issues";var A;for(A=0;A<M.lit;A++){for(var U=w(e[M.p[A]]);c<U&&i.value<S;)d(v,c,a,i),v=y.c,c=y.lc;if(c>=U&&p(e[M.p[A]])==(v>>c-U&(1<<U)-1)){c-=U,b(M.p[A],f,v,c,a,0,i,s,u,h),v=g.c,c=g.lc;break}}if(A==M.lit)throw"hufDecode issues"}var m=8-o&7;for(v>>=m,c-=m;c>0;){var M;if(!(M=r[v<<t-c&16383]).len)throw"hufDecode issues";c-=M.len,b(M.lit,f,v,c,a,0,i,s,u,h),v=g.c,c=g.lc}}(S,A,e,0,a,c,v,l,f,{value:0})}function C(e){for(var r=1;r<e.length;r++){var a=e[r-1]+e[r]-128;e[r]=a}}function R(e,r){for(var a=0,n=Math.floor((e.length+1)/2),t=0,i=e.length-1;!(t>i||(r[t++]=e[a++],t>i));)r[t++]=e[n++]}function x(e){for(var r=e.byteLength,a=new Array,n=0,t=new DataView(e);r>0;){var i=t.getInt8(n++);if(i<0){r-=(f=-i)+1;for(var o=0;o<f;o++)a.push(t.getUint8(n++))}else{var f=i;r-=2;for(var l=t.getUint8(n++),s=0;s<f+1;s++)a.push(l)}}return a}function I(e,r,a){for(var n,t=1;t<64;)65280==(n=r[e.value])?t=64:n>>8==255?t+=255&n:(a[t]=n,t++),e.value++}function z(e,r){r[0]=Y(e[0]),r[1]=Y(e[1]),r[2]=Y(e[5]),r[3]=Y(e[6]),r[4]=Y(e[14]),r[5]=Y(e[15]),r[6]=Y(e[27]),r[7]=Y(e[28]),r[8]=Y(e[2]),r[9]=Y(e[4]),r[10]=Y(e[7]),r[11]=Y(e[13]),r[12]=Y(e[16]),r[13]=Y(e[26]),r[14]=Y(e[29]),r[15]=Y(e[42]),r[16]=Y(e[3]),r[17]=Y(e[8]),r[18]=Y(e[12]),r[19]=Y(e[17]),r[20]=Y(e[25]),r[21]=Y(e[30]),r[22]=Y(e[41]),r[23]=Y(e[43]),r[24]=Y(e[9]),r[25]=Y(e[11]),r[26]=Y(e[18]),r[27]=Y(e[24]),r[28]=Y(e[31]),r[29]=Y(e[40]),r[30]=Y(e[44]),r[31]=Y(e[53]),r[32]=Y(e[10]),r[33]=Y(e[19]),r[34]=Y(e[23]),r[35]=Y(e[32]),r[36]=Y(e[39]),r[37]=Y(e[45]),r[38]=Y(e[52]),r[39]=Y(e[54]),r[40]=Y(e[20]),r[41]=Y(e[22]),r[42]=Y(e[33]),r[43]=Y(e[38]),r[44]=Y(e[46]),r[45]=Y(e[51]),r[46]=Y(e[55]),r[47]=Y(e[60]),r[48]=Y(e[21]),r[49]=Y(e[34]),r[50]=Y(e[37]),r[51]=Y(e[47]),r[52]=Y(e[50]),r[53]=Y(e[56]),r[54]=Y(e[59]),r[55]=Y(e[61]),r[56]=Y(e[35]),r[57]=Y(e[36]),r[58]=Y(e[48]),r[59]=Y(e[49]),r[60]=Y(e[57]),r[61]=Y(e[58]),r[62]=Y(e[62]),r[63]=Y(e[63])}function P(e){for(var r=.5*Math.cos(.7853975),a=.5*Math.cos(3.14159/16),n=.5*Math.cos(3.14159/8),t=.5*Math.cos(3*3.14159/16),i=.5*Math.cos(.981746875),o=.5*Math.cos(3*3.14159/8),f=.5*Math.cos(1.374445625),l=new Array(4),s=new Array(4),u=new Array(4),v=new Array(4),c=0;c<8;++c){var h=8*c;l[0]=n*e[h+2],l[1]=o*e[h+2],l[2]=n*e[h+6],l[3]=o*e[h+6],s[0]=a*e[h+1]+t*e[h+3]+i*e[h+5]+f*e[h+7],s[1]=t*e[h+1]-f*e[h+3]-a*e[h+5]-i*e[h+7],s[2]=i*e[h+1]-a*e[h+3]+f*e[h+5]+t*e[h+7],s[3]=f*e[h+1]-i*e[h+3]+t*e[h+5]-a*e[h+7],u[0]=r*(e[h+0]+e[h+4]),u[3]=r*(e[h+0]-e[h+4]),u[1]=l[0]+l[3],u[2]=l[1]-l[2],v[0]=u[0]+u[1],v[1]=u[3]+u[2],v[2]=u[3]-u[2],v[3]=u[0]-u[1],e[h+0]=v[0]+s[0],e[h+1]=v[1]+s[1],e[h+2]=v[2]+s[2],e[h+3]=v[3]+s[3],e[h+4]=v[3]-s[3],e[h+5]=v[2]-s[2],e[h+6]=v[1]-s[1],e[h+7]=v[0]-s[0]}for(var w=0;w<8;++w)l[0]=n*e[16+w],l[1]=o*e[16+w],l[2]=n*e[48+w],l[3]=o*e[48+w],s[0]=a*e[8+w]+t*e[24+w]+i*e[40+w]+f*e[56+w],s[1]=t*e[8+w]-f*e[24+w]-a*e[40+w]-i*e[56+w],s[2]=i*e[8+w]-a*e[24+w]+f*e[40+w]+t*e[56+w],s[3]=f*e[8+w]-i*e[24+w]+t*e[40+w]-a*e[56+w],u[0]=r*(e[w]+e[32+w]),u[3]=r*(e[w]-e[32+w]),u[1]=l[0]+l[3],u[2]=l[1]-l[2],v[0]=u[0]+u[1],v[1]=u[3]+u[2],v[2]=u[3]-u[2],v[3]=u[0]-u[1],e[0+w]=v[0]+s[0],e[8+w]=v[1]+s[1],e[16+w]=v[2]+s[2],e[24+w]=v[3]+s[3],e[32+w]=v[3]-s[3],e[40+w]=v[2]-s[2],e[48+w]=v[1]-s[1],e[56+w]=v[0]-s[0]}function T(e){for(var r=0;r<64;++r){var a=e[0][r],n=e[1][r],t=e[2][r];e[0][r]=a+1.5747*t,e[1][r]=a-.1873*n-.4682*t,e[2][r]=a+1.8556*n}}function N(r,a,n){for(var t=0;t<64;++t)a[n+t]=e.DataUtils.toHalfFloat(F(r[t]))}function F(e){return e<=1?Math.sign(e)*Math.pow(Math.abs(e),2.2):Math.sign(e)*Math.pow(f,Math.abs(e)-1)}function D(e){var a=e.array.slice(e.offset.value,e.offset.value+e.size),n=r.unzlibSync(a),t=new Uint8Array(n.length);return C(n),R(n,t),new DataView(t.buffer)}function k(e){var r=e.viewer,a={value:e.offset.value},n=new Uint8Array(e.width*e.lines*(K.channels.length*e.type*2)),t={version:W(r,a),unknownUncompressedSize:W(r,a),unknownCompressedSize:W(r,a),acCompressedSize:W(r,a),dcCompressedSize:W(r,a),rleCompressedSize:W(r,a),rleUncompressedSize:W(r,a),rleRawSize:W(r,a),totalAcUncompressedCount:W(r,a),totalDcUncompressedCount:W(r,a),acCompression:W(r,a)};if(t.version<2)throw"EXRLoader.parse: "+K.compression+" version "+t.version+" is unsupported";for(var i=new Array,o=G(r,a)-2;o>0;){var f=_(r.buffer,a),l=H(r,a),s=l>>2&3,u=new Int8Array([(l>>4)-1])[0],v=H(r,a);i.push({name:f,index:u,type:v,compression:s}),o-=f.length+3}for(var c=K.channels,h=new Array(e.channels),w=0;w<e.channels;++w){var p=h[w]={},y=c[w];p.name=y.name,p.compression=0,p.decoded=!1,p.type=y.pixelType,p.pLinear=y.pLinear,p.width=e.width,p.height=e.lines}for(var d={idx:new Array(3)},g=0;g<e.channels;++g){p=h[g];for(var b=0;b<i.length;++b){var S=i[b];p.name==S.name&&(p.compression=S.compression,S.index>=0&&(d.idx[S.index]=g),p.offset=g)}}if(t.acCompressedSize>0)switch(t.acCompression){case 0:var A=new Uint16Array(t.totalAcUncompressedCount);O(e.array,r,a,t.acCompressedSize,A,t.totalAcUncompressedCount);break;case 1:var U=e.array.slice(a.value,a.value+t.totalAcUncompressedCount),m=fflate.unzlibSync(U);A=new Uint16Array(m.buffer);a.value+=t.totalAcUncompressedCount}if(t.dcCompressedSize>0){var M={array:e.array,offset:a,size:t.dcCompressedSize},E=new Uint16Array(D(M).buffer);a.value+=t.dcCompressedSize}if(t.rleRawSize>0){U=e.array.slice(a.value,a.value+t.rleCompressedSize);var C=x((m=fflate.unzlibSync(U)).buffer);a.value+=t.rleCompressedSize}for(var R=0,F=new Array(h.length),k=0;k<F.length;++k)F[k]=new Array;for(var L=0;L<e.lines;++L)for(var B=0;B<h.length;++B)F[B].push(R),R+=h[B].width*e.type*2;!function(e,r,a,n,t,i){for(var o=new DataView(i.buffer),f=a[e.idx[0]].width,l=a[e.idx[0]].height,s=Math.floor(f/8),u=Math.ceil(f/8),v=Math.ceil(l/8),c=f-8*(u-1),h=l-8*(v-1),w={value:0},p=new Array(3),y=new Array(3),d=new Array(3),g=new Array(3),b=new Array(3),S=0;S<3;++S)b[S]=r[e.idx[S]],p[S]=S<1?0:p[S-1]+u*v,y[S]=new Float32Array(64),d[S]=new Uint16Array(64),g[S]=new Uint16Array(64*u);for(var A=0;A<v;++A){var U=8;A==v-1&&(U=h);for(var m=8,M=0;M<u;++M){M==u-1&&(m=c);for(var E=0;E<3;++E)d[E].fill(0),d[E][0]=t[p[E]++],I(w,n,d[E]),z(d[E],y[E]),P(y[E]);T(y);for(var O=0;O<3;++O)N(y[O],g[O],64*M)}for(var C=0,R=0;R<3;++R){for(var x=a[e.idx[R]].type,F=8*A;F<8*A+U;++F){C=b[R][F];for(var D=0;D<s;++D){var k=64*D+8*(7&F);o.setUint16(C+0*x,g[R][k+0],!0),o.setUint16(C+2*x,g[R][k+1],!0),o.setUint16(C+4*x,g[R][k+2],!0),o.setUint16(C+6*x,g[R][k+3],!0),o.setUint16(C+8*x,g[R][k+4],!0),o.setUint16(C+10*x,g[R][k+5],!0),o.setUint16(C+12*x,g[R][k+6],!0),o.setUint16(C+14*x,g[R][k+7],!0),C+=16*x}}if(s!=u)for(var _=8*A;_<8*A+U;++_)for(var L=b[R][_]+8*s*2*x,B=64*s+8*(7&_),X=0;X<m;++X)o.setUint16(L+2*X*x,g[R][B+X],!0)}}for(var V=new Uint16Array(f),H=(o=new DataView(i.buffer),0);H<3;++H){a[e.idx[H]].decoded=!0;var W=a[e.idx[H]].type;if(2==a[H].type)for(var Z=0;Z<l;++Z){for(var G=b[H][Z],j=0;j<f;++j)V[j]=o.getUint16(G+2*j*W,!0);for(var q=0;q<f;++q)o.setFloat32(G+2*q*W,Y(V[q]),!0)}}}(d,F,h,A,E,n);for(var X=0;X<h.length;++X){if(!(p=h[X]).decoded)switch(p.compression){case 2:for(var V=0,Z=0,j=0;j<e.lines;++j){for(var q=F[X][V],J=0;J<p.width;++J){for(var Q=0;Q<2*p.type;++Q)n[q++]=C[Z+Q*p.width*p.height];Z++}V++}break;case 1:default:throw"EXRLoader.parse: unsupported channel compression"}}return new DataView(n.buffer)}function _(e,r){for(var a=new Uint8Array(e),n=0;0!=a[r.value+n];)n+=1;var t=(new TextDecoder).decode(a.slice(r.value,r.value+n));return r.value=r.value+n+1,t}function L(e,r){var a=e.getUint32(0,!0);return r.value=r.value+8,a}function B(e,r){var a=e.getInt32(r.value,!0);return r.value=r.value+4,a}function X(e,r){var a=e.getUint32(r.value,!0);return r.value=r.value+4,a}function V(e,r){var a=e[r.value];return r.value=r.value+1,a}function H(e,r){var a=e.getUint8(r.value);return r.value=r.value+1,a}function W(e,r){var a=Number(e.getBigInt64(r.value,!0));return r.value+=8,a}function Z(e,r){var a=e.getFloat32(r.value,!0);return r.value+=4,a}function Y(e){var r=(31744&e)>>10,a=1023&e;return(e>>15?-1:1)*(r?31===r?a?NaN:1/0:Math.pow(2,r-15)*(1+a/1024):a/1024*6103515625e-14)}function G(e,r){var a=e.getUint16(r.value,!0);return r.value+=2,a}function j(e,r,a,n,t){return"string"===n||"stringvector"===n||"iccProfile"===n?function(e,r,a){var n=(new TextDecoder).decode(new Uint8Array(e).slice(r.value,r.value+a));return r.value=r.value+a,n}(r,a,t):"chlist"===n?function(e,r,a,n){for(var t=a.value,i=[];a.value<t+n-1;){var o=_(r,a),f=B(e,a),l=H(e,a);a.value+=3;var s=B(e,a),u=B(e,a);i.push({name:o,pixelType:f,pLinear:l,xSampling:s,ySampling:u})}return a.value+=1,i}(e,r,a,t):"chromaticities"===n?function(e,r){return{redX:Z(e,r),redY:Z(e,r),greenX:Z(e,r),greenY:Z(e,r),blueX:Z(e,r),blueY:Z(e,r),whiteX:Z(e,r),whiteY:Z(e,r)}}(e,a):"compression"===n?function(e,r){return["NO_COMPRESSION","RLE_COMPRESSION","ZIPS_COMPRESSION","ZIP_COMPRESSION","PIZ_COMPRESSION","PXR24_COMPRESSION","B44_COMPRESSION","B44A_COMPRESSION","DWAA_COMPRESSION","DWAB_COMPRESSION"][H(e,r)]}(e,a):"box2i"===n?function(e,r){return{xMin:X(e,r),yMin:X(e,r),xMax:X(e,r),yMax:X(e,r)}}(e,a):"lineOrder"===n?function(e,r){return["INCREASING_Y"][H(e,r)]}(e,a):"float"===n?Z(e,a):"v2f"===n?function(e,r){return[Z(e,r),Z(e,r)]}(e,a):"v3f"===n?function(e,r){return[Z(e,r),Z(e,r),Z(e,r)]}(e,a):"int"===n?B(e,a):"rational"===n?function(e,r){return[B(e,r),X(e,r)]}(e,a):"timecode"===n?function(e,r){return[X(e,r),X(e,r)]}(e,a):"preview"===n?(a.value+=t,"skipped"):void(a.value+=t)}var q=new DataView(a),J=new Uint8Array(a),K={};q.getUint32(0,!0),q.getUint8(4,!0),q.getUint8(5,!0);for(var Q={value:8},$=!0;$;){var ee=_(a,Q);if(0==ee)$=!1;else{var re=_(a,Q),ae=j(q,a,Q,re,X(q,Q));void 0===ae?console.warn("EXRLoader.parse: skipped unknown header attribute type '"+re+"'."):K[ee]=ae}}var ne,te,ie,oe,fe=K.dataWindow.yMax+1;switch(K.compression){case"NO_COMPRESSION":te=1,ne=function(e){return new DataView(e.array.buffer,e.offset.value,e.size)};break;case"RLE_COMPRESSION":te=1,ne=function(e){var r=e.viewer.buffer.slice(e.offset.value,e.offset.value+e.size),a=new Uint8Array(x(r)),n=new Uint8Array(a.length);return C(a),R(a,n),new DataView(n.buffer)};break;case"ZIPS_COMPRESSION":te=1,ne=D;break;case"ZIP_COMPRESSION":te=16,ne=D;break;case"PIZ_COMPRESSION":te=32,ne=function(e){for(var r=e.viewer,a={value:e.offset.value},t=e.width*te*(K.channels.length*e.type),i=new Uint16Array(t),o=new Uint8Array(8192),f=0,l=new Array(e.channels),s=0;s<e.channels;s++)l[s]={},l[s].start=f,l[s].end=l[s].start,l[s].nx=e.width,l[s].ny=e.lines,l[s].size=e.type,f+=l[s].nx*l[s].ny*l[s].size;var u=G(r,a),v=G(r,a);if(v>=8192)throw"Something is wrong with PIZ_COMPRESSION BITMAP_SIZE";if(u<=v)for(var c=0;c<v-u+1;c++)o[c+u]=H(r,a);var h=new Uint16Array(n),w=function(e,r){for(var a=0,t=0;t<n;++t)(0==t||e[t>>3]&1<<(7&t))&&(r[a++]=t);for(var i=a-1;a<n;)r[a++]=0;return i}(o,h),p=X(r,a);O(e.array,r,a,p,i,f);for(var y=0;y<e.channels;++y)for(var d=l[y],g=0;g<l[y].size;++g)E(i,d.start+g,d.nx,d.size,d.ny,d.nx*d.size,w);!function(e,r,a){for(var n=0;n<a;++n)r[n]=e[r[n]]}(h,i,f);for(var b=0,S=new Uint8Array(i.buffer.byteLength),A=0;A<e.lines;A++)for(var U=0;U<e.channels;U++){var m=(d=l[U]).nx*d.size,M=new Uint8Array(i.buffer,2*d.end,2*m);S.set(M,b),b+=2*m,d.end+=m}return new DataView(S.buffer)};break;case"PXR24_COMPRESSION":te=16,ne=function(e){var r=e.array.slice(e.offset.value,e.offset.value+e.size);"undefined"==typeof fflate&&console.error("THREE.EXRLoader: External library fflate.min.js required.");for(var a=fflate.unzlibSync(r),n=e.lines*e.channels*e.width,t=1==e.type?new Uint16Array(n):new Uint32Array(n),i=0,o=0,f=new Array(4),l=0;l<e.lines;l++)for(var s=0;s<e.channels;s++){var u=0;switch(e.type){case 1:f[0]=i,f[1]=f[0]+e.width,i=f[1]+e.width;for(var v=0;v<e.width;++v)u+=a[f[0]++]<<8|a[f[1]++],t[o]=u,o++;break;case 2:f[0]=i,f[1]=f[0]+e.width,f[2]=f[1]+e.width,i=f[2]+e.width;for(var c=0;c<e.width;++c)u+=a[f[0]++]<<24|a[f[1]++]<<16|a[f[2]++]<<8,t[o]=u,o++}}return new DataView(t.buffer)};break;case"DWAA_COMPRESSION":te=32,ne=k;break;case"DWAB_COMPRESSION":te=256,ne=k;break;default:throw"EXRLoader.parse: "+K.compression+" is unsupported"}var le=K.channels[0].pixelType;if(1===le)switch(this.type){case e.UnsignedByteType:case e.FloatType:oe=function(e,r){return Y(G(e,r))},ie=2;break;case e.HalfFloatType:oe=G,ie=2}else{if(2!==le)throw"EXRLoader.parse: unsupported pixelType "+le+" for "+K.compression+".";switch(this.type){case e.UnsignedByteType:case e.FloatType:oe=Z,ie=4;break;case e.HalfFloatType:oe=function(r,a){return e.DataUtils.toHalfFloat(Z(r,a))},ie=4}}for(var se=fe/te,ue=0;ue<se;ue++)L(q,Q);var ve=K.dataWindow.xMax-K.dataWindow.xMin+1,ce=K.dataWindow.yMax-K.dataWindow.yMin+1,he=ve*ce*4;switch(this.type){case e.UnsignedByteType:case e.FloatType:var we=new Float32Array(he);K.channels.length<4&&we.fill(1,0,he);break;case e.HalfFloatType:we=new Uint16Array(he);K.channels.length<4&&we.fill(15360,0,he);break;default:console.error("THREE.EXRLoader: unsupported type: ",this.type)}for(var pe,ye,de={R:0,G:1,B:2,A:3},ge={size:0,width:ve,lines:te,offset:Q,array:J,viewer:q,type:le,channels:K.channels.length},be={value:0},Se=0;Se<ce/te;Se++){pe=X(q,Q),he=X(q,Q),ge.lines=pe+te>ce?ce-pe:te,ge.offset=Q,ge.size=he,ye=ne(ge),Q.value+=he;for(var Ae=0;Ae<te;Ae++){var Ue=Ae+Se*te;if(Ue>=ce)break;for(var me=0;me<K.channels.length;me++)for(var Me=de[K.channels[me].name],Ee=0;Ee<ve;Ee++){var Oe=Ae*(K.channels.length*ve)+me*ve+Ee;be.value=Oe*ie;var Ce=oe(ye,be);we[4*ve*(ce-1-Ue)+4*Ee+Me]=Ce}}}if(this.type===e.UnsignedByteType){for(var Re,xe,Ie=we.length,ze=new Uint8Array(Ie),Pe=0;Pe<ce;++Pe)for(var Te=0;Te<ve;++Te){var Ne=we[xe=Pe*ve*4+4*Te],Fe=we[xe+1],De=we[xe+2];if((Re=De>(Re=Ne>Fe?Ne:Fe)?De:Re)<1e-32)ze[xe]=ze[xe+1]=ze[xe+2]=ze[xe+3]=0;else{var ke=s(Re);Re=256*ke[0]/Re,ze[xe]=Ne*Re,ze[xe+1]=Fe*Re,ze[xe+2]=De*Re,ze[xe+3]=ke[1]+128}}we=ze}var _e=this.type===e.UnsignedByteType?e.RGBEFormat:e.RGBAFormat;return{header:K,width:ve,height:ce,data:we,format:_e,type:this.type}},setDataType:function(e){return this.type=e,this},load:function(r,a,n,t){return e.DataTextureLoader.prototype.load.call(this,r,(function(r,n){switch(r.type){case e.UnsignedByteType:r.encoding=e.RGBEEncoding,r.minFilter=e.NearestFilter,r.magFilter=e.NearestFilter,r.generateMipmaps=!1,r.flipY=!1;break;case e.FloatType:case e.HalfFloatType:r.encoding=e.LinearEncoding,r.minFilter=e.LinearFilter,r.magFilter=e.LinearFilter,r.generateMipmaps=!1,r.flipY=!1}a&&a(r,n)}),n,t)}}),exports.EXRLoader=a;
