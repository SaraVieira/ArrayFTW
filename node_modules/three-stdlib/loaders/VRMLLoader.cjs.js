"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("three"),r=require("chevrotain"),a=function(){function a(r){e.Loader.call(this,r)}function t(e){this.lexer=new r.Lexer(e)}function n(e){r.Parser.call(this,e);var a=this,t=e.Version,n=e.LCurly,o=e.RCurly,s=e.LSquare,i=e.RSquare,l=e.Identifier,c=e.RouteIdentifier,u=e.StringLiteral,f=e.HexLiteral,p=e.NumberLiteral,d=e.TrueLiteral,h=e.FalseLiteral,v=e.NullLiteral,b=e.DEF,x=e.USE,m=e.ROUTE,g=e.TO,k=e.NodeName;a.RULE("vrml",(function(){a.SUBRULE(a.version),a.AT_LEAST_ONE((function(){a.SUBRULE(a.node)})),a.MANY((function(){a.SUBRULE(a.route)}))})),a.RULE("version",(function(){a.CONSUME(t)})),a.RULE("node",(function(){a.OPTION((function(){a.SUBRULE(a.def)})),a.CONSUME(k),a.CONSUME(n),a.MANY((function(){a.SUBRULE(a.field)})),a.CONSUME(o)})),a.RULE("field",(function(){a.CONSUME(l),a.OR2([{ALT:function(){a.SUBRULE(a.singleFieldValue)}},{ALT:function(){a.SUBRULE(a.multiFieldValue)}}])})),a.RULE("def",(function(){a.CONSUME(b),a.OR([{ALT:function(){a.CONSUME(l)}},{ALT:function(){a.CONSUME(k)}}])})),a.RULE("use",(function(){a.CONSUME(x),a.OR([{ALT:function(){a.CONSUME(l)}},{ALT:function(){a.CONSUME(k)}}])})),a.RULE("singleFieldValue",(function(){a.AT_LEAST_ONE((function(){a.OR([{ALT:function(){a.SUBRULE(a.node)}},{ALT:function(){a.SUBRULE(a.use)}},{ALT:function(){a.CONSUME(u)}},{ALT:function(){a.CONSUME(f)}},{ALT:function(){a.CONSUME(p)}},{ALT:function(){a.CONSUME(d)}},{ALT:function(){a.CONSUME(h)}},{ALT:function(){a.CONSUME(v)}}])}))})),a.RULE("multiFieldValue",(function(){a.CONSUME(s),a.MANY((function(){a.OR([{ALT:function(){a.SUBRULE(a.node)}},{ALT:function(){a.SUBRULE(a.use)}},{ALT:function(){a.CONSUME(u)}},{ALT:function(){a.CONSUME(f)}},{ALT:function(){a.CONSUME(p)}},{ALT:function(){a.CONSUME(v)}}])})),a.CONSUME(i)})),a.RULE("route",(function(){a.CONSUME(m),a.CONSUME(c),a.CONSUME(g),a.CONSUME2(c)})),this.performSelfAnalysis()}function o(r,a,t){this.a=r,this.b=a,this.c=t,this.normal=new e.Vector3}a.prototype=Object.assign(Object.create(e.Loader.prototype),{constructor:a,load:function(r,a,t,n){var o=this,s=""===o.path?e.LoaderUtils.extractUrlBase(r):o.path,i=new e.FileLoader(o.manager);i.setPath(o.path),i.setRequestHeader(o.requestHeader),i.setWithCredentials(o.withCredentials),i.load(r,(function(e){try{a(o.parse(e,s))}catch(e){n?n(e):console.error(e),o.manager.itemError(r)}}),t,n)},parse:function(a,i){var l={};function c(e){e.DEF&&(l[e.DEF]=e);for(var r=e.fields,a=0,t=r.length;a<t;a++){var n=r[a];if("node"===n.type)for(var o=n.values,s=0,i=o.length;s<i;s++)c(o[s])}}function u(r){return r.USE?(a=r.USE,(t=u(l[a])).isObject3D||t.isMaterial?t.clone():t):(void 0!==r.build||(r.build=function(r){var a,t=r.name;switch(t){case"Group":case"Transform":case"Collision":a=function(r){for(var a=new e.Group,t=r.fields,n=0,o=t.length;n<o;n++){var s=t[n],i=s.name,l=s.values;switch(i){case"bboxCenter":case"bboxSize":case"center":break;case"children":d(l,a);break;case"collide":break;case"rotation":var c=new e.Vector3(l[0],l[1],l[2]),u=l[3];a.quaternion.setFromAxisAngle(c,u);break;case"scale":a.scale.set(l[0],l[1],l[2]);break;case"scaleOrientation":break;case"translation":a.position.set(l[0],l[1],l[2]);break;case"proxy":break;default:console.warn("THREE.VRMLLoader: Unknown field:",i)}}return a}(r);break;case"Background":a=function(r){for(var a,t,n,o,s=new e.Group,i=r.fields,l=0,c=i.length;l<c;l++){var u=i[l],f=u.name,p=u.values;switch(f){case"groundAngle":a=p;break;case"groundColor":t=p;break;case"backUrl":case"bottomUrl":case"frontUrl":case"leftUrl":case"rightUrl":case"topUrl":break;case"skyAngle":n=p;break;case"skyColor":o=p;break;default:console.warn("THREE.VRMLLoader: Unknown field:",f)}}var d=1e4;if(o){var h=new e.SphereGeometry(d,32,16),v=new e.MeshBasicMaterial({fog:!1,side:e.BackSide,depthWrite:!1,depthTest:!1});o.length>3?(N(h,d,n,I(o),!0),v.vertexColors=!0):v.color.setRGB(o[0],o[1],o[2]);var b=new e.Mesh(h,v);s.add(b)}if(t&&t.length>0){var x=new e.SphereGeometry(d,32,16,0,2*Math.PI,.5*Math.PI,1.5*Math.PI),m=new e.MeshBasicMaterial({fog:!1,side:e.BackSide,vertexColors:!0,depthWrite:!1,depthTest:!1});N(x,d,a,I(t),!1);var g=new e.Mesh(x,m);s.add(g)}return s.renderOrder=-1/0,s}(r);break;case"Shape":a=function(r){for(var a,t,n=r.fields,o=new e.MeshBasicMaterial({color:0}),s=0,i=n.length;s<i;s++){var l=n[s],c=l.name,f=l.values;switch(c){case"appearance":null!==f[0]&&(o=u(f[0]));break;case"geometry":null!==f[0]&&(a=u(f[0]));break;default:console.warn("THREE.VRMLLoader: Unknown field:",c)}}if(a&&a.attributes.position){var p=a._type;if("points"===p){var d=new e.PointsMaterial({color:16777215});void 0!==a.attributes.color?d.vertexColors=!0:o.isMeshPhongMaterial&&d.color.copy(o.emissive),t=new e.Points(a,d)}else if("line"===p){var h=new e.LineBasicMaterial({color:16777215});void 0!==a.attributes.color?h.vertexColors=!0:o.isMeshPhongMaterial&&h.color.copy(o.emissive),t=new e.LineSegments(a,h)}else void 0!==a._solid&&(o.side=a._solid?e.FrontSide:e.DoubleSide),void 0!==a.attributes.color&&(o.vertexColors=!0),t=new e.Mesh(a,o)}else(t=new e.Object3D).visible=!1;return t}(r);break;case"Appearance":a=function(r){for(var a,t=new e.MeshPhongMaterial,n=r.fields,o=0,i=n.length;o<i;o++){var l=n[o],c=l.name,f=l.values;switch(c){case"material":if(null!==f[0]){var p=u(f[0]);p.diffuseColor&&t.color.copy(p.diffuseColor),p.emissiveColor&&t.emissive.copy(p.emissiveColor),p.shininess&&(t.shininess=p.shininess),p.specularColor&&t.specular.copy(p.specularColor),p.transparency&&(t.opacity=1-p.transparency),p.transparency>0&&(t.transparent=!0)}else t=new e.MeshBasicMaterial({color:0});break;case"texture":var d=f[0];null!==d&&("ImageTexture"!==d.name&&"PixelTexture"!==d.name||(t.map=u(d)));break;case"textureTransform":null!==f[0]&&(a=u(f[0]));break;default:console.warn("THREE.VRMLLoader: Unknown field:",c)}}if(t.map){if(t.map.__type){switch(t.map.__type){case s.INTENSITY_ALPHA:t.opacity=1;break;case s.RGB:t.color.set(16777215);break;case s.RGBA:t.color.set(16777215),t.opacity=1}delete t.map.__type}a&&(t.map.center.copy(a.center),t.map.rotation=a.rotation,t.map.repeat.copy(a.scale),t.map.offset.copy(a.translation))}return t}(r);break;case"Material":a=function(r){for(var a={},t=r.fields,n=0,o=t.length;n<o;n++){var s=t[n],i=s.name,l=s.values;switch(i){case"ambientIntensity":break;case"diffuseColor":a.diffuseColor=new e.Color(l[0],l[1],l[2]);break;case"emissiveColor":a.emissiveColor=new e.Color(l[0],l[1],l[2]);break;case"shininess":a.shininess=l[0];break;case"specularColor":a.emissiveColor=new e.Color(l[0],l[1],l[2]);break;case"transparency":a.transparency=l[0];break;default:console.warn("THREE.VRMLLoader: Unknown field:",i)}}return a}(r);break;case"ImageTexture":a=function(r){for(var a,t=e.RepeatWrapping,n=e.RepeatWrapping,o=r.fields,s=0,i=o.length;s<i;s++){var l=o[s],c=l.name,u=l.values;switch(c){case"url":var f=u[0];f&&(a=B.load(f));break;case"repeatS":!1===u[0]&&(t=e.ClampToEdgeWrapping);break;case"repeatT":!1===u[0]&&(n=e.ClampToEdgeWrapping);break;default:console.warn("THREE.VRMLLoader: Unknown field:",c)}}a&&(a.wrapS=t,a.wrapT=n);return a}(r);break;case"PixelTexture":a=function(r){for(var a,t=e.RepeatWrapping,n=e.RepeatWrapping,o=r.fields,s=0,i=o.length;s<i;s++){var l=o[s],c=l.name,u=l.values;switch(c){case"image":for(var d=u[0],h=u[1],v=u[2],b=2===v||4===v,x=p(v),m=new Uint8Array(d*h*(!0===b?4:3)),g={r:0,g:0,b:0,a:0},k=3,w=0,L=u.length;k<L;k++,w++){var y;if(f(u[k],x,g),!0===b)m[(y=4*w)+0]=g.r,m[y+1]=g.g,m[y+2]=g.b,m[y+3]=g.a;else m[(y=3*w)+0]=g.r,m[y+1]=g.g,m[y+2]=g.b}(a=new e.DataTexture(m,d,h,!0===b?e.RGBAFormat:e.RGBFormat)).__type=x;break;case"repeatS":!1===u[0]&&(t=e.ClampToEdgeWrapping);break;case"repeatT":!1===u[0]&&(n=e.ClampToEdgeWrapping);break;default:console.warn("THREE.VRMLLoader: Unknown field:",c)}}a&&(a.wrapS=t,a.wrapT=n);return a}(r);break;case"TextureTransform":a=function(r){for(var a={center:new e.Vector2,rotation:new e.Vector2,scale:new e.Vector2,translation:new e.Vector2},t=r.fields,n=0,o=t.length;n<o;n++){var s=t[n],i=s.name,l=s.values;switch(i){case"center":a.center.set(l[0],l[1]);break;case"rotation":a.rotation=l[0];break;case"scale":a.scale.set(l[0],l[1]);break;case"translation":a.translation.set(l[0],l[1]);break;default:console.warn("THREE.VRMLLoader: Unknown field:",i)}}return a}(r);break;case"IndexedFaceSet":a=function(r){for(var a,t,n,o,s,i,l,c,f=!0,p=!0,d=0,x=!0,m=!0,g=r.fields,k=0,w=g.length;k<w;k++){var L=g[k],y=L.name,E=L.values;switch(y){case"color":var A=E[0];null!==A&&(a=u(A));break;case"coord":var U=E[0];null!==U&&(t=u(U));break;case"normal":var C=E[0];null!==C&&(n=u(C));break;case"texCoord":var V=E[0];null!==V&&(o=u(V));break;case"ccw":f=E[0];break;case"colorIndex":s=E;break;case"colorPerVertex":x=E[0];break;case"convex":break;case"coordIndex":i=E;break;case"creaseAngle":d=E[0];break;case"normalIndex":l=E;break;case"normalPerVertex":m=E[0];break;case"solid":p=E[0];break;case"texCoordIndex":c=E;break;default:console.warn("THREE.VRMLLoader: Unknown field:",y)}}if(void 0===i)return console.warn("THREE.VRMLLoader: Missing coordIndex."),new e.BufferGeometry;var I,N,B,O,F=h(i,f);if(a){if(!0===x)if(s&&s.length>0)N=T(F,h(s,f),a,3);else N=R(F,new e.Float32BufferAttribute(a,3));else if(s&&s.length>0)N=S(F,v(b(a,s),i));else N=S(F,v(a,i))}if(n){if(!0===m)if(l&&l.length>0)B=T(F,h(l,f),n,3);else B=R(F,new e.Float32BufferAttribute(n,3));else if(l&&l.length>0)B=S(F,v(b(n,l),i));else B=S(F,v(n,i))}else B=M(F,t,d);if(o){if(c&&c.length>0)O=T(F,h(c,f),o,2);else O=R(F,new e.Float32BufferAttribute(o,2))}var P=new e.BufferGeometry;I=R(F,new e.Float32BufferAttribute(t,3)),P.setAttribute("position",I),P.setAttribute("normal",B),N&&P.setAttribute("color",N);O&&P.setAttribute("uv",O);return P._solid=p,P._type="mesh",P}(r);break;case"IndexedLineSet":a=function(r){for(var a,t,n,o,s,i=!0,l=r.fields,c=0,f=l.length;c<f;c++){var p=l[c],d=p.name,h=p.values;switch(d){case"color":var v=h[0];null!==v&&(a=u(v));break;case"coord":var g=h[0];null!==g&&(t=u(g));break;case"colorIndex":n=h;break;case"colorPerVertex":i=h[0];break;case"coordIndex":o=h;break;default:console.warn("THREE.VRMLLoader: Unknown field:",d)}}var k=x(o);if(a){if(!0===i)if(n.length>0)s=T(k,x(n),a,3);else s=R(k,new e.Float32BufferAttribute(a,3));else if(n.length>0)s=A(k,m(b(a,n),o));else s=A(k,m(a,o))}var w=new e.BufferGeometry,L=R(k,new e.Float32BufferAttribute(t,3));w.setAttribute("position",L),s&&w.setAttribute("color",s);return w._type="line",w}(r);break;case"PointSet":a=function(r){for(var a,t,n=r.fields,o=0,s=n.length;o<s;o++){var i=n[o],l=i.name,c=i.values;switch(l){case"color":var f=c[0];null!==f&&(a=u(f));break;case"coord":var p=c[0];null!==p&&(t=u(p));break;default:console.warn("THREE.VRMLLoader: Unknown field:",l)}}var d;(d=new e.BufferGeometry).setAttribute("position",new e.Float32BufferAttribute(t,3)),a&&d.setAttribute("color",new e.Float32BufferAttribute(a,3));return d._type="points",d}(r);break;case"Box":a=function(r){for(var a=new e.Vector3(2,2,2),t=r.fields,n=0,o=t.length;n<o;n++){var s=t[n],i=s.name,l=s.values;switch(i){case"size":a.x=l[0],a.y=l[1],a.z=l[2];break;default:console.warn("THREE.VRMLLoader: Unknown field:",i)}}return new e.BoxGeometry(a.x,a.y,a.z)}(r);break;case"Cone":a=function(r){for(var a=1,t=2,n=!1,o=r.fields,s=0,i=o.length;s<i;s++){var l=o[s],c=l.name,u=l.values;switch(c){case"bottom":n=!u[0];break;case"bottomRadius":a=u[0];break;case"height":t=u[0];break;case"side":break;default:console.warn("THREE.VRMLLoader: Unknown field:",c)}}return new e.ConeGeometry(a,t,16,1,n)}(r);break;case"Cylinder":a=function(r){for(var a=1,t=2,n=r.fields,o=0,s=n.length;o<s;o++){var i=n[o],l=i.name,c=i.values;switch(l){case"bottom":break;case"radius":a=c[0];break;case"height":t=c[0];break;case"side":case"top":break;default:console.warn("THREE.VRMLLoader: Unknown field:",l)}}return new e.CylinderGeometry(a,a,t,16,1)}(r);break;case"Sphere":a=function(r){for(var a=1,t=r.fields,n=0,o=t.length;n<o;n++){var s=t[n],i=s.name,l=s.values;switch(i){case"radius":a=l[0];break;default:console.warn("THREE.VRMLLoader: Unknown field:",i)}}return new e.SphereGeometry(a,16,16)}(r);break;case"ElevationGrid":a=function(r){for(var a,t,n,o,s=!0,i=!0,l=!0,c=!0,f=0,p=2,d=2,h=1,v=1,b=r.fields,x=0,m=b.length;x<m;x++){var g=b[x],k=g.name,w=g.values;switch(k){case"color":var L=w[0];null!==L&&(a=u(L));break;case"normal":var y=w[0];null!==y&&(t=u(y));break;case"texCoord":var E=w[0];null!==E&&(n=u(E));break;case"height":o=w;break;case"ccw":c=w[0];break;case"colorPerVertex":s=w[0];break;case"creaseAngle":f=w[0];break;case"normalPerVertex":i=w[0];break;case"solid":l=w[0];break;case"xDimension":p=w[0];break;case"xSpacing":h=w[0];break;case"zDimension":d=w[0];break;case"zSpacing":v=w[0];break;default:console.warn("THREE.VRMLLoader: Unknown field:",k)}}for(var T=[],S=[],A=[],U=[],C=0;C<d;C++)for(var V=0;V<p;V++){var I=h*C,N=o[ne=C*p+V],B=v*V;if(T.push(I,N,B),a&&!0===s){var O=a[3*ne+0],F=a[3*ne+1],P=a[3*ne+2];A.push(O,F,P)}if(t&&!0===i){var _=t[3*ne+0],H=t[3*ne+1],G=t[3*ne+2];S.push(_,H,G)}if(n){var z=n[2*ne+0],D=n[2*ne+1];U.push(z,D)}else U.push(C/(p-1),V/(d-1))}for(var W=[],j=0;j<p-1;j++)for(var Y=0;Y<d-1;Y++){var q=j+Y*p,X=(P=j+(Y+1)*p,j+1+(Y+1)*p),K=j+1+Y*p;!0===c?(W.push(q,X,P),W.push(X,q,K)):(W.push(q,P,X),W.push(X,K,q))}var Q,Z,J=R(W,new e.Float32BufferAttribute(T,3)),$=R(W,new e.Float32BufferAttribute(U,2));if(a)if(!1===s){for(var ee=0;ee<p-1;ee++)for(var re=0;re<d-1;re++){O=a[3*(ne=ee+re*(p-1))+0],F=a[3*ne+1],P=a[3*ne+2];A.push(O,F,P),A.push(O,F,P),A.push(O,F,P),A.push(O,F,P),A.push(O,F,P),A.push(O,F,P)}Q=new e.Float32BufferAttribute(A,3)}else Q=R(W,new e.Float32BufferAttribute(A,3));if(t)if(!1===i){for(var ae=0;ae<p-1;ae++)for(var te=0;te<d-1;te++){var ne;_=t[3*(ne=ae+te*(p-1))+0],H=t[3*ne+1],G=t[3*ne+2];S.push(_,H,G),S.push(_,H,G),S.push(_,H,G),S.push(_,H,G),S.push(_,H,G),S.push(_,H,G)}Z=new e.Float32BufferAttribute(S,3)}else Z=R(W,new e.Float32BufferAttribute(S,3));else Z=M(W,T,f);var oe=new e.BufferGeometry;oe.setAttribute("position",J),oe.setAttribute("normal",Z),oe.setAttribute("uv",$),Q&&oe.setAttribute("color",Q);return oe._solid=l,oe._type="mesh",oe}(r);break;case"Extrusion":a=function(r){for(var a,t,n=[1,1,1,-1,-1,-1,-1,1,1,1],o=[0,0,0,0,1,0],s=!0,i=!0,l=0,c=!0,u=!0,f=r.fields,p=0,d=f.length;p<d;p++){var h=f[p],v=h.name,b=h.values;switch(v){case"beginCap":s=b[0];break;case"ccw":i=b[0];break;case"convex":break;case"creaseAngle":l=b[0];break;case"crossSection":n=b;break;case"endCap":c=b[0];break;case"orientation":t=b;break;case"scale":a=b;break;case"solid":u=b[0];break;case"spine":o=b;break;default:console.warn("THREE.VRMLLoader: Unknown field:",v)}}for(var x=n[0]===n[n.length-2]&&n[1]===n[n.length-1],m=[],g=new e.Vector3,k=new e.Vector3,w=new e.Vector3,L=new e.Vector3,y=new e.Quaternion,E=0,T=0,S=0,A=o.length;E<A;E+=3,T+=2,S+=4){g.fromArray(o,E),k.x=a?a[T+0]:1,k.y=1,k.z=a?a[T+1]:1,w.x=t?t[S+0]:0,w.y=t?t[S+1]:0,w.z=t?t[S+2]:1;for(var U=t?t[S+3]:0,C=0,V=n.length;C<V;C+=2)L.x=n[C+0],L.y=0,L.z=n[C+1],L.multiply(k),y.setFromAxisAngle(w,U),L.applyQuaternion(y),L.add(g),m.push(L.x,L.y,L.z)}for(var I=[],N=o.length/3,B=n.length/2,O=0;O<N-1;O++)for(var F=0;F<B-1;F++){var P=F+O*B,_=F+1+O*B,H=F+(O+1)*B,G=F+1+(O+1)*B;F===B-2&&!0===x&&(_=O*B,G=(O+1)*B),!0===i?(I.push(P,_,H),I.push(H,_,G)):(I.push(P,H,_),I.push(H,G,_))}if(!0===s||!0===c){for(var z=[],D=0,W=n.length;D<W;D+=2)z.push(new e.Vector2(n[D],n[D+1]));for(var j=e.ShapeUtils.triangulateShape(z,[]),Y=[],q=0,X=j.length;q<X;q++){var K=j[q];Y.push(K[0],K[1],K[2])}if(!0===s)for(var Q=0,Z=Y.length;Q<Z;Q+=3)!0===i?I.push(Y[Q+0],Y[Q+1],Y[Q+2]):I.push(Y[Q+0],Y[Q+2],Y[Q+1]);if(!0===c)for(var J=B*(N-1),$=0,ee=Y.length;$<ee;$+=3)!0===i?I.push(J+Y[$+0],J+Y[$+2],J+Y[$+1]):I.push(J+Y[$+0],J+Y[$+1],J+Y[$+2])}var re=R(I,new e.Float32BufferAttribute(m,3)),ae=M(I,m,l),te=new e.BufferGeometry;return te.setAttribute("position",re),te.setAttribute("normal",ae),te._solid=u,te._type="mesh",te}(r);break;case"Color":case"Coordinate":case"Normal":case"TextureCoordinate":a=function(e){return e.fields[0].values}(r);break;case"WorldInfo":a=function(e){for(var r={},a=e.fields,t=0,n=a.length;t<n;t++){var o=a[t],s=o.name,i=o.values;switch(s){case"title":r.title=i[0];break;case"info":r.info=i;break;default:console.warn("THREE.VRMLLoader: Unknown field:",s)}}return r}(r);break;case"Anchor":case"Billboard":case"Inline":case"LOD":case"Switch":case"AudioClip":case"DirectionalLight":case"PointLight":case"Script":case"Sound":case"SpotLight":case"CylinderSensor":case"PlaneSensor":case"ProximitySensor":case"SphereSensor":case"TimeSensor":case"TouchSensor":case"VisibilitySensor":case"Text":case"FontStyle":case"MovieTexture":case"ColorInterpolator":case"CoordinateInterpolator":case"NormalInterpolator":case"OrientationInterpolator":case"PositionInterpolator":case"ScalarInterpolator":case"Fog":case"NavigationInfo":case"Viewpoint":break;default:console.warn("THREE.VRMLLoader: Unknown node:",t)}void 0!==a&&void 0!==r.DEF&&!0===a.hasOwnProperty("name")&&(a.name=r.DEF);return a}(r)),r.build);var a,t}function f(e,r,a){switch(r){case s.INTENSITY:var t=parseInt(e);a.r=t,a.g=t,a.b=t;break;case s.INTENSITY_ALPHA:t=parseInt("0x"+e.substring(2,4));a.r=t,a.g=t,a.b=t,a.a=parseInt("0x"+e.substring(4,6));break;case s.RGB:a.r=parseInt("0x"+e.substring(2,4)),a.g=parseInt("0x"+e.substring(4,6)),a.b=parseInt("0x"+e.substring(6,8));break;case s.RGBA:a.r=parseInt("0x"+e.substring(2,4)),a.g=parseInt("0x"+e.substring(4,6)),a.b=parseInt("0x"+e.substring(6,8)),a.a=parseInt("0x"+e.substring(8,10))}}function p(e){var r;switch(e){case 1:r=s.INTENSITY;break;case 2:r=s.INTENSITY_ALPHA;break;case 3:r=s.RGB;break;case 4:r=s.RGBA}return r}function d(r,a){for(var t=0,n=r.length;t<n;t++){var o=u(r[t]);o instanceof e.Object3D&&a.add(o)}}function h(e,r){for(var a=[],t=0,n=0,o=e.length;n<o;n++){var s=e[t],i=e[n+(r?1:2)],l=e[n+(r?2:1)];a.push(s,i,l),(-1===e[n+3]||n+3>=o)&&(t=(n+=3)+1)}return a}function v(e,r){for(var a=[],t=0,n=0,o=r.length;n<o;n++){var s=3*t,i=e[s],l=e[s+1],c=e[s+2];a.push(i,l,c),(-1===r[n+3]||n+3>=o)&&(n+=3,t++)}return a}function b(e,r){for(var a=[],t=0,n=r.length;t<n;t++){var o=3*r[t],s=e[o],i=e[o+1],l=e[o+2];a.push(s,i,l)}return a}function x(e){for(var r=[],a=0,t=e.length;a<t;a++){var n=e[a],o=e[a+1];r.push(n,o),(-1===e[a+2]||a+2>=t)&&(a+=2)}return r}function m(e,r){for(var a=[],t=0,n=0,o=r.length;n<o;n++){var s=3*t,i=e[s],l=e[s+1],c=e[s+2];a.push(i,l,c),(-1===r[n+2]||n+2>=o)&&(n+=2,t++)}return a}var g=new e.Vector3,k=new e.Vector3,w=new e.Vector3,L=new e.Vector2,y=new e.Vector2,E=new e.Vector2;function T(r,a,t,n){for(var o=[],s=0,i=r.length;s<i;s+=3){var l=a[s],c=a[s+1],u=a[s+2];2===n?(L.fromArray(t,l*n),y.fromArray(t,c*n),E.fromArray(t,u*n),o.push(L.x,L.y),o.push(y.x,y.y),o.push(E.x,E.y)):(g.fromArray(t,l*n),k.fromArray(t,c*n),w.fromArray(t,u*n),o.push(g.x,g.y,g.z),o.push(k.x,k.y,k.z),o.push(w.x,w.y,w.z))}return new e.Float32BufferAttribute(o,n)}function S(r,a){for(var t=[],n=0,o=0,s=r.length;n<s;n+=3,o++)g.fromArray(a,3*o),t.push(g.x,g.y,g.z),t.push(g.x,g.y,g.z),t.push(g.x,g.y,g.z);return new e.Float32BufferAttribute(t,3)}function A(r,a){for(var t=[],n=0,o=0,s=r.length;n<s;n+=2,o++)g.fromArray(a,3*o),t.push(g.x,g.y,g.z),t.push(g.x,g.y,g.z);return new e.Float32BufferAttribute(t,3)}function R(r,a){for(var t=a.array,n=a.itemSize,o=new t.constructor(r.length*n),s=0,i=0,l=0,c=r.length;l<c;l++){s=r[l]*n;for(var u=0;u<n;u++)o[i++]=t[s++]}return new e.Float32BufferAttribute(o,n)}var U=new e.Vector3,C=new e.Vector3;function M(r,a,t){for(var n=[],s={},i=0,l=r.length;i<l;i+=3){var c=r[i],u=r[i+1],f=r[i+2],p=new o(c,u,f);g.fromArray(a,3*c),k.fromArray(a,3*u),w.fromArray(a,3*f),C.subVectors(w,k),U.subVectors(g,k),C.cross(U),C.normalize(),p.normal.copy(C),void 0===s[c]&&(s[c]=[]),void 0===s[u]&&(s[u]=[]),void 0===s[f]&&(s[f]=[]),s[c].push(p.normal),s[u].push(p.normal),s[f].push(p.normal),n.push(p)}for(var d=[],h=0,v=n.length;h<v;h++){var b=V(s[(p=n[h]).a],p.normal,t),x=V(s[p.b],p.normal,t),m=V(s[p.c],p.normal,t);g.fromArray(a,3*p.a),k.fromArray(a,3*p.b),w.fromArray(a,3*p.c),d.push(b.x,b.y,b.z),d.push(x.x,x.y,x.z),d.push(m.x,m.y,m.z)}return new e.Float32BufferAttribute(d,3)}function V(r,a,t){var n=new e.Vector3;if(0===t)n.copy(a);else for(var o=0,s=r.length;o<s;o++)r[o].angleTo(a)<t&&n.add(r[o]);return n.normalize()}function I(r){for(var a=[],t=0,n=r.length;t<n;t+=3)a.push(new e.Color(r[t],r[t+1],r[t+2]));return a}function N(r,a,t,n,o){for(var s=[],i=!0===o?0:Math.PI,l=0,c=n.length;l<c;l++){var u=0===l?0:t[l-1];u=!0===o?u:i-u;var f=new e.Vector3;f.setFromSphericalCoords(a,u,0),s.push(f)}for(var p=r.index,d=r.attributes.position,h=new e.BufferAttribute(new Float32Array(3*r.attributes.position.count),3),v=new e.Vector3,b=new e.Color,x=0;x<p.count;x++){var m,g,k=p.getX(x);v.fromBufferAttribute(d,k);for(var w=1,L=1;L<s.length;L++){g=L;var y=s[m=L-1],E=s[g];if(!0===o){if(v.y<=y.y&&v.y>E.y){w=Math.abs(y.y-v.y)/Math.abs(y.y-E.y);break}}else if(v.y>=y.y&&v.y<E.y){w=Math.abs(y.y-v.y)/Math.abs(y.y-E.y);break}}var T=n[m],S=n[g];b.copy(T).lerp(S,w),h.setXYZ(k,b.r,b.g,b.b)}r.setAttribute("color",h)}var B=new e.TextureLoader(this.manager);if(B.setPath(this.resourcePath||i).setCrossOrigin(this.crossOrigin),-1===a.indexOf("#VRML V2.0"))throw Error("THREE.VRMLLexer: Version of VRML asset not supported.");return function(r){for(var a=r.nodes,t=new e.Scene,n=0,o=a.length;n<o;n++){c(l=a[n])}for(var s=0,i=a.length;s<i;s++){var l,f=u(l=a[s]);f instanceof e.Object3D&&t.add(f),"WorldInfo"===l.name&&(t.userData.worldInfo=f)}return t}(function(e){var a=function(){for(var e=r.createToken({name:"RouteIdentifier",pattern:/[^\x30-\x39\0-\x20\x22\x27\x23\x2b\x2c\x2d\x2e\x5b\x5d\x5c\x7b\x7d][^\0-\x20\x22\x27\x23\x2b\x2c\x2d\x2e\x5b\x5d\x5c\x7b\x7d]*[\.][^\x30-\x39\0-\x20\x22\x27\x23\x2b\x2c\x2d\x2e\x5b\x5d\x5c\x7b\x7d][^\0-\x20\x22\x27\x23\x2b\x2c\x2d\x2e\x5b\x5d\x5c\x7b\x7d]*/}),a=r.createToken({name:"Identifier",pattern:/[^\x30-\x39\0-\x20\x22\x27\x23\x2b\x2c\x2d\x2e\x5b\x5d\x5c\x7b\x7d][^\0-\x20\x22\x27\x23\x2b\x2c\x2d\x2e\x5b\x5d\x5c\x7b\x7d]*/,longer_alt:e}),t=["Anchor","Billboard","Collision","Group","Transform","Inline","LOD","Switch","AudioClip","DirectionalLight","PointLight","Script","Shape","Sound","SpotLight","WorldInfo","CylinderSensor","PlaneSensor","ProximitySensor","SphereSensor","TimeSensor","TouchSensor","VisibilitySensor","Box","Cone","Cylinder","ElevationGrid","Extrusion","IndexedFaceSet","IndexedLineSet","PointSet","Sphere","Color","Coordinate","Normal","TextureCoordinate","Appearance","FontStyle","ImageTexture","Material","MovieTexture","PixelTexture","TextureTransform","ColorInterpolator","CoordinateInterpolator","NormalInterpolator","OrientationInterpolator","PositionInterpolator","ScalarInterpolator","Background","Fog","NavigationInfo","Viewpoint","Text"],n=r.createToken({name:"Version",pattern:/#VRML.*/,longer_alt:a}),o=r.createToken({name:"NodeName",pattern:new RegExp(t.join("|")),longer_alt:a}),s=r.createToken({name:"DEF",pattern:/DEF/,longer_alt:a}),i=r.createToken({name:"USE",pattern:/USE/,longer_alt:a}),l=r.createToken({name:"ROUTE",pattern:/ROUTE/,longer_alt:a}),c=r.createToken({name:"TO",pattern:/TO/,longer_alt:a}),u=r.createToken({name:"StringLiteral",pattern:/"(:?[^\\"\n\r]+|\\(:?[bfnrtv"\\/]|u[0-9a-fA-F]{4}))*"/}),f=r.createToken({name:"HexLiteral",pattern:/0[xX][0-9a-fA-F]+/}),p=r.createToken({name:"NumberLiteral",pattern:/[-+]?[0-9]*\.?[0-9]+([eE][-+]?[0-9]+)?/}),d=r.createToken({name:"TrueLiteral",pattern:/TRUE/}),h=r.createToken({name:"FalseLiteral",pattern:/FALSE/}),v=r.createToken({name:"NullLiteral",pattern:/NULL/}),b=r.createToken({name:"LSquare",pattern:/\[/}),x=r.createToken({name:"RSquare",pattern:/]/}),m=r.createToken({name:"LCurly",pattern:/{/}),g=r.createToken({name:"RCurly",pattern:/}/}),k=r.createToken({name:"Comment",pattern:/#.*/,group:r.Lexer.SKIPPED}),w=[r.createToken({name:"WhiteSpace",pattern:/[ ,\s]/,group:r.Lexer.SKIPPED}),o,s,i,l,c,d,h,v,n,a,e,u,f,p,b,x,m,g,k],L={},y=0,E=w.length;y<E;y++){var T=w[y];L[T.name]=T}return{tokens:w,tokenVocabulary:L}}(),o=new t(a.tokens),s=new n(a.tokenVocabulary),i=function(e){function r(){e.call(this),this.validateVisitor()}function a(e,r){var a={type:null,values:[]};if(r.node){a.type="node";for(var t=0,n=r.node.length;t<n;t++){var o=r.node[t];a.values.push(e.visit(o))}}if(r.use){a.type="use";for(var s=0,i=r.use.length;s<i;s++){var l=r.use[s];a.values.push(e.visit(l))}}if(r.StringLiteral){a.type="string";for(var c=0,u=r.StringLiteral.length;c<u;c++){var f=r.StringLiteral[c];a.values.push(f.image.replace(/'|"/g,""))}}if(r.NumberLiteral){a.type="number";for(var p=0,d=r.NumberLiteral.length;p<d;p++){var h=r.NumberLiteral[p];a.values.push(parseFloat(h.image))}}if(r.HexLiteral){a.type="hex";for(var v=0,b=r.HexLiteral.length;v<b;v++){var x=r.HexLiteral[v];a.values.push(x.image)}}if(r.TrueLiteral){a.type="boolean";for(var m=0,g=r.TrueLiteral.length;m<g;m++){"TRUE"===r.TrueLiteral[m].image&&a.values.push(!0)}}if(r.FalseLiteral){a.type="boolean";for(var k=0,w=r.FalseLiteral.length;k<w;k++){"FALSE"===r.FalseLiteral[k].image&&a.values.push(!1)}}return r.NullLiteral&&(a.type="null",r.NullLiteral.forEach((function(){a.values.push(null)}))),a}return r.prototype=Object.assign(Object.create(e.prototype),{constructor:r,vrml:function(e){for(var r={version:this.visit(e.version),nodes:[],routes:[]},a=0,t=e.node.length;a<t;a++){var n=e.node[a];r.nodes.push(this.visit(n))}if(e.route)for(var o=0,s=e.route.length;o<s;o++){var i=e.route[o];r.routes.push(this.visit(i))}return r},version:function(e){return e.Version[0].image},node:function(e){var r={name:e.NodeName[0].image,fields:[]};if(e.field)for(var a=0,t=e.field.length;a<t;a++){var n=e.field[a];r.fields.push(this.visit(n))}return e.def&&(r.DEF=this.visit(e.def[0])),r},field:function(e){var r,a={name:e.Identifier[0].image,type:null,values:null};return e.singleFieldValue&&(r=this.visit(e.singleFieldValue[0])),e.multiFieldValue&&(r=this.visit(e.multiFieldValue[0])),a.type=r.type,a.values=r.values,a},def:function(e){return(e.Identifier||e.NodeName)[0].image},use:function(e){return{USE:(e.Identifier||e.NodeName)[0].image}},singleFieldValue:function(e){return a(this,e)},multiFieldValue:function(e){return a(this,e)},route:function(e){return{FROM:e.RouteIdentifier[0].image,TO:e.RouteIdentifier[1].image}}}),new r}(s.getBaseCstVisitorConstructor()),l=o.lex(e);s.input=l.tokens;var c=s.vrml();if(s.errors.length>0)throw console.error(s.errors),Error("THREE.VRMLLoader: Parsing errors detected.");return i.visit(c)}(a))}}),t.prototype={constructor:t,lex:function(e){var r=this.lexer.tokenize(e);if(r.errors.length>0)throw console.error(r.errors),Error("THREE.VRMLLexer: Lexing errors detected.");return r}},n.prototype=Object.create(r.Parser.prototype),n.prototype.constructor=n;var s={INTENSITY:1,INTENSITY_ALPHA:2,RGB:3,RGBA:4};return a}();exports.VRMLLoader=a;
