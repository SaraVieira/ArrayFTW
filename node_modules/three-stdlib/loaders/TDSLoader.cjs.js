"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("three"),t=function(t){e.Loader.call(this,t),this.debug=!1,this.group=null,this.position=0,this.materials=[],this.meshes=[]};t.prototype=Object.assign(Object.create(e.Loader.prototype),{constructor:t,load:function(t,s,i,r){var a=this,n=""===this.path?e.LoaderUtils.extractUrlBase(t):this.path,h=new e.FileLoader(this.manager);h.setPath(this.path),h.setResponseType("arraybuffer"),h.setRequestHeader(this.requestHeader),h.setWithCredentials(this.withCredentials),h.load(t,(function(e){try{s(a.parse(e,n))}catch(e){r?r(e):console.error(e),a.manager.itemError(t)}}),i,r)},parse:function(t,s){this.group=new e.Group,this.position=0,this.materials=[],this.meshes=[],this.readFile(t,s);for(var i=0;i<this.meshes.length;i++)this.group.add(this.meshes[i]);return this.group},readFile:function(e,t){var n=new DataView(e),h=this.readChunk(n);if(h.id===i||h.id===r||h.id===s)for(var o=this.nextChunk(n,h);0!==o;){if(o===a){var d=this.readDWord(n);this.debugMessage("3DS file version: "+d)}else o===l?(this.resetPosition(n),this.readMeshData(n,t)):this.debugMessage("Unknown main chunk: "+o.toString(16));o=this.nextChunk(n,h)}this.debugMessage("Parsed "+this.meshes.length+" meshes")},readMeshData:function(e,t){for(var s=this.readChunk(e),i=this.nextChunk(e,s);0!==i;){if(i===c){var r=+this.readDWord(e);this.debugMessage("Mesh Version: "+r)}else if(i===f){var a=this.readFloat(e);this.debugMessage("Master scale: "+a),this.group.scale.set(a,a,a)}else i===L?(this.debugMessage("Named Object"),this.resetPosition(e),this.readNamedObject(e)):i===p?(this.debugMessage("Material"),this.resetPosition(e),this.readMaterialEntry(e,t)):this.debugMessage("Unknown MDATA chunk: "+i.toString(16));i=this.nextChunk(e,s)}},readNamedObject:function(e){var t=this.readChunk(e),s=this.readString(e,64);t.cur=this.position;for(var i=this.nextChunk(e,t);0!==i;){if(i===T){this.resetPosition(e);var r=this.readMesh(e);r.name=s,this.meshes.push(r)}else this.debugMessage("Unknown named object chunk: "+i.toString(16));i=this.nextChunk(e,t)}this.endChunk(t)},readMaterialEntry:function(t,s){for(var i=this.readChunk(t),r=this.nextChunk(t,i),a=new e.MeshPhongMaterial;0!==r;){if(r===M)a.name=this.readString(t,64),this.debugMessage("   Name: "+a.name);else if(r===w)this.debugMessage("   Wireframe"),a.wireframe=!0;else if(r===F){var n=this.readByte(t);a.wireframeLinewidth=n,this.debugMessage("   Wireframe Thickness: "+n)}else if(r===y)a.side=e.DoubleSide,this.debugMessage("   DoubleSided");else if(r===x)this.debugMessage("   Additive Blending"),a.blending=e.AdditiveBlending;else if(r===m)this.debugMessage("   Diffuse Color"),a.color=this.readColor(t);else if(r===k)this.debugMessage("   Specular Color"),a.specular=this.readColor(t);else if(r===b)this.debugMessage("   Ambient color"),a.color=this.readColor(t);else if(r===v){var h=this.readPercentage(t);a.shininess=100*h,this.debugMessage("   Shininess : "+h)}else if(r===C){var o=this.readPercentage(t);a.opacity=1-o,this.debugMessage("  Transparency : "+o),a.transparent=a.opacity<1}else r===S?(this.debugMessage("   ColorMap"),this.resetPosition(t),a.map=this.readMap(t,s)):r===W?(this.debugMessage("   BumpMap"),this.resetPosition(t),a.bumpMap=this.readMap(t,s)):r===P?(this.debugMessage("   OpacityMap"),this.resetPosition(t),a.alphaMap=this.readMap(t,s)):r===U?(this.debugMessage("   SpecularMap"),this.resetPosition(t),a.specularMap=this.readMap(t,s)):this.debugMessage("   Unknown material chunk: "+r.toString(16));r=this.nextChunk(t,i)}this.endChunk(i),this.materials[a.name]=a},readMesh:function(t){var s=this.readChunk(t),i=this.nextChunk(t,s),r=new e.BufferGeometry,a=[],n=new e.MeshPhongMaterial,h=new e.Mesh(r,n);for(h.name="mesh";0!==i;){if(i===j){var o=this.readWord(t);this.debugMessage("   Vertex: "+o);for(var d=[],u=0;u<o;u++)d.push(this.readFloat(t)),d.push(this.readFloat(t)),d.push(this.readFloat(t));r.setAttribute("position",new e.Float32BufferAttribute(d,3))}else if(i===N)this.resetPosition(t),this.readFaceArray(t,h);else if(i===V){var g=this.readWord(t);this.debugMessage("   UV: "+g);a=[];for(var l=0;l<g;l++)a.push(this.readFloat(t)),a.push(this.readFloat(t));r.setAttribute("uv",new e.Float32BufferAttribute(a,2))}else if(i===q){this.debugMessage("   Tranformation Matrix (TODO)");for(var c=[],f=0;f<12;f++)c[f]=this.readFloat(t);var p=new e.Matrix4;p.elements[0]=c[0],p.elements[1]=c[6],p.elements[2]=c[3],p.elements[3]=c[9],p.elements[4]=c[2],p.elements[5]=c[8],p.elements[6]=c[5],p.elements[7]=c[11],p.elements[8]=c[1],p.elements[9]=c[7],p.elements[10]=c[4],p.elements[11]=c[10],p.elements[12]=0,p.elements[13]=0,p.elements[14]=0,p.elements[15]=1,p.transpose();var M=new e.Matrix4;M.copy(p).invert(),r.applyMatrix4(M),p.decompose(h.position,h.quaternion,h.scale)}else this.debugMessage("   Unknown mesh chunk: "+i.toString(16));i=this.nextChunk(t,s)}return this.endChunk(s),r.computeVertexNormals(),h},readFaceArray:function(e,t){var s=this.readChunk(e),i=this.readWord(e);this.debugMessage("   Faces: "+i);for(var r=[],a=0;a<i;++a)r.push(this.readWord(e),this.readWord(e),this.readWord(e)),this.readWord(e);t.geometry.setIndex(r);for(var n=0,h=0;this.position<s.end;){var o=this.readChunk(e);if(o.id===R){this.debugMessage("      Material Group"),this.resetPosition(e);var d=this.readMaterialGroup(e),u=3*d.index.length;t.geometry.addGroup(h,u,n),h+=u,n++;var g=this.materials[d.name];!1===Array.isArray(t.material)&&(t.material=[]),void 0!==g&&t.material.push(g)}else this.debugMessage("      Unknown face array chunk: "+o.toString(16));this.endChunk(o)}1===t.material.length&&(t.material=t.material[0]),this.endChunk(s)},readMap:function(t,s){var i=this.readChunk(t),r=this.nextChunk(t,i),a={},n=new e.TextureLoader(this.manager);for(n.setPath(this.resourcePath||s).setCrossOrigin(this.crossOrigin);0!==r;){if(r===B){var h=this.readString(t,128);a=n.load(h),this.debugMessage("      File: "+s+h)}else r===O?(a.offset.x=this.readFloat(t),this.debugMessage("      OffsetX: "+a.offset.x)):r===G?(a.offset.y=this.readFloat(t),this.debugMessage("      OffsetY: "+a.offset.y)):r===D?(a.repeat.x=this.readFloat(t),this.debugMessage("      RepeatX: "+a.repeat.x)):r===A?(a.repeat.y=this.readFloat(t),this.debugMessage("      RepeatY: "+a.repeat.y)):this.debugMessage("      Unknown map chunk: "+r.toString(16));r=this.nextChunk(t,i)}return this.endChunk(i),a},readMaterialGroup:function(e){this.readChunk(e);var t=this.readString(e,64),s=this.readWord(e);this.debugMessage("         Name: "+t),this.debugMessage("         Faces: "+s);for(var i=[],r=0;r<s;++r)i.push(this.readWord(e));return{name:t,index:i}},readColor:function(t){var s=this.readChunk(t),i=new e.Color;if(s.id===h||s.id===o){var r=this.readByte(t),a=this.readByte(t),u=this.readByte(t);i.setRGB(r/255,a/255,u/255),this.debugMessage("      Color: "+i.r+", "+i.g+", "+i.b)}else if(s.id===n||s.id===d){r=this.readFloat(t),a=this.readFloat(t),u=this.readFloat(t);i.setRGB(r,a,u),this.debugMessage("      Color: "+i.r+", "+i.g+", "+i.b)}else this.debugMessage("      Unknown color chunk: "+s.toString(16));return this.endChunk(s),i},readChunk:function(e){var t={};return t.cur=this.position,t.id=this.readWord(e),t.size=this.readDWord(e),t.end=t.cur+t.size,t.cur+=6,t},endChunk:function(e){this.position=e.end},nextChunk:function(e,t){if(t.cur>=t.end)return 0;this.position=t.cur;try{var s=this.readChunk(e);return t.cur+=s.size,s.id}catch(e){return this.debugMessage("Unable to read chunk at "+this.position),0}},resetPosition:function(){this.position-=6},readByte:function(e){var t=e.getUint8(this.position,!0);return this.position+=1,t},readFloat:function(e){try{var t=e.getFloat32(this.position,!0);return this.position+=4,t}catch(t){this.debugMessage(t+" "+this.position+" "+e.byteLength)}},readInt:function(e){var t=e.getInt32(this.position,!0);return this.position+=4,t},readShort:function(e){var t=e.getInt16(this.position,!0);return this.position+=2,t},readDWord:function(e){var t=e.getUint32(this.position,!0);return this.position+=4,t},readWord:function(e){var t=e.getUint16(this.position,!0);return this.position+=2,t},readString:function(e,t){for(var s="",i=0;i<t;i++){var r=this.readByte(e);if(!r)break;s+=String.fromCharCode(r)}return s},readPercentage:function(e){var t,s=this.readChunk(e);switch(s.id){case u:t=this.readShort(e)/100;break;case g:t=this.readFloat(e);break;default:this.debugMessage("      Unknown percentage chunk: "+s.toString(16))}return this.endChunk(s),t},debugMessage:function(e){this.debug&&console.log(e)}});var s=19789,i=15786,r=49725,a=2,n=16,h=17,o=18,d=19,u=48,g=49,l=15677,c=15678,f=256,p=45055,M=40960,b=40976,m=40992,k=41008,v=41024,C=41040,y=41089,x=41091,w=41093,F=41095,S=41472,P=41488,W=41520,U=41476,B=41728,D=41812,A=41814,O=41816,G=41818,L=16384,T=16640,j=16656,N=16672,R=16688,V=16704,q=16736;exports.TDSLoader=t;
