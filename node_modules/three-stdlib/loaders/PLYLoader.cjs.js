"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("three"),t=function(t){e.Loader.call(this,t),this.propertyNameMapping={}};t.prototype=Object.assign(Object.create(e.Loader.prototype),{constructor:t,load:function(t,r,n,s){var a=this,i=new e.FileLoader(this.manager);i.setPath(this.path),i.setResponseType("arraybuffer"),i.setRequestHeader(this.requestHeader),i.setWithCredentials(this.withCredentials),i.load(t,(function(e){try{r(a.parse(e))}catch(e){s?s(e):console.error(e),a.manager.itemError(t)}}),n,s)},setPropertyNameMapping:function(e){this.propertyNameMapping=e},parse:function(t){function r(e){var t="",r=0,n=/ply([\s\S]*)end_header\r?\n/.exec(e);null!==n&&(t=n[1],r=new Blob([n[0]]).size);var s,a,i,o,c,u,l={comments:[],elements:[],headerLength:r,objInfo:""},f=t.split("\n");for(var h=0;h<f.length;h++){var m=f[h];if(""!==(m=m.trim()))switch(a=(i=m.split(/\s+/)).shift(),m=i.join(" "),a){case"format":l.format=i[0],l.version=i[1];break;case"comment":l.comments.push(m);break;case"element":void 0!==s&&l.elements.push(s),(s={}).name=i[0],s.count=parseInt(i[1]),s.properties=[];break;case"property":s.properties.push((o=i,c=p.propertyNameMapping,u=void 0,"list"===(u={type:o[0]}).type?(u.name=o[3],u.countType=o[1],u.itemType=o[2]):u.name=o[1],u.name in c&&(u.name=c[u.name]),u));break;case"obj_info":l.objInfo=m;break;default:console.log("unhandled",a,i)}}return void 0!==s&&l.elements.push(s),l}function n(e,t){switch(t){case"char":case"uchar":case"short":case"ushort":case"int":case"uint":case"int8":case"uint8":case"int16":case"uint16":case"int32":case"uint32":return parseInt(e);case"float":case"double":case"float32":case"float64":return parseFloat(e)}}function s(e,t){for(var r=t.split(/\s+/),s={},a=0;a<e.length;a++)if("list"===e[a].type){for(var i=[],o=n(r.shift(),e[a].countType),c=0;c<o;c++)i.push(n(r.shift(),e[a].itemType));s[e[a].name]=i}else s[e[a].name]=n(r.shift(),e[a].type);return s}function a(e,t){var r,n={indices:[],vertices:[],normals:[],uvs:[],faceVertexUvs:[],colors:[]},a="";null!==(r=/end_header\s([\s\S]*)$/.exec(e))&&(a=r[1]);for(var c=a.split("\n"),u=0,l=0,p=0;p<c.length;p++){var f=c[p];if(""!==(f=f.trim())){l>=t.elements[u].count&&(u++,l=0);var h=s(t.elements[u].properties,f);o(n,t.elements[u].name,h),l++}}return i(n)}function i(t){var r=new e.BufferGeometry;return t.indices.length>0&&r.setIndex(t.indices),r.setAttribute("position",new e.Float32BufferAttribute(t.vertices,3)),t.normals.length>0&&r.setAttribute("normal",new e.Float32BufferAttribute(t.normals,3)),t.uvs.length>0&&r.setAttribute("uv",new e.Float32BufferAttribute(t.uvs,2)),t.colors.length>0&&r.setAttribute("color",new e.Float32BufferAttribute(t.colors,3)),t.faceVertexUvs.length>0&&(r=r.toNonIndexed()).setAttribute("uv",new e.Float32BufferAttribute(t.faceVertexUvs,2)),r.computeBoundingSphere(),r}function o(e,t,r){if("vertex"===t)e.vertices.push(r.x,r.y,r.z),"nx"in r&&"ny"in r&&"nz"in r&&e.normals.push(r.nx,r.ny,r.nz),"s"in r&&"t"in r&&e.uvs.push(r.s,r.t),"red"in r&&"green"in r&&"blue"in r&&e.colors.push(r.red/255,r.green/255,r.blue/255);else if("face"===t){var n=r.vertex_indices||r.vertex_index,s=r.texcoord;3===n.length?(e.indices.push(n[0],n[1],n[2]),s&&6===s.length&&(e.faceVertexUvs.push(s[0],s[1]),e.faceVertexUvs.push(s[2],s[3]),e.faceVertexUvs.push(s[4],s[5]))):4===n.length&&(e.indices.push(n[0],n[1],n[3]),e.indices.push(n[1],n[2],n[3]))}}function c(e,t,r,n){switch(r){case"int8":case"char":return[e.getInt8(t),1];case"uint8":case"uchar":return[e.getUint8(t),1];case"int16":case"short":return[e.getInt16(t,n),2];case"uint16":case"ushort":return[e.getUint16(t,n),2];case"int32":case"int":return[e.getInt32(t,n),4];case"uint32":case"uint":return[e.getUint32(t,n),4];case"float32":case"float":return[e.getFloat32(t,n),4];case"float64":case"double":return[e.getFloat64(t,n),8]}}function u(e,t,r,n){for(var s,a={},i=0,o=0;o<r.length;o++)if("list"===r[o].type){var u=[],l=(s=c(e,t+i,r[o].countType,n))[0];i+=s[1];for(var p=0;p<l;p++)s=c(e,t+i,r[o].itemType,n),u.push(s[0]),i+=s[1];a[r[o].name]=u}else s=c(e,t+i,r[o].type,n),a[r[o].name]=s[0],i+=s[1];return[a,i]}var l,p=this;if(t instanceof ArrayBuffer){var f=e.LoaderUtils.decodeText(new Uint8Array(t)),h=r(f);l="ascii"===h.format?a(f,h):function(e,t){for(var r,n={indices:[],vertices:[],normals:[],uvs:[],faceVertexUvs:[],colors:[]},s="binary_little_endian"===t.format,a=new DataView(e,t.headerLength),c=0,l=0;l<t.elements.length;l++)for(var p=0;p<t.elements[l].count;p++){c+=(r=u(a,c,t.elements[l].properties,s))[1];var f=r[0];o(n,t.elements[l].name,f)}return i(n)}(t,h)}else l=a(t,r(t));return l}}),exports.PLYLoader=t;
