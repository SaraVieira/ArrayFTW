"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("three"),t=function(t){e.Loader.call(this,t),this.littleEndian=!0};t.prototype=Object.assign(Object.create(e.Loader.prototype),{constructor:t,load:function(t,i,r,s){var n=this,o=new e.FileLoader(n.manager);o.setPath(n.path),o.setResponseType("arraybuffer"),o.setRequestHeader(n.requestHeader),o.setWithCredentials(n.withCredentials),o.load(t,(function(e){try{i(n.parse(e,t))}catch(e){s?s(e):console.error(e),n.manager.itemError(t)}}),r,s)},parse:function(t,i){var r=e.LoaderUtils.decodeText(new Uint8Array(t)),s=function(e){var t={},i=e.search(/[\r\n]DATA\s(\S*)\s/i),r=/[\r\n]DATA\s(\S*)\s/i.exec(e.substr(i-1));if(t.data=r[1],t.headerLen=r[0].length+i,t.str=e.substr(0,t.headerLen),t.str=t.str.replace(/\#.*/gi,""),t.version=/VERSION (.*)/i.exec(t.str),t.fields=/FIELDS (.*)/i.exec(t.str),t.size=/SIZE (.*)/i.exec(t.str),t.type=/TYPE (.*)/i.exec(t.str),t.count=/COUNT (.*)/i.exec(t.str),t.width=/WIDTH (.*)/i.exec(t.str),t.height=/HEIGHT (.*)/i.exec(t.str),t.viewpoint=/VIEWPOINT (.*)/i.exec(t.str),t.points=/POINTS (.*)/i.exec(t.str),null!==t.version&&(t.version=parseFloat(t.version[1])),null!==t.fields&&(t.fields=t.fields[1].split(" ")),null!==t.type&&(t.type=t.type[1].split(" ")),null!==t.width&&(t.width=parseInt(t.width[1])),null!==t.height&&(t.height=parseInt(t.height[1])),null!==t.viewpoint&&(t.viewpoint=t.viewpoint[1]),null!==t.points&&(t.points=parseInt(t.points[1],10)),null===t.points&&(t.points=t.width*t.height),null!==t.size&&(t.size=t.size[1].split(" ").map((function(e){return parseInt(e,10)}))),null!==t.count)t.count=t.count[1].split(" ").map((function(e){return parseInt(e,10)}));else{t.count=[];for(var s=0,n=t.fields.length;s<n;s++)t.count.push(1)}t.offset={};for(var o=0,a=0,l=t.fields.length;a<l;a++)"ascii"===t.data?t.offset[t.fields[a]]=a:(t.offset[t.fields[a]]=o,o+=t.size[a]*t.count[a]);return t.rowSize=o,t}(r),n=[],o=[],a=[];if("ascii"===s.data)for(var l=s.offset,p=r.substr(s.headerLen).split("\n"),h=0,u=p.length;h<u;h++)if(""!==p[h]){var d=p[h].split(" ");if(void 0!==l.x&&(n.push(parseFloat(d[l.x])),n.push(parseFloat(d[l.y])),n.push(parseFloat(d[l.z]))),void 0!==l.rgb){var f=parseFloat(d[l.rgb]),c=f>>16&255,g=f>>8&255,w=f>>0&255;a.push(c/255,g/255,w/255)}void 0!==l.normal_x&&(o.push(parseFloat(d[l.normal_x])),o.push(parseFloat(d[l.normal_y])),o.push(parseFloat(d[l.normal_z])))}if("binary_compressed"===s.data)for(var v=new Uint32Array(t.slice(s.headerLen,s.headerLen+8)),b=v[0],m=v[1],x=function(e,t){var i,r,s,n=e.length,o=new Uint8Array(t),a=0,l=0;do{if((i=e[a++])<32){if(l+ ++i>t)throw new Error("Output buffer is not large enough");if(a+i>n)throw new Error("Invalid compressed data");do{o[l++]=e[a++]}while(--i)}else{if(r=i>>5,s=l-((31&i)<<8)-1,a>=n)throw new Error("Invalid compressed data");if(7===r&&(r+=e[a++],a>=n))throw new Error("Invalid compressed data");if(s-=e[a++],l+r+2>t)throw new Error("Output buffer is not large enough");if(s<0)throw new Error("Invalid compressed data");if(s>=l)throw new Error("Invalid compressed data");do{o[l++]=o[s++]}while(2+--r)}}while(a<n);return o}(new Uint8Array(t,s.headerLen+8,b),m),E=new DataView(x.buffer),F=(l=s.offset,0);F<s.points;F++)void 0!==l.x&&(n.push(E.getFloat32(s.points*l.x+s.size[0]*F,this.littleEndian)),n.push(E.getFloat32(s.points*l.y+s.size[1]*F,this.littleEndian)),n.push(E.getFloat32(s.points*l.z+s.size[2]*F,this.littleEndian))),void 0!==l.rgb&&(a.push(E.getUint8(s.points*l.rgb+s.size[3]*F+0)/255),a.push(E.getUint8(s.points*l.rgb+s.size[3]*F+1)/255),a.push(E.getUint8(s.points*l.rgb+s.size[3]*F+2)/255)),void 0!==l.normal_x&&(o.push(E.getFloat32(s.points*l.normal_x+s.size[4]*F,this.littleEndian)),o.push(E.getFloat32(s.points*l.normal_y+s.size[5]*F,this.littleEndian)),o.push(E.getFloat32(s.points*l.normal_z+s.size[6]*F,this.littleEndian)));if("binary"===s.data){E=new DataView(t,s.headerLen),l=s.offset;for(var y=0,z=0;y<s.points;y++,z+=s.rowSize)void 0!==l.x&&(n.push(E.getFloat32(z+l.x,this.littleEndian)),n.push(E.getFloat32(z+l.y,this.littleEndian)),n.push(E.getFloat32(z+l.z,this.littleEndian))),void 0!==l.rgb&&(a.push(E.getUint8(z+l.rgb+2)/255),a.push(E.getUint8(z+l.rgb+1)/255),a.push(E.getUint8(z+l.rgb+0)/255)),void 0!==l.normal_x&&(o.push(E.getFloat32(z+l.normal_x,this.littleEndian)),o.push(E.getFloat32(z+l.normal_y,this.littleEndian)),o.push(E.getFloat32(z+l.normal_z,this.littleEndian)))}var I=new e.BufferGeometry;n.length>0&&I.setAttribute("position",new e.Float32BufferAttribute(n,3)),o.length>0&&I.setAttribute("normal",new e.Float32BufferAttribute(o,3)),a.length>0&&I.setAttribute("color",new e.Float32BufferAttribute(a,3)),I.computeBoundingSphere();var _=new e.PointsMaterial({size:.005});a.length>0?_.vertexColors=!0:_.color.setHex(16777215*Math.random());var A=new e.Points(I,_),L=i.split("").reverse().join("");return L=(L=/([^\/]*)/.exec(L))[1].split("").reverse().join(""),A.name=L,A}}),exports.PCDLoader=t;
