"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("three"),t=require("fflate"),a=function(t){e.Loader.call(this,t)};a.prototype=Object.assign(Object.create(e.Loader.prototype),{constructor:a,load:function(t,a,n,r){var o=this,i=new e.FileLoader(o.manager);i.setPath(o.path),i.setResponseType("arraybuffer"),i.setRequestHeader(o.requestHeader),i.setWithCredentials(o.withCredentials),i.load(t,(function(e){try{a(o.parse(e))}catch(e){r?r(e):console.error(e),o.manager.itemError(t)}}),n,r)},parse:function(a){function n(t){for(var a="AMF Material",n=t.attributes.id.textContent,o={r:1,g:1,b:1,a:1},i=null,l=0;l<t.childNodes.length;l++){var s=t.childNodes[l];"metadata"===s.nodeName&&void 0!==s.attributes.type?"name"===s.attributes.type.value&&(a=s.textContent):"color"===s.nodeName&&(o=r(s))}return i=new e.MeshPhongMaterial({flatShading:!0,color:new e.Color(o.r,o.g,o.b),name:a}),1!==o.a&&(i.transparent=!0,i.opacity=o.a),{id:n,material:i}}function r(e){for(var t={r:1,g:1,b:1,a:1},a=0;a<e.childNodes.length;a++){var n=e.childNodes[a];"r"===n.nodeName?t.r=n.textContent:"g"===n.nodeName?t.g=n.textContent:"b"===n.nodeName?t.b=n.textContent:"a"===n.nodeName&&(t.a=n.textContent)}return t}function o(e){var t={name:"",triangles:[],materialid:null},a=e.firstElementChild;for(void 0!==e.attributes.materialid&&(t.materialId=e.attributes.materialid.nodeValue);a;){if("metadata"===a.nodeName)void 0!==a.attributes.type&&"name"===a.attributes.type.value&&(t.name=a.textContent);else if("triangle"===a.nodeName){var n=a.getElementsByTagName("v1")[0].textContent,r=a.getElementsByTagName("v2")[0].textContent,o=a.getElementsByTagName("v3")[0].textContent;t.triangles.push(n,r,o)}a=a.nextElementSibling}return t}function i(e){for(var t=[],a=[],n=e.firstElementChild;n;){if("vertex"===n.nodeName)for(var r=n.firstElementChild;r;){if("coordinates"===r.nodeName){var o=r.getElementsByTagName("x")[0].textContent,i=r.getElementsByTagName("y")[0].textContent,l=r.getElementsByTagName("z")[0].textContent;t.push(o,i,l)}else if("normal"===r.nodeName){var s=r.getElementsByTagName("nx")[0].textContent,m=r.getElementsByTagName("ny")[0].textContent,d=r.getElementsByTagName("nz")[0].textContent;a.push(s,m,d)}r=r.nextElementSibling}n=n.nextElementSibling}return{vertices:t,normals:a}}function l(e){for(var t=e.attributes.id.textContent,a={name:"amfobject",meshes:[]},n=null,l=e.firstElementChild;l;){if("metadata"===l.nodeName)void 0!==l.attributes.type&&"name"===l.attributes.type.value&&(a.name=l.textContent);else if("color"===l.nodeName)n=r(l);else if("mesh"===l.nodeName){for(var s=l.firstElementChild,m={vertices:[],normals:[],volumes:[],color:n};s;){if("vertices"===s.nodeName){var d=i(s);m.normals=m.normals.concat(d.normals),m.vertices=m.vertices.concat(d.vertices)}else"volume"===s.nodeName&&m.volumes.push(o(s));s=s.nextElementSibling}a.meshes.push(m)}l=l.nextElementSibling}return{id:t,obj:a}}var s,m,d=function(a){var n=new DataView(a);if("PK"===String.fromCharCode(n.getUint8(0),n.getUint8(1))){var r=null;console.log("THREE.AMFLoader: Loading Zip");try{r=t.unzipSync(new Uint8Array(a))}catch(e){if(e instanceof ReferenceError)return console.log("THREE.AMFLoader: fflate missing and file is compressed."),null}for(var o in r)if(".amf"===o.toLowerCase().substr(-4))break;console.log("THREE.AMFLoader: Trying to load file asset: null"),n=new DataView(r.null.buffer)}var i=e.LoaderUtils.decodeText(n),l=(new DOMParser).parseFromString(i,"application/xml");return"amf"!==l.documentElement.nodeName.toLowerCase()?(console.log("THREE.AMFLoader: Error loading AMF - no AMF document found."),null):l}(a),u="",c="",f=function(e){var t=1,a="millimeter";void 0!==e.documentElement.attributes.unit&&(a=e.documentElement.attributes.unit.value.toLowerCase());var n={millimeter:1,inch:25.4,feet:304.8,meter:1e3,micron:.001};return void 0!==n[a]&&(t=n[a]),console.log("THREE.AMFLoader: Unit scale: "+t),t}(d),v={},g={},h=d.documentElement.childNodes;for(s=0;s<h.length;s++){var b=h[s];if("metadata"===b.nodeName)void 0!==b.attributes.type&&("name"===b.attributes.type.value?u=b.textContent:"author"===b.attributes.type.value&&(c=b.textContent));else if("material"===b.nodeName){var p=n(b);v[p.id]=p.material}else if("object"===b.nodeName){var E=l(b);g[E.id]=E.obj}}var C=new e.Group,N=new e.MeshPhongMaterial({color:11184895,flatShading:!0});for(var x in C.name=u,C.userData.author=c,C.userData.loader="AMF",g){var y=g[x],w=y.meshes,M=new e.Group;for(M.name=y.name||"",s=0;s<w.length;s++){var T=N,A=w[s],F=new e.Float32BufferAttribute(A.vertices,3),L=null;if(A.normals.length&&(L=new e.Float32BufferAttribute(A.normals,3)),A.color){var B=A.color;(T=N.clone()).color=new e.Color(B.r,B.g,B.b),1!==B.a&&(T.transparent=!0,T.opacity=B.a)}var S=A.volumes;for(m=0;m<S.length;m++){var R=S[m],j=new e.BufferGeometry,H=T;j.setIndex(R.triangles),j.setAttribute("position",F.clone()),L&&j.setAttribute("normal",L.clone()),void 0!==v[R.materialId]&&(H=v[R.materialId]),j.scale(f,f,f),M.add(new e.Mesh(j,H.clone()))}}C.add(M)}return C}}),exports.AMFLoader=a;
