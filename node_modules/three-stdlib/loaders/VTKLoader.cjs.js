"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var t=require("three"),e=require("fflate"),r=function(e){t.Loader.call(this,e)};r.prototype=Object.assign(Object.create(t.Loader.prototype),{constructor:r,load:function(e,r,a,n){var s=this,i=new t.FileLoader(s.manager);i.setPath(s.path),i.setResponseType("arraybuffer"),i.setRequestHeader(s.requestHeader),i.setWithCredentials(s.withCredentials),i.load(e,(function(t){try{r(s.parse(t))}catch(t){n?n(t):console.error(t),s.manager.itemError(e)}}),a,n)},parse:function(r){function a(t,e){var r=t.length,a=new Int32Array(r+e.length);return a.set(t),a.set(e,r),a}var n=t.LoaderUtils.decodeText(new Uint8Array(r,0,250)).split("\n");return-1!==n[0].indexOf("xml")?function(r){function n(t){var e,r,a,n,s,i,o="undefined"!=typeof Uint8Array?Uint8Array:Array,l=[],f=[],u="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",p=u.length;for(e=0;e<p;e++)l[e]=u[e];for(e=0;e<p;++e)f[u.charCodeAt(e)]=e;if(f["-".charCodeAt(0)]=62,f["_".charCodeAt(0)]=63,(p=t.length)%4>0)throw new Error("Invalid string. Length must be a multiple of 4");i=new o(3*p/4-(s="="===t[p-2]?2:"="===t[p-1]?1:0)),a=s>0?p-4:p;var A=0;for(e=0,r=0;e<a;e+=4,r+=3)n=f[t.charCodeAt(e)]<<18|f[t.charCodeAt(e+1)]<<12|f[t.charCodeAt(e+2)]<<6|f[t.charCodeAt(e+3)],i[A++]=(16711680&n)>>16,i[A++]=(65280&n)>>8,i[A++]=255&n;return 2===s?(n=f[t.charCodeAt(e)]<<2|f[t.charCodeAt(e+1)]>>4,i[A++]=255&n):1===s&&(n=f[t.charCodeAt(e)]<<10|f[t.charCodeAt(e+1)]<<4|f[t.charCodeAt(e+2)]>>2,i[A++]=n>>8&255,i[A++]=255&n),i}function s(t,r){var s,i,l,f,u=0;if("UInt64"===o.attributes.header_type?u=8:"UInt32"===o.attributes.header_type&&(u=4),"binary"===t.attributes.format&&r){var p,A,d,h,c,y;if("Float32"===t.attributes.type)var b=new Float32Array;else"Int64"===t.attributes.type&&(b=new Int32Array);A=(p=n(t["#text"]))[0];for(var v=1;v<u-1;v++)A|=p[v]<<v*u;h=(A+3)*u,y=h+=h%3>0?3-h%3:0,(c=[]).push(y),d=3*u;for(var x=0;x<A;x++){for(var w=p[x*u+d],I=1;I<u-1;I++)w|=p[x*u+d+I]<<8*I;y+=w,c.push(y)}for(var g=0;g<c.length-1;g++)m=e.unzlibSync(p.slice(c[g],c[g+1])).buffer,"Float32"===t.attributes.type?(i=m=new Float32Array(m),l=void 0,f=void 0,l=(s=b).length,(f=new Float32Array(l+i.length)).set(s),f.set(i,l),b=f):"Int64"===t.attributes.type&&(b=a(b,m=new Int32Array(m)));delete t["#text"],"Int64"===t.attributes.type&&"binary"===t.attributes.format&&(b=b.filter((function(t,e){if(e%2!=1)return!0})))}else{if("binary"!==t.attributes.format||r)if(t["#text"])var m=t["#text"].split(/\s+/).filter((function(t){if(""!==t)return t}));else m=new Int32Array(0).buffer;else m=(m=n(t["#text"])).slice(u).buffer;delete t["#text"],"Float32"===t.attributes.type?b=new Float32Array(m):"Int32"===t.attributes.type?b=new Int32Array(m):"Int64"===t.attributes.type&&(b=new Int32Array(m),"binary"===t.attributes.format&&(b=b.filter((function(t,e){if(e%2!=1)return!0}))))}return b}var i=null;if(window.DOMParser)try{i=(new DOMParser).parseFromString(r,"text/xml")}catch(t){i=null}else{if(!window.ActiveXObject)throw new Error("Cannot parse xml string!");try{if((i=new ActiveXObject("Microsoft.XMLDOM")).async=!1,!i.loadXML())throw new Error(i.parseError.reason+i.parseError.srcText)}catch(t){i=null}}var o=function t(e){var r={};if(1===e.nodeType){if(e.attributes&&e.attributes.length>0){r.attributes={};for(var a=0;a<e.attributes.length;a++){var n=e.attributes.item(a);r.attributes[n.nodeName]=n.nodeValue.trim()}}}else 3===e.nodeType&&(r=e.nodeValue.trim());if(e.hasChildNodes())for(var s=0;s<e.childNodes.length;s++){var i=e.childNodes.item(s),o=i.nodeName;if(void 0===r[o])""!==(f=t(i))&&(r[o]=f);else{if(void 0===r[o].push){var l=r[o];r[o]=[l]}var f;""!==(f=t(i))&&r[o].push(f)}}return r}(i.documentElement),l=[],f=[],u=[];if(o.PolyData){for(var p=o.PolyData.Piece,A=o.attributes.hasOwnProperty("compressor"),d=["PointData","Points","Strips","Polys"],h=0,c=d.length;h<c;){var y=p[d[h]];if(y&&y.DataArray){if("[object Array]"===Object.prototype.toString.call(y.DataArray))var b=y.DataArray;else b=[y.DataArray];for(var v=0,x=b.length;v<x;)"#text"in b[v]&&b[v]["#text"].length>0&&(b[v].text=s(b[v],A)),v++;switch(d[h]){case"PointData":var w=parseInt(p.attributes.NumberOfPoints),I=y.attributes.Normals;if(w>0)for(var g=0,m=b.length;g<m;g++)if(I===b[g].attributes.Name){var O=b[g].attributes.NumberOfComponents;(f=new Float32Array(w*O)).set(b[g].text,0)}break;case"Points":(w=parseInt(p.attributes.NumberOfPoints))>0&&(O=y.DataArray.attributes.NumberOfComponents,(l=new Float32Array(w*O)).set(y.DataArray.text,0));break;case"Strips":var D=parseInt(p.attributes.NumberOfStrips);if(D>0){var F=new Int32Array(y.DataArray[0].text.length),T=new Int32Array(y.DataArray[1].text.length);F.set(y.DataArray[0].text,0),T.set(y.DataArray[1].text,0);var P=D+F.length;u=new Uint32Array(3*P-9*D);for(var S=0,C=0,N=D;C<N;C++){for(var L=[],E=0,U=T[C],B=0;E<U-B;E++)L.push(F[E]),C>0&&(B=T[C-1]);for(var _=0,R=T[C],j=0;_<R-j-2;_++)_%2?(u[S++]=L[_],u[S++]=L[_+2],u[S++]=L[_+1]):(u[S++]=L[_],u[S++]=L[_+1],u[S++]=L[_+2]),C>0&&(j=T[C-1])}}break;case"Polys":var M=parseInt(p.attributes.NumberOfPolys);if(M>0){F=new Int32Array(y.DataArray[0].text.length),T=new Int32Array(y.DataArray[1].text.length),F.set(y.DataArray[0].text,0),T.set(y.DataArray[1].text,0),P=M+F.length,u=new Uint32Array(3*P-9*M),S=0;for(var G=0,k=0,q=M,V=0;k<q;){for(var X=[],Y=0,H=T[k];Y<H-V;)X.push(F[G++]),Y++;for(var z=1;z<H-V-1;)u[S++]=X[0],u[S++]=X[z],u[S++]=X[z+1],z++;V=T[++k-1]}}}}h++}var K=new t.BufferGeometry;return K.setIndex(new t.BufferAttribute(u,1)),K.setAttribute("position",new t.BufferAttribute(l,3)),f.length===l.length&&K.setAttribute("normal",new t.BufferAttribute(f,3)),K}throw new Error("Unsupported DATASET type")}(t.LoaderUtils.decodeText(r)):n[2].includes("ASCII")?function(e){var r,a=[],n=[],s=[],i=[],o=/^[^\d.\s-]+/,l=/(\-?\d+\.?[\d\-\+e]*)\s+(\-?\d+\.?[\d\-\+e]*)\s+(\-?\d+\.?[\d\-\+e]*)/g,f=/^(\d+)\s+([\s\d]*)/,u=/^POINTS /,p=/^POLYGONS /,A=/^TRIANGLE_STRIPS /,d=/^POINT_DATA[ ]+(\d+)/,h=/^CELL_DATA[ ]+(\d+)/,c=/^COLOR_SCALARS[ ]+(\w+)[ ]+3/,y=/^NORMALS[ ]+(\w+)[ ]+(\w+)/,b=!1,v=!1,x=!1,w=!1,I=!1,g=!1,m=!1,O=e.split("\n");for(var D in O){var F=O[D].trim();if(0===F.indexOf("DATASET")){var T=F.split(" ")[1];if("POLYDATA"!==T)throw new Error("Unsupported DATASET type: "+T)}else if(b)for(;null!==(r=l.exec(F))&&null===o.exec(F);){var P=parseFloat(r[1]),S=parseFloat(r[2]),C=parseFloat(r[3]);n.push(P,S,C)}else if(v){if(null!==(r=f.exec(F))){var N=parseInt(r[1]),L=r[2].split(/\s+/);if(N>=3)for(var E=parseInt(L[0]),U=1,B=0;B<N-2;++B)_=parseInt(L[U]),R=parseInt(L[U+1]),a.push(E,_,R),U++}}else if(x){if(null!==(r=f.exec(F))&&(N=parseInt(r[1]),L=r[2].split(/\s+/),N>=3))for(var _,R,j=0;j<N-2;j++)j%2==1?(E=parseInt(L[j]),_=parseInt(L[j+2]),R=parseInt(L[j+1]),a.push(E,_,R)):(E=parseInt(L[j]),_=parseInt(L[j+1]),R=parseInt(L[j+2]),a.push(E,_,R))}else if(w||I)if(g)for(;null!==(r=l.exec(F))&&null===o.exec(F);){var M=parseFloat(r[1]),G=parseFloat(r[2]),k=parseFloat(r[3]);s.push(M,G,k)}else if(m)for(;null!==(r=l.exec(F))&&null===o.exec(F);){var q=parseFloat(r[1]),V=parseFloat(r[2]),X=parseFloat(r[3]);i.push(q,V,X)}null!==p.exec(F)?(v=!0,b=!1,x=!1):null!==u.exec(F)?(v=!1,b=!0,x=!1):null!==A.exec(F)?(v=!1,b=!1,x=!0):null!==d.exec(F)?(w=!0,b=!1,v=!1,x=!1):null!==h.exec(F)?(I=!0,b=!1,v=!1,x=!1):null!==c.exec(F)?(g=!0,m=!1,b=!1,v=!1,x=!1):null!==y.exec(F)&&(m=!0,g=!1,b=!1,v=!1,x=!1)}var Y=new t.BufferGeometry;if(Y.setIndex(a),Y.setAttribute("position",new t.Float32BufferAttribute(n,3)),i.length===n.length&&Y.setAttribute("normal",new t.Float32BufferAttribute(i,3)),s.length!==a.length)s.length===n.length&&Y.setAttribute("color",new t.Float32BufferAttribute(s,3));else{var H=(Y=Y.toNonIndexed()).attributes.position.count/3;if(s.length===3*H){for(var z=[],K=0;K<H;K++)M=s[3*K+0],G=s[3*K+1],k=s[3*K+2],z.push(M,G,k),z.push(M,G,k),z.push(M,G,k);Y.setAttribute("color",new t.Float32BufferAttribute(z,3))}}return Y}(t.LoaderUtils.decodeText(r)):function(e){var r,a,n,s,i,o,l,f=new Uint8Array(e),u=new DataView(e),p=[],A=[],d=[],h=0;function c(t,e){for(var r=e,a=t[r],n=[];10!==a;)n.push(String.fromCharCode(a)),a=t[++r];return{start:e,end:r,next:r+1,parsedString:n.join("")}}for(;;){if(0===(l=(o=c(f,h)).parsedString).indexOf("DATASET")){var y=l.split(" ")[1];if("POLYDATA"!==y)throw new Error("Unsupported DATASET type: "+y)}else if(0===l.indexOf("POINTS")){for(r=4*(s=parseInt(l.split(" ")[1],10))*3,p=new Float32Array(3*s),a=o.next,n=0;n<s;n++)p[3*n]=u.getFloat32(a,!1),p[3*n+1]=u.getFloat32(a+4,!1),p[3*n+2]=u.getFloat32(a+8,!1),a+=12;o.next=o.next+r+1}else if(0===l.indexOf("TRIANGLE_STRIPS")){var b=parseInt(l.split(" ")[1],10);r=4*(g=parseInt(l.split(" ")[2],10)),d=new Uint32Array(3*g-9*b);var v=0;for(a=o.next,n=0;n<b;n++){var x=u.getInt32(a,!1),w=[];for(a+=4,i=0;i<x;i++)w.push(u.getInt32(a,!1)),a+=4;for(var I=0;I<x-2;I++)I%2?(d[v++]=w[I],d[v++]=w[I+2],d[v++]=w[I+1]):(d[v++]=w[I],d[v++]=w[I+1],d[v++]=w[I+2])}o.next=o.next+r+1}else if(0===l.indexOf("POLYGONS")){var g;for(b=parseInt(l.split(" ")[1],10),r=4*(g=parseInt(l.split(" ")[2],10)),d=new Uint32Array(3*g-9*b),v=0,a=o.next,n=0;n<b;n++){for(x=u.getInt32(a,!1),w=[],a+=4,i=0;i<x;i++)w.push(u.getInt32(a,!1)),a+=4;for(var m=1;m<x-1;m++)d[v++]=w[0],d[v++]=w[m],d[v++]=w[m+1]}o.next=o.next+r+1}else if(0===l.indexOf("POINT_DATA")){for(s=parseInt(l.split(" ")[1],10),o=c(f,o.next),r=4*s*3,A=new Float32Array(3*s),a=o.next,n=0;n<s;n++)A[3*n]=u.getFloat32(a,!1),A[3*n+1]=u.getFloat32(a+4,!1),A[3*n+2]=u.getFloat32(a+8,!1),a+=12;o.next=o.next+r}if((h=o.next)>=f.byteLength)break}var O=new t.BufferGeometry;return O.setIndex(new t.BufferAttribute(d,1)),O.setAttribute("position",new t.BufferAttribute(p,3)),A.length===p.length&&O.setAttribute("normal",new t.BufferAttribute(A,3)),O}(r)}}),exports.VTKLoader=r;
