"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("three"),t=function(t){e.Loader.call(this,t),this.animateBonePositions=!0,this.animateBoneRotations=!0};t.prototype=Object.assign(Object.create(e.Loader.prototype),{constructor:t,load:function(t,r,o,a){var n=this,i=new e.FileLoader(n.manager);i.setPath(n.path),i.setRequestHeader(n.requestHeader),i.setWithCredentials(n.withCredentials),i.load(t,(function(e){try{r(n.parse(e))}catch(e){a?a(e):console.error(e),n.manager.itemError(t)}}),o,a)},parse:function(t){function r(t,o,a){if("ENDSITE"!==a.type){var n={time:o,position:new e.Vector3,rotation:new e.Quaternion};a.frames.push(n);for(var i=new e.Quaternion,s=new e.Vector3(1,0,0),p=new e.Vector3(0,1,0),l=new e.Vector3(0,0,1),c=0;c<a.channels.length;c++)switch(a.channels[c]){case"Xposition":n.position.x=parseFloat(t.shift().trim());break;case"Yposition":n.position.y=parseFloat(t.shift().trim());break;case"Zposition":n.position.z=parseFloat(t.shift().trim());break;case"Xrotation":i.setFromAxisAngle(s,parseFloat(t.shift().trim())*Math.PI/180),n.rotation.multiply(i);break;case"Yrotation":i.setFromAxisAngle(p,parseFloat(t.shift().trim())*Math.PI/180),n.rotation.multiply(i);break;case"Zrotation":i.setFromAxisAngle(l,parseFloat(t.shift().trim())*Math.PI/180),n.rotation.multiply(i);break;default:console.warn("THREE.BVHLoader: Invalid channel type.")}for(var f=0;f<a.children.length;f++)r(t,o,a.children[f])}}function o(t,r,n){var i={name:"",type:"",frames:[]};n.push(i);var s=r.split(/[\s]+/);"END"===s[0].toUpperCase()&&"SITE"===s[1].toUpperCase()?(i.type="ENDSITE",i.name="ENDSITE"):(i.name=s[1],i.type=s[0].toUpperCase()),"{"!==a(t)&&console.error("THREE.BVHLoader: Expected opening { after type & name"),"OFFSET"!==(s=a(t).split(/[\s]+/))[0]&&console.error("THREE.BVHLoader: Expected OFFSET but got: "+s[0]),4!==s.length&&console.error("THREE.BVHLoader: Invalid number of values for OFFSET.");var p=new e.Vector3(parseFloat(s[1]),parseFloat(s[2]),parseFloat(s[3]));if((isNaN(p.x)||isNaN(p.y)||isNaN(p.z))&&console.error("THREE.BVHLoader: Invalid values of OFFSET."),i.offset=p,"ENDSITE"!==i.type){"CHANNELS"!==(s=a(t).split(/[\s]+/))[0]&&console.error("THREE.BVHLoader: Expected CHANNELS definition.");var l=parseInt(s[1]);i.channels=s.splice(2,l),i.children=[]}for(;;){var c=a(t);if("}"===c)return i;i.children.push(o(t,c,n))}}function a(e){for(var t;0===(t=e.shift().trim()).length;);return t}var n=this,i=function(e){"HIERARCHY"!==a(e)&&console.error("THREE.BVHLoader: HIERARCHY expected.");var t=[],n=o(e,a(e),t);"MOTION"!==a(e)&&console.error("THREE.BVHLoader: MOTION expected.");var i=a(e).split(/[\s]+/),s=parseInt(i[1]);isNaN(s)&&console.error("THREE.BVHLoader: Failed to read number of frames."),i=a(e).split(/[\s]+/);var p=parseFloat(i[2]);isNaN(p)&&console.error("THREE.BVHLoader: Failed to read frame time.");for(var l=0;l<s;l++)r(i=a(e).split(/[\s]+/),l*p,n);return t}(t.split(/[\r\n]+/g)),s=[];!function t(r,o){var a=new e.Bone;if(o.push(a),a.position.add(r.offset),a.name=r.name,"ENDSITE"!==r.type)for(var n=0;n<r.children.length;n++)a.add(t(r.children[n],o));return a}(i[0],s);var p=function(t){for(var r=[],o=0;o<t.length;o++){var a=t[o];if("ENDSITE"!==a.type){for(var i=[],s=[],p=[],l=0;l<a.frames.length;l++){var c=a.frames[l];i.push(c.time),s.push(c.position.x+a.offset.x),s.push(c.position.y+a.offset.y),s.push(c.position.z+a.offset.z),p.push(c.rotation.x),p.push(c.rotation.y),p.push(c.rotation.z),p.push(c.rotation.w)}n.animateBonePositions&&r.push(new e.VectorKeyframeTrack(".bones["+a.name+"].position",i,s)),n.animateBoneRotations&&r.push(new e.QuaternionKeyframeTrack(".bones["+a.name+"].quaternion",i,p))}}return new e.AnimationClip("animation",-1,r)}(i);return{skeleton:new e.Skeleton(s),clip:p}}}),exports.BVHLoader=t;
