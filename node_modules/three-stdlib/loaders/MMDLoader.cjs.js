"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("three"),t=require("./TGALoader.cjs.js"),r=require("mmd-parser"),a=function(){function a(t){e.Loader.call(this,t),this.loader=new e.FileLoader(this.manager),this.parser=null,this.meshBuilder=new i(this.manager),this.animationBuilder=new A}a.prototype=Object.assign(Object.create(e.Loader.prototype),{constructor:a,setAnimationPath:function(e){return this.animationPath=e,this},load:function(t,r,a,n){var i,o=this.meshBuilder.setCrossOrigin(this.crossOrigin);i=""!==this.resourcePath?this.resourcePath:""!==this.path?this.path:e.LoaderUtils.extractUrlBase(t);var s=this._extractExtension(t).toLowerCase();"pmd"===s||"pmx"===s?this["pmd"===s?"loadPMD":"loadPMX"](t,(function(e){r(o.build(e,i,a,n))}),a,n):n&&n(new Error("THREE.MMDLoader: Unknown model file extension ."+s+"."))},loadAnimation:function(e,t,r,a,n){var i=this.animationBuilder;this.loadVMD(e,(function(e){r(t.isCamera?i.buildCameraAnimation(e):i.build(e,t))}),a,n)},loadWithAnimation:function(e,t,r,a,n){var i=this;this.load(e,(function(e){i.loadAnimation(t,e,(function(t){r({mesh:e,animation:t})}),a,n)}),a,n)},loadPMD:function(e,t,r,a){var n=this._getParser();this.loader.setMimeType(void 0).setPath(this.path).setResponseType("arraybuffer").setRequestHeader(this.requestHeader).setWithCredentials(this.withCredentials).load(e,(function(e){t(n.parsePmd(e,!0))}),r,a)},loadPMX:function(e,t,r,a){var n=this._getParser();this.loader.setMimeType(void 0).setPath(this.path).setResponseType("arraybuffer").setRequestHeader(this.requestHeader).setWithCredentials(this.withCredentials).load(e,(function(e){t(n.parsePmx(e,!0))}),r,a)},loadVMD:function(e,t,r,a){var n=Array.isArray(e)?e:[e],i=[],o=n.length,s=this._getParser();this.loader.setMimeType(void 0).setPath(this.animationPath).setResponseType("arraybuffer").setRequestHeader(this.requestHeader).setWithCredentials(this.withCredentials);for(var A=0,u=n.length;A<u;A++)this.loader.load(n[A],(function(e){i.push(s.parseVmd(e,!0)),i.length===o&&t(s.mergeVmds(i))}),r,a)},loadVPD:function(e,t,r,a,n){var i=this._getParser();this.loader.setMimeType(t?void 0:"text/plain; charset=shift_jis").setPath(this.animationPath).setResponseType("text").setRequestHeader(this.requestHeader).setWithCredentials(this.withCredentials).load(e,(function(e){r(i.parseVpd(e,!0))}),a,n)},_extractExtension:function(e){var t=e.lastIndexOf(".");return t<0?"":e.slice(t+1)},_getParser:function(){return null===this.parser&&(this.parser=new r.Parser),this.parser}});var n=["data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAL0lEQVRYR+3QQREAAAzCsOFfNJPBJ1XQS9r2hsUAAQIECBAgQIAAAQIECBAgsBZ4MUx/ofm2I/kAAAAASUVORK5CYII=","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAN0lEQVRYR+3WQREAMBACsZ5/bWiiMvgEBTt5cW37hjsBBAgQIECAwFwgyfYPCCBAgAABAgTWAh8aBHZBl14e8wAAAABJRU5ErkJggg==","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAOUlEQVRYR+3WMREAMAwDsYY/yoDI7MLwIiP40+RJklfcCCBAgAABAgTqArfb/QMCCBAgQIAAgbbAB3z/e0F3js2cAAAAAElFTkSuQmCC","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAN0lEQVRYR+3WQREAMBACsZ5/B5ilMvgEBTt5cW37hjsBBAgQIECAwFwgyfYPCCBAgAABAgTWAh81dWyx0gFwKAAAAABJRU5ErkJggg==","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAOklEQVRYR+3WoREAMAwDsWb/UQtCy9wxTOQJ/oQ8SXKKGwEECBAgQIBAXeDt7f4BAQQIECBAgEBb4AOz8Hzx7WLY4wAAAABJRU5ErkJggg==","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABPUlEQVRYR+1XwW7CMAy1+f9fZOMysSEOEweEOPRNdm3HbdOyIhAcklPrOs/PLy9RygBALxzcCDQFmgJNgaZAU6Ap0BR4PwX8gsRMVLssMRH5HcpzJEaWL7EVg9F1IHRlyqQohgVr4FGUlUcMJSjcUlDw0zvjeun70cLWmneoyf7NgBTQSniBTQQSuJAZsOnnaczjIMb5hCiuHKxokCrJfVnrctyZL0PkJAJe1HMil4nxeyi3Ypfn1kX51jpPvo/JeCNC4PhVdHdJw2XjBR8brF8PEIhNVn12AgP7uHsTBguBn53MUZCqv7Lp07Pn5k1Ro+uWmUNn7D+M57rtk7aG0Vo73xyF/fbFf0bPJjDXngnGocDTdFhygZjwUQrMNrDcmZlQT50VJ/g/UwNyHpu778+yW+/ksOz/BFo54P4AsUXMfRq7XWsAAAAASUVORK5CYII=","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAACMElEQVRYR+2Xv4pTQRTGf2dubhLdICiii2KnYKHVolhauKWPoGAnNr6BD6CvIVaihYuI2i1ia0BY0MZGRHQXjZj/mSPnnskfNWiWZUlzJ5k7M2cm833nO5Mziej2DWWJRUoCpQKlAntSQCqgw39/iUWAGmh37jrRnVsKlgpiqmkoGVABA7E57fvY+pJDdgKqF6HzFCSADkDq+F6AHABtQ+UMVE5D7zXod7fFNhTEckTbj5XQgHzNN+5tQvc5NG7C6BNkp6D3EmpXHDR+dQAjFLchW3VS9rlw3JBh+B7ys5Cf9z0GW1C/7P32AyBAOAz1q4jGliIH3YPuBnSfQX4OGreTIgEYQb/pBDtPnEQ4CivXYPAWBk13oHrB54yA9QuSn2H4AcKRpEILDt0BUzj+RLR1V5EqjD66NPRBVpLcQwjHoHYJOhsQv6U4mnzmrIXJCFr4LDwm/xBUoboG9XX4cc9VKdYoSA2yk5NQLJaKDUjTBoveG3Z2TElTxwjNK4M3LEZgUdDdruvcXzKBpStgp2NPiWi3ks9ZXxIoFVi+AvHLdc9TqtjL3/aYjpPlrzOcEnK62Szhimdd7xX232zFDTgtxezOu3WNMRLjiKgjtOhHVMd1loynVHvOgjuIIJMaELEqhJAV/RCSLbWTcfPFakFgFlALTRRvx+ok6Hlp/Q+v3fmx90bMyUzaEAhmM3KvHlXTL5DxnbGf/1M8RNNACLL5MNtPxP/mypJAqcDSFfgFhpYqWUzhTEAAAAAASUVORK5CYII=","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAL0lEQVRYR+3QQREAAAzCsOFfNJPBJ1XQS9r2hsUAAQIECBAgQIAAAQIECBAgsBZ4MUx/ofm2I/kAAAAASUVORK5CYII=","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAL0lEQVRYR+3QQREAAAzCsOFfNJPBJ1XQS9r2hsUAAQIECBAgQIAAAQIECBAgsBZ4MUx/ofm2I/kAAAAASUVORK5CYII=","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAL0lEQVRYR+3QQREAAAzCsOFfNJPBJ1XQS9r2hsUAAQIECBAgQIAAAQIECBAgsBZ4MUx/ofm2I/kAAAAASUVORK5CYII=","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAL0lEQVRYR+3QQREAAAzCsOFfNJPBJ1XQS9r2hsUAAQIECBAgQIAAAQIECBAgsBZ4MUx/ofm2I/kAAAAASUVORK5CYII="];function i(e){this.geometryBuilder=new o,this.materialBuilder=new s(e)}function o(){}function s(t){this.manager=t,this.textureLoader=new e.TextureLoader(this.manager),this.tgaLoader=null}function A(){}function u(t,r,a,n,i){e.Interpolant.call(this,t,r,a,n),this.interpolationParams=i}return i.prototype={constructor:i,crossOrigin:"anonymous",setCrossOrigin:function(e){return this.crossOrigin=e,this},build:function(t,r,a,n){var i=this.geometryBuilder.build(t),o=this.materialBuilder.setCrossOrigin(this.crossOrigin).setResourcePath(r).build(t,i,a,n),s=new e.SkinnedMesh(i,o),A=new e.Skeleton(function(t){var r,a,n,i,o=t.geometry,s=[];if(o&&void 0!==o.bones){for(n=0,i=o.bones.length;n<i;n++)a=o.bones[n],r=new e.Bone,s.push(r),r.name=a.name,r.position.fromArray(a.pos),r.quaternion.fromArray(a.rotq),void 0!==a.scl&&r.scale.fromArray(a.scl);for(n=0,i=o.bones.length;n<i;n++)-1!==(a=o.bones[n]).parent&&null!==a.parent&&void 0!==s[a.parent]?s[a.parent].add(s[n]):t.add(s[n])}return t.updateMatrixWorld(!0),s}(s));return s.bind(A),s}},o.prototype={constructor:o,build:function(t){for(var r=[],a=[],n=[],i=[],o=[],s=[],A=[],u=[],l=[],h=[],d=[],p=[],f=[],m=[],g=0,c={},v=0;v<t.metadata.vertexCount;v++){for(var C=t.vertices[v],x=0,b=C.position.length;x<b;x++)r.push(C.position[x]);for(var y=0,B=C.normal.length;y<B;y++)n.push(C.normal[y]);for(var I=0,w=C.uv.length;I<w;I++)a.push(C.uv[I]);for(var R=0;R<4;R++)A.push(C.skinIndices.length-1>=R?C.skinIndices[R]:0);for(var T=0;T<4;T++)u.push(C.skinWeights.length-1>=T?C.skinWeights[T]:0)}for(var E=0;E<t.metadata.faceCount;E++)for(var k=t.faces[E],Q=0,M=k.indices.length;Q<M;Q++)i.push(k.indices[Q]);for(var U=0;U<t.metadata.materialCount;U++){var P=t.materials[U];o.push({offset:3*g,count:3*P.faceCount}),g+=P.faceCount}for(var O=0;O<t.metadata.rigidBodyCount;O++){var V=t.rigidBodies[O],L=c[V.boneIndex];L=void 0===L?V.type:Math.max(V.type,L),c[V.boneIndex]=L}for(var N=0;N<t.metadata.boneCount;N++){-1!==(de={parent:(Z=t.bones[N]).parentIndex,name:Z.name,pos:Z.position.slice(0,3),rotq:[0,0,0,1],scl:[1,1,1],rigidBodyType:void 0!==c[N]?c[N]:-1}).parent&&(de.pos[0]-=t.bones[de.parent].position[0],de.pos[1]-=t.bones[de.parent].position[1],de.pos[2]-=t.bones[de.parent].position[2]),s.push(de)}if("pmd"===t.metadata.format)for(var S=0;S<t.metadata.ikCount;S++){for(var F={target:(K=t.iks[S]).target,effector:K.effector,iteration:K.iteration,maxAngle:4*K.maxAngle,links:[]},D=0,Y=K.links.length;D<Y;D++){(J={}).index=K.links[D].index,J.enabled=!0,t.bones[J.index].name.indexOf("ひざ")>=0&&(J.limitation=new e.Vector3(1,0,0)),F.links.push(J)}d.push(F)}else for(var z=0;z<t.metadata.boneCount;z++){var K;if(void 0!==(K=t.bones[z].ik)){F={target:z,effector:K.effector,iteration:K.iteration,maxAngle:K.maxAngle,links:[]};for(var W=0,H=K.links.length;W<H;W++){var J;if((J={}).index=K.links[W].index,J.enabled=!0,1===K.links[W].angleLimitation){var _=K.links[W].lowerLimitationAngle,j=K.links[W].upperLimitationAngle,G=-j[0],q=-j[1];j[0]=-_[0],j[1]=-_[1],_[0]=G,_[1]=q,J.rotationMin=(new e.Vector3).fromArray(_),J.rotationMax=(new e.Vector3).fromArray(j)}F.links.push(J)}d.push(F)}}if("pmx"===t.metadata.format){for(var X=0;X<t.metadata.boneCount;X++){var Z,$=(Z=t.bones[X]).grant;if(void 0!==$){F={index:X,parentIndex:$.parentIndex,ratio:$.ratio,isLocal:$.isLocal,affectRotation:$.affectRotation,affectPosition:$.affectPosition,transformationClass:Z.transformationClass};p.push(F)}}p.sort((function(e,t){return e.transformationClass-t.transformationClass}))}function ee(e,r,a){for(var n=0;n<r.elementCount;n++){var i,o=r.elements[n];i="pmd"===t.metadata.format?t.morphs[0].elements[o.index].index:o.index,e.array[3*i+0]+=o.position[0]*a,e.array[3*i+1]+=o.position[1]*a,e.array[3*i+2]+=o.position[2]*a}}for(var te=0;te<t.metadata.morphCount;te++){var re=t.morphs[te],ae={name:re.name},ne=new e.Float32BufferAttribute(3*t.metadata.vertexCount,3);ne.name=re.name;for(var ie=0;ie<3*t.metadata.vertexCount;ie++)ne.array[ie]=r[ie];if("pmd"===t.metadata.format)0!==te&&ee(ne,re,1);else if(0===re.type)for(var oe=0;oe<re.elementCount;oe++){var se=t.morphs[re.elements[oe].index],Ae=re.elements[oe].ratio;1===se.type&&ee(ne,se,Ae)}else 1===re.type?ee(ne,re,1):2===re.type||3===re.type||4===re.type||5===re.type||6===re.type||7===re.type||re.type;l.push(ae),h.push(ne)}for(var ue=0;ue<t.metadata.rigidBodyCount;ue++){var le=t.rigidBodies[ue];ae={};for(var he in le)ae[he]=le[he];if("pmx"===t.metadata.format&&-1!==ae.boneIndex){var de=t.bones[ae.boneIndex];ae.position[0]-=de.position[0],ae.position[1]-=de.position[1],ae.position[2]-=de.position[2]}f.push(ae)}for(var pe=0;pe<t.metadata.constraintCount;pe++){var fe=t.constraints[pe];ae={};for(var me in fe)ae[me]=fe[me];var ge=f[ae.rigidBodyIndex1],ce=f[ae.rigidBodyIndex2];0!==ge.type&&2===ce.type&&-1!==ge.boneIndex&&-1!==ce.boneIndex&&t.bones[ce.boneIndex].parentIndex===ge.boneIndex&&(ce.type=1),m.push(ae)}var ve=new e.BufferGeometry;ve.setAttribute("position",new e.Float32BufferAttribute(r,3)),ve.setAttribute("normal",new e.Float32BufferAttribute(n,3)),ve.setAttribute("uv",new e.Float32BufferAttribute(a,2)),ve.setAttribute("skinIndex",new e.Uint16BufferAttribute(A,4)),ve.setAttribute("skinWeight",new e.Float32BufferAttribute(u,4)),ve.setIndex(i);for(var Ce=0,xe=o.length;Ce<xe;Ce++)ve.addGroup(o[Ce].offset,o[Ce].count,Ce);return ve.bones=s,ve.morphTargets=l,ve.morphAttributes.position=h,ve.morphTargetsRelative=!1,ve.userData.MMD={bones:s,iks:d,grants:p,rigidBodies:f,constraints:m,format:t.metadata.format},ve.computeBoundingSphere(),ve}},s.prototype={constructor:s,crossOrigin:"anonymous",resourcePath:void 0,setCrossOrigin:function(e){return this.crossOrigin=e,this},setResourcePath:function(e){return this.resourcePath=e,this},build:function(t,r){var a=[],n={};this.textureLoader.setCrossOrigin(this.crossOrigin);for(var i=0;i<t.metadata.materialCount;i++){var o=t.materials[i],s={userData:{}};if(void 0!==o.name&&(s.name=o.name),s.color=(new e.Color).fromArray(o.diffuse),s.opacity=o.diffuse[3],s.emissive=(new e.Color).fromArray(o.ambient),s.transparent=1!==s.opacity,s.skinning=r.bones.length>0,s.morphTargets=r.morphTargets.length>0,s.fog=!0,s.blending=e.CustomBlending,s.blendSrc=e.SrcAlphaFactor,s.blendDst=e.OneMinusSrcAlphaFactor,s.blendSrcAlpha=e.SrcAlphaFactor,s.blendDstAlpha=e.DstAlphaFactor,"pmx"===t.metadata.format&&1==(1&o.flag)?s.side=e.DoubleSide:s.side=1===s.opacity?e.FrontSide:e.DoubleSide,"pmd"===t.metadata.format){if(o.fileName){var A=o.fileName.split("*");if(s.map=this._loadTexture(A[0],n),A.length>1){var u=A[1].slice(-4).toLowerCase();s.envMap=this._loadTexture(A[1],n),s.combine=".sph"===u?e.MultiplyOperation:e.AddOperation}}var l=-1===o.toonIndex?"toon00.bmp":t.toonTextures[o.toonIndex].fileName;s.gradientMap=this._loadTexture(l,n,{isToonTexture:!0,isDefaultToonTexture:this._isDefaultToonTexture(l)}),s.userData.outlineParameters={thickness:1===o.edgeFlag?.003:0,color:[0,0,0],alpha:1,visible:1===o.edgeFlag}}else{var h;-1!==o.textureIndex&&(s.map=this._loadTexture(t.textures[o.textureIndex],n)),-1===o.envTextureIndex||1!==o.envFlag&&2!=o.envFlag||(s.envMap=this._loadTexture(t.textures[o.envTextureIndex],n),s.combine=1===o.envFlag?e.MultiplyOperation:e.AddOperation),-1===o.toonIndex||0!==o.toonFlag?(l="toon"+("0"+(o.toonIndex+1)).slice(-2)+".bmp",h=!0):(l=t.textures[o.toonIndex],h=!1),s.gradientMap=this._loadTexture(l,n,{isToonTexture:!0,isDefaultToonTexture:h}),s.userData.outlineParameters={thickness:o.edgeSize/300,color:o.edgeColor.slice(0,3),alpha:o.edgeColor[3],visible:0!=(16&o.flag)&&o.edgeSize>0}}void 0!==s.map&&(s.transparent||this._checkImageTransparency(s.map,r,i),s.emissive.multiplyScalar(.2)),a.push(new e.MeshToonMaterial(s))}if("pmx"===t.metadata.format)for(var d=function(e,t){for(var r=0,a=e.length;r<a;r++){var n=e[r];if(-1!==n.index){var i=t[n.index];i.opacity!==n.diffuse[3]&&(i.transparent=!0)}}},p=0,f=t.morphs.length;p<f;p++){var m=t.morphs[p],g=m.elements;if(0===m.type)for(var c=0,v=g.length;c<v;c++){var C=t.morphs[g[c].index];8===C.type&&d(C.elements,a)}else 8===m.type&&d(g,a)}return a},_getTGALoader:function(){if(null===this.tgaLoader){if(void 0===t.TGALoader)throw new Error("THREE.MMDLoader: Import TGALoader");this.tgaLoader=new t.TGALoader(this.manager)}return this.tgaLoader},_isDefaultToonTexture:function(e){return 10===e.length&&/toon(10|0[0-9])\.bmp/.test(e)},_loadTexture:function(t,r,a,i,o){var s,A=this;if(!0===(a=a||{}).isDefaultToonTexture){var u;try{u=parseInt(t.match(/toon([0-9]{2})\.bmp$/)[1])}catch(e){console.warn("THREE.MMDLoader: "+t+" seems like a not right default texture path. Using toon00.bmp instead."),u=0}s=n[u]}else s=this.resourcePath+t;if(void 0!==r[s])return r[s];var l=this.manager.getHandler(s);null===l&&(l=".tga"===t.slice(-4).toLowerCase()?this._getTGALoader():this.textureLoader);var h=l.load(s,(function(t){!0===a.isToonTexture&&(t.image=A._getRotatedImage(t.image),t.magFilter=e.NearestFilter,t.minFilter=e.NearestFilter),t.flipY=!1,t.wrapS=e.RepeatWrapping,t.wrapT=e.RepeatWrapping;for(var r=0;r<h.readyCallbacks.length;r++)h.readyCallbacks[r](h);delete h.readyCallbacks}),i,o);return h.readyCallbacks=[],r[s]=h,h},_getRotatedImage:function(e){var t=document.createElement("canvas"),r=t.getContext("2d"),a=e.width,n=e.height;return t.width=a,t.height=n,r.clearRect(0,0,a,n),r.translate(a/2,n/2),r.rotate(.5*Math.PI),r.translate(-a/2,-n/2),r.drawImage(e,0,0),r.getImageData(0,0,a,n)},_checkImageTransparency:function(e,t,r){e.readyCallbacks.push((function(a){function n(e,t){var r=e.width,a=e.height,n=Math.round(t.x*r)%r,i=Math.round(t.y*a)%a;n<0&&(n+=r),i<0&&(i+=a);var o=i*r+n;return e.data[4*o+3]}var i=void 0!==a.image.data?a.image:function(e){var t=document.createElement("canvas");t.width=e.width,t.height=e.height;var r=t.getContext("2d");return r.drawImage(e,0,0),r.getImageData(0,0,t.width,t.height)}(a.image),o=t.groups[r];(function(e,t,r){var a=e.width,i=e.height;if(e.data.length/(a*i)!=4)return!1;for(var o=0;o<r.length;o+=3){for(var s={x:0,y:0},A=0;A<3;A++){var u=r[3*o+A],l={x:t[2*u+0],y:t[2*u+1]};if(n(e,l)<253)return!0;s.x+=l.x,s.y+=l.y}if(s.x/=3,s.y/=3,n(e,s)<253)return!0}return!1})(i,t.attributes.uv.array,t.index.array.slice(o.start,o.start+o.count))&&(e.transparent=!0)}))}},A.prototype={constructor:A,build:function(t,r){for(var a=this.buildSkeletalAnimation(t,r).tracks,n=this.buildMorphAnimation(t,r).tracks,i=0,o=n.length;i<o;i++)a.push(n[i]);return new e.AnimationClip("",-1,a)},buildSkeletalAnimation:function(t,r){function a(e,t,r){e.push(t[r+0]/127),e.push(t[r+8]/127),e.push(t[r+4]/127),e.push(t[r+12]/127)}for(var n=[],i={},o=r.skeleton.bones,s={},A=0,u=o.length;A<u;A++)s[o[A].name]=!0;for(var l=0;l<t.metadata.motionCount;l++){var h=t.motions[l],d=h.boneName;void 0!==s[d]&&(i[d]=i[d]||[],i[d].push(h))}for(var p in i){var f=i[p];f.sort((function(e,t){return e.frameNum-t.frameNum}));for(var m=[],g=[],c=[],v=[],C=[],x=r.skeleton.getBoneByName(p).position.toArray(),b=0,y=f.length;b<y;b++){var B=f[b].frameNum/30,I=f[b].position,w=f[b].rotation,R=f[b].interpolation;m.push(B);for(var T=0;T<3;T++)g.push(x[T]+I[T]);for(var E=0;E<4;E++)c.push(w[E]);for(var k=0;k<3;k++)a(v,R,k);a(C,R,3)}var Q=".bones["+p+"]";n.push(this._createTrack(Q+".position",e.VectorKeyframeTrack,m,g,v)),n.push(this._createTrack(Q+".quaternion",e.QuaternionKeyframeTrack,m,c,C))}return new e.AnimationClip("",-1,n)},buildMorphAnimation:function(t,r){for(var a=[],n={},i=r.morphTargetDictionary,o=0;o<t.metadata.morphCount;o++){var s=t.morphs[o],A=s.morphName;void 0!==i[A]&&(n[A]=n[A]||[],n[A].push(s))}for(var u in n){var l=n[u];l.sort((function(e,t){return e.frameNum-t.frameNum}));for(var h=[],d=[],p=0,f=l.length;p<f;p++)h.push(l[p].frameNum/30),d.push(l[p].weight);a.push(new e.NumberKeyframeTrack(".morphTargetInfluences["+i[u]+"]",h,d))}return new e.AnimationClip("",-1,a)},buildCameraAnimation:function(t){function r(e,t){e.push(t.x),e.push(t.y),e.push(t.z)}function a(e,t,r){e.push(t[4*r+0]/127),e.push(t[4*r+1]/127),e.push(t[4*r+2]/127),e.push(t[4*r+3]/127)}var n=[],i=void 0===t.cameras?[]:t.cameras.slice();i.sort((function(e,t){return e.frameNum-t.frameNum}));for(var o,s,A=[],u=[],l=[],h=[],d=[],p=[],f=[],m=[],g=[],c=new e.Quaternion,v=new e.Euler,C=new e.Vector3,x=new e.Vector3,b=0,y=i.length;b<y;b++){var B=i[b],I=B.frameNum/30,w=B.position,R=B.rotation,T=B.distance,E=B.fov,k=B.interpolation;A.push(I),C.set(0,0,-T),x.set(w[0],w[1],w[2]),v.set(-R[0],-R[1],-R[2]),c.setFromEuler(v),C.add(x),C.applyQuaternion(c),r(u,x),(o=l).push((s=c).x),o.push(s.y),o.push(s.z),o.push(s.w),r(h,C),d.push(E);for(var Q=0;Q<3;Q++)a(p,k,Q);a(f,k,3);for(var M=0;M<3;M++)a(m,k,4);a(g,k,5)}return(n=[]).push(this._createTrack("target.position",e.VectorKeyframeTrack,A,u,p)),n.push(this._createTrack(".quaternion",e.QuaternionKeyframeTrack,A,l,f)),n.push(this._createTrack(".position",e.VectorKeyframeTrack,A,h,m)),n.push(this._createTrack(".fov",e.NumberKeyframeTrack,A,d,g)),new e.AnimationClip("",-1,n)},_createTrack:function(e,t,r,a,n){if(r.length>2){r=r.slice(),a=a.slice(),n=n.slice();for(var i=a.length/r.length,o=n.length/r.length,s=1,A=2,l=r.length;A<l;A++){for(var h=0;h<i;h++)if(a[s*i+h]!==a[(s-1)*i+h]||a[s*i+h]!==a[A*i+h]){s++;break}if(A>s){r[s]=r[A];for(var d=0;d<i;d++)a[s*i+d]=a[A*i+d];for(var p=0;p<o;p++)n[s*o+p]=n[A*o+p]}}r.length=s+1,a.length=(s+1)*i,n.length=(s+1)*o}var f=new t(e,r,a);return f.createInterpolant=function(e){return new u(this.times,this.values,this.getValueSize(),e,new Float32Array(n))},f}},u.prototype=Object.assign(Object.create(e.Interpolant.prototype),{constructor:u,interpolate_:function(t,r,a,n){var i=this.resultBuffer,o=this.sampleValues,s=this.valueSize,A=this.interpolationParams,u=t*s,l=u-s,h=n-r<.05?0:(a-r)/(n-r);if(4===s){var d=A[4*t+0],p=A[4*t+1],f=A[4*t+2],m=A[4*t+3],g=this._calculate(d,p,f,m,h);e.Quaternion.slerpFlat(i,0,o,l,o,u,g)}else if(3===s)for(var c=0;c!==s;++c){d=A[12*t+4*c+0],p=A[12*t+4*c+1],f=A[12*t+4*c+2],m=A[12*t+4*c+3],g=this._calculate(d,p,f,m,h);i[c]=o[l+c]*(1-g)+o[u+c]*g}else{d=A[4*t+0],p=A[4*t+1],f=A[4*t+2],m=A[4*t+3],g=this._calculate(d,p,f,m,h);i[0]=o[l]*(1-g)+o[u]*g}return i},_calculate:function(e,t,r,a,n){for(var i,o,s,A=.5,u=A,l=1-u,h=Math,d=0;d<15;d++){var p=(i=3*l*l*u)*e+(o=3*l*u*u)*t+(s=u*u*u)-n;if(h.abs(p)<1e-5)break;A/=2,l=1-(u+=p<0?A:-A)}return i*r+o*a+s}}),a}();exports.MMDLoader=a;
