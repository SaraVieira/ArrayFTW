"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("three"),t=function(t){e.Loader.call(this,t),this.decoderPath="",this.decoderConfig={},this.decoderBinary=null,this.decoderPending=null,this.workerLimit=4,this.workerPool=[],this.workerNextTaskID=1,this.workerSourceURL="",this.defaultAttributeIDs={position:"POSITION",normal:"NORMAL",color:"COLOR",uv:"TEX_COORD"},this.defaultAttributeTypes={position:"Float32Array",normal:"Float32Array",color:"Float32Array",uv:"Float32Array"}};t.prototype=Object.assign(Object.create(e.Loader.prototype),{constructor:t,setDecoderPath:function(e){return this.decoderPath=e,this},setDecoderConfig:function(e){return this.decoderConfig=e,this},setWorkerLimit:function(e){return this.workerLimit=e,this},setVerbosity:function(){console.warn("THREE.DRACOLoader: The .setVerbosity() method has been removed.")},setDrawMode:function(){console.warn("THREE.DRACOLoader: The .setDrawMode() method has been removed.")},setSkipDequantization:function(){console.warn("THREE.DRACOLoader: The .setSkipDequantization() method has been removed.")},load:function(t,r,o,n){var a=this,s=new e.FileLoader(this.manager);s.setPath(this.path),s.setResponseType("arraybuffer"),s.setRequestHeader(this.requestHeader),s.setWithCredentials(this.withCredentials),s.load(t,(function(e){var t={attributeIDs:a.defaultAttributeIDs,attributeTypes:a.defaultAttributeTypes,useUniqueIDs:!1};a.decodeGeometry(e,t).then(r).catch(n)}),o,n)},decodeDracoFile:function(e,t,r,o){var n={attributeIDs:r||this.defaultAttributeIDs,attributeTypes:o||this.defaultAttributeTypes,useUniqueIDs:!!r};this.decodeGeometry(e,n).then(t)},decodeGeometry:function(e,r){var o=this;for(var n in r.attributeTypes){var a=r.attributeTypes[n];void 0!==a.BYTES_PER_ELEMENT&&(r.attributeTypes[n]=a.name)}var s,i=JSON.stringify(r);if(t.taskCache.has(e)){var d=t.taskCache.get(e);if(d.key===i)return d.promise;if(0===e.byteLength)throw new Error("THREE.DRACOLoader: Unable to re-decode a buffer with different settings. Buffer has already been transferred.")}var c=this.workerNextTaskID++,u=e.byteLength,h=this._getWorker(c,u).then((function(t){return s=t,new Promise((function(t,o){s._callbacks[c]={resolve:t,reject:o},s.postMessage({type:"decode",id:c,taskConfig:r,buffer:e},[e])}))})).then((function(e){return o._createGeometry(e.geometry)}));return h.catch((function(){return!0})).then((function(){s&&c&&o._releaseTask(s,c)})),t.taskCache.set(e,{key:i,promise:h}),h},_createGeometry:function(t){var r=new e.BufferGeometry;t.index&&r.setIndex(new e.BufferAttribute(t.index.array,1));for(var o=0;o<t.attributes.length;o++){var n=t.attributes[o],a=n.name,s=n.array,i=n.itemSize;r.setAttribute(a,new e.BufferAttribute(s,i))}return r},_loadLibrary:function(t,r){var o=new e.FileLoader(this.manager);return o.setPath(this.decoderPath),o.setResponseType(r),o.setWithCredentials(this.withCredentials),new Promise((function(e,r){o.load(t,e,void 0,r)}))},preload:function(){return this._initDecoder(),this},_initDecoder:function(){var e=this;if(this.decoderPending)return this.decoderPending;var r="object"!=typeof WebAssembly||"js"===this.decoderConfig.type,o=[];return r?o.push(this._loadLibrary("draco_decoder.js","text")):(o.push(this._loadLibrary("draco_wasm_wrapper.js","text")),o.push(this._loadLibrary("draco_decoder.wasm","arraybuffer"))),this.decoderPending=Promise.all(o).then((function(o){var n=o[0];r||(e.decoderConfig.wasmBinary=o[1]);var a=t.DRACOWorker.toString(),s=["/* draco decoder */",n,"","/* worker */",a.substring(a.indexOf("{")+1,a.lastIndexOf("}"))].join("\n");e.workerSourceURL=URL.createObjectURL(new Blob([s]))})),this.decoderPending},_getWorker:function(e,t){var r=this;return this._initDecoder().then((function(){var o;r.workerPool.length<r.workerLimit?((o=new Worker(r.workerSourceURL))._callbacks={},o._taskCosts={},o._taskLoad=0,o.postMessage({type:"init",decoderConfig:r.decoderConfig}),o.onmessage=function(e){var t=e.data;switch(t.type){case"decode":o._callbacks[t.id].resolve(t);break;case"error":o._callbacks[t.id].reject(t);break;default:console.error('THREE.DRACOLoader: Unexpected message, "'+t.type+'"')}},r.workerPool.push(o)):r.workerPool.sort((function(e,t){return e._taskLoad>t._taskLoad?-1:1}));return(o=r.workerPool[r.workerPool.length-1])._taskCosts[e]=t,o._taskLoad+=t,o}))},_releaseTask:function(e,t){e._taskLoad-=e._taskCosts[t],delete e._callbacks[t],delete e._taskCosts[t]},debug:function(){console.log("Task load: ",this.workerPool.map((function(e){return e._taskLoad})))},dispose:function(){for(var e=0;e<this.workerPool.length;++e)this.workerPool[e].terminate();return this.workerPool.length=0,this}}),t.DRACOWorker=function(){var e,t;function r(e,t,r,o,n,a){var s=a.num_components(),i=r.num_points()*s,d=i*n.BYTES_PER_ELEMENT,c=function(e,t){switch(t){case Float32Array:return e.DT_FLOAT32;case Int8Array:return e.DT_INT8;case Int16Array:return e.DT_INT16;case Int32Array:return e.DT_INT32;case Uint8Array:return e.DT_UINT8;case Uint16Array:return e.DT_UINT16;case Uint32Array:return e.DT_UINT32}}(e,n),u=e._malloc(d);t.GetAttributeDataArrayForAllPoints(r,a,c,d,u);var h=new n(e.HEAPF32.buffer,u,i).slice();return e._free(u),{name:o,array:h,itemSize:s}}onmessage=function(o){var n=o.data;switch(n.type){case"init":e=n.decoderConfig,t=new Promise((function(t){e.onModuleLoaded=function(e){t({draco:e})},DracoDecoderModule(e)}));break;case"decode":var a=n.buffer,s=n.taskConfig;t.then((function(e){var t=e.draco,o=new t.Decoder,i=new t.DecoderBuffer;i.Init(new Int8Array(a),a.byteLength);try{var d=function(e,t,o,n){var a,s,i=n.attributeIDs,d=n.attributeTypes,c=t.GetEncodedGeometryType(o);if(c===e.TRIANGULAR_MESH)a=new e.Mesh,s=t.DecodeBufferToMesh(o,a);else{if(c!==e.POINT_CLOUD)throw new Error("THREE.DRACOLoader: Unexpected geometry type.");a=new e.PointCloud,s=t.DecodeBufferToPointCloud(o,a)}if(!s.ok()||0===a.ptr)throw new Error("THREE.DRACOLoader: Decoding failed: "+s.error_msg());var u={index:null,attributes:[]};for(var h in i){var f,l,y=self[d[h]];if(n.useUniqueIDs)l=i[h],f=t.GetAttributeByUniqueId(a,l);else{if(-1===(l=t.GetAttributeId(a,e[i[h]])))continue;f=t.GetAttribute(a,l)}u.attributes.push(r(e,t,a,h,y,f))}c===e.TRIANGULAR_MESH&&(u.index=function(e,t,r){var o=3*r.num_faces(),n=4*o,a=e._malloc(n);t.GetTrianglesUInt32Array(r,n,a);var s=new Uint32Array(e.HEAPF32.buffer,a,o).slice();return e._free(a),{array:s,itemSize:1}}(e,t,a));return e.destroy(a),u}(t,o,i,s),c=d.attributes.map((function(e){return e.array.buffer}));d.index&&c.push(d.index.array.buffer),self.postMessage({type:"decode",id:n.id,geometry:d},c)}catch(e){console.error(e),self.postMessage({type:"error",id:n.id,error:e.message})}finally{t.destroy(i),t.destroy(o)}}))}}},t.taskCache=new WeakMap,t.setDecoderPath=function(){console.warn("THREE.DRACOLoader: The .setDecoderPath() method has been removed. Use instance methods.")},t.setDecoderConfig=function(){console.warn("THREE.DRACOLoader: The .setDecoderConfig() method has been removed. Use instance methods.")},t.releaseDecoderModule=function(){console.warn("THREE.DRACOLoader: The .releaseDecoderModule() method has been removed. Use instance methods.")},t.getDecoderModule=function(){console.warn("THREE.DRACOLoader: The .getDecoderModule() method has been removed. Use instance methods.")},exports.DRACOLoader=t;
