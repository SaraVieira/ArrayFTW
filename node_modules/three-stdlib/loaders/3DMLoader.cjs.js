"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("three"),t=function(t){e.Loader.call(this,t),this.libraryPath="",this.libraryPending=null,this.libraryBinary=null,this.libraryConfig={},this.url="",this.workerLimit=4,this.workerPool=[],this.workerNextTaskID=1,this.workerSourceURL="",this.workerConfig={},this.materials=[]};t.taskCache=new WeakMap,t.prototype=Object.assign(Object.create(e.Loader.prototype),{constructor:t,setLibraryPath:function(e){return this.libraryPath=e,this},setWorkerLimit:function(e){return this.workerLimit=e,this},load:function(r,a,o,n){var i=this,s=new e.FileLoader(this.manager);s.setPath(this.path),s.setResponseType("arraybuffer"),s.setRequestHeader(this.requestHeader),this.url=r,s.load(r,(function(e){if(t.taskCache.has(e))return t.taskCache.get(e).promise.then(a).catch(n);i.decodeObjects(e,r).then(a).catch(n)}),o,n)},debug:function(){console.log("Task load: ",this.workerPool.map((function(e){return e._taskLoad})))},decodeObjects:function(e,r){var a,o,n=this,i=e.byteLength,s=this._getWorker(i).then((function(t){return a=t,o=n.workerNextTaskID++,new Promise((function(t,r){a._callbacks[o]={resolve:t,reject:r},a.postMessage({type:"decode",id:o,buffer:e},[e])}))})).then((function(e){return n._createGeometry(e.data)}));return s.catch((function(){return!0})).then((function(){a&&o&&n._releaseTask(a,o)})),t.taskCache.set(e,{url:r,promise:s}),s},parse:function(e,t,r){this.decodeObjects(e,"").then(t).catch(r)},_compareMaterials:function(e){var t={};t.name=e.name,t.color={},t.color.r=e.color.r,t.color.g=e.color.g,t.color.b=e.color.b,t.type=e.type;for(var r=0;r<this.materials.length;r++){var a=this.materials[r],o={};if(o.name=a.name,o.color={},o.color.r=a.color.r,o.color.g=a.color.g,o.color.b=a.color.b,o.type=a.type,JSON.stringify(t)===JSON.stringify(o))return a}return this.materials.push(e),e},_createMaterial:function(t){if(void 0===t)return new e.MeshStandardMaterial({color:new e.Color(1,1,1),metalness:.8,name:"default",side:2});var r=t.diffuseColor,a=new e.Color(r.r/255,r.g/255,r.b/255);0===r.r&&0===r.g&&0===r.b&&(a.r=1,a.g=1,a.b=1);for(var o=new e.MeshStandardMaterial({color:a,name:t.name,side:2,transparent:t.transparency>0,opacity:1-t.transparency}),n=new e.TextureLoader,i=0;i<t.textures.length;i++){var s=t.textures[i];if(null!==s.image){var c=n.load(s.image);switch(s.type){case"Diffuse":o.map=c;break;case"Bump":o.bumpMap=c;break;case"Transparency":o.alphaMap=c,o.transparent=!0;break;case"Emap":o.envMap=c}}}return o},_createGeometry:function(t){var r=new e.Object3D,a=[],o=[],n=[];r.userData.layers=t.layers,r.userData.groups=t.groups,r.userData.settings=t.settings,r.userData.objectType="File3dm",r.userData.materials=null,r.name=this.url;for(var i=t.objects,s=t.materials,c=0;c<i.length;c++){var l=i[c],u=l.attributes;switch(l.objectType){case"InstanceDefinition":o.push(l);break;case"InstanceReference":n.push(l);break;default:if(u.materialIndex>=0){var h=s[u.materialIndex],p=this._createMaterial(h);p=this._compareMaterials(p);var d=this._createObject(l,p)}else p=this._createMaterial(),d=this._createObject(l,p);if(void 0===d)continue;var y=t.layers[u.layerIndex];d.visible=!y||t.layers[u.layerIndex].visible,u.isInstanceDefinitionObject?a.push(d):r.add(d)}}for(var g=0;g<o.length;g++){for(var f=o[g],m=(i=[],0);m<f.attributes.objectIds.length;m++)for(var b=f.attributes.objectIds[m],v=0;v<a.length;v++){b===a[v].userData.attributes.id&&i.push(a[v])}for(var T=0;T<n.length;T++){var w=n[T];if(w.geometry.parentIdefId===f.attributes.id){var x=new e.Object3D,k=w.geometry.xform.array,P=new e.Matrix4;P.set(k[0],k[1],k[2],k[3],k[4],k[5],k[6],k[7],k[8],k[9],k[10],k[11],k[12],k[13],k[14],k[15]),x.applyMatrix4(P);for(var j=0;j<i.length;j++)x.add(i[j].clone(!0));r.add(x)}}}return r.userData.materials=this.materials,r},_createObject:function(t,r){var a=new e.BufferGeometryLoader,o=t.attributes;switch(t.objectType){case"Point":case"PointSet":var n=null;if((l=a.parse(t.geometry)).attributes.hasOwnProperty("color"))n=new e.PointsMaterial({vertexColors:!0,sizeAttenuation:!1,size:2});else{var i=o.drawColor,s=new e.Color(i.r/255,i.g/255,i.b/255);n=new e.PointsMaterial({color:s,sizeAttenuation:!1,size:2})}n=this._compareMaterials(n);var c=new e.Points(l,n);return c.userData.attributes=o,c.userData.objectType=t.objectType,o.name&&(c.name=o.name),c;case"Mesh":case"Extrusion":case"SubD":case"Brep":if(null===t.geometry)return;var l;(l=a.parse(t.geometry)).attributes.hasOwnProperty("color")&&(r.vertexColors=!0),null===r&&(r=this._createMaterial(),r=this._compareMaterials(r));var u=new e.Mesh(l,r);return u.castShadow=o.castsShadows,u.receiveShadow=o.receivesShadows,u.userData.attributes=o,u.userData.objectType=t.objectType,o.name&&(u.name=o.name),u;case"Curve":l=a.parse(t.geometry);i=o.drawColor,s=new e.Color(i.r/255,i.g/255,i.b/255),n=new e.LineBasicMaterial({color:s});n=this._compareMaterials(n);var h=new e.Line(l,n);return h.userData.attributes=o,h.userData.objectType=t.objectType,o.name&&(h.name=o.name),h;case"TextDot":l=t.geometry;var p=document.createElement("canvas").getContext("2d"),d=l.fontHeight+"px "+l.fontFace;p.font=d;var y=p.measureText(l.text).width+10,g=l.fontHeight+10,f=window.devicePixelRatio;p.canvas.width=y*f,p.canvas.height=g*f,p.canvas.style.width=y+"px",p.canvas.style.height=g+"px",p.setTransform(f,0,0,f,0,0),p.font=d,p.textBaseline="middle",p.textAlign="center";s=o.drawColor;p.fillStyle="rgba("+s.r+","+s.g+","+s.b+","+s.a+")",p.fillRect(0,0,y,g),p.fillStyle="white",p.fillText(l.text,y/2,g/2);var m=new e.CanvasTexture(p.canvas);m.minFilter=e.LinearFilter,m.wrapS=e.ClampToEdgeWrapping,m.wrapT=e.ClampToEdgeWrapping;n=new e.SpriteMaterial({map:m,depthTest:!1});var b=new e.Sprite(n);return b.position.set(l.point[0],l.point[1],l.point[2]),b.scale.set(y/10,g/10,1),b.userData.attributes=o,b.userData.objectType=t.objectType,o.name&&(b.name=o.name),b;case"Light":var v;if((l=t.geometry).isDirectionalLight)(v=new e.DirectionalLight).castShadow=o.castsShadows,v.position.set(l.location[0],l.location[1],l.location[2]),v.target.position.set(l.direction[0],l.direction[1],l.direction[2]),v.shadow.normalBias=.1;else if(l.isPointLight)(v=new e.PointLight).castShadow=o.castsShadows,v.position.set(l.location[0],l.location[1],l.location[2]),v.shadow.normalBias=.1;else if(l.isRectangularLight){v=new e.RectAreaLight;y=Math.abs(l.width[2]),g=Math.abs(l.length[0]);v.position.set(l.location[0]-g/2,l.location[1],l.location[2]-y/2),v.height=g,v.width=y,v.lookAt(new e.Vector3(l.direction[0],l.direction[1],l.direction[2]))}else if(l.isSpotLight)(v=new e.SpotLight).castShadow=o.castsShadows,v.position.set(l.location[0],l.location[1],l.location[2]),v.target.position.set(l.direction[0],l.direction[1],l.direction[2]),v.angle=l.spotAngleRadians,v.shadow.normalBias=.1;else if(l.isLinearLight)return void console.warn("THREE.3DMLoader:  No conversion exists for linear lights.");if(v){v.intensity=l.intensity;i=l.diffuse,s=new e.Color(i.r/255,i.g/255,i.b/255);v.color=s,v.userData.attributes=o,v.userData.objectType=t.objectType}return v}},_initLibrary:function(){var r=this;if(!this.libraryPending){var a=new e.FileLoader(this.manager);a.setPath(this.libraryPath);var o=new Promise((function(e,t){a.load("rhino3dm.js",e,void 0,t)})),n=new e.FileLoader(this.manager);n.setPath(this.libraryPath),n.setResponseType("arraybuffer");var i=new Promise((function(e,t){n.load("rhino3dm.wasm",e,void 0,t)}));this.libraryPending=Promise.all([o,i]).then((function(e){var a=e[0],o=e[1];r.libraryConfig.wasmBinary=o;var n=t.Rhino3dmWorker.toString(),i=["/* rhino3dm.js */",a,"/* worker */",n.substring(n.indexOf("{")+1,n.lastIndexOf("}"))].join("\n");r.workerSourceURL=URL.createObjectURL(new Blob([i]))}))}return this.libraryPending},_getWorker:function(e){var t=this;return this._initLibrary().then((function(){var r;t.workerPool.length<t.workerLimit?((r=new Worker(t.workerSourceURL))._callbacks={},r._taskCosts={},r._taskLoad=0,r.postMessage({type:"init",libraryConfig:t.libraryConfig}),r.onmessage=function(e){var t=e.data;switch(t.type){case"decode":r._callbacks[t.id].resolve(t);break;case"error":r._callbacks[t.id].reject(t);break;default:console.error('THREE.Rhino3dmLoader: Unexpected message, "'+t.type+'"')}},t.workerPool.push(r)):t.workerPool.sort((function(e,t){return e._taskLoad>t._taskLoad?-1:1}));return(r=t.workerPool[t.workerPool.length-1])._taskLoad+=e,r}))},_releaseTask:function(e,t){e._taskLoad-=e._taskCosts[t],delete e._callbacks[t],delete e._taskCosts[t]},dispose:function(){for(var e=0;e<this.workerPool.length;++e)this.workerPool[e].terminate();return this.workerPool.length=0,this}}),t.Rhino3dmWorker=function(){var e,t;function r(e,r){var n=e.geometry(),i=e.attributes(),s=n.objectType,c=null,l=null;switch(s){case t.ObjectType.Curve:var u=o(n,100),l={},h={};(d={}).itemSize=3,d.type="Float32Array",d.array=[];for(var p=0;p<u.length;p++)d.array.push(u[p][0]),d.array.push(u[p][1]),d.array.push(u[p][2]);l.position=d,h.attributes=l,c={data:h};break;case t.ObjectType.Point:var d,y=n.location,g={};l={},h={};(d={}).itemSize=3,d.type="Float32Array",d.array=[y[0],y[1],y[2]];var f=i.drawColor(r);g.itemSize=3,g.type="Float32Array",g.array=[f.r/255,f.g/255,f.b/255],l.position=d,l.color=g,h.attributes=l,c={data:h};break;case t.ObjectType.PointSet:case t.ObjectType.Mesh:c=n.toThreejsJSON();break;case t.ObjectType.Brep:for(var m=n.faces(),b=new t.Mesh,v=0;v<m.count;v++){var T=m.get(v),w=T.getMesh(t.MeshType.Any);w&&(b.append(w),w.delete()),T.delete()}b.faces().count>0&&(b.compact(),c=b.toThreejsJSON(),m.delete()),b.delete();break;case t.ObjectType.Extrusion:(b=n.getMesh(t.MeshType.Any))&&(c=b.toThreejsJSON(),b.delete());break;case t.ObjectType.TextDot:case t.ObjectType.Light:c=a(n);break;case t.ObjectType.InstanceReference:(c=a(n)).xform=a(n.xform),c.xform.array=n.xform.toFloatArray(!0);break;case t.ObjectType.SubD:n.subdivide(3),(b=t.Mesh.createFromSubDControlNet(n))&&(c=b.toThreejsJSON(),b.delete());break;default:console.warn("THREE.3DMLoader: TODO: Implement "+s.constructor.name)}if(c)return(l=a(i)).geometry=a(n),i.groupCount>0&&(l.groupIds=i.getGroupList()),i.userStringCount>0&&(l.userStrings=i.getUserStrings()),n.userStringCount>0&&(l.geometry.userStrings=n.getUserStrings()),l.drawColor=i.drawColor(r),{geometry:c,attributes:l,objectType:s=(s=s.constructor.name).substring(11,s.length)};console.warn("THREE.3DMLoader: "+s.constructor.name+" has no associated mesh geometry.")}function a(e){var t={};for(var r in e){var a=e[r];"function"!=typeof a&&("object"==typeof a&&null!==a&&a.hasOwnProperty("constructor")?t[r]={name:a.constructor.name,value:a.value}:t[r]=a)}return t}function o(e,r){var a=r,n=[],i=[];if(e instanceof t.LineCurve)return[e.pointAtStart,e.pointAtEnd];if(e instanceof t.PolylineCurve){a=e.pointCount;for(var s=0;s<a;s++)n.push(e.point(s));return n}if(e instanceof t.PolyCurve){for(var c=e.segmentCount,l=0;l<c;l++){var u=e.segmentCurve(l),h=o(u,a);n=n.concat(h),u.delete()}return n}if(e instanceof t.ArcCurve&&(a=(a=Math.floor(e.angleDegrees/5))<2?2:a),e instanceof t.NurbsCurve&&1===e.degree){for(var p=e.tryGetPolyline(),d=0;d<p.count;d++)n.push(p.get(d));return p.delete(),n}for(var y=e.domain,g=a-1,f=0;f<a;f++){var m=y[0]+f/g*(y[1]-y[0]);if(m!==y[0]&&m!==y[1]){var b,v=e.tangentAt(m),T=e.tangentAt(i.slice(-1)[0]),w=v[0]*v[0]+v[1]*v[1]+v[2]*v[2],x=T[0]*T[0]+T[1]*T[1]+T[2]*T[2],k=Math.sqrt(w*x);if(0===k)b=Math.PI/2;else{var P=(v.x*T.x+v.y*T.y+v.z*T.z)/k;b=Math.acos(Math.max(-1,Math.min(1,P)))}b<.1||i.push(m)}else i.push(m)}return n=i.map((function(t){return e.pointAt(t)}))}onmessage=function(o){var n=o.data;switch(n.type){case"init":var i,s=n.libraryConfig.wasmBinary;e=new Promise((function(e){i={wasmBinary:s,onRuntimeInitialized:e},rhino3dm(i)})).then((function(){t=i}));break;case"decode":var c=n.buffer;e.then((function(){var e=function(e,t){for(var o=new Uint8Array(t),n=e.File3dm.fromByteArray(o),i=[],s=[],c=[],l=[],u=[],h=[],p=n.objects(),d=p.count,y=0;y<d;y++){var g=p.get(y),f=r(g,n);g.delete(),f&&i.push(f)}for(var m=0;m<n.instanceDefinitions().count();m++){var b=n.instanceDefinitions().get(m),v=a(b);v.objectIds=b.getObjectIds(),i.push({geometry:null,attributes:v,objectType:"InstanceDefinition"})}for(var T=[e.TextureType.Diffuse,e.TextureType.Bump,e.TextureType.Transparency,e.TextureType.Opacity,e.TextureType.Emap],w=[e.TextureType.PBR_BaseColor,e.TextureType.PBR_Subsurface,e.TextureType.PBR_SubsurfaceScattering,e.TextureType.PBR_SubsurfaceScatteringRadius,e.TextureType.PBR_Metallic,e.TextureType.PBR_Specular,e.TextureType.PBR_SpecularTint,e.TextureType.PBR_Roughness,e.TextureType.PBR_Anisotropic,e.TextureType.PBR_Anisotropic_Rotation,e.TextureType.PBR_Sheen,e.TextureType.PBR_SheenTint,e.TextureType.PBR_Clearcoat,e.TextureType.PBR_ClearcoatBump,e.TextureType.PBR_ClearcoatRoughness,e.TextureType.PBR_OpacityIor,e.TextureType.PBR_OpacityRoughness,e.TextureType.PBR_Emission,e.TextureType.PBR_AmbientOcclusion,e.TextureType.PBR_Displacement],x=0;x<n.materials().count();x++){for(var k=n.materials().get(x),P=k.physicallyBased(),j=a(k),_=[],S=0;S<T.length;S++){if(L=k.getTexture(T[S])){var R={type:M=(M=T[S].constructor.name).substring(12,M.length)};(B=n.getEmbeddedFileAsBase64(L.fileName))?R.image="data:image/png;base64,"+B:(console.warn("THREE.3DMLoader: Image for "+M+" texture not embedded in file."),R.image=null),_.push(R),L.delete()}}if(j.textures=_,P.supported){console.log("pbr true");for(var C=0;C<w.length;C++){var L;if(L=k.getTexture(T[C])){var M,B=n.getEmbeddedFileAsBase64(L.fileName);R={type:M=(M=T[C].constructor.name).substring(12,M.length),image:"data:image/png;base64,"+B};_.push(R),L.delete()}}var D=a(k.physicallyBased());j=Object.assign(D,j)}s.push(j),k.delete(),P.delete()}for(var O=0;O<n.layers().count();O++){var A=n.layers().get(O),I=a(A);c.push(I),A.delete()}for(var E=0;E<n.views().count();E++){var F=n.views().get(E),N=a(F);l.push(N),F.delete()}for(var z=0;z<n.namedViews().count();z++){var H=n.namedViews().get(z),U=a(H);u.push(U),H.delete()}for(var W=0;W<n.groups().count();W++){var J=n.groups().get(W),G=a(J);h.push(G),J.delete()}var q=a(n.settings());return n.delete(),{objects:i,materials:s,layers:c,views:l,namedViews:u,groups:h,settings:q}}(t,c);self.postMessage({type:"decode",id:n.id,data:e})}))}}},exports.Rhino3dmLoader=t;
