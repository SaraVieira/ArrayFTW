"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("@babel/runtime/helpers/asyncToGenerator"),r=require("@babel/runtime/helpers/inheritsLoose"),t=require("three"),a=require("./BasisTextureLoader.cjs.js"),s=require("zstddec"),n=require("ktx-parse");function o(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}require("@babel/runtime/helpers/extends");var i,u=o(e),l=o(r),c=166,p={RGB:0,RRR:3,GGG:4,AAA:15},d={RGB:0,RGBA:3,RRR:4,RRRG:5},h=2,f=2,m=function(e){function r(r){var t;return(t=e.call(this,r)||this).basisLoader=new a.BasisTextureLoader(r),t.zstd=new s.ZSTDDecoder,t.zstd.init(),"undefined"!=typeof MSC_TRANSCODER&&console.warn('THREE.KTX2Loader: Please update to latest "basis_transcoder". "msc_basis_transcoder" is no longer supported in three.js r125+.'),t}l.default(r,e);var o=r.prototype;return o.setTranscoderPath=function(e){return this.basisLoader.setTranscoderPath(e),this},o.setWorkerLimit=function(e){return this.basisLoader.setWorkerLimit(e),this},o.detectSupport=function(e){return this.basisLoader.detectSupport(e),this},o.dispose=function(){return this.basisLoader.dispose(),this},o.load=function(e,r,a,s){var n=this,o=new t.CompressedTexture;return new Promise((function(r,s){new t.FileLoader(n.manager).setPath(n.path).setResponseType("arraybuffer").load(e,r,a,s)})).then((function(e){n.parse(e,(function(e){o.copy(e),o.needsUpdate=!0,r&&r(o)}),s)})).catch(s),o},o.parse=function(e,r,s){var o=this,i=n.read(new Uint8Array(e));if(i.pixelDepth>0)throw new Error("THREE.KTX2Loader: Only 2D textures are currently supported.");if(i.layerCount>1)throw new Error("THREE.KTX2Loader: Array textures are not currently supported.");if(i.faceCount>1)throw new Error("THREE.KTX2Loader: Cube textures are not currently supported.");var u=x.getBasicDFD(i);return x.createLevels(i,this.zstd).then((function(e){var r=u.colorModel===c?a.BasisTextureLoader.BasisFormat.UASTC_4x4:a.BasisTextureLoader.BasisFormat.ETC1S,t={levels:e,width:i.pixelWidth,height:i.pixelHeight,basisFormat:r,hasAlpha:x.getAlpha(i)};return r===a.BasisTextureLoader.BasisFormat.ETC1S&&(t.globalData=i.globalData),o.basisLoader.parseInternalAsync(t)})).then((function(e){e.encoding=u.transferFunction===f?t.sRGBEncoding:t.LinearEncoding,e.premultiplyAlpha=x.getPremultiplyAlpha(i),r(e)})).catch(s),this},r}(t.CompressedTextureLoader),x={createLevels:(i=u.default(regeneratorRuntime.mark((function e(r,t){var a,s,n,o,i,u,l;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r.supercompressionScheme!==h){e.next=3;break}return e.next=3,t.init();case 3:for(a=[],s=r.pixelWidth,n=r.pixelHeight,o=0;o<r.levels.length;o++)i=Math.max(1,Math.floor(s/Math.pow(2,o))),u=Math.max(1,Math.floor(n/Math.pow(2,o))),l=r.levels[o].levelData,r.supercompressionScheme===h&&(l=t.decode(l,r.levels[o].uncompressedByteLength)),a.push({index:o,width:i,height:u,data:l});return e.abrupt("return",a);case 8:case"end":return e.stop()}}),e)}))),function(e,r){return i.apply(this,arguments)}),getBasicDFD:function(e){return e.dataFormatDescriptor[0]},getAlpha:function(e){var r=this.getBasicDFD(e);return r.colorModel===c?(15&r.samples[0].channelID)===d.RGBA:2===r.samples.length&&(15&r.samples[1].channelID)===p.AAA},getPremultiplyAlpha:function(e){return!!(1&this.getBasicDFD(e).flags)}};exports.KTX2Loader=m;
