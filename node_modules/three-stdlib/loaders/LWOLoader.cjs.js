"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e,t=require("three"),a=require("./lwo/IFFParser.cjs.js");require("./lwo/LWO2Parser.cjs.js"),require("./lwo/LWO3Parser.cjs.js");var r=function(e,a){t.Loader.call(this,e),a=a||{},this.resourcePath=void 0!==a.resourcePath?a.resourcePath:""};function s(e){this.textureLoader=e}function i(e){this.textureLoader=e}function n(){}r.prototype=Object.assign(Object.create(t.Loader.prototype),{constructor:r,load:function(e,a,r,s){var i=this,n=""===i.path?function(e,t){var a=e.indexOf(t);return-1===a?"./":e.substr(0,a)}(e,"Objects"):i.path,o=e.split(n).pop().split(".")[0],p=new t.FileLoader(this.manager);p.setPath(i.path),p.setResponseType("arraybuffer"),p.load(e,(function(t){try{a(i.parse(t,n,o))}catch(t){s?s(t):console.error(t),i.manager.itemError(e)}}),r,s)},parse:function(r,i,n){return e=(new a.IFFParser).parse(r),new s(new t.TextureLoader(this.manager).setPath(this.resourcePath||i).setCrossOrigin(this.crossOrigin)).parse(n)}}),s.prototype={constructor:s,parse:function(e){return this.materials=new i(this.textureLoader).parse(),this.defaultLayerName=e,this.meshes=this.parseLayers(),{materials:this.materials,meshes:this.meshes}},parseLayers:function(){var t=[],a=[],r=new n,s=this;return e.layers.forEach((function(e){var i=r.parse(e.geometry,e),n=s.parseMesh(i,e);t[e.number]=n,-1===e.parent?a.push(n):t[e.parent].add(n)})),this.applyPivots(a),a},parseMesh:function(e,a){var r,s=this.getMaterials(e.userData.matNames,a.geometry.type);return this.duplicateUVs(e,s),r="points"===a.geometry.type?new t.Points(e,s):"lines"===a.geometry.type?new t.LineSegments(e,s):new t.Mesh(e,s),a.name?r.name=a.name:r.name=this.defaultLayerName+"_layer_"+a.number,r.userData.pivot=a.pivot,r},applyPivots:function(e){e.forEach((function(e){e.traverse((function(e){var t=e.userData.pivot;if(e.position.x+=t[0],e.position.y+=t[1],e.position.z+=t[2],e.parent){var a=e.parent.userData.pivot;e.position.x-=a[0],e.position.y-=a[1],e.position.z-=a[2]}}))}))},getMaterials:function(e,a){var r=[],s=this;e.forEach((function(e,t){r[t]=s.getMaterialByName(e)})),"points"!==a&&"lines"!==a||r.forEach((function(e,s){var i={color:e.color};"points"===a?(i.size=.1,i.map=e.map,i.morphTargets=e.morphTargets,r[s]=new t.PointsMaterial(i)):"lines"===a&&(r[s]=new t.LineBasicMaterial(i))}));var i=r.filter(Boolean);return 1===i.length?i[0]:r},getMaterialByName:function(e){return this.materials.filter((function(t){return t.name===e}))[0]},duplicateUVs:function(e,a){var r=!1;Array.isArray(a)?a.forEach((function(e){e.aoMap&&(r=!0)})):a.aoMap&&(r=!0),r&&e.setAttribute("uv2",new t.BufferAttribute(e.attributes.uv.array,2))}},i.prototype={constructor:i,parse:function(){var t=[];for(var a in this.textures={},e.materials)"LWO3"===e.format?t.push(this.parseMaterial(e.materials[a],a,e.textures)):"LWO2"===e.format&&t.push(this.parseMaterialLwo2(e.materials[a],a,e.textures));return t},parseMaterial:function(e,t,a){var r={name:t,side:this.getSide(e.attributes),flatShading:this.getSmooth(e.attributes)},s=this.parseConnections(e.connections,e.nodes),i=this.parseTextureNodes(s.maps);this.parseAttributeImageMaps(s.attributes,a,i,e.maps);var n=this.parseAttributes(s.attributes,i);return this.parseEnvMap(s,i,n),r=Object.assign(i,r),r=Object.assign(r,n),new(this.getMaterialType(s.attributes))(r)},parseMaterialLwo2:function(e,a){var r={name:a,side:this.getSide(e.attributes),flatShading:this.getSmooth(e.attributes)},s=this.parseAttributes(e.attributes,{});return r=Object.assign(r,s),new t.MeshPhongMaterial(r)},getSide:function(e){if(!e.side)return t.BackSide;switch(e.side){case 0:case 1:return t.BackSide;case 2:return t.FrontSide;case 3:return t.DoubleSide}},getSmooth:function(e){return!e.smooth||!e.smooth},parseConnections:function(e,t){var a={maps:{}},r=e.inputName,s=e.inputNodeName,i=e.nodeName,n=this;return r.forEach((function(e,r){if("Material"===e){var i=n.getNodeByRefName(s[r],t);a.attributes=i.attributes,a.envMap=i.fileName,a.name=s[r]}})),i.forEach((function(e,i){e===a.name&&(a.maps[r[i]]=n.getNodeByRefName(s[i],t))})),a},getNodeByRefName:function(e,t){for(var a in t)if(t[a].refName===e)return t[a]},parseTextureNodes:function(e){var a={};for(var r in e){var s=e[r],i=s.fileName;if(!i)return;var n=this.loadTexture(i);switch(void 0!==s.widthWrappingMode&&(n.wrapS=this.getWrappingType(s.widthWrappingMode)),void 0!==s.heightWrappingMode&&(n.wrapT=this.getWrappingType(s.heightWrappingMode)),r){case"Color":a.map=n;break;case"Roughness":a.roughnessMap=n,a.roughness=.5;break;case"Specular":a.specularMap=n,a.specular=16777215;break;case"Luminous":a.emissiveMap=n,a.emissive=8421504;break;case"Luminous Color":a.emissive=8421504;break;case"Metallic":a.metalnessMap=n,a.metalness=.5;break;case"Transparency":case"Alpha":a.alphaMap=n,a.transparent=!0;break;case"Normal":a.normalMap=n,void 0!==s.amplitude&&(a.normalScale=new t.Vector2(s.amplitude,s.amplitude));break;case"Bump":a.bumpMap=n}}return a.roughnessMap&&a.specularMap&&delete a.specularMap,a},parseAttributeImageMaps:function(e,t,a){for(var r in e){var s=e[r];if(s.maps){var i=s.maps[0],n=this.getTexturePathByIndex(i.imageIndex,t);if(!n)return;var o=this.loadTexture(n);switch(void 0!==i.wrap&&(o.wrapS=this.getWrappingType(i.wrap.w)),void 0!==i.wrap&&(o.wrapT=this.getWrappingType(i.wrap.h)),r){case"Color":a.map=o;break;case"Diffuse":a.aoMap=o;break;case"Roughness":a.roughnessMap=o,a.roughness=1;break;case"Specular":a.specularMap=o,a.specular=16777215;break;case"Luminosity":a.emissiveMap=o,a.emissive=8421504;break;case"Metallic":a.metalnessMap=o,a.metalness=1;break;case"Transparency":case"Alpha":a.alphaMap=o,a.transparent=!0;break;case"Normal":a.normalMap=o;break;case"Bump":a.bumpMap=o}}}},parseAttributes:function(e,a){var r={};return e.Color&&!a.map?r.color=(new t.Color).fromArray(e.Color.value):r.color=new t.Color,e.Transparency&&0!==e.Transparency.value&&(r.opacity=1-e.Transparency.value,r.transparent=!0),e["Bump Height"]&&(r.bumpScale=.1*e["Bump Height"].value),e["Refraction Index"]&&(r.refractionRatio=1/e["Refraction Index"].value),this.parsePhysicalAttributes(r,e,a),this.parseStandardAttributes(r,e,a),this.parsePhongAttributes(r,e,a),r},parsePhysicalAttributes:function(e,t){t.Clearcoat&&t.Clearcoat.value>0&&(e.clearcoat=t.Clearcoat.value,t["Clearcoat Gloss"]&&(e.clearcoatRoughness=.5*(1-t["Clearcoat Gloss"].value)))},parseStandardAttributes:function(e,a,r){a.Luminous&&(e.emissiveIntensity=a.Luminous.value,a["Luminous Color"]&&!r.emissive?e.emissive=(new t.Color).fromArray(a["Luminous Color"].value):e.emissive=new t.Color(8421504)),a.Roughness&&!r.roughnessMap&&(e.roughness=a.Roughness.value),a.Metallic&&!r.metalnessMap&&(e.metalness=a.Metallic.value)},parsePhongAttributes:function(e,a,r){a.Diffuse&&e.color.multiplyScalar(a.Diffuse.value),a.Reflection&&(e.reflectivity=a.Reflection.value,e.combine=t.AddOperation),a.Luminosity&&(e.emissiveIntensity=a.Luminosity.value,r.emissiveMap||r.map?e.emissive=new t.Color(8421504):e.emissive=e.color),a.Roughness||!a.Specular||r.specularMap||(a["Color Highlight"]?e.specular=(new t.Color).setScalar(a.Specular.value).lerp(e.color.clone().multiplyScalar(a.Specular.value),a["Color Highlight"].value):e.specular=(new t.Color).setScalar(a.Specular.value)),e.specular&&a.Glossiness&&(e.shininess=7+Math.pow(2,12*a.Glossiness.value+2))},parseEnvMap:function(e,a,r){if(e.envMap){var s=this.loadTexture(e.envMap);r.transparent&&r.opacity<.999?(s.mapping=t.EquirectangularRefractionMapping,void 0!==r.reflectivity&&(delete r.reflectivity,delete r.combine),void 0!==r.metalness&&delete r.metalness):s.mapping=t.EquirectangularReflectionMapping,a.envMap=s}},getTexturePathByIndex:function(t){var a="";return e.textures?(e.textures.forEach((function(e){e.index===t&&(a=e.fileName)})),a):a},loadTexture:function(e){return e?this.textureLoader.load(e,void 0,void 0,(function(){console.warn("LWOLoader: non-standard resource hierarchy. Use `resourcePath` parameter to specify root content directory.")})):null},getWrappingType:function(e){switch(e){case 0:return console.warn('LWOLoader: "Reset" texture wrapping type is not supported in three'),t.ClampToEdgeWrapping;case 1:return t.RepeatWrapping;case 2:return t.MirroredRepeatWrapping;case 3:return t.ClampToEdgeWrapping}},getMaterialType:function(e){return e.Clearcoat&&e.Clearcoat.value>0?t.MeshPhysicalMaterial:e.Roughness?t.MeshStandardMaterial:t.MeshPhongMaterial}},n.prototype={constructor:n,parse:function(e,a){var r=new t.BufferGeometry;r.setAttribute("position",new t.Float32BufferAttribute(e.points,3));var s=this.splitIndices(e.vertexIndices,e.polygonDimensions);return r.setIndex(s),this.parseGroups(r,e),r.computeVertexNormals(),this.parseUVs(r,a,s),this.parseMorphTargets(r,a,s),r.translate(-a.pivot[0],-a.pivot[1],-a.pivot[2]),r},splitIndices:function(e,t){var a=[],r=0;return t.forEach((function(t){if(t<4)for(var s=0;s<t;s++)a.push(e[r+s]);else if(4===t)a.push(e[r],e[r+1],e[r+2],e[r],e[r+2],e[r+3]);else if(t>4){for(var i=1;i<t-1;i++)a.push(e[r],e[r+i],e[r+i+1]);console.warn("LWOLoader: polygons with greater than 4 sides are not supported")}r+=t})),a},parseGroups:function(t,a){var r=e.tags,s=[],i=3;"lines"===a.type&&(i=2),"points"===a.type&&(i=1);for(var n,o=this.splitMaterialIndices(a.polygonDimensions,a.materialIndices),p=0,u={},c=0,l=0,h=0;h<o.length;h+=2){var m,f=o[h+1];if(0===h&&(s[p]=r[f]),void 0===n&&(n=f),f!==n)u[r[n]]?m=u[r[n]]:(m=p,u[r[n]]=p,s[p]=r[n],p++),t.addGroup(c,l,m),c+=l,n=f,l=0;l+=i}t.groups.length>0&&(u[r[f]]?m=u[r[f]]:(m=p,u[r[f]]=p,s[p]=r[f]),t.addGroup(c,l,m));t.userData.matNames=s},splitMaterialIndices:function(e,t){var a=[];return e.forEach((function(e,r){if(e<=3)a.push(t[2*r],t[2*r+1]);else if(4===e)a.push(t[2*r],t[2*r+1],t[2*r],t[2*r+1]);else for(var s=0;s<e-2;s++)a.push(t[2*r],t[2*r+1])})),a},parseUVs:function(e,a){var r=Array.from(Array(2*e.attributes.position.count),(function(){return 0}));for(var s in a.uvs){var i=a.uvs[s].uvs;a.uvs[s].uvIndices.forEach((function(e,t){r[2*e]=i[2*t],r[2*e+1]=i[2*t+1]}))}e.setAttribute("uv",new t.Float32BufferAttribute(r,2))},parseMorphTargets:function(e,a){var r=0;for(var s in a.morphTargets){var i=e.attributes.position.array.slice();e.morphAttributes.position||(e.morphAttributes.position=[]);var n=a.morphTargets[s].points,o=a.morphTargets[s].indices,p=a.morphTargets[s].type;o.forEach((function(e,t){"relative"===p?(i[3*e]+=n[3*t],i[3*e+1]+=n[3*t+1],i[3*e+2]+=n[3*t+2]):(i[3*e]=n[3*t],i[3*e+1]=n[3*t+1],i[3*e+2]=n[3*t+2])})),e.morphAttributes.position[r]=new t.Float32BufferAttribute(i,3),e.morphAttributes.position[r].name=s,r++}e.morphTargetsRelative=!1}},exports.LWOLoader=r;
