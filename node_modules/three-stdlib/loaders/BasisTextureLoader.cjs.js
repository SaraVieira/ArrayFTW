"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("@babel/runtime/helpers/extends"),t=require("three");function r(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var a=r(e),o=function(e){t.Loader.call(this,e),this.transcoderPath="",this.transcoderBinary=null,this.transcoderPending=null,this.workerLimit=4,this.workerPool=[],this.workerNextTaskID=1,this.workerSourceURL="",this.workerConfig=null};o.taskCache=new WeakMap,o.prototype=Object.assign(Object.create(t.Loader.prototype),{constructor:o,setTranscoderPath:function(e){return this.transcoderPath=e,this},setWorkerLimit:function(e){return this.workerLimit=e,this},detectSupport:function(e){return this.workerConfig={astcSupported:e.extensions.has("WEBGL_compressed_texture_astc"),etc1Supported:e.extensions.has("WEBGL_compressed_texture_etc1"),etc2Supported:e.extensions.has("WEBGL_compressed_texture_etc"),dxtSupported:e.extensions.has("WEBGL_compressed_texture_s3tc"),bptcSupported:e.extensions.has("EXT_texture_compression_bptc"),pvrtcSupported:e.extensions.has("WEBGL_compressed_texture_pvrtc")||e.extensions.has("WEBKIT_WEBGL_compressed_texture_pvrtc")},this},load:function(e,r,a,i){var s=this,n=new t.FileLoader(this.manager);n.setResponseType("arraybuffer"),n.setWithCredentials(this.withCredentials);var d=new t.CompressedTexture;return n.load(e,(function(e){if(o.taskCache.has(e))return o.taskCache.get(e).promise.then(r).catch(i);s._createTexture([e]).then((function(e){d.copy(e),d.needsUpdate=!0,r&&r(d)})).catch(i)}),a,i),d},parseInternalAsync:function(e){for(var t=e.levels,r=new Set,o=0;o<t.length;o++)r.add(t[o].data.buffer);return this._createTexture(Array.from(r),a.default({},e,{lowLevel:!0}))},_createTexture:function(e,r){for(var a,i,s=this,n=r||{},d=0,c=0;c<e.length;c++)d+=e[c].byteLength;var h=this._allocateWorker(d).then((function(t){return a=t,i=s.workerNextTaskID++,new Promise((function(t,r){a._callbacks[i]={resolve:t,reject:r},a.postMessage({type:"transcode",id:i,buffers:e,taskConfig:n},e)}))})).then((function(e){var r=e.mipmaps,a=e.width,o=e.height,i=e.format,s=new t.CompressedTexture(r,a,o,i,t.UnsignedByteType);return s.minFilter=1===r.length?t.LinearFilter:t.LinearMipmapLinearFilter,s.magFilter=t.LinearFilter,s.generateMipmaps=!1,s.needsUpdate=!0,s}));return h.catch((function(){return!0})).then((function(){a&&i&&(a._taskLoad-=d,delete a._callbacks[i])})),o.taskCache.set(e[0],{promise:h}),h},_initTranscoder:function(){var e=this;if(!this.transcoderPending){var r=new t.FileLoader(this.manager);r.setPath(this.transcoderPath),r.setWithCredentials(this.withCredentials);var a=new Promise((function(e,t){r.load("basis_transcoder.js",e,void 0,t)})),i=new t.FileLoader(this.manager);i.setPath(this.transcoderPath),i.setResponseType("arraybuffer"),i.setWithCredentials(this.withCredentials);var s=new Promise((function(e,t){i.load("basis_transcoder.wasm",e,void 0,t)}));this.transcoderPending=Promise.all([a,s]).then((function(t){var r=t[0],a=t[1],i=o.BasisWorker.toString(),s=["/* constants */","var _EngineFormat = "+JSON.stringify(o.EngineFormat),"var _TranscoderFormat = "+JSON.stringify(o.TranscoderFormat),"var _BasisFormat = "+JSON.stringify(o.BasisFormat),"/* basis_transcoder.js */",r,"/* worker */",i.substring(i.indexOf("{")+1,i.lastIndexOf("}"))].join("\n");e.workerSourceURL=URL.createObjectURL(new Blob([s])),e.transcoderBinary=a}))}return this.transcoderPending},_allocateWorker:function(e){var t=this;return this._initTranscoder().then((function(){var r;t.workerPool.length<t.workerLimit?((r=new Worker(t.workerSourceURL))._callbacks={},r._taskLoad=0,r.postMessage({type:"init",config:t.workerConfig,transcoderBinary:t.transcoderBinary}),r.onmessage=function(e){var t=e.data;switch(t.type){case"transcode":r._callbacks[t.id].resolve(t);break;case"error":r._callbacks[t.id].reject(t);break;default:console.error('THREE.BasisTextureLoader: Unexpected message, "'+t.type+'"')}},t.workerPool.push(r)):t.workerPool.sort((function(e,t){return e._taskLoad>t._taskLoad?-1:1}));return(r=t.workerPool[t.workerPool.length-1])._taskLoad+=e,r}))},dispose:function(){for(var e=0;e<this.workerPool.length;e++)this.workerPool[e].terminate();return this.workerPool.length=0,this}}),o.BasisFormat={ETC1S:0,UASTC_4x4:1},o.TranscoderFormat={ETC1:0,ETC2:1,BC1:2,BC3:3,BC4:4,BC5:5,BC7_M6_OPAQUE_ONLY:6,BC7_M5:7,PVRTC1_4_RGB:8,PVRTC1_4_RGBA:9,ASTC_4x4:10,ATC_RGB:11,ATC_RGBA_INTERPOLATED_ALPHA:12,RGBA32:13,RGB565:14,BGR565:15,RGBA4444:16},o.EngineFormat={RGBAFormat:t.RGBAFormat,RGBA_ASTC_4x4_Format:t.RGBA_ASTC_4x4_Format,RGBA_BPTC_Format:t.RGBA_BPTC_Format,RGBA_ETC2_EAC_Format:t.RGBA_ETC2_EAC_Format,RGBA_PVRTC_4BPPV1_Format:t.RGBA_PVRTC_4BPPV1_Format,RGBA_S3TC_DXT5_Format:t.RGBA_S3TC_DXT5_Format,RGB_ETC1_Format:t.RGB_ETC1_Format,RGB_ETC2_Format:t.RGB_ETC2_Format,RGB_PVRTC_4BPPV1_Format:t.RGB_PVRTC_4BPPV1_Format,RGB_S3TC_DXT1_Format:t.RGB_S3TC_DXT1_Format},o.BasisWorker=function(){var e,t,r,a=_EngineFormat,o=_TranscoderFormat,i=_BasisFormat;onmessage=function(a){var o,s=a.data;switch(s.type){case"init":e=s.config,o=s.transcoderBinary,t=new Promise((function(e){r={wasmBinary:o,onRuntimeInitialized:e},BASIS(r)})).then((function(){r.initializeBasis()}));break;case"transcode":t.then((function(){try{for(var e=s.taskConfig.lowLevel?function(e){var t=e.basisFormat,a=e.width,o=e.height,s=e.hasAlpha,n=c(t,a,o,s),d=n.transcoderFormat,T=n.engineFormat,u=r.getBytesPerBlockOrPixel(d);h(r.isFormatSupported(d),"THREE.BasisTextureLoader: Unsupported format.");var f=[];if(t===i.ETC1S){var p=new r.LowLevelETC1SImageTranscoder,C=e.globalData,g=C.endpointCount,B=C.endpointsData,w=C.selectorCount,F=C.selectorsData,S=C.tablesData;try{h(p.decodePalettes(g,B,w,F),"THREE.BasisTextureLoader: decodePalettes() failed."),h(p.decodeTables(S),"THREE.BasisTextureLoader: decodeTables() failed.");for(var R=0;R<e.levels.length;R++){var A=e.levels[R],E=e.globalData.imageDescs[R],P=l(d,A.width,A.height),x=new Uint8Array(P);h(p.transcodeImage(d,x,P/u,A.data,_(d,A.width),m(d,A.height),A.width,A.height,A.index,E.rgbSliceByteOffset,E.rgbSliceByteLength,E.alphaSliceByteOffset,E.alphaSliceByteLength,E.imageFlags,s,!1,0,0),"THREE.BasisTextureLoader: transcodeImage() failed for level "+A.index+"."),f.push({data:x,width:A.width,height:A.height})}}finally{p.delete()}}else for(var y=0;y<e.levels.length;y++){P=l(d,(A=e.levels[y]).width,A.height),x=new Uint8Array(P);h(r.transcodeUASTCImage(d,x,P/u,A.data,_(d,A.width),m(d,A.height),A.width,A.height,A.index,0,A.data.byteLength,0,s,!1,0,0,-1,-1),"THREE.BasisTextureLoader: transcodeUASTCImage() failed for level "+A.index+"."),f.push({data:x,width:A.width,height:A.height})}return{width:a,height:o,hasAlpha:s,mipmaps:f,format:T}}(s.taskConfig):function(e){var t=new r.BasisFile(new Uint8Array(e)),a=t.isUASTC()?i.UASTC_4x4:i.ETC1S,o=t.getImageWidth(0,0),s=t.getImageHeight(0,0),n=t.getNumLevels(0),d=t.getHasAlpha();function h(){t.close(),t.delete()}var _=c(a,o,s,d),m=_.transcoderFormat,l=_.engineFormat;if(!o||!s||!n)throw h(),new Error("THREE.BasisTextureLoader:\tInvalid texture");if(!t.startTranscoding())throw h(),new Error("THREE.BasisTextureLoader: .startTranscoding failed");for(var T=[],u=0;u<n;u++){var f=t.getImageWidth(0,u),p=t.getImageHeight(0,u),C=new Uint8Array(t.getImageTranscodedSizeInBytes(0,u,m));if(!t.transcodeImage(C,0,u,m,0,d))throw h(),new Error("THREE.BasisTextureLoader: .transcodeImage failed.");T.push({data:C,width:f,height:p})}return h(),{width:o,height:s,hasAlpha:d,mipmaps:T,format:l}}(s.buffers[0]),t=e.width,a=e.height,o=e.hasAlpha,n=e.mipmaps,d=e.format,T=[],u=0;u<n.length;++u)T.push(n[u].data.buffer);self.postMessage({type:"transcode",id:s.id,width:t,height:a,hasAlpha:o,mipmaps:n,format:d},T)}catch(e){console.error(e),self.postMessage({type:"error",id:s.id,error:e.message})}}))}};var s=[{if:"astcSupported",basisFormat:[i.UASTC_4x4],transcoderFormat:[o.ASTC_4x4,o.ASTC_4x4],engineFormat:[a.RGBA_ASTC_4x4_Format,a.RGBA_ASTC_4x4_Format],priorityETC1S:1/0,priorityUASTC:1,needsPowerOfTwo:!1},{if:"bptcSupported",basisFormat:[i.ETC1S,i.UASTC_4x4],transcoderFormat:[o.BC7_M5,o.BC7_M5],engineFormat:[a.RGBA_BPTC_Format,a.RGBA_BPTC_Format],priorityETC1S:3,priorityUASTC:2,needsPowerOfTwo:!1},{if:"dxtSupported",basisFormat:[i.ETC1S,i.UASTC_4x4],transcoderFormat:[o.BC1,o.BC3],engineFormat:[a.RGB_S3TC_DXT1_Format,a.RGBA_S3TC_DXT5_Format],priorityETC1S:4,priorityUASTC:5,needsPowerOfTwo:!1},{if:"etc2Supported",basisFormat:[i.ETC1S,i.UASTC_4x4],transcoderFormat:[o.ETC1,o.ETC2],engineFormat:[a.RGB_ETC2_Format,a.RGBA_ETC2_EAC_Format],priorityETC1S:1,priorityUASTC:3,needsPowerOfTwo:!1},{if:"etc1Supported",basisFormat:[i.ETC1S,i.UASTC_4x4],transcoderFormat:[o.ETC1,o.ETC1],engineFormat:[a.RGB_ETC1_Format,a.RGB_ETC1_Format],priorityETC1S:2,priorityUASTC:4,needsPowerOfTwo:!1},{if:"pvrtcSupported",basisFormat:[i.ETC1S,i.UASTC_4x4],transcoderFormat:[o.PVRTC1_4_RGB,o.PVRTC1_4_RGBA],engineFormat:[a.RGB_PVRTC_4BPPV1_Format,a.RGBA_PVRTC_4BPPV1_Format],priorityETC1S:5,priorityUASTC:6,needsPowerOfTwo:!0}],n=s.sort((function(e,t){return e.priorityETC1S-t.priorityETC1S})),d=s.sort((function(e,t){return e.priorityUASTC-t.priorityUASTC}));function c(t,r,s,c){for(var h=t===i.ETC1S?n:d,_=0;_<h.length;_++){var m=h[_];if(e[m.if]&&(m.basisFormat.includes(t)&&(!m.needsPowerOfTwo||T(r)&&T(s))))return{transcoderFormat:m.transcoderFormat[c?1:0],engineFormat:m.engineFormat[c?1:0]}}return console.warn("THREE.BasisTextureLoader: No suitable compressed texture format found. Decoding to RGBA32."),{transcoderFormat:o.RGBA32,engineFormat:a.RGBAFormat}}function h(e,t){if(!e)throw new Error(t)}function _(e,t){return Math.ceil(t/r.getFormatBlockWidth(e))}function m(e,t){return Math.ceil(t/r.getFormatBlockHeight(e))}function l(e,t,a){var i=r.getBytesPerBlockOrPixel(e);if(r.formatIsUncompressed(e))return t*a*i;if(e===o.PVRTC1_4_RGB||e===o.PVRTC1_4_RGBA){var s=t+3&-4,n=a+3&-4;return(Math.max(8,s)*Math.max(8,n)*4+7)/8}return _(e,t)*m(e,a)*i}function T(e){return e<=2||0==(e&e-1)&&0!==e}},exports.BasisTextureLoader=o;
