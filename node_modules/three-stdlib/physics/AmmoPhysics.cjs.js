"use strict";function e(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}Object.defineProperty(exports,"__esModule",{value:!0});var t=e(require("@babel/runtime/helpers/asyncToGenerator"));function n(){return(n=t.default(regeneratorRuntime.mark((function e(){var t,n,i,o,a,s,c,u,d,l,f,w,y,p,b,g;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(g=function(){var e=performance.now();if(b>0){var t=(e-b)/1e3;s.stepSimulation(t,10)}b=e;for(var n=0,i=d.length;n<i;n++){var o=d[n];if(o.isInstancedMesh){for(var a=o.instanceMatrix.array,u=l.get(o),f=0;f<u.length;f++){u[f].getMotionState().getWorldTransform(c),r(c.getOrigin(),c.getRotation(),a,16*f)}o.instanceMatrix.needsUpdate=!0}else if(o.isMesh){l.get(o).getMotionState().getWorldTransform(c);var w=c.getOrigin(),y=c.getRotation();o.position.set(w.x(),w.y(),w.z()),o.quaternion.set(y.x(),y.y(),y.z(),y.w())}}},p=function(e,n,r){if(void 0===r&&(r=0),e.isInstancedMesh){var i=l.get(e)[r];i.setAngularVelocity(new t.btVector3(0,0,0)),i.setLinearVelocity(new t.btVector3(0,0,0)),c.setIdentity(),c.setOrigin(new t.btVector3(n.x,n.y,n.z)),i.setWorldTransform(c)}else if(e.isMesh){var o=l.get(e);o.setAngularVelocity(new t.btVector3(0,0,0)),o.setLinearVelocity(new t.btVector3(0,0,0)),c.setIdentity(),c.setOrigin(new t.btVector3(n.x,n.y,n.z)),o.setWorldTransform(c)}},y=function(e,n,r){for(var i=e.instanceMatrix.array,o=[],a=0;a<e.count;a++){var c=16*a,u=new t.btTransform;u.setFromOpenGLMatrix(i.slice(c,c+16));var f=new t.btDefaultMotionState(u),w=new t.btVector3(0,0,0);r.calculateLocalInertia(n,w);var y=new t.btRigidBodyConstructionInfo(n,f,r,w),p=new t.btRigidBody(y);s.addRigidBody(p),o.push(p)}n>0&&(e.instanceMatrix.setUsage(35048),d.push(e),l.set(e,o))},w=function(e,n,r){var i=e.position,o=e.quaternion,a=new t.btTransform;a.setIdentity(),a.setOrigin(new t.btVector3(i.x,i.y,i.z)),a.setRotation(new t.btQuaternion(o.x,o.y,o.z,o.w));var c=new t.btDefaultMotionState(a),u=new t.btVector3(0,0,0);r.calculateLocalInertia(n,u);var f=new t.btRigidBodyConstructionInfo(n,c,r,u),w=new t.btRigidBody(f);s.addRigidBody(w),n>0&&(d.push(e),l.set(e,w))},f=function(e,t){void 0===t&&(t=0);var n=u(e.geometry);null!==n&&(e.isInstancedMesh?y(e,t,n):e.isMesh&&w(e,t,n))},u=function(e){var n=e.parameters;if("BoxGeometry"===e.type){var r=void 0!==n.width?n.width/2:.5,i=void 0!==n.height?n.height/2:.5,o=void 0!==n.depth?n.depth/2:.5,a=new t.btBoxShape(new t.btVector3(r,i,o));return a.setMargin(.05),a}if("SphereGeometry"===e.type||"IcosahedronGeometry"===e.type){var s=void 0!==n.radius?n.radius:1,c=new t.btSphereShape(s);return c.setMargin(.05),c}return null},"Ammo"in window!=!1){e.next=9;break}return console.error("AmmoPhysics: Couldn't find Ammo.js"),e.abrupt("return");case 9:return e.next=11,Ammo();case 11:return t=e.sent,60,n=new t.btDefaultCollisionConfiguration,i=new t.btCollisionDispatcher(n),o=new t.btDbvtBroadphase,a=new t.btSequentialImpulseConstraintSolver,(s=new t.btDiscreteDynamicsWorld(i,o,a,n)).setGravity(new t.btVector3(0,-9.8,0)),c=new t.btTransform,d=[],l=new WeakMap,b=0,setInterval(g,1e3/60),e.abrupt("return",{addMesh:f,setMeshPosition:p});case 25:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function r(e,t,n,r){var i=t.x(),o=t.y(),a=t.z(),s=t.w(),c=i+i,u=o+o,d=a+a,l=i*c,f=i*u,w=i*d,y=o*u,p=o*d,b=a*d,g=s*c,h=s*u,v=s*d;n[r+0]=1-(y+b),n[r+1]=f+v,n[r+2]=w-h,n[r+3]=0,n[r+4]=f-v,n[r+5]=1-(l+b),n[r+6]=p+g,n[r+7]=0,n[r+8]=w+h,n[r+9]=p-g,n[r+10]=1-(l+y),n[r+11]=0,n[r+12]=e.x(),n[r+13]=e.y(),n[r+14]=e.z(),n[r+15]=1}exports.AmmoPhysics=function(){return n.apply(this,arguments)};
