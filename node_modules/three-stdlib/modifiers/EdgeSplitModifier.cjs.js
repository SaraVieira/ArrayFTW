"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("@babel/runtime/helpers/defineProperty"),t=require("three"),r=require("../BufferGeometryUtils-62c024b1.js");function n(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}require("../types/helpers.cjs.js");var o=n(e);function i(e,t){var r;if("undefined"==typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(r=function(e,t){if(!e)return;if("string"==typeof e)return s(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);"Object"===r&&e.constructor&&(r=e.constructor.name);if("Map"===r||"Set"===r)return Array.from(e);if("Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r))return s(e,t)}(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var n=0;return function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}return(r=e[Symbol.iterator]()).next.bind(r)}function s(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}exports.EdgeSplitModifier=function(){var e=this;o.default(this,"A",new t.Vector3),o.default(this,"B",new t.Vector3),o.default(this,"C",new t.Vector3),o.default(this,"positions",[]),o.default(this,"normals",new Float32Array),o.default(this,"indexes",[]),o.default(this,"pointToIndexMap",[]),o.default(this,"splitIndexes",[]),o.default(this,"oldNormals",[]),o.default(this,"computeNormals",(function(){e.normals=new Float32Array(3*e.indexes.length);for(var t=0;t<e.indexes.length;t+=3){var r=e.indexes[t];e.A.set(e.positions[3*r],e.positions[3*r+1],e.positions[3*r+2]),r=e.indexes[t+1],e.B.set(e.positions[3*r],e.positions[3*r+1],e.positions[3*r+2]),r=e.indexes[t+2],e.C.set(e.positions[3*r],e.positions[3*r+1],e.positions[3*r+2]),e.C.sub(e.B),e.A.sub(e.B);for(var n=e.C.cross(e.A).normalize(),o=0;o<3;o++)e.normals[3*(t+o)]=n.x,e.normals[3*(t+o)+1]=n.y,e.normals[3*(t+o)+2]=n.z}})),o.default(this,"mapPositionsToIndexes",(function(){e.pointToIndexMap=Array(e.positions.length/3);for(var t=0;t<e.indexes.length;t++){var r=e.indexes[t];null==e.pointToIndexMap[r]&&(e.pointToIndexMap[r]=[]),e.pointToIndexMap[r].push(t)}})),o.default(this,"edgeSplitToGroups",(function(t,r,n){e.A.set(e.normals[3*n],e.normals[3*n+1],e.normals[3*n+2]).normalize();for(var o,s={splitGroup:[],currentGroup:[n]},a=i(t);!(o=a()).done;){var l=o.value;l!==n&&(e.B.set(e.normals[3*l],e.normals[3*l+1],e.normals[3*l+2]).normalize(),e.B.dot(e.A)<r?s.splitGroup.push(l):s.currentGroup.push(l))}return s})),o.default(this,"edgeSplit",(function(t,r,n){if(void 0===n&&(n=null),0!==t.length){for(var o,s=[],a=i(t);!(o=a()).done;){var l=o.value;s.push(e.edgeSplitToGroups(t,r,l))}for(var u=s[0],d=0,p=s;d<p.length;d++){var f=p[d];f.currentGroup.length>u.currentGroup.length&&(u=f)}null!=n&&e.splitIndexes.push({original:n,indexes:u.currentGroup}),u.splitGroup.length&&e.edgeSplit(u.splitGroup,r,n||u.currentGroup[0])}})),o.default(this,"modify",(function(n,o,s){void 0===s&&(s=!0);var a=!1;if(n.attributes.normal&&(a=!0,n=n.clone(),!0===s&&null!==n.index&&(e.oldNormals=n.attributes.normal.array),n.deleteAttribute("normal")),null==n.index){if(void 0===r.BufferGeometryUtils)throw"THREE.EdgeSplitModifier relies on BufferGeometryUtils";n=r.mergeVertices(n)}e.indexes=n.index.array,e.positions=n.getAttribute("position").array,e.computeNormals(),e.mapPositionsToIndexes(),e.splitIndexes=[];for(var l,u=i(e.pointToIndexMap);!(l=u()).done;){var d=l.value;e.edgeSplit(d,Math.cos(o)-.001)}for(var p={},f=0,m=Object.keys(n.attributes);f<m.length;f++){var h=m[f],c=n.attributes[h],v=new c.array.constructor((e.indexes.length+e.splitIndexes.length)*c.itemSize);v.set(c.array),p[h]=new t.BufferAttribute(v,c.itemSize,c.normalized)}var x=new Uint32Array(e.indexes.length);x.set(e.indexes);for(var y=0;y<e.splitIndexes.length;y++){for(var g=e.splitIndexes[y],b=e.indexes[g.original],A=0,I=Object.values(p);A<I.length;A++)for(var S=I[A],G=0;G<S.itemSize;G++)S.array[(e.indexes.length+y)*S.itemSize+G]=S.array[b*S.itemSize+G];for(var w,B=i(g.indexes);!(w=B()).done;){x[w.value]=e.indexes.length+y}}(n=new t.BufferGeometry).setIndex(new t.BufferAttribute(x,1));for(var T=0,j=Object.keys(p);T<j.length;T++){var M=j[T];n.setAttribute(M,p[M])}if(a&&(n.computeVertexNormals(),null!==e.oldNormals)){for(var z,N=new Array(e.oldNormals.length/3).fill(!1),O=i(e.splitIndexes);!(z=O()).done;){N[z.value.original]=!0}for(var C=0;C<N.length;C++)if(!1===N[C])for(var E=0;E<3;E++)n.attributes.normal.array[3*C+E]=e.oldNormals[3*C+E]}return n}))};
