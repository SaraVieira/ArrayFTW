"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var t=require("@babel/runtime/helpers/assertThisInitialized"),i=require("@babel/runtime/helpers/inheritsLoose"),e=require("three");function n(t){return t&&"object"==typeof t&&"default"in t?t:{default:t}}var r=n(t),s=n(i),a=function(){function t(t,i,n,r,s){var a=this;this.xrLight=t,this.renderer=i,this.lightProbe=n,this.xrWebGLBinding=null,this.estimationStartCallback=s,this.frameCallback=this.onXRFrame.bind(this);var o=i.xr.getSession();if(r&&"XRWebGLBinding"in window){var h=new e.WebGLCubeRenderTarget(16);t.environment=h.texture;var l=i.getContext();switch(o.preferredReflectionFormat){case"srgba8":l.getExtension("EXT_sRGB");break;case"rgba16f":l.getExtension("OES_texture_half_float")}this.xrWebGLBinding=new XRWebGLBinding(o,l),this.lightProbe.addEventListener("reflectionchange",(function(){a.updateReflection()}))}o.requestAnimationFrame(this.frameCallback)}var i=t.prototype;return i.updateReflection=function(){var t=this.renderer.properties.get(this.xrLight.environment);if(t){var i=this.xrWebGLBinding.getReflectionCubeMap(this.lightProbe);i&&(t.__webglTexture=i)}},i.onXRFrame=function(t,i){if(this.xrLight){i.session.requestAnimationFrame(this.frameCallback);var e=i.getLightEstimate(this.lightProbe);if(e){this.xrLight.lightProbe.sh.fromArray(e.sphericalHarmonicsCoefficients),this.xrLight.lightProbe.intensity=1;var n=Math.max(1,Math.max(e.primaryLightIntensity.x,Math.max(e.primaryLightIntensity.y,e.primaryLightIntensity.z)));this.xrLight.directionalLight.color.setRGB(e.primaryLightIntensity.x/n,e.primaryLightIntensity.y/n,e.primaryLightIntensity.z/n),this.xrLight.directionalLight.intensity=n,this.xrLight.directionalLight.position.copy(e.primaryLightDirection),this.estimationStartCallback&&(this.estimationStartCallback(),this.estimationStartCallback=null)}}},i.dispose=function(){this.xrLight=null,this.renderer=null,this.lightProbe=null,this.xrWebGLBinding=null},t}(),o=function(t){function i(i,n){var s;void 0===n&&(n=!0),(s=t.call(this)||this).lightProbe=new e.LightProbe,s.lightProbe.intensity=0,s.add(s.lightProbe),s.directionalLight=new e.DirectionalLight,s.directionalLight.intensity=0,s.add(s.directionalLight),s.environment=null;var o=null,h=!1;return i.xr.addEventListener("sessionstart",(function(){var t=i.xr.getSession();"requestLightProbe"in t&&t.requestLightProbe({reflectionFormat:t.preferredReflectionFormat}).then((function(t){o=new a(r.default(s),i,t,n,(function(){h=!0,s.dispatchEvent({type:"estimationstart"})}))}))})),i.xr.addEventListener("sessionend",(function(){o&&(o.dispose(),o=null),h&&s.dispatchEvent({type:"estimationend"})})),s.dispose=function(){o&&(o.dispose(),o=null),s.remove(s.lightProbe),s.lightProbe=null,s.remove(s.directionalLight),s.directionalLight=null,s.environment=null},s}return s.default(i,t),i}(e.Group);exports.XREstimatedLight=o;
