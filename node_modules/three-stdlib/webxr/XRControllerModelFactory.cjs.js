"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("three"),o=require("../loaders/GLTFLoader.cjs.js"),t=require("@webxr-input-profiles/motion-controllers");function n(){e.Object3D.call(this),this.motionController=null,this.envMap=null}function r(o,n){!function(o,n){Object.values(o.components).forEach((function(o){var r=o.type,a=o.touchPointNodeName,i=o.visualResponses;if(r===t.Constants.ComponentType.TOUCHPAD)if(o.touchPointNode=n.getObjectByName(a),o.touchPointNode){var s=new e.SphereGeometry(.001),l=new e.MeshBasicMaterial({color:255}),c=new e.Mesh(s,l);o.touchPointNode.add(c)}else console.warn("Could not find touch dot, "+o.touchPointNodeName+", in touchpad component "+o.id);Object.values(i).forEach((function(e){var o=e.valueNodeName,r=e.minNodeName,a=e.maxNodeName;if(e.valueNodeProperty===t.Constants.VisualResponseProperty.TRANSFORM){if(e.minNode=n.getObjectByName(r),e.maxNode=n.getObjectByName(a),!e.minNode)return void console.warn("Could not find "+r+" in the model");if(!e.maxNode)return void console.warn("Could not find "+a+" in the model")}e.valueNode=n.getObjectByName(o),e.valueNode||console.warn("Could not find "+o+" in the model")}))}))}(o.motionController,n),o.envMap&&n.traverse((function(e){e.isMesh&&(e.material.envMap=o.envMap,e.material.needsUpdate=!0)})),o.add(n)}n.prototype=Object.assign(Object.create(e.Object3D.prototype),{constructor:n,setEnvironmentMap:function(e){var o=this;return this.envMap==e||(this.envMap=e,this.traverse((function(e){e.isMesh&&(e.material.envMap=o.envMap,e.material.needsUpdate=!0)}))),this},updateMatrixWorld:function(o){e.Object3D.prototype.updateMatrixWorld.call(this,o),this.motionController&&(this.motionController.updateFromGamepad(),Object.values(this.motionController.components).forEach((function(o){Object.values(o.visualResponses).forEach((function(o){var n=o.valueNode,r=o.minNode,a=o.maxNode,i=o.value,s=o.valueNodeProperty;n&&(s===t.Constants.VisualResponseProperty.VISIBILITY?n.visible=i:s===t.Constants.VisualResponseProperty.TRANSFORM&&(e.Quaternion.slerp(r.quaternion,a.quaternion,n.quaternion,i),n.position.lerpVectors(r.position,a.position,i)))}))})))}});var a=function(){function e(e){void 0===e&&(e=null),this.gltfLoader=e,this.path="https://cdn.jsdelivr.net/npm/@webxr-input-profiles/assets@1.0/dist/profiles",this._assetCache={},this.gltfLoader||(this.gltfLoader=new o.GLTFLoader)}return e.prototype={constructor:e,createControllerModel:function(e){var o=this,a=new n,i=null;return e.addEventListener("connected",(function(e){var n=e.data;"tracked-pointer"===n.targetRayMode&&n.gamepad&&t.fetchProfile(n,o.path,"generic-trigger").then((function(e){var s=e.profile,l=e.assetPath;a.motionController=new t.MotionController(n,s,l);var c=o._assetCache[a.motionController.assetUrl];if(c)i=c.scene.clone(),r(a,i);else{if(!o.gltfLoader)throw new Error("GLTFLoader not set.");o.gltfLoader.setPath(""),o.gltfLoader.load(a.motionController.assetUrl,(function(e){o._assetCache[a.motionController.assetUrl]=e,i=e.scene.clone(),r(a,i)}),null,(function(){throw new Error("Asset "+a.motionController.assetUrl+" missing or malformed.")}))}})).catch((function(e){console.warn(e)}))})),e.addEventListener("disconnected",(function(){a.motionController=null,a.remove(i),i=null})),a}},e}();exports.XRControllerModelFactory=a;
