"use strict";function e(e,r){var i;if("undefined"==typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(i=function(e,r){if(!e)return;if("string"==typeof e)return t(e,r);var i=Object.prototype.toString.call(e).slice(8,-1);"Object"===i&&e.constructor&&(i=e.constructor.name);if("Map"===i||"Set"===i)return Array.from(e);if("Arguments"===i||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(i))return t(e,r)}(e))||r&&e&&"number"==typeof e.length){i&&(e=i);var u=0;return function(){return u>=e.length?{done:!0}:{done:!1,value:e[u++]}}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}return(i=e[Symbol.iterator]()).next.bind(i)}function t(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,i=new Array(t);r<t;r++)i[r]=e[r];return i}var r=function(){function t(e,t,r,i,u,a,n,s){this.device=e,this.info=t,this.properties=r,this.textures=i,this.pipelines=u,this.computePipelines=a,this.attributes=n,this.nodes=s,this.uniformsData=new WeakMap,this.updateMap=new WeakMap}var r=t.prototype;return r.get=function(e){var t=this.uniformsData.get(e);if(void 0===t){var r=this.pipelines.get(e),i=e.material,u=this.nodes.get(i).getBindings(),a=r.getBindGroupLayout(0);t={layout:a,group:this._createBindGroup(u,a),bindings:u},this.uniformsData.set(e,t)}return t},r.getForCompute=function(e){var t=this.uniformsData.get(e);if(void 0===t){var r=this.computePipelines.get(e),i=void 0!==e.bindings?e.bindings.slice():[],u=r.getBindGroupLayout(0);t={layout:u,group:this._createBindGroup(i,u),bindings:i},this.uniformsData.set(e,t)}return t},r.update=function(t,r){for(var i,u=this.textures,a=this.get(t),n=a.bindings,s=this.updateMap,o=this.info.render.frame,f=!1,p=e(n);!(i=p()).done;){var l=i.value,d=l.isShared,h=s.get(l)===o;if(!d||!h){if(l.isUniformsGroup){var g=l.array,m=l.bufferGPU;l.onBeforeUpdate(t,r),!0===l.update()&&this.device.queue.writeBuffer(m,0,g,0)}else if(l.isStorageBuffer){var c=l.attribute;this.attributes.update(c,!1,l.usage)}else if(l.isSampler){var b=l.texture;u.updateSampler(b);var v=u.getSampler(b);l.samplerGPU!==v&&(l.samplerGPU=v,f=!0)}else if(l.isSampledTexture){var G=l.texture,y=u.updateTexture(G),U=u.getTextureGPU(G);l.textureGPU===U&&!0!==y||(l.textureGPU=U,f=!0)}s.set(l,o)}}!0===f&&(a.group=this._createBindGroup(n,a.layout))},r.dispose=function(){this.uniformsData=new WeakMap,this.updateMap=new WeakMap},r._createBindGroup=function(t,r){for(var i,u=0,a=[],n=e(t);!(i=n()).done;){var s=i.value;if(s.isUniformsGroup){if(null===s.bufferGPU){var o=s.getByteLength();s.array=new Float32Array(new ArrayBuffer(o)),s.bufferGPU=this.device.createBuffer({size:o,usage:s.usage})}a.push({binding:u,resource:{buffer:s.bufferGPU}})}else if(s.isStorageBuffer){if(null===s.bufferGPU){var f=s.attribute;this.attributes.update(f,!1,s.usage),s.bufferGPU=this.attributes.get(f).buffer}a.push({binding:u,resource:{buffer:s.bufferGPU}})}else s.isSampler?(null===s.samplerGPU&&(s.samplerGPU=this.textures.getDefaultSampler()),a.push({binding:u,resource:s.samplerGPU})):s.isSampledTexture&&(null===s.textureGPU&&(s.isSampledCubeTexture?s.textureGPU=this.textures.getDefaultCubeTexture():s.textureGPU=this.textures.getDefaultTexture()),a.push({binding:u,resource:s.textureGPU.createView({dimension:s.dimension})}));u++}return this.device.createBindGroup({layout:r,entries:a})},t}();module.exports=r;
