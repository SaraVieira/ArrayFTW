"use strict";var e=require("@babel/runtime/helpers/inherits");require("@babel/runtime/helpers/possibleConstructorReturn"),require("@babel/runtime/helpers/getPrototypeOf");var t=require("@babel/runtime/helpers/wrapNativeSuper"),r=require("./constants.cjs.js"),a=require("three");function n(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var o=n(e),i=n(t);function l(e,t){l=function(e,t){return new c(e,void 0,t)};var r=i.default(RegExp),a=RegExp.prototype,n=new WeakMap;function c(e,t,a){var o=r.call(this,e,t);return n.set(o,a||n.get(e)),o}function s(e,t){var r=n.get(t);return Object.keys(r).reduce((function(t,a){return t[a]=e[r[a]],t}),Object.create(null))}return o.default(c,r),c.prototype.exec=function(e){var t=a.exec.call(this,e);return t&&(t.groups=s(t,this)),t},c.prototype[Symbol.replace]=function(e,t){if("string"==typeof t){var r=n.get(this);return a[Symbol.replace].call(this,e,t.replace(/\$<([^>]+)>/g,(function(e,t){return"$"+r[t]})))}if("function"==typeof t){var o=this;return a[Symbol.replace].call(this,e,(function(){var e=[];return e.push.apply(e,arguments),"object"!=typeof e[e.length-1]&&e.push(s(e,o)),t.apply(this,e)}))}return a[Symbol.replace].call(this,e,t)},l.apply(this,arguments)}function c(e,t){var r;if("undefined"==typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(r=function(e,t){if(!e)return;if("string"==typeof e)return s(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);"Object"===r&&e.constructor&&(r=e.constructor.name);if("Map"===r||"Set"===r)return Array.from(e);if("Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r))return s(e,t)}(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var a=0;return function(){return a>=e.length?{done:!0}:{done:!1,value:e[a++]}}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}return(r=e[Symbol.iterator]()).next.bind(r)}function s(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,a=new Array(t);r<t;r++)a[r]=e[r];return a}var u=function(){function e(e,t,r,a,n,o){this.renderer=e,this.properties=t,this.device=r,this.glslang=a,this.sampleCount=n,this.nodes=o,this.pipelines=new WeakMap,this.shaderAttributes=new WeakMap,this.shaderModules={vertex:new Map,fragment:new Map}}var t=e.prototype;return t.get=function(e){var t=this.pipelines.get(e);if(void 0===t){var n=this.device,o=this.properties,i=e.material,l=this.nodes.get(i),s=this.glslang,u=this.shaderModules.vertex.get(l.vertexShader);if(void 0===u){var p=s.compileGLSL(l.vertexShader,"vertex");u={module:n.createShaderModule({code:p}),entryPoint:"main"},this.shaderModules.vertex.set(l.vertexShader,u)}var F=this.shaderModules.fragment.get(l.fragmentShader);if(void 0===F){var h=s.compileGLSL(l.fragmentShader,"fragment");F={module:n.createShaderModule({code:h}),entryPoint:"main"},this.shaderModules.fragment.set(l.fragmentShader,F)}var m=o.get(i);if(void 0===m.disposeCallback){var b=d.bind(this);m.disposeCallback=b,i.addEventListener("dispose",b)}for(var v,P,g=this._parseShaderAttributes(l.vertexShader),G=[],U=e.geometry,S=c(g);!(v=S()).done;){var f=v.value,B=f.name,A=U.getAttribute(B),k=void 0!==A&&A.isInstancedBufferAttribute?r.GPUInputStepMode.Instance:r.GPUInputStepMode.Vertex;G.push({arrayStride:f.arrayStride,attributes:[{shaderLocation:f.slot,offset:0,format:f.format}],stepMode:k})}if(e.isLine)P=(U.index?U.index.count:U.attributes.position.count)>65535?r.GPUIndexFormat.Uint32:r.GPUIndexFormat.Uint16;var C={},O={};!0===i.transparent&&i.blending!==a.NoBlending&&(C=this._getAlphaBlend(i),O=this._getColorBlend(i));var y={};!0===i.stencilWrite&&(y={compare:this._getStencilCompare(i),failOp:this._getStencilOperation(i.stencilFail),depthFailOp:this._getStencilOperation(i.stencilZFail),passOp:this._getStencilOperation(i.stencilZPass)});var E=this._getPrimitiveTopology(e),M=this._getRasterizationStateDescriptor(i),x=this._getColorWriteMask(i),_=this._getDepthCompare(i),R=this._getColorFormat(this.renderer),W=this._getDepthStencilFormat(this.renderer);t=n.createRenderPipeline({vertexStage:u,fragmentStage:F,primitiveTopology:E,rasterizationState:M,colorStates:[{format:R,alphaBlend:C,colorBlend:O,writeMask:x}],depthStencilState:{format:W,depthWriteEnabled:i.depthWrite,depthCompare:_,stencilFront:y,stencilBack:{},stencilReadMask:i.stencilFuncMask,stencilWriteMask:i.stencilWriteMask},vertexState:{indexFormat:P,vertexBuffers:G},sampleCount:this.sampleCount}),this.pipelines.set(e,t),this.shaderAttributes.set(t,g)}return t},t.getShaderAttributes=function(e){return this.shaderAttributes.get(e)},t.dispose=function(){this.pipelines=new WeakMap,this.shaderAttributes=new WeakMap,this.shaderModules={vertex:new Map,fragment:new Map}},t._getArrayStride=function(e){return"float"===e?4:"vec2"===e?8:"vec3"===e?12:"vec4"===e?16:"int"===e?4:"ivec2"===e?8:"ivec3"===e?12:"ivec4"===e?16:"uint"===e?4:"uvec2"===e?8:"uvec3"===e?12:"uvec4"===e?16:void console.error("THREE.WebGPURenderer: Shader variable type not supported yet.",e)},t._getAlphaBlend=function(e){var t=e.blending,n=e.premultipliedAlpha,o=void 0;switch(t){case a.NormalBlending:!1===n&&(o={srcFactor:r.GPUBlendFactor.One,dstFactor:r.GPUBlendFactor.OneMinusSrcAlpha,operation:r.GPUBlendOperation.Add});break;case a.AdditiveBlending:break;case a.SubtractiveBlending:!0===n&&(o={srcFactor:r.GPUBlendFactor.OneMinusSrcColor,dstFactor:r.GPUBlendFactor.OneMinusSrcAlpha,operation:r.GPUBlendOperation.Add});break;case a.MultiplyBlending:!0===n&&(o={srcFactor:r.GPUBlendFactor.Zero,dstFactor:r.GPUBlendFactor.SrcAlpha,operation:r.GPUBlendOperation.Add});break;case a.CustomBlending:var i=e.blendSrcAlpha,l=e.blendDstAlpha,c=e.blendEquationAlpha;null!==i&&null!==l&&null!==c&&(o={srcFactor:this._getBlendFactor(i),dstFactor:this._getBlendFactor(l),operation:this._getBlendOperation(c)});break;default:console.error("THREE.WebGPURenderer: Blending not supported.",t)}return o},t._getBlendFactor=function(e){var t;switch(e){case a.ZeroFactor:t=r.GPUBlendFactor.Zero;break;case a.OneFactor:t=r.GPUBlendFactor.One;break;case a.SrcColorFactor:t=r.GPUBlendFactor.SrcColor;break;case a.OneMinusSrcColorFactor:t=r.GPUBlendFactor.OneMinusSrcColor;break;case a.SrcAlphaFactor:t=r.GPUBlendFactor.SrcAlpha;break;case a.OneMinusSrcAlphaFactor:t=r.GPUBlendFactor.OneMinusSrcAlpha;break;case a.DstColorFactor:t=r.GPUBlendFactor.DstColor;break;case a.OneMinusDstColorFactor:t=r.GPUBlendFactor.OneMinusDstColor;break;case a.DstAlphaFactor:t=r.GPUBlendFactor.DstAlpha;break;case a.OneMinusDstAlphaFactor:t=r.GPUBlendFactor.OneMinusDstAlpha;break;case a.SrcAlphaSaturateFactor:t=r.GPUBlendFactor.SrcAlphaSaturated;break;case r.BlendColorFactor:t=r.GPUBlendFactor.BlendColor;break;case r.OneMinusBlendColorFactor:t=r.GPUBlendFactor.OneMinusBlendColor;break;default:console.error("THREE.WebGPURenderer: Blend factor not supported.",e)}return t},t._getBlendOperation=function(e){var t;switch(e){case a.AddEquation:t=r.GPUBlendOperation.Add;break;case a.SubtractEquation:t=r.GPUBlendOperation.Subtract;break;case a.ReverseSubtractEquation:t=r.GPUBlendOperation.ReverseSubtract;break;case a.MinEquation:t=r.GPUBlendOperation.Min;break;case a.MaxEquation:t=r.GPUBlendOperation.Max;break;default:console.error("THREE.WebGPURenderer: Blend equation not supported.",e)}return t},t._getColorBlend=function(e){var t=e.blending,n=e.premultipliedAlpha,o={srcFactor:null,dstFactor:null,operation:null};switch(t){case a.NormalBlending:o.srcFactor=!0===n?r.GPUBlendFactor.One:r.GPUBlendFactor.SrcAlpha,o.dstFactor=r.GPUBlendFactor.OneMinusSrcAlpha,o.operation=r.GPUBlendOperation.Add;break;case a.AdditiveBlending:o.srcFactor=!0===n?r.GPUBlendFactor.One:r.GPUBlendFactor.SrcAlpha,o.operation=r.GPUBlendOperation.Add;break;case a.SubtractiveBlending:o.srcFactor=r.GPUBlendFactor.Zero,o.dstFactor=!0===n?r.GPUBlendFactor.Zero:r.GPUBlendFactor.OneMinusSrcColor,o.operation=r.GPUBlendOperation.Add;break;case a.MultiplyBlending:o.srcFactor=r.GPUBlendFactor.Zero,o.dstFactor=r.GPUBlendFactor.SrcColor,o.operation=r.GPUBlendOperation.Add;break;case a.CustomBlending:o.srcFactor=this._getBlendFactor(e.blendSrc),o.dstFactor=this._getBlendFactor(e.blendDst),o.operation=this._getBlendOperation(e.blendEquation);break;default:console.error("THREE.WebGPURenderer: Blending not supported.",t)}return o},t._getColorFormat=function(e){var t,a=e.getRenderTarget();null!==a?t=this.properties.get(a).colorTextureFormat:t=r.GPUTextureFormat.BRGA8Unorm;return t},t._getColorWriteMask=function(e){return!0===e.colorWrite?r.GPUColorWriteFlags.All:r.GPUColorWriteFlags.None},t._getDepthCompare=function(e){var t;if(!1===e.depthTest)t=r.GPUCompareFunction.Always;else{var n=e.depthFunc;switch(n){case a.NeverDepth:t=r.GPUCompareFunction.Never;break;case a.AlwaysDepth:t=r.GPUCompareFunction.Always;break;case a.LessDepth:t=r.GPUCompareFunction.Less;break;case a.LessEqualDepth:t=r.GPUCompareFunction.LessEqual;break;case a.EqualDepth:t=r.GPUCompareFunction.Equal;break;case a.GreaterEqualDepth:t=r.GPUCompareFunction.GreaterEqual;break;case a.GreaterDepth:t=r.GPUCompareFunction.Greater;break;case a.NotEqualDepth:t=r.GPUCompareFunction.NotEqual;break;default:console.error("THREE.WebGPURenderer: Invalid depth function.",n)}}return t},t._getDepthStencilFormat=function(e){var t,a=e.getRenderTarget();null!==a?t=this.properties.get(a).depthTextureFormat:t=r.GPUTextureFormat.Depth24PlusStencil8;return t},t._getPrimitiveTopology=function(e){return e.isMesh?r.GPUPrimitiveTopology.TriangleList:e.isPoints?r.GPUPrimitiveTopology.PointList:e.isLine?r.GPUPrimitiveTopology.LineStrip:e.isLineSegments?r.GPUPrimitiveTopology.LineList:void 0},t._getRasterizationStateDescriptor=function(e){var t={};switch(e.side){case a.FrontSide:t.frontFace=r.GPUFrontFace.CCW,t.cullMode=r.GPUCullMode.Back;break;case a.BackSide:t.frontFace=r.GPUFrontFace.CW,t.cullMode=r.GPUCullMode.Back;break;case a.DoubleSide:t.frontFace=r.GPUFrontFace.CCW,t.cullMode=r.GPUCullMode.None;break;default:console.error("THREE.WebGPURenderer: Unknown Material.side value.",e.side)}return t},t._getStencilCompare=function(e){var t,n=e.stencilFunc;switch(n){case a.NeverStencilFunc:t=r.GPUCompareFunction.Never;break;case a.AlwaysStencilFunc:t=r.GPUCompareFunction.Always;break;case a.LessStencilFunc:t=r.GPUCompareFunction.Less;break;case a.LessEqualStencilFunc:t=r.GPUCompareFunction.LessEqual;break;case a.EqualStencilFunc:t=r.GPUCompareFunction.Equal;break;case a.GreaterEqualStencilFunc:t=r.GPUCompareFunction.GreaterEqual;break;case a.GreaterStencilFunc:t=r.GPUCompareFunction.Greater;break;case a.NotEqualStencilFunc:t=r.GPUCompareFunction.NotEqual;break;default:console.error("THREE.WebGPURenderer: Invalid stencil function.",n)}return t},t._getStencilOperation=function(e){var t;switch(e){case a.KeepStencilOp:t=r.GPUStencilOperation.Keep;break;case a.ZeroStencilOp:t=r.GPUStencilOperation.Zero;break;case a.ReplaceStencilOp:t=r.GPUStencilOperation.Replace;break;case a.InvertStencilOp:t=r.GPUStencilOperation.Invert;break;case a.IncrementStencilOp:t=r.GPUStencilOperation.IncrementClamp;break;case a.DecrementStencilOp:t=r.GPUStencilOperation.DecrementClamp;break;case a.IncrementWrapStencilOp:t=r.GPUStencilOperation.IncrementWrap;break;case a.DecrementWrapStencilOp:t=r.GPUStencilOperation.DecrementWrap;break;default:console.error("THREE.WebGPURenderer: Invalid stencil operation.",t)}return t},t._getVertexFormat=function(e){return"float"===e?r.GPUVertexFormat.Float:"vec2"===e?r.GPUVertexFormat.Float2:"vec3"===e?r.GPUVertexFormat.Float3:"vec4"===e?r.GPUVertexFormat.Float4:"int"===e?r.GPUVertexFormat.Int:"ivec2"===e?r.GPUVertexFormat.Int2:"ivec3"===e?r.GPUVertexFormat.Int3:"ivec4"===e?r.GPUVertexFormat.Int4:"uint"===e?r.GPUVertexFormat.UInt:"uvec2"===e?r.GPUVertexFormat.UInt2:"uvec3"===e?r.GPUVertexFormat.UInt3:"uvec4"===e?r.GPUVertexFormat.UInt4:void console.error("THREE.WebGPURenderer: Shader variable type not supported yet.",e)},t._parseShaderAttributes=function(e){for(var t=l(/[\t-\r \xA0\u1680\u2000-\u200A\u2028\u2029\u202F\u205F\u3000\uFEFF]*layout[\t-\r \xA0\u1680\u2000-\u200A\u2028\u2029\u202F\u205F\u3000\uFEFF]*\([\t-\r \xA0\u1680\u2000-\u200A\u2028\u2029\u202F\u205F\u3000\uFEFF]*location[\t-\r \xA0\u1680\u2000-\u200A\u2028\u2029\u202F\u205F\u3000\uFEFF]*=[\t-\r \xA0\u1680\u2000-\u200A\u2028\u2029\u202F\u205F\u3000\uFEFF]*([0-9]+)[\t-\r \xA0\u1680\u2000-\u200A\u2028\u2029\u202F\u205F\u3000\uFEFF]*\)[\t-\r \xA0\u1680\u2000-\u200A\u2028\u2029\u202F\u205F\u3000\uFEFF]*in[\t-\r \xA0\u1680\u2000-\u200A\u2028\u2029\u202F\u205F\u3000\uFEFF]+([0-9A-Z_a-z]+)[\t-\r \xA0\u1680\u2000-\u200A\u2028\u2029\u202F\u205F\u3000\uFEFF]+([0-9A-Z_a-z]+)[\t-\r \xA0\u1680\u2000-\u200A\u2028\u2029\u202F\u205F\u3000\uFEFF]*;/gim,{location:1,type:2,name:3}),r=null,a=[];r=t.exec(e);){var n=parseInt(r.groups.location),o=this._getArrayStride(r.groups.type),i=this._getVertexFormat(r.groups.type);a.push({name:r.groups.name,arrayStride:o,slot:n,format:i})}return a.sort((function(e,t){return e.slot-t.slot}))},e}();function d(e){var t=this.properties,r=this.nodes,a=this.shaderModules,n=e.target,o=t.get(n),i=r.get(n);n.removeEventListener("dispose",o.disposeCallback),t.remove(n),r.remove(n),a.vertex.delete(i.vertexShader),a.fragment.delete(i.fragmentShader)}module.exports=u;
