"use strict";var e=require("@babel/runtime/helpers/inheritsLoose"),r=require("./WebGPUNodeUniformsGroup.cjs.js"),t=require("./WebGPUNodeUniform.cjs.js"),o=require("../WebGPUSampler.cjs.js"),n=require("../WebGPUSampledTexture.cjs.js"),i=require("../../nodes/core/NodeSlot.cjs.js"),s=require("../../nodes/core/NodeBuilder.cjs.js"),a=require("../../nodes/accessors/ModelViewProjectionNode.cjs.js"),u=require("./ShaderLib.cjs.js");function d(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}require("../WebGPUUniformsGroup.cjs.js"),require("@babel/runtime/helpers/assertThisInitialized"),require("../WebGPUBinding.cjs.js"),require("../constants.cjs.js"),require("../WebGPUUniform.cjs.js"),require("three"),require("../../nodes/core/NodeUniform.cjs.js"),require("@babel/runtime/helpers/createClass"),require("../../nodes/core/NodeAttribute.cjs.js"),require("../../nodes/core/NodeVary.cjs.js"),require("../../nodes/core/constants.cjs.js"),require("../../nodes/core/Node.cjs.js"),require("../../nodes/accessors/CameraNode.cjs.js"),require("@babel/runtime/helpers/defineProperty"),require("../../nodes/inputs/Vector3Node.cjs.js"),require("../../nodes/core/InputNode.cjs.js"),require("../../nodes/inputs/Matrix4Node.cjs.js"),require("../../nodes/accessors/ModelNode.cjs.js"),require("../../nodes/inputs/Matrix3Node.cjs.js"),require("../../nodes/math/OperatorNode.cjs.js"),require("../../nodes/accessors/PositionNode.cjs.js"),require("../../nodes/core/AttributeNode.cjs.js");var c=d(e);function f(e,r){var t;if("undefined"==typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(t=function(e,r){if(!e)return;if("string"==typeof e)return l(e,r);var t=Object.prototype.toString.call(e).slice(8,-1);"Object"===t&&e.constructor&&(t=e.constructor.name);if("Map"===t||"Set"===t)return Array.from(e);if("Arguments"===t||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(t))return l(e,r)}(e))||r&&e&&"number"==typeof e.length){t&&(e=t);var o=0;return function(){return o>=e.length?{done:!0}:{done:!1,value:e[o++]}}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}return(t=e[Symbol.iterator]()).next.bind(t)}function l(e,r){(null==r||r>e.length)&&(r=e.length);for(var t=0,o=new Array(r);t<r;t++)o[t]=e[t];return o}var m=function(e){function s(r,t){var o;return(o=e.call(this,r,t)||this).bindings={vertex:[],fragment:[]},o.bindingsOffset={vertex:0,fragment:0},o.uniformsGroup={},o.nativeShader=null,o._parseMaterial(),o}c.default(s,e);var d=s.prototype;return d._parseMaterial=function(){var e=this.material;if(this.nativeShader=u.common,e.isMeshBasicMaterial||e.isPointsMaterial||e.isLineBasicMaterial){var r=new a;void 0!==e.positionNode&&(r.position=e.positionNode),this.addSlot("vertex",new i(r,"MVP","vec4")),void 0!==e.colorNode&&this.addSlot("fragment",new i(e.colorNode,"COLOR","vec4")),void 0!==e.opacityNode&&this.addSlot("fragment",new i(e.opacityNode,"OPACITY","float"))}},d.getTexture=function(e,r){return"texture( sampler2D( "+e+", "+e+"_sampler ), "+r+" )"},d.getPropertyName=function(r){if(r.isNodeUniform){var t=r.name;return"texture"===r.type?t:"nodeUniforms."+t}return e.prototype.getPropertyName.call(this,r)},d.getBindings=function(){var e=this.bindings;return[].concat(e.vertex,e.fragment)},d.getUniformFromNode=function(i,s,a){var u=e.prototype.getUniformFromNode.call(this,i,s,a),d=this.getDataFromNode(i,s);if(void 0===d.uniformGPU){var c,f=this.bindings[s];if("texture"===a){var l=new o(u.name+"_sampler",u.value),m=new n.WebGPUSampledTexture(u.name,u.value),p=f[f.length-1],h=p&&p.isUniformsGroup?f.length-1:f.length;f.splice(h,0,l,m),c={sampler:l,texture:m}}else{var v=this.uniformsGroup[s];if(void 0===v&&(v=new r(s),this.uniformsGroup[s]=v,f.push(v)),"float"===a)c=new t.FloatNodeUniform(u);else if("vec2"===a)c=new t.Vector2NodeUniform(u);else if("vec3"===a)c=new t.Vector3NodeUniform(u);else if("vec4"===a)c=new t.Vector4NodeUniform(u);else if("color"===a)c=new t.ColorNodeUniform(u);else if("mat3"===a)c=new t.Matrix3NodeUniform(u);else{if("mat4"!==a)throw new Error('Uniform "'+a+'" not declared.');c=new t.Matrix4NodeUniform(u)}v.addUniform(c)}d.uniformGPU=c,"vertex"===s&&(this.bindingsOffset.fragment=f.length)}return u},d.getAttributesHeaderSnippet=function(e){var r="";if("vertex"===e)for(var t=this.attributes,o=0;o<t.length;o++){var n=t[o];r+="layout(location = "+o+") in "+n.type+" "+n.name+";"}return r},d.getVarysHeaderSnippet=function(e){for(var r="",t=this.varys,o="vertex"===e?"out":"in",n=0;n<t.length;n++){var i=t[n];r+="layout(location = "+n+") "+o+" "+i.type+" "+i.name+";"}return r},d.getVarysBodySnippet=function(e){var r="";if("vertex"===e)for(var t,o=f(this.varys);!(t=o()).done;){var n=t.value;r+=n.name+" = "+n.snippet+";"}return r},d.getUniformsHeaderSnippet=function(e){for(var r,t=this.uniforms[e],o="",n="",i=this.bindingsOffset[e],s=f(t);!(r=s()).done;){var a=r.value;if("texture"===a.type)o+="layout(set = 0, binding = "+i+++") uniform sampler "+a.name+"_sampler;",o+="layout(set = 0, binding = "+i+++") uniform texture2D "+a.name+";";else n+="uniform "+this.getVectorType(a.type)+" "+a.name+";"}return n&&(o+="layout(set = 0, binding = "+i+++") uniform NodeUniforms { "+n+" } nodeUniforms;"),o},d.composeShaderCode=function(e,r){var t=e.indexOf("\n"),o=e.substr(0,t)+"\n\n";return o+=r,o+=e.substr(t)},d.build=function(){return e.prototype.build.call(this),this.vertexShader=this.composeShaderCode(this.nativeShader.vertexShader,this.vertexShader),this.fragmentShader=this.composeShaderCode(this.nativeShader.fragmentShader,this.fragmentShader),this},s}(s);module.exports=m;
