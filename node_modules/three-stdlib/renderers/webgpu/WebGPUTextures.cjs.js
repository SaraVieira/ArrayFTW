"use strict";var e=require("./constants.cjs.js"),t=require("three"),r=require("./WebGPUTextureUtils.cjs.js"),i=function(){function i(e,t,r,i){this.device=e,this.properties=t,this.info=r,this.glslang=i,this.defaultTexture=null,this.defaultCubeTexture=null,this.defaultSampler=null,this.samplerCache=new Map,this.utils=null}var s=i.prototype;return s.getDefaultSampler=function(){return null===this.defaultSampler&&(this.defaultSampler=this.device.createSampler({})),this.defaultSampler},s.getDefaultTexture=function(){if(null===this.defaultTexture){var e=new t.Texture;e.minFilter=t.NearestFilter,e.magFilter=t.NearestFilter,this.defaultTexture=this._createTexture(e)}return this.defaultTexture},s.getDefaultCubeTexture=function(){if(null===this.defaultCubeTexture){var e=new t.CubeTexture;e.minFilter=t.NearestFilter,e.magFilter=t.NearestFilter,this.defaultCubeTexture=this._createTexture(e)}return this.defaultCubeTexture},s.getTextureGPU=function(e){return this.properties.get(e).textureGPU},s.getSampler=function(e){return this.properties.get(e).samplerGPU},s.updateTexture=function(e){var t=!1,r=this.properties.get(e);if(e.version>0&&r.version!==e.version){var i=e.image;if(void 0===i)console.warn("THREE.WebGPURenderer: Texture marked for update but image is undefined.");else if(!1===i.complete)console.warn("THREE.WebGPURenderer: Texture marked for update but image is incomplete.");else{if(void 0===r.initialized){r.initialized=!0;var a=o.bind(this);r.disposeCallback=a,e.addEventListener("dispose",a),this.info.memory.textures++}void 0!==r.textureGPU&&r.textureGPU.destroy(),r.textureGPU=this._createTexture(e),r.version=e.version,t=!0}}return!1===r.initializedRTT&&(r.initializedRTT=!0,t=!0),t},s.updateSampler=function(e){var t=[];t.push(e.wrapS),t.push(e.wrapT),t.push(e.wrapR),t.push(e.magFilter),t.push(e.minFilter),t.push(e.anisotropy);var r=t.join(),i=this.samplerCache.get(r);void 0===i&&(i=this.device.createSampler({addressModeU:this._convertAddressMode(e.wrapS),addressModeV:this._convertAddressMode(e.wrapT),addressModeW:this._convertAddressMode(e.wrapR),magFilter:this._convertFilterMode(e.magFilter),minFilter:this._convertFilterMode(e.minFilter),mipmapFilter:this._convertFilterMode(e.minFilter),maxAnisotropy:e.anisotropy}),this.samplerCache.set(r,i)),this.properties.get(e).samplerGPU=i},s.initRenderTarget=function(t){var r=this.properties,i=r.get(t);if(void 0===i.initialized){var o=this.device,s=t.width,n=t.height,u=this._getFormat(t.texture),m=o.createTexture({size:{width:s,height:n,depthOrArrayLayers:1},format:u,usage:GPUTextureUsage.RENDER_ATTACHMENT|GPUTextureUsage.SAMPLED});this.info.memory.textures++,i.colorTextureGPU=m,i.colorTextureFormat=u;var h=r.get(t.texture);if(h.textureGPU=m,h.initializedRTT=!1,!0===t.depthBuffer){var d=e.GPUTextureFormat.Depth24PlusStencil8,p=o.createTexture({size:{width:s,height:n,depthOrArrayLayers:1},format:d,usage:GPUTextureUsage.RENDER_ATTACHMENT});if(this.info.memory.textures++,i.depthTextureGPU=p,i.depthTextureFormat=d,null!==t.depthTexture){var l=r.get(t.depthTexture);l.textureGPU=p,l.initializedRTT=!1}}var T=a.bind(this);i.disposeCallback=T,t.addEventListener("dispose",T),i.initialized=!0}},s.dispose=function(){this.samplerCache.clear()},s._convertAddressMode=function(r){var i=e.GPUAddressMode.ClampToEdge;return r===t.RepeatWrapping?i=e.GPUAddressMode.Repeat:r===t.MirroredRepeatWrapping&&(i=e.GPUAddressMode.MirrorRepeat),i},s._convertFilterMode=function(r){var i=e.GPUFilterMode.Linear;return r!==t.NearestFilter&&r!==t.NearestMipmapNearestFilter&&r!==t.NearestMipmapLinearFilter||(i=e.GPUFilterMode.Nearest),i},s._createTexture=function(e){var t=this,r=this.device,i=e.image,a=this._getSize(e),o=a.width,s=a.height,n=a.depth,u=this._needsMipmaps(e),m=this._getDimension(e),h=this._getMipLevelCount(e,o,s,u),d=this._getFormat(e),p=GPUTextureUsage.SAMPLED|GPUTextureUsage.COPY_DST;!0===u&&(p|=GPUTextureUsage.RENDER_ATTACHMENT);var l={size:{width:o,height:s,depthOrArrayLayers:n},mipLevelCount:h,sampleCount:1,dimension:m,format:d,usage:p},T=r.createTexture(l);return e.isDataTexture||e.isDataTexture2DArray||e.isDataTexture3D?(this._copyBufferToTexture(i,d,T),!0===u&&this._generateMipmaps(T,l)):e.isCompressedTexture?this._copyCompressedBufferToTexture(e.mipmaps,d,T):e.isCubeTexture?this._copyCubeMapToTexture(i,e,T):void 0!==i&&this._getImageBitmap(i,e).then((function(e){t._copyImageBitmapToTexture(e,T),!0===u&&t._generateMipmaps(T,l)})),T},s._copyBufferToTexture=function(e,t,r){var i=e.data,a=this._getBytesPerTexel(t),o=256*Math.ceil(e.width*a/256);this.device.queue.writeTexture({texture:r,mipLevel:0},i,{offset:0,bytesPerRow:o},{width:e.width,height:e.height,depthOrArrayLayers:void 0!==e.depth?e.depth:1})},s._copyCubeMapToTexture=function(e,t,r){for(var i=this,a=function(a){var o=e[a];i._getImageBitmap(o,t).then((function(e){i._copyImageBitmapToTexture(e,r,{x:0,y:0,z:a})}))},o=0;o<e.length;o++)a(o)},s._copyImageBitmapToTexture=function(e,t,r){void 0===r&&(r={x:0,y:0,z:0}),this.device.queue.copyImageBitmapToTexture({imageBitmap:e},{texture:t,mipLevel:0,origin:r},{width:e.width,height:e.height,depthOrArrayLayers:1})},s._copyCompressedBufferToTexture=function(e,t,r){for(var i=this._getBlockData(t),a=0;a<e.length;a++){var o=e[a],s=o.width,n=o.height,u=Math.ceil(s/i.width)*i.byteLength;this.device.queue.writeTexture({texture:r,mipLevel:a},o.data,{offset:0,bytesPerRow:u},{width:Math.ceil(s/i.width)*i.width,height:Math.ceil(n/i.width)*i.width,depthOrArrayLayers:1})}},s._generateMipmaps=function(e,t){null===this.utils&&(this.utils=new r(this.device,this.glslang)),this.utils.generateMipmaps(e,t)},s._getBlockData=function(t){return t===e.GPUTextureFormat.BC1RGBAUnorm||t===e.GPUTextureFormat.BC1RGBAUnormSRGB?{byteLength:8,width:4,height:4}:t===e.GPUTextureFormat.BC2RGBAUnorm||t===e.GPUTextureFormat.BC2RGBAUnormSRGB||t===e.GPUTextureFormat.BC3RGBAUnorm||t===e.GPUTextureFormat.BC3RGBAUnormSRGB?{byteLength:16,width:4,height:4}:t===e.GPUTextureFormat.BC4RUnorm||t===e.GPUTextureFormat.BC4RSNorm?{byteLength:8,width:4,height:4}:t===e.GPUTextureFormat.BC5RGUnorm||t===e.GPUTextureFormat.BC5RGSnorm||t===e.GPUTextureFormat.BC6HRGBUFloat||t===e.GPUTextureFormat.BC6HRGBFloat||t===e.GPUTextureFormat.BC7RGBAUnorm||t===e.GPUTextureFormat.BC7RGBAUnormSRGB?{byteLength:16,width:4,height:4}:void 0},s._getBytesPerTexel=function(t){return t===e.GPUTextureFormat.R8Unorm?1:t===e.GPUTextureFormat.R16Float||t===e.GPUTextureFormat.RG8Unorm?2:t===e.GPUTextureFormat.RG16Float||t===e.GPUTextureFormat.R32Float||t===e.GPUTextureFormat.RGBA8Unorm||t===e.GPUTextureFormat.RGBA8UnormSRGB?4:t===e.GPUTextureFormat.RG32Float||t===e.GPUTextureFormat.RGBA16Float?8:t===e.GPUTextureFormat.RGBA32Float?16:void 0},s._getDimension=function(t){return t.isDataTexture3D?e.GPUTextureDimension.ThreeD:e.GPUTextureDimension.TwoD},s._getFormat=function(r){var i,a=r.format,o=r.type,s=r.encoding;switch(a){case t.RGBA_S3TC_DXT1_Format:i=s===t.sRGBEncoding?e.GPUTextureFormat.BC1RGBAUnormSRGB:e.GPUTextureFormat.BC1RGBAUnorm;break;case t.RGBA_S3TC_DXT3_Format:i=s===t.sRGBEncoding?e.GPUTextureFormat.BC2RGBAUnormSRGB:e.GPUTextureFormat.BC2RGBAUnorm;break;case t.RGBA_S3TC_DXT5_Format:i=s===t.sRGBEncoding?e.GPUTextureFormat.BC3RGBAUnormSRGB:e.GPUTextureFormat.BC3RGBAUnorm;break;case t.RGBFormat:case t.RGBAFormat:switch(o){case t.UnsignedByteType:i=s===t.sRGBEncoding?e.GPUTextureFormat.RGBA8UnormSRGB:e.GPUTextureFormat.RGBA8Unorm;break;case t.HalfFloatType:i=e.GPUTextureFormat.RGBA16Float;break;case t.FloatType:i=e.GPUTextureFormat.RGBA32Float;break;default:console.error("WebGPURenderer: Unsupported texture type with RGBAFormat.",o)}break;case t.RedFormat:switch(o){case t.UnsignedByteType:i=e.GPUTextureFormat.R8Unorm;break;case t.HalfFloatType:i=e.GPUTextureFormat.R16Float;break;case t.FloatType:i=e.GPUTextureFormat.R32Float;break;default:console.error("WebGPURenderer: Unsupported texture type with RedFormat.",o)}break;case t.RGFormat:switch(o){case t.UnsignedByteType:i=e.GPUTextureFormat.RG8Unorm;break;case t.HalfFloatType:i=e.GPUTextureFormat.RG16Float;break;case t.FloatType:i=e.GPUTextureFormat.RG32Float;break;default:console.error("WebGPURenderer: Unsupported texture type with RGFormat.",o)}break;default:console.error("WebGPURenderer: Unsupported texture format.",a)}return i},s._getImageBitmap=function(e,t){var r=e.width,i=e.height;if("undefined"!=typeof HTMLImageElement&&e instanceof HTMLImageElement||"undefined"!=typeof HTMLCanvasElement&&e instanceof HTMLCanvasElement){var a={};return a.imageOrientation=!0===t.flipY?"flipY":"none",a.premultiplyAlpha=!0===t.premultiplyAlpha?"premultiply":"default",createImageBitmap(e,0,0,r,i,a)}return Promise.resolve(e)},s._getMipLevelCount=function(e,t,r,i){return e.isCompressedTexture?e.mipmaps.length:!0===i?Math.floor(Math.log2(Math.max(t,r)))+1:1},s._getSize=function(e){var t,r,i,a=e.image;return e.isCubeTexture?(t=a.length>0?a[0].width:1,r=a.length>0?a[0].height:1,i=6):void 0!==a?(t=a.width,r=a.height,i=void 0!==a.depth?a.depth:1):t=r=i=1,{width:t,height:r,depth:i}},s._needsMipmaps=function(e){return!0!==e.isCompressedTexture&&!0===e.generateMipmaps&&e.minFilter!==t.NearestFilter&&e.minFilter!==t.LinearFilter},i}();function a(e){var t=e.target,r=this.properties,i=r.get(t);t.removeEventListener("dispose",i.disposeCallback),i.colorTextureGPU.destroy(),r.remove(t.texture),this.info.memory.textures--,!0===t.depthBuffer&&(i.depthTextureGPU.destroy(),this.info.memory.textures--,null!==t.depthTexture&&r.remove(t.depthTexture)),r.remove(t)}function o(e){var t=e.target,r=this.properties.get(t);r.textureGPU.destroy(),t.removeEventListener("dispose",r.disposeCallback),this.properties.remove(t),this.info.memory.textures--}module.exports=i;
