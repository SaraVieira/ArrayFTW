"use strict";var e=require("@babel/runtime/helpers/asyncToGenerator"),t=require("./constants.cjs.js"),r=require("./WebGPUObjects.cjs.js"),i=require("./WebGPUAttributes.cjs.js"),s=require("./WebGPUGeometries.cjs.js"),n=require("./WebGPUInfo.cjs.js"),o=require("./WebGPUProperties.cjs.js"),a=require("./WebGPURenderPipelines.cjs.js"),h=require("./WebGPUComputePipelines.cjs.js"),u=require("./WebGPUBindings.cjs.js"),l=require("./WebGPURenderLists.cjs.js"),c=require("./WebGPUTextures.cjs.js"),d=require("./WebGPUBackground.cjs.js"),p=require("./nodes/WebGPUNodes.cjs.js"),_=require("@webgpu/glslang/dist/web-devel/glslang"),f=require("three");function m(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}require("@babel/runtime/helpers/inherits"),require("@babel/runtime/helpers/possibleConstructorReturn"),require("@babel/runtime/helpers/getPrototypeOf"),require("@babel/runtime/helpers/wrapNativeSuper"),require("./WebGPUTextureUtils.cjs.js"),require("./nodes/WebGPUNodeBuilder.cjs.js"),require("@babel/runtime/helpers/inheritsLoose"),require("./nodes/WebGPUNodeUniformsGroup.cjs.js"),require("./WebGPUUniformsGroup.cjs.js"),require("@babel/runtime/helpers/assertThisInitialized"),require("./WebGPUBinding.cjs.js"),require("./nodes/WebGPUNodeUniform.cjs.js"),require("./WebGPUUniform.cjs.js"),require("./WebGPUSampler.cjs.js"),require("./WebGPUSampledTexture.cjs.js"),require("../nodes/core/NodeSlot.cjs.js"),require("../nodes/core/NodeBuilder.cjs.js"),require("../nodes/core/NodeUniform.cjs.js"),require("@babel/runtime/helpers/createClass"),require("../nodes/core/NodeAttribute.cjs.js"),require("../nodes/core/NodeVary.cjs.js"),require("../nodes/core/constants.cjs.js"),require("../nodes/accessors/ModelViewProjectionNode.cjs.js"),require("../nodes/core/Node.cjs.js"),require("../nodes/accessors/CameraNode.cjs.js"),require("@babel/runtime/helpers/defineProperty"),require("../nodes/inputs/Vector3Node.cjs.js"),require("../nodes/core/InputNode.cjs.js"),require("../nodes/inputs/Matrix4Node.cjs.js"),require("../nodes/accessors/ModelNode.cjs.js"),require("../nodes/inputs/Matrix3Node.cjs.js"),require("../nodes/math/OperatorNode.cjs.js"),require("../nodes/accessors/PositionNode.cjs.js"),require("../nodes/core/AttributeNode.cjs.js"),require("./nodes/ShaderLib.cjs.js"),require("../nodes/core/NodeFrame.cjs.js");var g=m(e),b=m(_);function j(e,t){var r;if("undefined"==typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(r=function(e,t){if(!e)return;if("string"==typeof e)return x(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);"Object"===r&&e.constructor&&(r=e.constructor.name);if("Map"===r||"Set"===r)return Array.from(e);if("Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r))return x(e,t)}(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var i=0;return function(){return i>=e.length?{done:!0}:{done:!1,value:e[i++]}}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}return(r=e[Symbol.iterator]()).next.bind(r)}function x(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,i=new Array(t);r<t;r++)i[r]=e[r];return i}console.info("THREE.WebGPURenderer: Modified Matrix4.makePerspective() and Matrix4.makeOrtographic() to work with WebGPU, see https://github.com/mrdoob/three.js/issues/20276."),f.Matrix4.prototype.makePerspective=function(e,t,r,i,s,n){var o=this.elements,a=2*s/(t-e),h=2*s/(r-i),u=(t+e)/(t-e),l=(r+i)/(r-i),c=-n/(n-s),d=-n*s/(n-s);return o[0]=a,o[4]=0,o[8]=u,o[12]=0,o[1]=0,o[5]=h,o[9]=l,o[13]=0,o[2]=0,o[6]=0,o[10]=c,o[14]=d,o[3]=0,o[7]=0,o[11]=-1,o[15]=0,this},f.Matrix4.prototype.makeOrthographic=function(e,t,r,i,s,n){var o=this.elements,a=1/(t-e),h=1/(r-i),u=1/(n-s),l=(t+e)*a,c=(r+i)*h,d=s*u;return o[0]=2*a,o[4]=0,o[8]=0,o[12]=-l,o[1]=0,o[5]=2*h,o[9]=0,o[13]=-c,o[2]=0,o[6]=0,o[10]=-1*u,o[14]=-d,o[3]=0,o[7]=0,o[11]=0,o[15]=1,this};var v=new f.Frustum,w=new f.Matrix4,P=new f.Vector3,y=function(){function e(e){void 0===e&&(e={}),this.domElement=void 0!==e.canvas?e.canvas:this._createCanvasElement(),this.autoClear=!0,this.autoClearColor=!0,this.autoClearDepth=!0,this.autoClearStencil=!0,this.sortObjects=!0,this._parameters=Object.assign({},e),this._pixelRatio=1,this._width=this.domElement.width,this._height=this.domElement.height,this._viewport=null,this._scissor=null,this._adapter=null,this._device=null,this._context=null,this._swapChain=null,this._colorBuffer=null,this._depthBuffer=null,this._info=null,this._properties=null,this._attributes=null,this._geometries=null,this._nodes=null,this._bindings=null,this._objects=null,this._renderPipelines=null,this._computePipelines=null,this._renderLists=null,this._textures=null,this._background=null,this._renderPassDescriptor=null,this._currentRenderList=null,this._opaqueSort=null,this._transparentSort=null,this._clearAlpha=1,this._clearColor=new f.Color(0),this._clearDepth=1,this._clearStencil=0,this._renderTarget=null,this._parameters.antialias=!0===e.antialias,!0===this._parameters.antialias?this._parameters.sampleCount=void 0===e.sampleCount?4:e.sampleCount:this._parameters.sampleCount=1,this._parameters.extensions=void 0===e.extensions?[]:e.extensions,this._parameters.limits=void 0===e.limits?{}:e.limits}var _=e.prototype;return _.init=function(){var e=g.default(regeneratorRuntime.mark((function e(){var _,f,m,g,j,x,v,w;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return _=this._parameters,f={powerPreference:_.powerPreference},e.next=4,navigator.gpu.requestAdapter(f);case 4:return m=e.sent,g={extensions:_.extensions,limits:_.limits},e.next=8,m.requestDevice(g);case 8:return j=e.sent,e.next=11,b.default();case 11:x=e.sent,v=void 0!==_.context?_.context:this.domElement.getContext("gpupresent"),w=v.configureSwapChain({device:j,format:t.GPUTextureFormat.BRGA8Unorm}),this._adapter=m,this._device=j,this._context=v,this._swapChain=w,this._info=new n,this._properties=new o,this._attributes=new i(j),this._geometries=new s(this._attributes,this._info),this._textures=new c(j,this._properties,this._info,x),this._objects=new r(this._geometries,this._info),this._nodes=new p(this),this._renderPipelines=new a(this,this._properties,j,x,_.sampleCount,this._nodes),this._computePipelines=new h(j,x),this._bindings=new u(j,this._info,this._properties,this._textures,this._renderPipelines,this._computePipelines,this._attributes,this._nodes),this._renderLists=new l,this._background=new d(this),this._renderPassDescriptor={colorAttachments:[{attachment:null}],depthStencilAttachment:{attachment:null,depthStoreOp:t.GPUStoreOp.Store,stencilStoreOp:t.GPUStoreOp.Store}},this._setupColorBuffer(),this._setupDepthBuffer();case 33:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}(),_.render=function(e,t){this._nodes.updateFrame(),!0===e.autoUpdate&&e.updateMatrixWorld(),null===t.parent&&t.updateMatrixWorld(),!0===this._info.autoReset&&this._info.reset(),w.multiplyMatrices(t.projectionMatrix,t.matrixWorldInverse),v.setFromProjectionMatrix(w),this._currentRenderList=this._renderLists.get(e,t),this._currentRenderList.init(),this._projectObject(e,t,0),this._currentRenderList.finish(),!0===this.sortObjects&&this._currentRenderList.sort(this._opaqueSort,this._transparentSort);var r=this._renderPassDescriptor.colorAttachments[0],i=this._renderPassDescriptor.depthStencilAttachment,s=this._renderTarget;if(null!==s){var n=this._properties.get(s);r.attachment=n.colorTextureGPU.createView(),i.attachment=n.depthTextureGPU.createView()}else!0===this._parameters.antialias?(r.attachment=this._colorBuffer.createView(),r.resolveTarget=this._swapChain.getCurrentTexture().createView()):(r.attachment=this._swapChain.getCurrentTexture().createView(),r.resolveTarget=void 0),i.attachment=this._depthBuffer.createView();this._background.update(e);var o=this._device,a=o.createCommandEncoder({}),h=a.beginRenderPass(this._renderPassDescriptor),u=this._viewport;if(null!==u){var l=Math.floor(u.width*this._pixelRatio),c=Math.floor(u.height*this._pixelRatio);h.setViewport(u.x,u.y,l,c,u.minDepth,u.maxDepth)}var d=this._scissor;if(null!==d){var p=Math.floor(d.width*this._pixelRatio),_=Math.floor(d.height*this._pixelRatio);h.setScissorRect(d.x,d.y,p,_)}var f=this._currentRenderList.opaque,m=this._currentRenderList.transparent;f.length>0&&this._renderObjects(f,t,h),m.length>0&&this._renderObjects(m,t,h),h.endPass(),o.queue.submit([a.finish()])},_.getContext=function(){return this._context},_.getPixelRatio=function(){return this._pixelRatio},_.getDrawingBufferSize=function(e){return e.set(this._width*this._pixelRatio,this._height*this._pixelRatio).floor()},_.getSize=function(e){return e.set(this._width,this._height)},_.setPixelRatio=function(e){void 0===e&&(e=1),this._pixelRatio=e,this.setSize(this._width,this._height,!1)},_.setDrawingBufferSize=function(e,t,r){this._width=e,this._height=t,this._pixelRatio=r,this.domElement.width=Math.floor(e*r),this.domElement.height=Math.floor(t*r),this._setupColorBuffer(),this._setupDepthBuffer()},_.setSize=function(e,t,r){void 0===r&&(r=!0),this._width=e,this._height=t,this.domElement.width=Math.floor(e*this._pixelRatio),this.domElement.height=Math.floor(t*this._pixelRatio),!0===r&&(this.domElement.style.width=e+"px",this.domElement.style.height=t+"px"),this._setupColorBuffer(),this._setupDepthBuffer()},_.setOpaqueSort=function(e){this._opaqueSort=e},_.setTransparentSort=function(e){this._transparentSort=e},_.getScissor=function(e){var t=this._scissor;return e.x=t.x,e.y=t.y,e.width=t.width,e.height=t.height,e},_.setScissor=function(e,t,r,i){this._scissor=null===e?null:{x:e,y:t,width:r,height:i}},_.getViewport=function(e){var t=this._viewport;return e.x=t.x,e.y=t.y,e.width=t.width,e.height=t.height,e.minDepth=t.minDepth,e.maxDepth=t.maxDepth,e},_.setViewport=function(e,t,r,i,s,n){void 0===s&&(s=0),void 0===n&&(n=1),this._viewport=null===e?null:{x:e,y:t,width:r,height:i,minDepth:s,maxDepth:n}},_.getClearColor=function(e){return e.copy(this._clearColor)},_.setClearColor=function(e,t){void 0===t&&(t=1),this._clearColor.set(e),this._clearAlpha=t},_.getClearAlpha=function(){return this._clearAlpha},_.setClearAlpha=function(e){this._clearAlpha=e},_.getClearDepth=function(){return this._clearDepth},_.setClearDepth=function(e){this._clearDepth=e},_.getClearStencil=function(){return this._clearStencil},_.setClearStencil=function(e){this._clearStencil=e},_.clear=function(){this._background.clear()},_.dispose=function(){this._objects.dispose(),this._properties.dispose(),this._renderPipelines.dispose(),this._computePipelines.dispose(),this._nodes.dispose(),this._bindings.dispose(),this._info.dispose(),this._renderLists.dispose(),this._textures.dispose()},_.setRenderTarget=function(e){this._renderTarget=e,null!==e&&this._textures.initRenderTarget(e)},_.compute=function(e){for(var t,r=this._device,i=r.createCommandEncoder({}),s=i.beginComputePass(),n=j(e);!(t=n()).done;){var o=t.value,a=this._computePipelines.get(o);s.setPipeline(a);var h=this._bindings.getForCompute(o).group;this._bindings.update(o),s.setBindGroup(0,h),s.dispatch(o.num)}s.endPass(),r.queue.submit([i.finish()])},_.getRenderTarget=function(){return this._renderTarget},_._projectObject=function(e,t,r){var i=this._info,s=this._currentRenderList;if(!1!==e.visible){if(e.layers.test(t.layers))if(e.isGroup)r=e.renderOrder;else if(e.isLOD)!0===e.autoUpdate&&e.update(t);else if(e.isLight)e.castShadow;else if(e.isSprite){if(!e.frustumCulled||v.intersectsSprite(e)){!0===this.sortObjects&&P.setFromMatrixPosition(e.matrixWorld).applyMatrix4(w);var n=e.geometry,o=e.material;o.visible&&s.push(e,n,o,r,P.z,null)}}else if(e.isLineLoop)console.error("THREE.WebGPURenderer: Objects of type THREE.LineLoop are not supported. Please use THREE.Line or THREE.LineSegments.");else if((e.isMesh||e.isLine||e.isPoints)&&(e.isSkinnedMesh&&e.skeleton.frame!==i.render.frame&&(e.skeleton.update(),e.skeleton.frame=i.render.frame),!e.frustumCulled||v.intersectsObject(e))){!0===this.sortObjects&&P.setFromMatrixPosition(e.matrixWorld).applyMatrix4(w);var a=e.geometry,h=e.material;if(Array.isArray(h))for(var u=a.groups,l=0,c=u.length;l<c;l++){var d=u[l],p=h[d.materialIndex];p&&p.visible&&s.push(e,a,p,r,P.z,d)}else h.visible&&s.push(e,a,h,r,P.z,null)}for(var _=e.children,f=0,m=_.length;f<m;f++)this._projectObject(_[f],t,r)}},_._renderObjects=function(e,t,r){for(var i=0,s=e.length;i<s;i++){var n=e[i].object;if(n.modelViewMatrix.multiplyMatrices(t.matrixWorldInverse,n.matrixWorld),n.normalMatrix.getNormalMatrix(n.modelViewMatrix),this._objects.update(n),t.isArrayCamera)for(var o=t.cameras,a=0,h=o.length;a<h;a++){var u=o[a];if(n.layers.test(u.layers)){var l=u.viewport,c=void 0===l.minDepth?0:l.minDepth,d=void 0===l.maxDepth?1:l.maxDepth;r.setViewport(l.x,l.y,l.width,l.height,c,d),this._nodes.update(n,u),this._bindings.update(n,u),this._renderObject(n,r)}}else this._nodes.update(n,t),this._bindings.update(n,t),this._renderObject(n,r)}},_._renderObject=function(e,t){var r=this._info,i=this._renderPipelines.get(e);t.setPipeline(i);var s=this._bindings.get(e).group;t.setBindGroup(0,s);var n=e.geometry,o=n.index,a=null!==o;!0===a&&this._setupIndexBuffer(o,t),this._setupVertexBuffers(n.attributes,t,i);var h=n.drawRange,u=h.start,l=n.isInstancedBufferGeometry?n.instanceCount:1;if(!0===a){var c=h.count!==1/0?h.count:o.count;t.drawIndexed(c,l,u,0,0),r.update(e,c,l)}else{var d=n.attributes.position,p=h.count!==1/0?h.count:d.count;t.draw(p,l,u,0),r.update(e,p,l)}},_._setupIndexBuffer=function(e,r){var i=this._attributes.get(e).buffer,s=e.array instanceof Uint16Array?t.GPUIndexFormat.Uint16:t.GPUIndexFormat.Uint32;r.setIndexBuffer(i,s)},_._setupVertexBuffers=function(e,t,r){for(var i,s=j(this._renderPipelines.getShaderAttributes(r));!(i=s()).done;){var n=i.value,o=n.name,a=n.slot,h=e[o];if(void 0!==h){var u=this._attributes.get(h).buffer;t.setVertexBuffer(a,u)}}},_._setupColorBuffer=function(){this._device&&(this._colorBuffer&&this._colorBuffer.destroy(),this._colorBuffer=this._device.createTexture({size:{width:this._width*this._pixelRatio,height:this._height*this._pixelRatio,depthOrArrayLayers:1},sampleCount:this._parameters.sampleCount,format:t.GPUTextureFormat.BRGA8Unorm,usage:GPUTextureUsage.RENDER_ATTACHMENT}))},_._setupDepthBuffer=function(){this._device&&(this._depthBuffer&&this._depthBuffer.destroy(),this._depthBuffer=this._device.createTexture({size:{width:this._width*this._pixelRatio,height:this._height*this._pixelRatio,depthOrArrayLayers:1},sampleCount:this._parameters.sampleCount,format:t.GPUTextureFormat.Depth24PlusStencil8,usage:GPUTextureUsage.RENDER_ATTACHMENT}))},_._createCanvasElement=function(){var e=document.createElementNS("http://www.w3.org/1999/xhtml","canvas");return e.style.display="block",e},e}();module.exports=y;
