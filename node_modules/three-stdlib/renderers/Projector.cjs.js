"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("three"),r=function(){this.id=0,this.object=null,this.z=0,this.renderOrder=0},t=function(){this.id=0,this.v1=new i,this.v2=new i,this.v3=new i,this.normalModel=new e.Vector3,this.vertexNormalsModel=[new e.Vector3,new e.Vector3,new e.Vector3],this.vertexNormalsLength=0,this.color=new e.Color,this.material=null,this.uvs=[new e.Vector2,new e.Vector2,new e.Vector2],this.z=0,this.renderOrder=0},i=function(){this.position=new e.Vector3,this.positionWorld=new e.Vector3,this.positionScreen=new e.Vector4,this.visible=!0};i.prototype.copy=function(e){this.positionWorld.copy(e.positionWorld),this.positionScreen.copy(e.positionScreen)};var o=function(){this.id=0,this.v1=new i,this.v2=new i,this.vertexColors=[new e.Color,new e.Color],this.material=null,this.z=0,this.renderOrder=0},n=function(){this.id=0,this.object=null,this.x=0,this.y=0,this.z=0,this.rotation=0,this.scale=new e.Vector2,this.material=null,this.renderOrder=0};exports.Projector=function(){var s,a,l,c,p,u,h,f,d,m,v,y=[],x=0,g=[],w=0,M=[],b=0,j=[],S=0,z=[],V=0,O={objects:[],lights:[],elements:[]},E=new e.Vector3,T=new e.Vector4,R=new e.Box3(new e.Vector3(-1,-1,-1),new e.Vector3(1,1,1)),C=new e.Box3,P=new Array(3),G=new e.Matrix4,W=new e.Matrix4,B=new e.Matrix4,L=new e.Frustum;this.projectVector=function(e,r){console.warn("THREE.Projector: .projectVector() is now vector.project()."),e.project(r)},this.unprojectVector=function(e,r){console.warn("THREE.Projector: .unprojectVector() is now vector.unproject()."),e.unproject(r)},this.pickingRay=function(){console.error("THREE.Projector: .pickingRay() is now raycaster.setFromCamera().")};var A=new function(){var r=[],t=[],n=[],s=null,a=new e.Matrix3;function u(e){var r=e.position,t=e.positionWorld,i=e.positionScreen;t.copy(r).applyMatrix4(v),i.copy(t).applyMatrix4(W);var o=1/i.w;i.x*=o,i.y*=o,i.z*=o,e.visible=i.x>=-1&&i.x<=1&&i.y>=-1&&i.y<=1&&i.z>=-1&&i.z<=1}function d(e,r,t){return!0===e.visible||!0===r.visible||!0===t.visible||(P[0]=e.positionScreen,P[1]=r.positionScreen,P[2]=t.positionScreen,R.intersectsBox(C.setFromPoints(P)))}function m(e,r,t){return(t.positionScreen.x-e.positionScreen.x)*(r.positionScreen.y-e.positionScreen.y)-(t.positionScreen.y-e.positionScreen.y)*(r.positionScreen.x-e.positionScreen.x)<0}return{setObject:function(e){s=e,a.getNormalMatrix(s.matrixWorld),r.length=0,t.length=0,n.length=0},projectVertex:u,checkTriangleVisibility:d,checkBackfaceCulling:m,pushVertex:function(e,r,t){(l=function(){if(c===w){var e=new i;return g.push(e),w++,c++,e}return g[c++]}()).position.set(e,r,t),u(l)},pushNormal:function(e,t,i){r.push(e,t,i)},pushColor:function(e,r,i){t.push(e,r,i)},pushUv:function(e,r){n.push(e,r)},pushLine:function(e,r){var i,n,a,l,c,p,u,d,m=g[e],v=g[r];m.positionScreen.copy(m.position).applyMatrix4(B),v.positionScreen.copy(v.position).applyMatrix4(B),!0==(i=m.positionScreen,n=v.positionScreen,a=0,l=1,c=i.z+i.w,p=n.z+n.w,u=-i.z+i.w,d=-n.z+n.w,c>=0&&p>=0&&u>=0&&d>=0||!(c<0&&p<0||u<0&&d<0)&&(c<0?a=Math.max(a,c/(c-p)):p<0&&(l=Math.min(l,c/(c-p))),u<0?a=Math.max(a,u/(u-d)):d<0&&(l=Math.min(l,u/(u-d))),!(l<a||(i.lerp(n,a),n.lerp(i,1-l),0))))&&(m.positionScreen.multiplyScalar(1/m.positionScreen.w),v.positionScreen.multiplyScalar(1/v.positionScreen.w),(h=function(){if(f===S){var e=new o;return j.push(e),S++,f++,e}return j[f++]}()).id=s.id,h.v1.copy(m),h.v2.copy(v),h.z=Math.max(m.positionScreen.z,v.positionScreen.z),h.renderOrder=s.renderOrder,h.material=s.material,s.material.vertexColors&&(h.vertexColors[0].fromArray(t,3*e),h.vertexColors[1].fromArray(t,3*r)),O.elements.push(h))},pushTriangle:function(i,o,l,c){var u=g[i],h=g[o],f=g[l];if(!1!==d(u,h,f)&&(c.side===e.DoubleSide||!0===m(u,h,f))){(p=U()).id=s.id,p.v1.copy(u),p.v2.copy(h),p.v3.copy(f),p.z=(u.positionScreen.z+h.positionScreen.z+f.positionScreen.z)/3,p.renderOrder=s.renderOrder,E.subVectors(f.position,h.position),T.subVectors(u.position,h.position),E.cross(T),p.normalModel.copy(E),p.normalModel.applyMatrix3(a).normalize();for(var v=0;v<3;v++){var y=p.vertexNormalsModel[v];y.fromArray(r,3*arguments[v]),y.applyMatrix3(a).normalize();var x=p.uvs[v];x.fromArray(n,2*arguments[v])}p.vertexNormalsLength=3,p.material=c,c.vertexColors&&p.color.fromArray(t,3*i),O.elements.push(p)}}}};function H(e){if(!1!==e.visible){if(e.isLight)O.lights.push(e);else if(e.isMesh||e.isLine||e.isPoints){if(!1===e.material.visible)return;if(!0===e.frustumCulled&&!1===L.intersectsObject(e))return;N(e)}else if(e.isSprite){if(!1===e.material.visible)return;if(!0===e.frustumCulled&&!1===L.intersectsSprite(e))return;N(e)}for(var r=e.children,t=0,i=r.length;t<i;t++)H(r[t])}}function N(e){(s=function(){if(a===x){var e=new r;return y.push(e),x++,a++,e}return y[a++]}()).id=e.id,s.object=e,E.setFromMatrixPosition(e.matrixWorld),E.applyMatrix4(W),s.z=E.z,s.renderOrder=e.renderOrder,O.objects.push(s)}function F(e,r,t){var i=1/e.w;e.z*=i,e.z>=-1&&e.z<=1&&((d=function(){if(m===V){var e=new n;return z.push(e),V++,m++,e}return z[m++]}()).id=r.id,d.x=e.x*i,d.y=e.y*i,d.z=e.z,d.renderOrder=r.renderOrder,d.object=r,d.rotation=r.rotation,d.scale.x=r.scale.x*Math.abs(d.x-(e.x+t.projectionMatrix.elements[0])/(e.w+t.projectionMatrix.elements[12])),d.scale.y=r.scale.y*Math.abs(d.y-(e.y+t.projectionMatrix.elements[5])/(e.w+t.projectionMatrix.elements[13])),d.material=r.material,O.elements.push(d))}function U(){if(u===b){var e=new t;return M.push(e),b++,u++,e}return M[u++]}function k(e,r){return e.renderOrder!==r.renderOrder?e.renderOrder-r.renderOrder:e.z!==r.z?r.z-e.z:e.id!==r.id?e.id-r.id:0}this.projectScene=function(e,r,t,i){u=0,f=0,m=0,O.elements.length=0,!0===e.autoUpdate&&e.updateMatrixWorld(),null===r.parent&&r.updateMatrixWorld(),G.copy(r.matrixWorldInverse),W.multiplyMatrices(r.projectionMatrix,G),L.setFromProjectionMatrix(W),a=0,O.objects.length=0,O.lights.length=0,H(e),!0===t&&O.objects.sort(k);for(var o=O.objects,n=0,s=o.length;n<s;n++){var l=o[n].object,p=l.geometry;if(A.setObject(l),v=l.matrixWorld,c=0,l.isMesh){if(p.isBufferGeometry){var h=l.material,d=Array.isArray(h),y=p.attributes,x=p.groups;if(void 0===y.position)continue;for(var g=0,w=(ye=y.position.array).length;g<w;g+=3){var M=ye[g],b=ye[g+1],j=ye[g+2];if(!0===h.morphTargets)for(var S=p.morphAttributes.position,z=p.morphTargetsRelative,V=l.morphTargetInfluences,E=0,R=S.length;E<R;E++){var C=V[E];if(0!==C){var P=S[E];z?(M+=P.getX(g/3)*C,b+=P.getY(g/3)*C,j+=P.getZ(g/3)*C):(M+=(P.getX(g/3)-ye[g])*C,b+=(P.getY(g/3)-ye[g+1])*C,j+=(P.getZ(g/3)-ye[g+2])*C)}}A.pushVertex(M,b,j)}if(void 0!==y.normal)for(var N=y.normal.array,U=0,I=N.length;U<I;U+=3)A.pushNormal(N[U],N[U+1],N[U+2]);if(void 0!==y.color)for(var X=0,Y=(ce=y.color.array).length;X<Y;X+=3)A.pushColor(ce[X],ce[X+1],ce[X+2]);if(void 0!==y.uv)for(var Z=y.uv.array,_=0,q=Z.length;_<q;_+=2)A.pushUv(Z[_],Z[_+1]);if(null!==p.index){var D=p.index.array;if(x.length>0)for(var J=0;J<x.length;J++){var K=x[J];if(void 0!==(h=!0===d?l.material[K.materialIndex]:l.material))for(var Q=K.start,$=K.start+K.count;Q<$;Q+=3)A.pushTriangle(D[Q],D[Q+1],D[Q+2],h)}else for(var ee=0,re=D.length;ee<re;ee+=3)A.pushTriangle(D[ee],D[ee+1],D[ee+2],h)}else if(x.length>0)for(var te=0;te<x.length;te++){K=x[te];if(void 0!==(h=!0===d?l.material[K.materialIndex]:l.material))for(var ie=K.start,oe=K.start+K.count;ie<oe;ie+=3)A.pushTriangle(ie,ie+1,ie+2,h)}else for(var ne=0,se=ye.length/3;ne<se;ne+=3)A.pushTriangle(ne,ne+1,ne+2,h)}else if(p.isGeometry)return void console.error("THREE.Projector no longer supports Geometry. Use THREE.BufferGeometry instead.")}else if(l.isLine){if(B.multiplyMatrices(W,v),p.isBufferGeometry){if(void 0!==(y=p.attributes).position){for(var ae=0,le=(ye=y.position.array).length;ae<le;ae+=3)A.pushVertex(ye[ae],ye[ae+1],ye[ae+2]);if(void 0!==y.color)for(var ce,pe=0,ue=(ce=y.color.array).length;pe<ue;pe+=3)A.pushColor(ce[pe],ce[pe+1],ce[pe+2]);if(null!==p.index)for(var he=0,fe=(D=p.index.array).length;he<fe;he+=2)A.pushLine(D[he],D[he+1]);else for(var de=l.isLineSegments?2:1,me=0,ve=ye.length/3-1;me<ve;me+=de)A.pushLine(me,me+1)}}else if(p.isGeometry)return void console.error("THREE.Projector no longer supports Geometry. Use THREE.BufferGeometry instead.")}else if(l.isPoints){if(B.multiplyMatrices(W,v),p.isGeometry)return void console.error("THREE.Projector no longer supports Geometry. Use THREE.BufferGeometry instead.");if(p.isBufferGeometry&&void 0!==(y=p.attributes).position)for(var ye,xe=0,ge=(ye=y.position.array).length;xe<ge;xe+=3)T.set(ye[xe],ye[xe+1],ye[xe+2],1),T.applyMatrix4(B),F(T,l,r)}else l.isSprite&&(l.modelViewMatrix.multiplyMatrices(r.matrixWorldInverse,l.matrixWorld),T.set(v.elements[12],v.elements[13],v.elements[14],1),T.applyMatrix4(W),F(T,l,r))}return!0===i&&O.elements.sort(k),O}},exports.RenderableFace=t,exports.RenderableLine=o,exports.RenderableObject=r,exports.RenderableSprite=n,exports.RenderableVertex=i;
