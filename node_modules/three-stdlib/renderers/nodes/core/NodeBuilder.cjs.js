"use strict";var e=require("./NodeUniform.cjs.js"),t=require("./NodeAttribute.cjs.js"),r=require("./NodeVary.cjs.js"),n=require("./constants.cjs.js");function o(e,t){var r;if("undefined"==typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(r=function(e,t){if(!e)return;if("string"==typeof e)return a(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);"Object"===r&&e.constructor&&(r=e.constructor.name);if("Map"===r||"Set"===r)return Array.from(e);if("Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r))return a(e,t)}(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var n=0;return function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}return(r=e[Symbol.iterator]()).next.bind(r)}function a(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}require("@babel/runtime/helpers/createClass");var i=function(){function a(e,t){this.material=e,this.renderer=t,this.nodes=[],this.updateNodes=[],this.vertexShader=null,this.fragmentShader=null,this.slots={vertex:[],fragment:[]},this.defines={vertex:{},fragment:{}},this.uniforms={vertex:[],fragment:[]},this.attributes=[],this.varys=[],this.nodesData=new WeakMap,this.shaderStage=null}var i=a.prototype;return i.addNode=function(e){-1===this.nodes.indexOf(e)&&(e.getUpdateType(this)!==n.NodeUpdateType.None&&this.updateNodes.push(e),this.nodes.push(e))},i.addSlot=function(e,t){this.slots[e].push(t)},i.define=function(e,t,r){void 0===r&&(r=""),this.defines[e][t]=r},i.getTexture=function(){console.warn("Abstract function.")},i.getConst=function(e,t){if("float"===e)return t+(t%1?"":".0");if("vec2"===e)return"vec2( "+t.x+", "+t.y+" )";if("vec3"===e)return"vec3( "+t.x+", "+t.y+", "+t.z+" )";if("vec4"===e)return"vec4( "+t.x+", "+t.y+", "+t.z+", "+t.w+" )";if("color"===e)return"vec3( "+t.r+", "+t.g+", "+t.b+" )";throw new Error("Type '"+e+"' not found in generate constant attempt.")},i.getAttribute=function(e,r){for(var n,a=this.attributes,i=o(a);!(n=i()).done;){var s=n.value;if(s.name===e)return s}var c=new t(e,r);return a.push(c),c},i.getPropertyName=function(e){return e.name},i.isVector=function(e){return/vec\d/.test(e)},i.isMatrix=function(e){return/mat\d/.test(e)},i.isShaderStage=function(e){return this.shaderStage===e},i.getVectorType=function(e){return"color"===e?"vec3":"texture"===e?"vec4":e},i.getTypeFromLength=function(e){return 1===e?"float":2===e?"vec2":3===e?"vec3":4===e?"vec4":0},i.getTypeLength=function(e){return"float"===(e=this.getVectorType(e))?1:"vec2"===e?2:"vec3"===e?3:"vec4"===e?4:0},i.getDataFromNode=function(e,t){void 0===t&&(t=null);var r=this.nodesData.get(e);return void 0===r&&(r={vertex:{},fragment:{}},this.nodesData.set(e,r)),t?r[t]:r},i.getUniformFromNode=function(t,r,n){var o=this.getDataFromNode(t,r),a=o.uniform;if(void 0===a){var i=this.uniforms[r],s=i.length;a=new e("nodeU"+s,n,t),i.push(a),o.uniform=a}return a},i.getVaryFromNode=function(e,t){var n=this.getDataFromNode(e),o=n.vary;if(void 0===o){var a=this.varys,i=a.length;o=new r("nodeV"+i,t),a.push(o),n.vary=o}return o},i.flowNode=function(e,t){var r={};return r.result=e.build(this,t),r},i._buildDefines=function(e){var t=this.defines[e],r="";for(var n in t)r+="#define "+n+" "+t[n]+"\n";return r},i.getAttributesBodySnippet=function(){console.warn("Abstract function.")},i.getAttributesHeaderSnippet=function(){console.warn("Abstract function.")},i.getVarysHeaderSnippet=function(){console.warn("Abstract function.")},i.getVarysBodySnippet=function(){console.warn("Abstract function.")},i.getUniformsHeaderSnippet=function(){console.warn("Abstract function.")},i.getHash=function(){return this.vertexShader+this.fragmentShader},i.build=function(){for(var e=["vertex","fragment"],t={},r=0,n=e;r<n.length;r++){var a=n[r];this.shaderStage=a;for(var i,s=o(this.slots[a]);!(i=s()).done;){var c=i.value,u=this.flowNode(c.node,c.output);this.define(a,"NODE_"+c.name,u.result)}}this.shaderStage=null;for(var f=0,v=e;f<v.length;f++){var d=v[f];this.define(d,"NODE_HEADER_UNIFORMS",this.getUniformsHeaderSnippet(d)),this.define(d,"NODE_HEADER_ATTRIBUTES",this.getAttributesHeaderSnippet(d)),this.define(d,"NODE_HEADER_VARYS",this.getVarysHeaderSnippet(d)),this.define(d,"NODE_BODY_VARYS",this.getVarysBodySnippet(d)),t[d]=this._buildDefines(d)}return this.vertexShader=t.vertex,this.fragmentShader=t.fragment,this},i.format=function(e,t,r){switch((t=this.getVectorType(t))+" to "+(r=this.getVectorType(r))){case"float to vec2":return"vec2( "+e+" )";case"float to vec3":return"vec3( "+e+" )";case"float to vec4":return"vec4( vec3( "+e+" ), 1.0 )";case"vec2 to float":return e+".x";case"vec2 to vec3":return"vec3( "+e+", 0.0 )";case"vec2 to vec4":return"vec4( "+e+".xy, 0.0, 1.0 )";case"vec3 to float":return e+".x";case"vec3 to vec2":return e+".xy";case"vec3 to vec4":return"vec4( "+e+", 1.0 )";case"vec4 to float":return e+".x";case"vec4 to vec2":return e+".xy";case"vec4 to vec3":return e+".xyz";case"mat3 to float":return"( "+e+" * vec3( 1.0 ) ).x";case"mat3 to vec2":return"( "+e+" * vec3( 1.0 ) ).xy";case"mat3 to vec3":return"( "+e+" * vec3( 1.0 ) ).xyz";case"mat3 to vec4":return"vec4( "+e+" * vec3( 1.0 ), 1.0 )";case"mat4 to float":return"( "+e+" * vec4( 1.0 ) ).x";case"mat4 to vec2":return"( "+e+" * vec4( 1.0 ) ).xy";case"mat4 to vec3":return"( "+e+" * vec4( 1.0 ) ).xyz";case"mat4 to vec4":return"( "+e+" * vec4( 1.0 ) )"}return e},a}();module.exports=i;
