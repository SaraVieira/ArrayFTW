"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("react"),t=require("@react-three/fiber"),r=require("@babel/runtime/helpers/extends"),n=require("@babel/runtime/helpers/objectWithoutPropertiesLoose"),i=require("react-merge-refs"),a=require("three");require("@babel/runtime/helpers/createClass"),require("@babel/runtime/helpers/assertThisInitialized"),require("@babel/runtime/helpers/inheritsLoose"),require("@babel/runtime/helpers/defineProperty");var o=require("../materials/MeshReflectorMaterial.cjs.js");function u(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var s=u(r),l=u(n),d=u(i);t.extend({MeshReflectorMaterial:o.MeshReflectorMaterial});var c=e.forwardRef((function(r,n){var i=r.mixBlur,o=void 0===i?0:i,u=r.mixStrength,c=void 0===u?.5:u,m=r.resolution,p=void 0===m?256:m,h=r.args,f=void 0===h?[1,1]:h,x=r.minDepthThreshold,M=void 0===x?.9:x,g=r.maxDepthThreshold,v=void 0===g?1:g,b=r.depthScale,T=void 0===b?0:b,S=r.depthToBlurRatioBias,w=void 0===S?.25:S,R=r.mirror,y=r.children,F=r.debug,B=void 0===F?0:F,D=r.distortion,W=void 0===D?1:D,q=r.distortionMap,V=l.default(r,["mixBlur","mixStrength","resolution","args","minDepthThreshold","maxDepthThreshold","depthScale","depthToBlurRatioBias","mirror","children","debug","distortion","distortionMap"]),j=t.useThree((function(e){return e.gl})),E=t.useThree((function(e){return e.camera})),P=t.useThree((function(e){return e.scene})),_=e.useRef(null),L=e.useState((function(){return new a.Plane}))[0],G=e.useState((function(){return new a.Vector3}))[0],I=e.useState((function(){return new a.Vector3}))[0],k=e.useState((function(){return new a.Vector3}))[0],z=e.useState((function(){return new a.Matrix4}))[0],C=e.useState((function(){return new a.Vector3(0,0,-1)}))[0],O=e.useState((function(){return new a.Vector4}))[0],U=e.useState((function(){return new a.Vector3}))[0],A=e.useState((function(){return new a.Vector3}))[0],N=e.useState((function(){return new a.Vector4}))[0],H=e.useState((function(){return new a.Matrix4}))[0],J=e.useState((function(){return new a.PerspectiveCamera}))[0],K=e.useState((function(){for(var e=[],t={minFilter:a.LinearFilter,magFilter:a.LinearFilter,format:a.RGBFormat,encoding:j.outputEncoding},r=0;r<8;r++){var n=Math.max(8,Math.round(p/Math.pow(2,r))),i=new a.WebGLRenderTarget(n,n,t);i.texture.generateMipmaps=!1,e.push(i)}return e}))[0],Q=e.useCallback((function(){if(I.setFromMatrixPosition(_.current.matrixWorld),k.setFromMatrixPosition(E.matrixWorld),z.extractRotation(_.current.matrixWorld),G.set(0,0,1),G.applyMatrix4(z),U.subVectors(I,k),!(U.dot(G)>0)){U.reflect(G).negate(),U.add(I),z.extractRotation(E.matrixWorld),C.set(0,0,-1),C.applyMatrix4(z),C.add(k),A.subVectors(I,C),A.reflect(G).negate(),A.add(I),J.position.copy(U),J.up.set(0,1,0),J.up.applyMatrix4(z),J.up.reflect(G),J.lookAt(A),J.far=E.far,J.updateMatrixWorld(),J.projectionMatrix.copy(E.projectionMatrix),H.set(.5,0,0,.5,0,.5,0,.5,0,0,.5,.5,0,0,0,1),H.multiply(J.projectionMatrix),H.multiply(J.matrixWorldInverse),H.multiply(_.current.matrixWorld),L.setFromNormalAndCoplanarPoint(G,I),L.applyMatrix4(J.matrixWorldInverse),O.set(L.normal.x,L.normal.y,L.normal.z,L.constant);var e=J.projectionMatrix;N.x=(Math.sign(O.x)+e.elements[8])/e.elements[0],N.y=(Math.sign(O.y)+e.elements[9])/e.elements[5],N.z=-1,N.w=(1+e.elements[10])/e.elements[14],O.multiplyScalar(2/O.dot(N)),e.elements[2]=O.x,e.elements[6]=O.y,e.elements[10]=O.z+1,e.elements[14]=O.w}}),[E.far,E.matrixWorld,E.projectionMatrix,k,O,C,G,N,L,I,z,A,H,U,J]),X=e.useMemo((function(){var e={minFilter:a.LinearFilter,magFilter:a.LinearFilter,format:a.RGBFormat,encoding:j.outputEncoding},t=new a.WebGLRenderTarget(p,p,e);T>0&&(t.depthBuffer=!0,t.depthTexture=new a.DepthTexture(p,p),t.depthTexture.format=a.DepthFormat,t.depthTexture.type=a.UnsignedShortType);var r=K.reduce((function(e,t,r){return e["u_mipmap_"+r]=t.texture,e["u_mipmap_res_"+r]=new a.Vector2(t.width,t.height),e}),{});return[t,s.default({mirror:R,textureMatrix:H,mixBlur:o,tDiffuse:t.texture,tDepth:t.depthTexture,mixStrength:c,minDepthThreshold:M,maxDepthThreshold:v,depthScale:T,depthToBlurRatioBias:w,debug:B,distortion:W,distortionMap:q,"defines-USE_DEPTH":T>0?"":void 0,"defines-USE_DISTORTION":q?"":void 0},r)]}),[j,H,p,R,o,c,M,v,T,w,B,W,q,K]),Y=X[0],Z=X[1];return t.useFrame((function(){(null==_?void 0:_.current)&&(_.current.visible=!1,Q(),j.setRenderTarget(Y),j.state.buffers.depth.setMask(!0),j.render(P,J),0!==o&&K.forEach((function(e){j.setRenderTarget(e),j.state.buffers.depth.setMask(!0),j.render(P,J)})),_.current.visible=!0,j.setRenderTarget(null))})),e.createElement("mesh",s.default({ref:d.default([_,n])},V),e.createElement("planeBufferGeometry",{args:f}),y?y("meshReflectorMaterial",Z):e.createElement("meshReflectorMaterial",Z))}));exports.Reflector=c;
